# 安全保护流程思维导图

## 1. 安全保护主流程

```mermaid
graph TD
    A[安全任务启动] --> B[安全管理器初始化]
    B --> C[安全限制参数设置]
    C --> D[故障记录清零]
    D --> E[进入安全监控主循环]

    E --> F[等待安全检查周期10ms]
    F --> G[执行全系统安全检查]
    G --> H[温度安全检查]
    G --> I[压力安全检查]
    G --> J[液位安全检查]
    G --> K[急停按钮检查]
    G --> L[传感器健康检查]
    G --> M[执行器健康检查]
    G --> N[通信超时检查]

    H --> O{发现温度故障?}
    I --> P{发现压力故障?}
    J --> Q{发现液位故障?}
    K --> R{急停按钮按下?}
    L --> S{传感器故障?}
    M --> T{执行器故障?}
    N --> U{通信超时?}

    O -->|是| V[温度故障处理]
    P -->|是| W[压力故障处理]
    Q -->|是| X[液位故障处理]
    R -->|是| Y[急停故障处理]
    S -->|是| Z[传感器故障处理]
    T -->|是| AA[执行器故障处理]
    U -->|是| BB[通信故障处理]

    O -->|否| CC[更新安全状态]
    P -->|否| CC
    Q -->|否| CC
    R -->|否| CC
    S -->|否| CC
    T -->|否| CC
    U -->|否| CC

    V --> DD[确定故障等级]
    W --> DD
    X --> DD
    Y --> DD
    Z --> DD
    AA --> DD
    BB --> DD

    DD --> EE{故障等级判断}
    EE -->|警告| FF[记录警告事件]
    EE -->|报警| GG[触发报警动作]
    EE -->|紧急| HH[触发紧急动作]
    EE -->|严重| II[触发严重故障动作]

    FF --> JJ[更新故障记录]
    GG --> KK[部分系统关闭]
    HH --> LL[紧急系统关闭]
    II --> MM[全系统紧急停机]

    JJ --> CC
    KK --> JJ
    LL --> JJ
    MM --> NN[进入故障安全状态]

    CC --> OO[更新系统健康状态]
    NN --> OO
    OO --> F
```

## 2. 温度安全检查详细流程

```mermaid
graph TD
    A[温度安全检查开始] --> B[遍历所有温度传感器]
    B --> C[获取传感器数据]
    C --> D{传感器数据有效?}

    D -->|否| E[传感器故障检测]
    E --> F{超时时间检查}
    F -->|超时| G[记录传感器超时故障]
    F -->|未超时| H[使用上次有效值]

    D -->|是| I[检查温度上限]
    I --> J{温度>最大限制?}

    J -->|是| K[高温故障检测]
    K --> L{连续超限时间>阈值?}
    L -->|是| M[触发高温保护]
    L -->|否| N[高温计数器+1]

    J -->|否| O[检查温度下限]
    O --> P{温度<最小限制?}

    P -->|是| Q[低温故障检测]
    Q --> R{连续超限时间>阈值?}
    R -->|是| S[触发低温保护]
    R -->|否| T[低温计数器+1]

    P -->|否| U[温度正常]
    U --> V[清零故障计数器]

    G --> W[关闭对应加热器]
    M --> X[紧急关闭加热器]
    S --> Y[启动加热器保护]
    H --> Z[继续监控]
    N --> Z
    T --> Z
    V --> Z

    W --> AA[记录故障代码]
    X --> AA
    Y --> AA
    Z --> BB[检查下一个传感器]
    AA --> BB

    BB --> CC{所有传感器检查完?}
    CC -->|否| C
    CC -->|是| DD[温度安全检查完成]
```

## 3. 压力安全检查详细流程

```mermaid
graph TD
    A[压力安全检查开始] --> B[遍历所有压力传感器]
    B --> C[获取传感器数据]
    C --> D{传感器数据有效?}

    D -->|否| E[传感器故障检测]
    E --> F{超时时间检查}
    F -->|超时| G[记录传感器超时故障]
    F -->|未超时| H[使用上次有效值]

    D -->|是| I[检查压力上限]
    I --> J{压力>最大限制?}

    J -->|是| K[高压故障检测]
    K --> L{连续超限时间>阈值?}
    L -->|是| M[触发高压保护]
    L -->|否| N[高压计数器+1]

    J -->|否| O[检查压力下限]
    O --> P{压力<最小限制?}

    P -->|是| Q[低压故障检测]
    Q --> R{连续超限时间>阈值?}
    R -->|是| S[触发低压保护]
    R -->|否| T[低压计数器+1]

    P -->|否| U[压力正常]
    U --> V[清零故障计数器]

    G --> W[停止相关泵]
    M --> X[紧急停止泵并开启泄压阀]
    S --> Y[启动增压保护]
    H --> Z[继续监控]
    N --> Z
    T --> Z
    V --> Z

    W --> AA[记录故障代码]
    X --> AA
    Y --> AA
    Z --> BB[检查下一个传感器]
    AA --> BB

    BB --> CC{所有传感器检查完?}
    CC -->|否| C
    CC -->|是| DD[压力安全检查完成]
```

## 4. 液位安全检查详细流程

```mermaid
graph TD
    A[液位安全检查开始] --> B[遍历所有液位传感器]
    B --> C[获取传感器数据]
    C --> D{传感器数据有效?}

    D -->|否| E[传感器故障检测]
    E --> F{超时时间检查}
    F -->|超时| G[记录传感器超时故障]
    F -->|未超时| H[使用上次有效值]

    D -->|是| I[检查液位上限]
    I --> J{液位>最大限制?}

    J -->|是| K[高液位故障检测]
    K --> L{连续超限时间>阈值?}
    L -->|是| M[触发高液位保护]
    L -->|否| N[高液位计数器+1]

    J -->|否| O[检查液位下限]
    O --> P{液位<最小限制?}

    P -->|是| Q[低液位故障检测]
    Q --> R{连续超限时间>阈值?}
    R -->|是| S[触发低液位保护]
    R -->|否| T[低液位计数器+1]

    P -->|否| U[液位正常]
    U --> V[清零故障计数器]

    G --> W[关闭进液阀]
    M --> X[关闭进液阀并开启排液阀]
    S --> Y[停止供液并报警]
    H --> Z[继续监控]
    N --> Z
    T --> Z
    V --> Z

    W --> AA[记录故障代码]
    X --> AA
    Y --> AA
    Z --> BB[检查下一个传感器]
    AA --> BB

    BB --> CC{所有传感器检查完?}
    CC -->|否| C
    CC -->|是| DD[液位安全检查完成]
```

## 5. 急停处理流程

```mermaid
graph TD
    A[急停检查开始] --> B[读取急停按钮状态]
    B --> C[按钮防抖处理]
    C --> D{急停按钮激活?}

    D -->|否| E[急停状态清除]
    E --> F[正常运行状态]

    D -->|是| G[急停状态确认]
    G --> H[记录急停事件]
    H --> I[触发急停动作序列]

    I --> J[立即关闭所有加热器]
    I --> K[立即停止所有泵]
    I --> L[关闭所有进液阀]
    I --> M[开启安全排放阀]
    I --> N[切断主电源继电器]

    J --> O[发送急停信号给所有任务]
    K --> O
    L --> O
    M --> O
    N --> O

    O --> P[设置系统为急停状态]
    P --> Q[启动急停指示灯]
    Q --> R[发送急停报警信息]
    R --> S[等待急停解除]

    S --> T{急停按钮释放?}
    T -->|否| S
    T -->|是| U[急停解除确认]

    U --> V[操作员确认解除?]
    V -->|否| S
    V -->|是| W[系统复位准备]

    W --> X[检查所有安全条件]
    X --> Y{安全条件满足?}
    Y -->|否| Z[显示未满足条件]
    Z --> S
    Y -->|是| AA[系统重新初始化]
    AA --> F
```

## 6. 故障等级处理流程

```mermaid
graph TD
    A[故障检测完成] --> B[故障等级评估]
    B --> C{故障等级判断}

    C -->|警告级| D[警告处理流程]
    C -->|报警级| E[报警处理流程]
    C -->|紧急级| F[紧急处理流程]
    C -->|严重级| G[严重故障处理流程]

    D --> D1[记录警告事件]
    D1 --> D2[更新警告计数]
    D2 --> D3[发送警告消息]
    D3 --> D4[继续正常运行]

    E --> E1[记录报警事件]
    E1 --> E2[激活报警指示]
    E2 --> E3[发送报警消息]
    E3 --> E4[部分功能降级]
    E4 --> E5[增加监控频率]

    F --> F1[记录紧急事件]
    F1 --> F2[立即安全动作]
    F2 --> F3[关闭相关系统]
    F3 --> F4[发送紧急消息]
    F4 --> F5[等待故障清除]

    G --> G1[记录严重故障]
    G1 --> G2[全系统紧急停机]
    G2 --> G3[进入故障安全状态]
    G3 --> G4[发送严重故障消息]
    G4 --> G5[等待人工干预]

    D4 --> H[继续安全监控]
    E5 --> H
    F5 --> I{故障是否清除?}
    G5 --> J{人工复位确认?}

    I -->|是| K[故障恢复流程]
    I -->|否| F5

    J -->|是| L[系统复位流程]
    J -->|否| G5

    K --> H
    L --> M[系统重新初始化]
    M --> H
```

## 7. 安全任务时序图

```mermaid
sequenceDiagram
    participant SAFETY as 安全任务
    participant SENSOR as 传感器任务
    participant CTRL as 控制任务
    participant ACT as 执行器任务
    participant COMM as 通信任务

    Note over SAFETY: 安全检查周期10ms开始

    SAFETY->>SENSOR: 获取所有传感器数据
    SENSOR-->>SAFETY: 返回传感器数据和状态

    SAFETY->>SAFETY: 温度安全检查
    SAFETY->>SAFETY: 压力安全检查
    SAFETY->>SAFETY: 液位安全检查
    SAFETY->>SAFETY: 急停按钮检查

    alt 发现故障
        SAFETY->>SAFETY: 故障等级评估

        alt 紧急/严重故障
            SAFETY->>CTRL: 发送紧急停止信号
            SAFETY->>ACT: 执行紧急安全动作
            CTRL-->>SAFETY: 确认停止完成
            ACT-->>SAFETY: 确认安全动作完成

            SAFETY->>COMM: 发送故障报警信息
            COMM-->>SAFETY: 确认消息发送
        else 警告/报警故障
            SAFETY->>CTRL: 发送故障信息
            SAFETY->>COMM: 发送报警信息
            CTRL-->>SAFETY: 确认故障处理
            COMM-->>SAFETY: 确认消息发送
        end

        SAFETY->>SAFETY: 更新故障记录
        SAFETY->>SAFETY: 更新系统安全状态
    else 无故障
        SAFETY->>SAFETY: 更新正常运行状态
    end

    Note over SAFETY: 等待下一个安全检查周期
```

## 8. 安全参数配置

### 8.1 温度安全限制
```c
// 温度安全参数
typedef struct {
    float max_temperature[3];      // 最大温度限制
    float min_temperature[3];      // 最小温度限制
    uint32_t temp_fault_timeout_ms; // 温度故障超时
    uint32_t temp_recovery_time_ms; // 温度恢复时间
} temperature_safety_limits_t;

const temperature_safety_limits_t temp_limits = {
    .max_temperature = {80.0f, 85.0f, 90.0f},   // 最大温度
    .min_temperature = {10.0f, 10.0f, 10.0f},   // 最小温度
    .temp_fault_timeout_ms = 1000,              // 故障超时1秒
    .temp_recovery_time_ms = 5000               // 恢复时间5秒
};
```

### 8.2 压力安全限制
```c
// 压力安全参数
typedef struct {
    float max_pressure[2];         // 最大压力限制
    float min_pressure[2];         // 最小压力限制
    uint32_t pressure_fault_timeout_ms; // 压力故障超时
    uint32_t pressure_recovery_time_ms; // 压力恢复时间
} pressure_safety_limits_t;

const pressure_safety_limits_t pressure_limits = {
    .max_pressure = {80.0f, 75.0f},            // 最大压力kPa
    .min_pressure = {5.0f, 5.0f},              // 最小压力kPa
    .pressure_fault_timeout_ms = 2000,         // 故障超时2秒
    .pressure_recovery_time_ms = 10000         // 恢复时间10秒
};
```

### 8.3 液位安全限制
```c
// 液位安全参数
typedef struct {
    float max_liquid_level[2];     // 最大液位限制
    float min_liquid_level[2];     // 最小液位限制
    uint32_t level_fault_timeout_ms; // 液位故障超时
    uint32_t level_recovery_time_ms; // 液位恢复时间
} liquid_level_safety_limits_t;

const liquid_level_safety_limits_t level_limits = {
    .max_liquid_level = {180.0f, 175.0f},      // 最大液位mm
    .min_liquid_level = {20.0f, 25.0f},        // 最小液位mm
    .level_fault_timeout_ms = 5000,            // 故障超时5秒
    .level_recovery_time_ms = 15000            // 恢复时间15秒
};
```

### 8.4 故障代码定义
```c
// 安全故障代码定义
#define SAFETY_FAULT_TEMPERATURE_HIGH_1     0x3001
#define SAFETY_FAULT_TEMPERATURE_HIGH_2     0x3002
#define SAFETY_FAULT_TEMPERATURE_HIGH_3     0x3003
#define SAFETY_FAULT_TEMPERATURE_LOW_1      0x3004
#define SAFETY_FAULT_TEMPERATURE_LOW_2      0x3005
#define SAFETY_FAULT_TEMPERATURE_LOW_3      0x3006
#define SAFETY_FAULT_PRESSURE_HIGH_1        0x3011
#define SAFETY_FAULT_PRESSURE_HIGH_2        0x3012
#define SAFETY_FAULT_PRESSURE_LOW_1         0x3013
#define SAFETY_FAULT_PRESSURE_LOW_2         0x3014
#define SAFETY_FAULT_LEVEL_HIGH_1           0x3021
#define SAFETY_FAULT_LEVEL_HIGH_2           0x3022
#define SAFETY_FAULT_LEVEL_LOW_1            0x3023
#define SAFETY_FAULT_LEVEL_LOW_2            0x3024
#define SAFETY_FAULT_EMERGENCY_STOP         0x3031
#define SAFETY_FAULT_SENSOR_TIMEOUT         0x3041
#define SAFETY_FAULT_ACTUATOR_TIMEOUT       0x3042
#define SAFETY_FAULT_COMMUNICATION_LOST     0x3051
```

---
**文档版本**: V4.0
**创建日期**: 2024-12-27
**维护者**: 供墨系统安全团队