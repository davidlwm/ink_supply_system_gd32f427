# 通信处理流程思维导图

## 1. 通信处理总体流程

```mermaid
graph TD
    A[通信任务启动] --> B[通信接口初始化]
    B --> C[EtherCAT接口初始化]
    B --> D[串口接口初始化]
    B --> E[网络接口初始化]

    C --> F[EtherCAT从站配置]
    D --> G[Modbus RTU配置]
    E --> H[TCP/IP协议栈配置]

    F --> I[进入通信主循环]
    G --> I
    H --> I

    I --> J[等待通信周期50ms]
    J --> K[处理接收数据]
    K --> L[EtherCAT数据处理]
    K --> M[串口数据处理]
    K --> N[网络数据处理]

    L --> O[解析EtherCAT帧]
    M --> P[解析Modbus帧]
    N --> Q[解析TCP/UDP帧]

    O --> R[更新输入PDO]
    P --> S[更新Modbus寄存器]
    Q --> T[更新网络数据]

    R --> U[数据有效性检查]
    S --> U
    T --> U

    U --> V{数据有效?}
    V -->|是| W[更新本地数据]
    V -->|否| X[使用默认数据]

    W --> Y[准备发送数据]
    X --> Y

    Y --> Z[收集系统状态]
    Z --> AA[收集传感器数据]
    AA --> BB[收集故障信息]

    BB --> CC[构造EtherCAT响应]
    BB --> DD[构造Modbus响应]
    BB --> EE[构造网络响应]

    CC --> FF[发送EtherCAT数据]
    DD --> GG[发送Modbus数据]
    EE --> HH[发送网络数据]

    FF --> II[更新通信统计]
    GG --> II
    HH --> II

    II --> JJ[通信状态监控]
    JJ --> J
```

## 2. EtherCAT通信详细流程

```mermaid
graph TD
    A[EtherCAT通信开始] --> B[检查EtherCAT状态]
    B --> C{从站状态检查}

    C -->|INIT状态| D[初始化状态处理]
    C -->|PREOP状态| E[预操作状态处理]
    C -->|SAFEOP状态| F[安全操作状态处理]
    C -->|OP状态| G[操作状态处理]

    D --> D1[配置从站参数]
    D1 --> D2[设置邮箱通信]
    D2 --> D3[配置PDO映射]
    D3 --> D4[状态转换到PREOP]

    E --> E1[验证配置参数]
    E1 --> E2[设置同步管理器]
    E2 --> E3[配置分布时钟]
    E3 --> E4[状态转换到SAFEOP]

    F --> F1[启用过程数据通信]
    F1 --> F2[同步输入数据]
    F2 --> F3[验证数据完整性]
    F3 --> F4[状态转换到OP]

    G --> G1[处理输入PDO]
    G1 --> H[解析控制命令]
    H --> H1[解析加热器功率控制]
    H --> H2[解析泵速度控制]
    H --> H3[解析阀门控制]
    H --> H4[解析系统控制字]

    H1 --> I1[验证功率范围]
    H2 --> I2[验证速度范围]
    H3 --> I3[验证阀门命令]
    H4 --> I4[验证控制命令]

    I1 --> J[更新本地控制数据]
    I2 --> J
    I3 --> J
    I4 --> J

    J --> K[准备输出PDO]
    K --> K1[收集液位数据]
    K --> K2[收集压力数据]
    K --> K3[收集温度数据]
    K --> K4[收集系统状态]

    K1 --> L1[格式化液位数据]
    K2 --> L2[格式化压力数据]
    K3 --> L3[格式化温度数据]
    K4 --> L4[格式化状态数据]

    L1 --> M[构造输出PDO帧]
    L2 --> M
    L3 --> M
    L4 --> M

    M --> N[发送PDO数据]
    N --> O[等待下一个周期]

    D4 --> O
    E4 --> O
    F4 --> O
    O --> B
```

## 3. Modbus RTU通信详细流程

```mermaid
graph TD
    A[Modbus通信开始] --> B[监听串口数据]
    B --> C{接收到数据?}

    C -->|否| D[检查超时]
    D --> E{通信超时?}
    E -->|是| F[清空接收缓冲区]
    E -->|否| B
    F --> B

    C -->|是| G[接收Modbus帧]
    G --> H[帧完整性检查]
    H --> I{帧完整?}

    I -->|否| J[等待更多数据]
    J --> K{接收超时?}
    K -->|是| L[丢弃不完整帧]
    K -->|否| G
    L --> B

    I -->|是| M[CRC校验]
    M --> N{CRC正确?}

    N -->|否| O[发送错误响应]
    O --> B

    N -->|是| P[解析从站地址]
    P --> Q{地址匹配?}

    Q -->|否| R[忽略帧]
    R --> B

    Q -->|是| S[解析功能码]
    S --> T{功能码识别}

    T -->|读保持寄存器(03)| U[读寄存器处理]
    T -->|写单个寄存器(06)| V[写单个寄存器处理]
    T -->|写多个寄存器(16)| W[写多个寄存器处理]
    T -->|读输入寄存器(04)| X[读输入寄存器处理]
    T -->|其他功能码| Y[不支持功能码错误]

    U --> U1[验证寄存器地址]
    U1 --> U2{地址有效?}
    U2 -->|否| U3[发送地址错误响应]
    U2 -->|是| U4[读取寄存器数据]
    U4 --> U5[构造读响应帧]

    V --> V1[验证寄存器地址]
    V1 --> V2{地址有效?}
    V2 -->|否| V3[发送地址错误响应]
    V2 -->|是| V4[写入寄存器数据]
    V4 --> V5[构造写响应帧]

    W --> W1[验证寄存器地址范围]
    W1 --> W2{地址范围有效?}
    W2 -->|否| W3[发送地址错误响应]
    W2 -->|是| W4[批量写入寄存器]
    W4 --> W5[构造写响应帧]

    X --> X1[验证输入寄存器地址]
    X1 --> X2{地址有效?}
    X2 -->|否| X3[发送地址错误响应]
    X2 -->|是| X4[读取输入寄存器]
    X4 --> X5[构造读响应帧]

    Y --> Y1[构造不支持功能码错误响应]

    U3 --> Z[发送响应帧]
    U5 --> Z
    V3 --> Z
    V5 --> Z
    W3 --> Z
    W5 --> Z
    X3 --> Z
    X5 --> Z
    Y1 --> Z

    Z --> AA[更新通信统计]
    AA --> B
```

## 4. 网络通信详细流程

```mermaid
graph TD
    A[网络通信开始] --> B[初始化TCP/UDP套接字]
    B --> C[绑定监听端口]
    C --> D[进入网络监听循环]

    D --> E{有新连接?}
    E -->|TCP连接| F[接受TCP连接]
    E -->|UDP数据| G[接收UDP数据]
    E -->|无数据| H[检查现有连接]

    F --> F1[验证客户端地址]
    F1 --> F2{客户端授权?}
    F2 -->|否| F3[拒绝连接]
    F2 -->|是| F4[建立TCP连接]
    F3 --> D
    F4 --> I[处理TCP数据]

    G --> G1[验证UDP来源]
    G1 --> G2{来源授权?}
    G2 -->|否| G3[丢弃UDP包]
    G2 -->|是| G4[处理UDP数据]
    G3 --> D
    G4 --> J[解析UDP命令]

    H --> H1[检查连接状态]
    H1 --> H2{连接活跃?}
    H2 -->|否| H3[清理无效连接]
    H2 -->|是| H4[处理连接数据]
    H3 --> D
    H4 --> I

    I --> I1[接收TCP数据]
    I1 --> I2[数据完整性检查]
    I2 --> I3{数据完整?}
    I3 -->|否| I4[等待更多数据]
    I3 -->|是| I5[解析TCP命令]
    I4 --> I1

    I5 --> K[命令类型识别]
    J --> K

    K --> K1{命令类型}
    K1 -->|状态查询| L[系统状态查询处理]
    K1 -->|参数设置| M[参数设置处理]
    K1 -->|数据订阅| N[数据订阅处理]
    K1 -->|固件升级| O[固件升级处理]
    K1 -->|文件传输| P[文件传输处理]

    L --> L1[收集系统状态]
    L1 --> L2[格式化状态数据]
    L2 --> L3[构造状态响应]

    M --> M1[验证参数范围]
    M1 --> M2{参数有效?}
    M2 -->|否| M3[构造参数错误响应]
    M2 -->|是| M4[更新系统参数]
    M4 --> M5[构造设置成功响应]

    N --> N1[建立数据订阅]
    N1 --> N2[配置推送频率]
    N2 --> N3[启动数据推送]

    O --> O1[验证固件文件]
    O1 --> O2{文件有效?}
    O2 -->|否| O3[拒绝固件升级]
    O2 -->|是| O4[启动固件升级流程]

    P --> P1[文件传输协议处理]
    P1 --> P2[文件完整性验证]
    P2 --> P3[文件存储处理]

    L3 --> Q[发送响应数据]
    M3 --> Q
    M5 --> Q
    N3 --> R[定期推送数据]
    O3 --> Q
    O4 --> S[固件升级流程]
    P3 --> Q

    Q --> T[更新网络统计]
    R --> T
    S --> U[系统重启]
    T --> D
    U --> A
```

## 5. 数据交换映射流程

```mermaid
graph TD
    A[数据交换开始] --> B[建立数据映射表]
    B --> C[输入数据映射]
    B --> D[输出数据映射]

    C --> C1[EtherCAT输入映射]
    C --> C2[Modbus输入映射]
    C --> C3[网络输入映射]

    C1 --> E1[PDO输入数据]
    C2 --> E2[Modbus寄存器数据]
    C3 --> E3[网络命令数据]

    E1 --> F1[加热器功率命令]
    E1 --> F2[泵速度命令]
    E1 --> F3[阀门控制命令]
    E1 --> F4[系统控制命令]

    E2 --> F5[温度设定值]
    E2 --> F6[压力设定值]
    E2 --> F7[液位设定值]
    E2 --> F8[系统配置参数]

    E3 --> F9[远程控制命令]
    E3 --> F10[参数配置命令]
    E3 --> F11[系统管理命令]

    F1 --> G[本地控制数据更新]
    F2 --> G
    F3 --> G
    F4 --> G
    F5 --> G
    F6 --> G
    F7 --> G
    F8 --> G
    F9 --> G
    F10 --> G
    F11 --> G

    D --> D1[EtherCAT输出映射]
    D --> D2[Modbus输出映射]
    D --> D3[网络输出映射]

    G --> H[收集本地数据]
    H --> H1[液位传感器数据]
    H --> H2[压力传感器数据]
    H --> H3[温度传感器数据]
    H --> H4[执行器状态数据]
    H --> H5[系统状态数据]
    H --> H6[故障信息数据]

    H1 --> D1
    H2 --> D1
    H3 --> D1
    H4 --> D1
    H5 --> D1
    H6 --> D1

    H1 --> D2
    H2 --> D2
    H3 --> D2
    H4 --> D2
    H5 --> D2
    H6 --> D2

    H1 --> D3
    H2 --> D3
    H3 --> D3
    H4 --> D3
    H5 --> D3
    H6 --> D3

    D1 --> I1[构造EtherCAT输出PDO]
    D2 --> I2[更新Modbus寄存器]
    D3 --> I3[构造网络响应包]

    I1 --> J[数据发送]
    I2 --> J
    I3 --> J

    J --> K[数据传输监控]
    K --> L[传输成功率统计]
    L --> M[数据交换完成]
```

## 6. 通信故障处理流程

```mermaid
graph TD
    A[通信故障检测] --> B{故障类型判断}

    B -->|连接断开| C[连接故障处理]
    B -->|数据错误| D[数据错误处理]
    B -->|超时故障| E[超时故障处理]
    B -->|协议错误| F[协议错误处理]

    C --> C1[检测连接状态]
    C1 --> C2[尝试重新连接]
    C2 --> C3{重连成功?}
    C3 -->|是| C4[恢复数据传输]
    C3 -->|否| C5[启用备用连接]
    C5 --> C6{备用连接可用?}
    C6 -->|是| C7[切换到备用连接]
    C6 -->|否| C8[进入离线模式]

    D --> D1[数据校验失败]
    D1 --> D2[请求重新发送]
    D2 --> D3[重新解析数据]
    D3 --> D4{数据修复成功?}
    D4 -->|是| D5[恢复正常处理]
    D4 -->|否| D6[丢弃错误数据]

    E --> E1[检查网络延迟]
    E1 --> E2[调整超时参数]
    E2 --> E3[重新发送数据]
    E3 --> E4{传输成功?}
    E4 -->|是| E5[恢复正常传输]
    E4 -->|否| E6[降低传输频率]

    F --> F1[协议版本检查]
    F1 --> F2[协议兼容性处理]
    F2 --> F3[协议降级处理]
    F3 --> F4{协议兼容?}
    F4 -->|是| F5[使用兼容协议]
    F4 -->|否| F6[拒绝通信]

    C4 --> G[更新通信状态]
    C7 --> G
    C8 --> H[本地运行模式]
    D5 --> G
    D6 --> G
    E5 --> G
    E6 --> G
    F5 --> G
    F6 --> I[通信拒绝模式]

    G --> J[记录故障处理]
    H --> J
    I --> J
    J --> K[通信故障处理完成]
```

## 7. 通信任务时序图

```mermaid
sequenceDiagram
    participant COMM as 通信任务
    participant ECTRL as EtherCAT控制器
    participant UART as 串口控制器
    participant NET as 网络控制器
    participant APP as 应用任务

    Note over COMM: 通信周期50ms开始

    COMM->>ECTRL: 检查EtherCAT状态
    ECTRL-->>COMM: 返回从站状态

    alt EtherCAT正常
        COMM->>ECTRL: 读取输入PDO
        ECTRL-->>COMM: 返回控制命令
        COMM->>APP: 更新控制数据
        APP-->>COMM: 确认数据更新

        COMM->>APP: 收集系统数据
        APP-->>COMM: 返回传感器和状态数据
        COMM->>ECTRL: 发送输出PDO
        ECTRL-->>COMM: 确认数据发送
    else EtherCAT故障
        COMM->>COMM: 执行EtherCAT故障处理
    end

    COMM->>UART: 检查串口数据
    UART-->>COMM: 返回接收数据

    alt 有Modbus数据
        COMM->>COMM: 解析Modbus帧
        COMM->>APP: 处理Modbus命令
        APP-->>COMM: 返回处理结果
        COMM->>UART: 发送Modbus响应
        UART-->>COMM: 确认发送完成
    end

    COMM->>NET: 检查网络连接
    NET-->>COMM: 返回连接状态

    alt 有网络数据
        COMM->>NET: 接收网络数据
        NET-->>COMM: 返回接收数据
        COMM->>COMM: 解析网络命令
        COMM->>APP: 处理网络命令
        APP-->>COMM: 返回处理结果
        COMM->>NET: 发送网络响应
        NET-->>COMM: 确认发送完成
    end

    COMM->>COMM: 更新通信统计
    COMM->>COMM: 检查通信健康状态

    Note over COMM: 等待下一个通信周期
```

## 8. 通信配置参数

### 8.1 EtherCAT配置参数
```c
// EtherCAT配置
typedef struct {
    uint16_t vendor_id;             // 厂商ID
    uint32_t product_code;          // 产品代码
    uint32_t revision_number;       // 版本号
    uint32_t serial_number;         // 序列号
    uint16_t station_alias;         // 站点别名
    uint32_t cycle_time_us;         // 循环时间
} ethercat_config_t;

const ethercat_config_t ethercat_cfg = {
    .vendor_id = 0x12345678,        // 供墨系统厂商ID
    .product_code = 0x87654321,     // 产品代码
    .revision_number = 0x00040000,  // 版本V4.0
    .serial_number = 0x00000001,    // 序列号
    .station_alias = 1000,          // 站点别名
    .cycle_time_us = 1000           // 1ms循环时间
};
```

### 8.2 Modbus配置参数
```c
// Modbus配置
typedef struct {
    uint8_t slave_address;          // 从站地址
    uint32_t baudrate;              // 波特率
    uint8_t data_bits;              // 数据位
    uint8_t stop_bits;              // 停止位
    char parity;                    // 奇偶校验
    uint32_t timeout_ms;            // 超时时间
} modbus_config_t;

const modbus_config_t modbus_cfg = {
    .slave_address = 1,             // 从站地址1
    .baudrate = 9600,               // 波特率9600
    .data_bits = 8,                 // 8数据位
    .stop_bits = 1,                 // 1停止位
    .parity = 'N',                  // 无奇偶校验
    .timeout_ms = 1000              // 超时1秒
};
```

### 8.3 网络配置参数
```c
// 网络配置
typedef struct {
    uint32_t ip_address;            // IP地址
    uint32_t subnet_mask;           // 子网掩码
    uint32_t gateway;               // 网关地址
    uint16_t tcp_port;              // TCP端口
    uint16_t udp_port;              // UDP端口
    uint32_t connect_timeout_ms;    // 连接超时
} network_config_t;

const network_config_t network_cfg = {
    .ip_address = 0xC0A80164,       // 192.168.1.100
    .subnet_mask = 0xFFFFFF00,      // 255.255.255.0
    .gateway = 0xC0A80101,          // 192.168.1.1
    .tcp_port = 502,                // Modbus TCP端口
    .udp_port = 5000,               // 自定义UDP端口
    .connect_timeout_ms = 5000      // 连接超时5秒
};
```

---
**文档版本**: V4.0
**创建日期**: 2024-12-27
**维护者**: 供墨系统通信团队