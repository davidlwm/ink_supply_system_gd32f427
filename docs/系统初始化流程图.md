# 系统初始化流程思维导图

## 1. 详细初始化流程

```mermaid
graph TD
    A[上电复位] --> B[CPU初始化]
    B --> B1[时钟配置]
    B --> B2[中断向量表]
    B --> B3[内存配置]

    B1 --> C[系统时钟设置200MHz]
    B2 --> D[中断优先级分组]
    B3 --> E[堆栈初始化]

    C --> F[外设时钟使能]
    D --> F
    E --> F

    F --> G[HAL层初始化]
    G --> G1[GPIO HAL初始化]
    G --> G2[ADC HAL初始化]
    G --> G3[PWM HAL初始化]
    G --> G4[I2C HAL初始化]
    G --> G5[Timer HAL初始化]
    G --> G6[UART HAL初始化]

    G1 --> H1[配置所有GPIO引脚]
    H1 --> H11[加热器控制引脚]
    H1 --> H12[阀门控制引脚]
    H1 --> H13[LED指示引脚]
    H1 --> H14[急停按钮引脚]

    G2 --> H2[配置ADC通道]
    H2 --> H21[液位传感器通道]
    H2 --> H22[压力传感器通道]
    H2 --> H23[温度传感器通道]
    H2 --> H24[电源监控通道]

    G3 --> H3[配置PWM通道]
    H3 --> H31[加热器PWM通道]
    H3 --> H32[泵控制PWM通道]
    H3 --> H33[风扇PWM通道]

    G4 --> H4[配置I2C接口]
    H4 --> H41[EEPROM通信]
    H4 --> H42[RTC通信]
    H4 --> H43[温度芯片通信]

    G5 --> H5[配置定时器]
    H5 --> H51[系统tick定时器]
    H5 --> H52[控制周期定时器]
    H5 --> H53[看门狗定时器]

    G6 --> H6[配置串口]
    H6 --> H61[调试串口UART1]
    H6 --> H62[通信串口UART2]
    H6 --> H63[EtherCAT接口]

    H11 --> I[中间件初始化]
    H12 --> I
    H13 --> I
    H14 --> I
    H21 --> I
    H22 --> I
    H23 --> I
    H24 --> I
    H31 --> I
    H32 --> I
    H33 --> I
    H41 --> I
    H42 --> I
    H43 --> I
    H51 --> I
    H52 --> I
    H53 --> I
    H61 --> I
    H62 --> I
    H63 --> I

    I --> I1[中间件系统初始化]
    I --> I2[PID系统初始化]
    I --> I3[滤波器系统初始化]
    I --> I4[任务管理器初始化]

    I1 --> J1[注册所有中间件模块]
    I2 --> J2[PID控制器数组清零]
    I3 --> J3[滤波器实例初始化]
    I4 --> J4[任务监控结构初始化]

    J1 --> K[FreeRTOS初始化]
    J2 --> K
    J3 --> K
    J4 --> K

    K --> K1[内核对象创建]
    K1 --> K11[互斥锁创建]
    K1 --> K12[信号量创建]
    K1 --> K13[消息队列创建]
    K1 --> K14[事件组创建]

    K11 --> L[任务创建]
    K12 --> L
    K13 --> L
    K14 --> L

    L --> L1[安全任务创建]
    L --> L2[控制任务创建]
    L --> L3[传感器任务创建]
    L --> L4[执行器任务创建]
    L --> L5[通信任务创建]
    L --> L6[HMI任务创建]
    L --> L7[配置任务创建]

    L1 --> M1[优先级15, 栈2KB, 周期10ms]
    L2 --> M2[优先级12, 栈4KB, 周期20ms]
    L3 --> M3[优先级8, 栈2KB, 周期50ms]
    L4 --> M4[优先级8, 栈2KB, 周期10ms]
    L5 --> M5[优先级5, 栈2KB, 周期50ms]
    L6 --> M6[优先级5, 栈2KB, 周期100ms]
    L7 --> M7[优先级2, 栈1KB, 周期1000ms]

    M1 --> N[任务注册到任务管理器]
    M2 --> N
    M3 --> N
    M4 --> N
    M5 --> N
    M6 --> N
    M7 --> N

    N --> O[驱动层初始化]
    O --> O1[传感器驱动初始化]
    O --> O2[执行器驱动初始化]
    O --> O3[通信驱动初始化]

    O1 --> P1[FRD8061液位传感器初始化]
    O1 --> P2[HP10MY压力传感器初始化]
    O1 --> P3[FTT518温度传感器初始化]

    O2 --> P4[MRA23D3加热器驱动初始化]
    O2 --> P5[MPB025BBB泵驱动初始化]
    O2 --> P6[阀门控制驱动初始化]
    O2 --> P7[LED控制驱动初始化]

    O3 --> P8[EtherCAT从站初始化]
    O3 --> P9[Modbus RTU初始化]
    O3 --> P10[自定义协议初始化]

    P1 --> Q[系统自检]
    P2 --> Q
    P3 --> Q
    P4 --> Q
    P5 --> Q
    P6 --> Q
    P7 --> Q
    P8 --> Q
    P9 --> Q
    P10 --> Q

    Q --> Q1[硬件自检]
    Q --> Q2[软件自检]
    Q --> Q3[通信自检]

    Q1 --> R1[GPIO功能测试]
    Q1 --> R2[ADC校准测试]
    Q1 --> R3[PWM输出测试]
    Q1 --> R4[I2C通信测试]
    Q1 --> R5[UART通信测试]

    Q2 --> R6[PID算法测试]
    Q2 --> R7[滤波器测试]
    Q2 --> R8[内存测试]
    Q2 --> R9[任务创建测试]

    Q3 --> R10[EtherCAT链路测试]
    Q3 --> R11[串口回环测试]
    Q3 --> R12[网络连接测试]

    R1 --> S{自检是否通过?}
    R2 --> S
    R3 --> S
    R4 --> S
    R5 --> S
    R6 --> S
    R7 --> S
    R8 --> S
    R9 --> S
    R10 --> S
    R11 --> S
    R12 --> S

    S -->|通过| T[启动调度器]
    S -->|失败| U[故障指示]

    U --> U1[LED故障闪烁]
    U --> U2[串口输出错误信息]
    U --> U3[看门狗复位]

    T --> V[进入正常运行状态]
    V --> V1[所有任务开始执行]
    V --> V2[实时调度开始]
    V --> V3[中断服务使能]
    V --> V4[系统运行指示]
```

## 2. 初始化时序图

```mermaid
sequenceDiagram
    participant CPU as CPU核心
    participant HAL as HAL层
    participant MW as 中间件
    participant RTOS as FreeRTOS
    participant APP as 应用层
    participant DRV as 驱动层

    Note over CPU: 系统上电复位

    CPU->>CPU: 时钟配置(200MHz)
    CPU->>CPU: 内存映射配置
    CPU->>CPU: 中断向量表配置

    CPU->>HAL: HAL层初始化
    HAL->>HAL: GPIO配置
    HAL->>HAL: ADC配置
    HAL->>HAL: PWM配置
    HAL->>HAL: I2C配置
    HAL->>HAL: Timer配置
    HAL->>HAL: UART配置

    HAL->>MW: 中间件初始化
    MW->>MW: 中间件系统注册
    MW->>MW: PID系统初始化
    MW->>MW: 滤波器系统初始化
    MW->>MW: 任务管理器初始化

    MW->>RTOS: FreeRTOS配置
    RTOS->>RTOS: 内核对象创建
    RTOS->>RTOS: 内存池配置
    RTOS->>RTOS: 调度器配置

    RTOS->>APP: 应用任务创建
    APP->>APP: 安全任务创建
    APP->>APP: 控制任务创建
    APP->>APP: 传感器任务创建
    APP->>APP: 执行器任务创建
    APP->>APP: 通信任务创建
    APP->>APP: HMI任务创建
    APP->>APP: 配置任务创建

    APP->>DRV: 驱动层初始化
    DRV->>DRV: 传感器驱动配置
    DRV->>DRV: 执行器驱动配置
    DRV->>DRV: 通信驱动配置

    DRV->>APP: 系统自检
    APP->>HAL: 硬件功能测试
    HAL-->>APP: 测试结果
    APP->>MW: 算法功能测试
    MW-->>APP: 测试结果
    APP->>DRV: 通信功能测试
    DRV-->>APP: 测试结果

    alt 自检通过
        APP->>RTOS: 启动调度器
        RTOS->>RTOS: 任务调度开始
        Note over RTOS: 系统进入运行状态
    else 自检失败
        APP->>APP: 故障处理
        APP->>CPU: 看门狗复位
    end
```

## 3. 关键初始化参数

### 3.1 时钟配置参数
```c
// 时钟配置
#define SYSTEM_CLOCK_FREQ       200000000UL  // 系统时钟200MHz
#define AHB_CLOCK_FREQ          200000000UL  // AHB时钟200MHz
#define APB1_CLOCK_FREQ         100000000UL  // APB1时钟100MHz
#define APB2_CLOCK_FREQ         200000000UL  // APB2时钟200MHz
#define PLL_SOURCE_HSE          1            // PLL时钟源为外部晶振
#define HSE_VALUE               25000000UL   // 外部晶振25MHz
```

### 3.2 内存配置参数
```c
// 内存配置
#define TOTAL_HEAP_SIZE         (128 * 1024) // 总堆大小128KB
#define STACK_SIZE_LARGE        (4 * 1024)   // 大栈4KB
#define STACK_SIZE_MEDIUM       (2 * 1024)   // 中栈2KB
#define STACK_SIZE_SMALL        (1 * 1024)   // 小栈1KB
#define ISR_STACK_SIZE          (1 * 1024)   // 中断栈1KB
```

### 3.3 任务配置参数
```c
// 任务优先级配置
#define TASK_PRIORITY_CRITICAL  15  // 关键任务(安全)
#define TASK_PRIORITY_HIGH      12  // 高优先级(控制)
#define TASK_PRIORITY_NORMAL    8   // 普通优先级(传感器/执行器)
#define TASK_PRIORITY_LOW       5   // 低优先级(通信/HMI)
#define TASK_PRIORITY_BACKGROUND 2  // 后台任务(配置)

// 任务周期配置
#define SAFETY_TASK_PERIOD_MS   10   // 安全任务周期
#define CONTROL_TASK_PERIOD_MS  20   // 控制任务周期
#define SENSOR_TASK_PERIOD_MS   50   // 传感器任务周期
#define ACTUATOR_TASK_PERIOD_MS 10   // 执行器任务周期
#define COMM_TASK_PERIOD_MS     50   // 通信任务周期
#define HMI_TASK_PERIOD_MS      100  // HMI任务周期
#define CONFIG_TASK_PERIOD_MS   1000 // 配置任务周期
```

### 3.4 硬件配置参数
```c
// ADC配置
#define ADC_RESOLUTION_BITS     12          // ADC分辨率12位
#define ADC_SAMPLE_TIME_US      10          // ADC采样时间10us
#define ADC_REFERENCE_VOLTAGE   3.3f        // ADC参考电压3.3V

// PWM配置
#define PWM_FREQUENCY_HZ        10000       // PWM频率10kHz
#define PWM_RESOLUTION_BITS     16          // PWM分辨率16位
#define PWM_DEAD_TIME_NS        100         // 死区时间100ns

// I2C配置
#define I2C_SPEED_HZ            400000      // I2C速度400kHz
#define I2C_TIMEOUT_MS          100         // I2C超时100ms

// UART配置
#define UART_DEBUG_BAUDRATE     115200      // 调试串口波特率
#define UART_COMM_BAUDRATE      9600        // 通信串口波特率
```

---
**文档版本**: V4.0
**创建日期**: 2024-12-27
**维护者**: 供墨系统初始化团队