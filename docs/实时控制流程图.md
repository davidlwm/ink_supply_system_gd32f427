# 实时控制流程思维导图

## 1. 实时控制主流程

```mermaid
graph TD
    A[控制任务启动] --> B[任务初始化]
    B --> C[控制管理器初始化]
    C --> D[PID控制器初始化]
    D --> E[进入控制主循环]

    E --> F[等待控制周期20ms]
    F --> G[获取系统状态]
    G --> H{安全检查通过?}

    H -->|否| I[关闭所有输出]
    I --> F

    H -->|是| J[获取传感器数据]
    J --> K{数据获取成功?}

    K -->|否| L[使用上次有效数据]
    K -->|是| M[数据有效性检查]

    L --> M
    M --> N{控制使能?}

    N -->|否| O[禁用所有控制输出]
    O --> F

    N -->|是| P[执行控制算法]
    P --> P1[温度控制循环]
    P --> P2[压力控制循环]
    P --> P3[液位控制循环]

    P1 --> Q1[更新控制统计]
    P2 --> Q1
    P3 --> Q1

    Q1 --> R{是否需要效率计算?}
    R -->|是,每1秒| S[计算系统效率]
    R -->|否| T{是否需要参数调整?}

    S --> T
    T -->|是,每5秒| U[自适应参数调整]
    T -->|否| F
    U --> F
```

## 2. 温度控制详细流程

```mermaid
graph TD
    A[温度控制循环开始] --> B[遍历3个温度控制器]
    B --> C{控制器使能?}

    C -->|否| D[关闭加热器]
    D --> E[继续下一个控制器]

    C -->|是| F[更新当前温度]
    F --> G{传感器故障?}

    G -->|是| H[安全关闭加热器]
    H --> I[清零稳定计数]
    I --> E

    G -->|否| J[计算温度误差]
    J --> K[PID控制计算]
    K --> L[输出限制处理]
    L --> M{过温保护检查}

    M -->|过温| N[紧急关闭加热器]
    M -->|正常| O[更新输出功率]

    N --> P[记录过温事件]
    O --> Q[设置加热器PWM]

    P --> R[稳定性统计]
    Q --> R

    R --> S{误差小于1°C?}
    S -->|是| T[稳定计数+1]
    S -->|否| U[稳定计数清零]

    T --> E
    U --> E
    E --> V{所有控制器处理完?}
    V -->|否| C
    V -->|是| W[温度控制循环结束]
```

## 3. 压力控制详细流程

```mermaid
graph TD
    A[压力控制循环开始] --> B[遍历2个压力控制器]
    B --> C{控制器使能?}

    C -->|否| D[停止泵运行]
    D --> E[继续下一个控制器]

    C -->|是| F[更新当前压力]
    F --> G{传感器故障?}

    G -->|是| H[安全停止泵]
    H --> I[清零稳定计数]
    I --> E

    G -->|否| J[计算压力误差]
    J --> K[PID控制计算]
    K --> L[输出转换为泵速]
    L --> M{泵速限制检查}

    M --> N[泵速范围限制]
    N --> O{PID输出<=0?}

    O -->|是| P[泵速设为0]
    O -->|否| Q[计算实际泵速]

    Q --> R[最大转速限制]
    P --> S[更新泵速输出]
    R --> S

    S --> T[设置泵PWM控制]
    T --> U[稳定性统计]

    U --> V{误差小于2kPa?}
    V -->|是| W[稳定计数+1]
    V -->|否| X[稳定计数清零]

    W --> E
    X --> E
    E --> Y{所有控制器处理完?}
    Y -->|否| C
    Y -->|是| Z[压力控制循环结束]
```

## 4. 液位控制详细流程

```mermaid
graph TD
    A[液位控制循环开始] --> B[获取当前时间]
    B --> C[遍历2个液位控制器]
    C --> D{控制器使能?}

    D -->|否| E[关闭阀门]
    E --> F[设置阀门状态为关闭]
    F --> G[继续下一个控制器]

    D -->|是| H[更新当前液位]
    H --> I{传感器故障?}

    I -->|是| J[维持当前阀门状态]
    J --> G

    I -->|否| K{检查最小动作间隔}
    K -->|时间未到| G
    K -->|时间已到| L[滞回控制逻辑]

    L --> M{当前阀门状态}

    M -->|关闭| N{液位<目标-滞回差?}
    M -->|开启| O{液位<目标+滞回差?}

    N -->|是| P[应该开启阀门]
    N -->|否| Q[保持关闭]

    O -->|是| R[继续开启阀门]
    O -->|否| S[应该关闭阀门]

    P --> T{阀门状态需要改变?}
    Q --> U[不改变阀门状态]
    R --> U
    S --> T

    T -->|是| V[更新阀门状态]
    T -->|否| U

    V --> W[执行阀门动作]
    W --> X[记录动作时间]

    X --> G
    U --> G
    G --> Y{所有控制器处理完?}
    Y -->|否| D
    Y -->|是| Z[液位控制循环结束]
```

## 5. PID算法计算流程

```mermaid
graph TD
    A[PID计算开始] --> B{PID控制器有效?}
    B -->|否| C[返回0输出]

    B -->|是| D{控制器初始化?}
    D -->|否| C

    D -->|是| E{控制器使能?}
    E -->|否| C

    E -->|是| F[计算当前误差]
    F --> G[计算比例项]
    G --> H[更新积分项]
    H --> I[积分限幅处理]
    I --> J[计算积分项]
    J --> K[计算微分项]
    K --> L[计算总输出]
    L --> M[输出限幅处理]
    M --> N{输出超上限?}

    N -->|是| O[输出设为上限]
    O --> P[反积分饱和处理]
    P --> Q[更新历史值]

    N -->|否| R{输出超下限?}
    R -->|是| S[输出设为下限]
    S --> T[反积分饱和处理]

    R -->|否| U[输出在正常范围]
    U --> Q
    T --> Q

    Q --> V[更新统计信息]
    V --> W[返回控制输出]
```

## 6. 控制任务时序图

```mermaid
sequenceDiagram
    participant CTRL as 控制任务
    participant SENSOR as 传感器任务
    participant SAFETY as 安全任务
    participant PID as PID控制器
    participant ACTUATOR as 执行器任务

    Note over CTRL: 控制周期20ms开始

    CTRL->>SAFETY: 获取系统安全状态
    SAFETY-->>CTRL: 返回安全状态

    alt 系统安全
        CTRL->>SENSOR: 获取传感器数据
        SENSOR-->>CTRL: 返回传感器数据

        CTRL->>CTRL: 检查控制使能状态

        alt 控制使能
            loop 温度控制器1-3
                CTRL->>PID: 温度PID计算
                PID-->>CTRL: 返回加热器功率
                CTRL->>ACTUATOR: 设置加热器功率
            end

            loop 压力控制器1-2
                CTRL->>PID: 压力PID计算
                PID-->>CTRL: 返回泵速度
                CTRL->>ACTUATOR: 设置泵速度
            end

            loop 液位控制器1-2
                CTRL->>CTRL: 滞回控制计算
                CTRL->>ACTUATOR: 设置阀门状态
            end

            CTRL->>CTRL: 更新控制统计
            CTRL->>CTRL: 计算系统效率(每1秒)
            CTRL->>CTRL: 自适应参数调整(每5秒)
        else 控制禁用
            CTRL->>ACTUATOR: 关闭所有输出
        end
    else 系统不安全
        CTRL->>ACTUATOR: 紧急关闭所有输出
    end

    Note over CTRL: 等待下一个控制周期
```

## 7. 关键控制参数

### 7.1 温度控制参数
```c
// 温度控制PID参数
const control_config_t temp_control_config = {
    .temperature_control = {
        .pid_params = {
            {.kp = 2.0f, .ki = 0.1f, .kd = 0.05f},  // 控制器1
            {.kp = 2.0f, .ki = 0.1f, .kd = 0.05f},  // 控制器2
            {.kp = 1.8f, .ki = 0.08f, .kd = 0.04f}  // 控制器3
        },
        .target_temps = {60.0f, 65.0f, 70.0f},       // 目标温度
        .max_powers = {100.0f, 100.0f, 80.0f},       // 最大功率
        .temp_tolerance = 2.0f,                      // 温度容差
        .overshoot_limit = 5.0f                      // 超调限制
    }
};
```

### 7.2 压力控制参数
```c
// 压力控制PID参数
const control_config_t pressure_control_config = {
    .pressure_control = {
        .pid_params = {
            {.kp = 1.5f, .ki = 0.05f, .kd = 0.02f}, // 控制器1
            {.kp = 1.5f, .ki = 0.05f, .kd = 0.02f}  // 控制器2
        },
        .target_pressures = {50.0f, 45.0f},          // 目标压力
        .max_speeds = {4500, 4000},                  // 最大泵速
        .pressure_tolerance = 5.0f,                  // 压力容差
        .min_pump_speed = 500                        // 最小泵速
    }
};
```

### 7.3 液位控制参数
```c
// 液位控制参数
const control_config_t level_control_config = {
    .level_control = {
        .target_levels = {80.0f, 75.0f},            // 目标液位
        .hysteresis = {5.0f, 5.0f},                 // 滞回差
        .min_action_interval = 2000                  // 最小动作间隔
    }
};
```

### 7.4 控制性能指标
```c
// 控制性能要求
#define TEMP_CONTROL_ACCURACY   1.0f    // 温度控制精度±1°C
#define PRESSURE_CONTROL_ACCURACY 2.0f  // 压力控制精度±2kPa
#define LEVEL_CONTROL_ACCURACY  1.0f    // 液位控制精度±1mm
#define CONTROL_SETTLING_TIME   10000   // 控制稳定时间10s
#define MAX_OVERSHOOT_PERCENT   5.0f    // 最大超调量5%
#define STEADY_STATE_ERROR      1.0f    // 稳态误差限制
```

---
**文档版本**: V4.0
**创建日期**: 2024-12-27
**维护者**: 供墨系统控制团队