# 供墨系统控制板卡程序运行思维导图

基于《供墨系统控制板卡综合技术设计文档》的程序运行流程和架构关系图

## 🧠 思维导图 (Mermaid格式)

```mermaid
graph TB
    %% 系统启动流程
    A[系统上电] --> B[系统初始化]
    B --> C[硬件初始化]
    C --> D[任务调度器启动]

    %% 四层架构
    subgraph "01_BSP层 - 硬件驱动"
        E[GD32F427初始化]
        F[时钟配置200MHz]
        G[GPIO/ADC/PWM/UART配置]
        H[外部芯片初始化]
        H1[YT8512C以太网PHY]
        H2[GDSCN832R2U6 EtherCAT]
        H3[CH12832B-12 LCD显示]
    end

    subgraph "02_HAL层 - 硬件抽象"
        I[传感器HAL接口]
        J[执行器HAL接口]
        K[通信HAL接口]
        L[HMI HAL接口]
        I1[液位传感器FRD-8061]
        I2[压力传感器HP10MY]
        I3[温度传感器FTT518 PT100]
        J1[加热器控制AC220V]
        J2[泵控制DC24V]
        J3[电磁阀控制]
    end

    subgraph "03_中间件层 - 核心服务"
        M[RTOS任务调度]
        N[EtherCAT协议栈]
        O[TCP/IP协议栈]
        P[PID控制算法]
        Q[数字滤波算法]
        R[安全监控]
        S[故障检测]
        T[配置管理]
    end

    subgraph "04_应用层 - 业务逻辑"
        U[供墨控制应用]
        V[传感器管理应用]
        W[执行器管理应用]
        X[通信管理应用]
        Y[HMI管理应用]
        Z[系统诊断应用]
    end

    %% 实时任务调度 (按优先级)
    subgraph "🚨 实时任务调度系统"
        T0[优先级0: 紧急处理任务 - 立即响应]
        T1[优先级1: EtherCAT通信 - 1ms严格实时 ⭐]
        T2[优先级2: 安全监控 - 10ms周期]
        T3[优先级3: 看门狗 - 100ms周期]
        T4[优先级4: 控制算法 - 10ms周期]
        T5[优先级5: ADC采集 - 5ms周期]
        T6[优先级6-14: 其他任务]
    end

    %% 数据流向
    subgraph "📊 数据处理流程"
        DATA1[ADC原始数据]
        DATA2[4-20mA电流信号]
        DATA3[PT100电阻值]
        DATA4[数字滤波处理]
        DATA5[校准和转换]
        DATA6[工程量值]
        DATA7[PID控制计算]
        DATA8[执行器输出]
    end

    %% LED指示系统
    subgraph "💡 LED指示系统 (5路状态)"
        LED1[红色: 电源指示]
        LED2[绿色: 网络状态]
        LED3[黄色: 系统运行]
        LED4[蓝色: 通信状态]
        LED5[白色: 故障报警]
    end

    %% 通信网络
    subgraph "🌐 网络通信架构"
        NET1[单工位系统: TCP/IP直连]
        NET2[小型系统: 多控制板TCP/IP组网]
        NET3[大型系统: EtherCAT+Modbus混合组网]
    end

    %% 安全保护系统
    subgraph "🛡️ 多级安全保护"
        SAFE1[硬件级保护]
        SAFE2[软件级保护]
        SAFE3[紧急停机]
        SAFE1A[过压/过流/过温硬件断路]
        SAFE2A[软件监控和状态机]
        SAFE3A[立即切断所有输出]
    end

    %% 主要连接关系
    A --> E
    E --> F
    F --> G
    G --> H
    H --> H1 & H2 & H3

    E & F & G & H --> I & J & K & L
    I --> I1 & I2 & I3
    J --> J1 & J2 & J3

    I & J & K & L --> M & N & O & P & Q & R & S & T
    M --> T0 & T1 & T2 & T3 & T4 & T5 & T6

    M & N & O & P & Q & R & S & T --> U & V & W & X & Y & Z

    %% 数据流连接
    I1 & I2 & I3 --> DATA1
    DATA1 --> DATA2 & DATA3
    DATA2 & DATA3 --> DATA4
    DATA4 --> DATA5
    DATA5 --> DATA6
    DATA6 --> DATA7
    DATA7 --> DATA8
    DATA8 --> J1 & J2 & J3

    %% LED和网络连接
    Y --> LED1 & LED2 & LED3 & LED4 & LED5
    X --> NET1 & NET2 & NET3

    %% 安全系统连接
    R & S --> SAFE1 & SAFE2 & SAFE3
    SAFE1 --> SAFE1A
    SAFE2 --> SAFE2A
    SAFE3 --> SAFE3A

    %% 样式定义
    classDef bspLayer fill:#ffcccc
    classDef halLayer fill:#ccffcc
    classDef middlewareLayer fill:#ccccff
    classDef applicationLayer fill:#ffffcc
    classDef criticalTask fill:#ff6666
    classDef safetySystem fill:#ff9999
    classDef communication fill:#99ccff

    class E,F,G,H,H1,H2,H3 bspLayer
    class I,J,K,L,I1,I2,I3,J1,J2,J3 halLayer
    class M,N,O,P,Q,R,S,T middlewareLayer
    class U,V,W,X,Y,Z applicationLayer
    class T0,T1,T2,T3,T4,T5 criticalTask
    class SAFE1,SAFE2,SAFE3,SAFE1A,SAFE2A,SAFE3A safetySystem
    class NET1,NET2,NET3,N,O communication
```

## 🔄 核心运行循环

```mermaid
flowchart LR
    subgraph "主运行循环 (1ms基础周期)"
        A1[系统定时器中断] --> A2[任务调度器]
        A2 --> A3[检查任务就绪队列]
        A3 --> A4[按优先级执行任务]
        A4 --> A5[更新任务状态]
        A5 --> A1
    end

    subgraph "EtherCAT实时循环 (1ms严格)"
        B1[EtherCAT定时器中断] --> B2[禁用全局中断]
        B2 --> B3[读取输入数据]
        B3 --> B4[处理控制逻辑]
        B4 --> B5[更新输出数据]
        B5 --> B6[发送EtherCAT帧]
        B6 --> B7[恢复全局中断]
        B7 --> B1
    end

    subgraph "传感器数据采集循环 (5ms)"
        C1[ADC采集定时器] --> C2[多通道ADC采样]
        C2 --> C3[数字滤波处理]
        C3 --> C4[校准和单位转换]
        C4 --> C5[更新传感器数据]
        C5 --> C1
    end

    subgraph "控制算法循环 (10ms)"
        D1[控制任务调度] --> D2[读取传感器数据]
        D2 --> D3[PID计算]
        D3 --> D4[输出限制]
        D4 --> D5[更新执行器输出]
        D5 --> D1
    end
```

### 🔄 泵速控制流程 (MPB025BBB调速泵)
```mermaid
sequenceDiagram
    participant User as 上位机/用户
    participant App as 应用层
    participant Mid as 中间件层
    participant HAL as HAL层
    participant BSP as BSP层
    participant HW as 硬件设备

    Note over User,HW: MPB025BBB调速泵控制流程

    User->>App: 设置泵转速3000RPM
    App->>Mid: 调用泵控制中间件

    loop 每50ms泵速调节
        Mid->>Mid: 转速限制检查(200-5000RPM)
        Mid->>Mid: 转速到控制电压转换
        Note over Mid: V=0.2+(RPM-200)*4.8/4800

        Mid->>HAL: 调用DAC输出HAL
        HAL->>BSP: 12bit DAC输出(0.2-5V)
        BSP->>HW: DAC_VALUE=(V*4095)/5.0
        HW->>HW: MPB025BBB调速泵响应(<500ms)

        Mid->>HAL: 读取泵运行状态
        HAL->>BSP: 读取电流检测ADC
        BSP->>HW: 电流传感器检测
        HW-->>BSP: 返回泵电流值
        BSP-->>HAL: 返回电流数字量
        HAL-->>Mid: 返回泵负载电流

        alt 泵过载保护
            Mid->>Mid: 电流超过1.5A
            Mid->>HAL: 泵紧急停止
            HAL->>BSP: DAC输出0V
            BSP->>HW: 泵停止运行
            Mid->>Mid: 触发FAULT_PUMP_OVERCURRENT
        else 泵堵转检测
            Mid->>Mid: 转速为0但有控制电压
            Mid->>HAL: 泵停止并报警
            Mid->>Mid: 触发FAULT_PUMP_STALL
        end
    end
```

### 🔌 电磁阀控制流程 (DC24V电磁阀)
```mermaid
sequenceDiagram
    participant User as 上位机/用户
    participant App as 应用层
    participant Mid as 中间件层
    participant HAL as HAL层
    participant BSP as BSP层
    participant HW as 硬件设备

    Note over User,HW: DC24V电磁阀控制流程(0.3A)

    User->>App: 电磁阀开启指令
    App->>Mid: 调用电磁阀控制中间件

    Mid->>Mid: 电磁阀互锁检查
    Note over Mid: 防止供墨和回收同时开启

    alt 开启电磁阀
        Mid->>HAL: 调用电磁阀开启HAL
        HAL->>BSP: 数字输出高电平
        BSP->>HW: GPIO输出24V(通过继电器)
        HW->>HW: 电磁阀开启(响应时间<10ms)

        Mid->>HAL: 读取电磁阀状态反馈
        HAL->>BSP: 读取状态检测GPIO
        BSP->>HW: 检测电磁阀位置反馈
        HW-->>BSP: 返回开启确认信号
        BSP-->>HAL: 返回状态数字量
        HAL-->>Mid: 返回电磁阀实际状态

        alt 开启确认超时(>100ms)
            Mid->>Mid: 触发FAULT_VALVE_TIMEOUT
            Mid->>App: 电磁阀故障事件
        end
    else 关闭电磁阀
        Mid->>HAL: 调用电磁阀关闭HAL
        HAL->>BSP: 数字输出低电平
        BSP->>HW: GPIO输出0V
        HW->>HW: 电磁阀关闭(弹簧复位)

        Mid->>HAL: 读取关闭状态确认
        HAL->>BSP: 读取位置反馈
        BSP->>HW: 检测关闭位置信号
        HW-->>BSP: 返回关闭确认信号
        BSP-->>HAL: 返回状态
        HAL-->>Mid: 确认电磁阀已关闭
    end

    loop 每200ms状态监控
        Mid->>HAL: 读取电磁阀电流
        HAL->>BSP: 电流检测ADC
        BSP->>HW: 0.3A额定电流监控
        HW-->>BSP: 返回实际电流值
        BSP-->>HAL: 返回电流数字量
        HAL-->>Mid: 返回电磁阀负载电流

        alt 电流异常检测
            Mid->>Mid: 电流超过0.5A或为0
            Mid->>Mid: 触发FAULT_VALVE_CURRENT
            Mid->>App: 电磁阀电流故障
        end
    end
```

### 📡 TCP/IP网络通信流程
```mermaid
sequenceDiagram
    participant Client as 上位机客户端
    participant App as 网络应用层
    participant Mid as TCP/IP中间件
    participant HAL as 以太网HAL
    participant BSP as YT8512C驱动
    participant HW as YT8512C PHY芯片

    Note over Client,HW: TCP/IP网络通信完整流程

    Client->>HW: 网络连接请求
    HW->>BSP: 以太网帧接收
    BSP->>HAL: 链路层数据处理
    HAL->>Mid: IP数据包解析

    Mid->>Mid: TCP连接建立(三次握手)
    Mid->>App: 新客户端连接事件
    App->>App: 客户端认证和授权

    loop TCP通信循环
        Client->>HW: 发送Modbus TCP请求
        HW->>BSP: 物理层信号接收
        BSP->>HAL: MAC帧解析
        HAL->>Mid: IP包处理
        Mid->>Mid: TCP段重组
        Mid->>App: Modbus TCP数据包

        App->>App: 解析Modbus功能码
        alt 读保持寄存器(0x03)
            App->>App: 读取传感器数据
            App->>Mid: 构造响应数据包
        else 写单个寄存器(0x06)
            App->>App: 写入控制参数
            App->>Mid: 构造确认响应
        else 写多个寄存器(0x10)
            App->>App: 批量写入配置
            App->>Mid: 构造批量确认
        else 读输入寄存器(0x04)
            App->>App: 读取状态信息
            App->>Mid: 构造状态响应
        end

        Mid->>Mid: TCP数据包封装
        Mid->>HAL: IP数据包发送
        HAL->>BSP: 以太网帧发送
        BSP->>HW: 物理层信号发送
        HW-->>Client: 返回Modbus TCP响应

        Note over Mid: 网络性能监控
        Mid->>Mid: 统计吞吐量和延迟
        Mid->>Mid: 检测数据包丢失
        Mid->>Mid: 监控连接状态
    end

    alt 网络异常处理
        Mid->>Mid: 检测到网络断开
        Mid->>App: 网络断开事件
        App->>App: 清理客户端连接
        App->>Mid: 激活网络重连机制

        loop 网络重连尝试
            Mid->>HAL: 重新初始化网络接口
            HAL->>BSP: 重置PHY芯片
            BSP->>HW: 硬件复位和重新配置
            HW->>HW: 自协商网络参数

            alt 网络恢复成功
                HW-->>Mid: 链路建立成功
                Mid->>App: 网络恢复事件
            else 重连失败
                Mid->>Mid: 等待5秒后重试
            end
        end
    end
```

### 📝 日志记录系统流程
```mermaid
sequenceDiagram
    participant System as 系统各模块
    participant App as 日志应用层
    participant Mid as 日志中间件
    participant HAL as 存储HAL
    participant BSP as Flash驱动
    participant HW as Flash存储

    Note over System,HW: 系统日志记录完整流程

    loop 系统运行过程中
        System->>App: 各种系统事件

        App->>App: 判断日志级别和过滤
        alt DEBUG级别日志
            App->>Mid: LOG_DEBUG("ADC value: %d", adc_val)
        else INFO级别日志
            App->>Mid: LOG_INFO("System started successfully")
        else WARNING级别日志
            App->>Mid: LOG_WARN("Temperature high: %.1f°C", temp)
        else ERROR级别日志
            App->>Mid: LOG_ERROR("Sensor communication failed")
        else FATAL级别日志
            App->>Mid: LOG_FATAL("Emergency shutdown activated")
        end

        Mid->>Mid: 构造日志条目
        Note over Mid: timestamp+level+module+message
        Mid->>Mid: 写入环形缓冲区

        alt 缓冲区未满
            Mid->>Mid: 更新写指针
        else 缓冲区已满
            Mid->>Mid: 覆盖最老的日志条目
            Mid->>Mid: 设置溢出标志
        end
    end

    loop 每5秒批量写入Flash
        Mid->>Mid: 检查缓冲区是否有新日志
        alt 有新日志需要持久化
            Mid->>HAL: 调用Flash存储HAL
            HAL->>BSP: Flash擦除日志扇区
            BSP->>HW: 硬件擦除操作
            HW-->>BSP: 擦除完成

            Mid->>Mid: 批量读取日志条目(最多100条)
            Mid->>HAL: 写入Flash日志区域
            HAL->>BSP: Flash批量写入
            BSP->>HW: 硬件写入操作
            HW-->>BSP: 写入完成

            Mid->>Mid: 更新Flash日志索引
            Mid->>Mid: 清空已写入的缓冲区条目
        end
    end

    alt 日志查询请求
        App->>Mid: 查询最近1000条日志
        Mid->>HAL: 从Flash读取日志
        HAL->>BSP: Flash批量读取
        BSP->>HW: 硬件读取操作
        HW-->>BSP: 返回日志数据
        BSP-->>HAL: 返回日志条目数组
        HAL-->>Mid: 返回格式化日志

        Mid->>Mid: 日志条目解析和过滤
        Mid->>App: 返回查询结果
        App->>System: 发送日志查询响应
    end

    alt 日志维护任务
        Mid->>Mid: 检查Flash存储空间
        alt 存储空间不足(<10%)
            Mid->>Mid: 删除最旧的日志文件
            Mid->>HAL: 擦除旧日志扇区
            HAL->>BSP: Flash批量擦除
            BSP->>HW: 释放存储空间
        end

        Mid->>Mid: 日志完整性检查
        Mid->>HAL: 验证Flash日志CRC
        alt CRC校验失败
            Mid->>Mid: 标记损坏的日志条目
            Mid->>App: 发送日志损坏警告
        end
    end
```

## 🎯 关键执行路径 - 完整传感器控制流程

### 🌡️ 温度控制流程 (PT100传感器)
```mermaid
sequenceDiagram
    participant User as 上位机/用户
    participant App as 应用层
    participant Mid as 中间件层
    participant HAL as HAL层
    participant BSP as BSP层
    participant HW as 硬件设备

    Note over User,HW: FTT518 PT100温度控制执行流程

    User->>App: 设置目标温度40°C
    App->>Mid: 调用温度控制中间件

    loop 每10ms控制周期
        Mid->>HAL: 调用PT100温度HAL
        HAL->>BSP: ADC读取PT100电阻值
        BSP->>HW: 操作ADC寄存器(恒流激励1mA)
        HW-->>BSP: 返回电阻对应的ADC值
        BSP-->>HAL: 返回数字量
        HAL->>HAL: 三线制补偿计算
        HAL->>HAL: 电阻-温度转换(Callendar-Van Dusen方程)
        HAL-->>Mid: 返回温度值(°C)

        Mid->>Mid: 自适应PID算法计算
        Note over Mid: Kp/Ki/Kd参数自动调整
        Mid->>Mid: 积分分离处理
        Mid->>Mid: 微分低通滤波
        Mid->>Mid: 输出限幅(0-100%)

        Mid->>HAL: 调用加热器控制HAL
        HAL->>BSP: PWM驱动设置占空比
        BSP->>HW: 控制固态继电器MRA-23D3
        HW->>HW: AC220V加热器功率调节(100W/150W)
    end
```

### 📏 液位控制流程 (FRD-8061传感器)
```mermaid
sequenceDiagram
    participant User as 上位机/用户
    participant App as 应用层
    participant Mid as 中间件层
    participant HAL as HAL层
    participant BSP as BSP层
    participant HW as 硬件设备

    Note over User,HW: FRD-8061液位传感器控制流程

    User->>App: 设置目标液位80%
    App->>Mid: 调用液位控制中间件

    loop 每100ms监控周期
        Mid->>HAL: 调用液位传感器HAL
        HAL->>BSP: ADC读取4-20mA电流信号
        BSP->>HW: 通过250Ω精密电阻转电压(1-5V)
        HW-->>BSP: 返回电压对应ADC值
        BSP-->>HAL: 返回15bit数字量
        HAL->>HAL: 电流值计算 I=(V/250Ω)*1000
        HAL->>HAL: 液位转换 Level=(I-4mA)*2000mm/16mA
        HAL->>HAL: 故障检测 I<3.5mA或I>20.5mA
        HAL-->>Mid: 返回液位值(mm)或故障码

        Mid->>Mid: 液位控制逻辑判断
        alt 液位过低
            Mid->>HAL: 启动供墨泵
            HAL->>BSP: 数字输出控制
            BSP->>HW: DC24V泵控制(12W)
        else 液位过高
            Mid->>HAL: 关闭供墨泵
            Mid->>HAL: 开启回收电磁阀
            HAL->>BSP: 电磁阀控制输出
            BSP->>HW: DC24V电磁阀(0.3A)
        end
    end
```

### 🔧 压力控制流程 (HP10MY传感器)
```mermaid
sequenceDiagram
    participant User as 上位机/用户
    participant App as 应用层
    participant Mid as 中间件层
    participant HAL as HAL层
    participant BSP as BSP层
    participant HW as 硬件设备

    Note over User,HW: HP10MY压力传感器控制流程

    User->>App: 设置目标压力500kPa
    App->>Mid: 调用压力控制中间件

    loop 每10ms快速响应
        Mid->>HAL: 调用压力传感器HAL(2路)
        HAL->>BSP: ADC采集4-20mA信号
        BSP->>HW: 250Ω电阻转换+15bit ADC
        HW-->>BSP: 返回压力对应ADC值
        BSP-->>HAL: 返回数字量
        HAL->>HAL: 线性转换 P=-100+(I-4)*100100/16 kPa
        HAL->>HAL: 一阶低通滤波 α=0.9
        HAL->>HAL: 校准处理(偏移+缩放)
        HAL-->>Mid: 返回校准后压力值

        Mid->>Mid: 双路压力PID控制
        Note over Mid: 供墨压力+回墨压力独立控制

        alt 压力过低
            Mid->>HAL: 增加泵速控制
            HAL->>BSP: DAC输出调速电压(0.2-5V)
            BSP->>HW: MPB025BBB调速泵(200-5000RPM)
        else 压力过高
            Mid->>HAL: 减少泵速或开启泄压阀
            HAL->>BSP: 调节DAC输出
            BSP->>HW: 泵速降低+电磁阀泄压
        end

        alt 压力异常(>110MPa或<-110kPa)
            Mid->>Mid: 触发紧急停机
            Mid->>HAL: 立即停止所有泵
            Mid->>HAL: 关闭所有电磁阀
            HAL->>BSP: 紧急输出控制
            BSP->>HW: 系统保护动作
        end
    end
```

### 🌐 EtherCAT实时通信流程
```mermaid
sequenceDiagram
    participant Master as EtherCAT主站
    participant App as 应用层
    participant Mid as 中间件层
    participant HAL as HAL层
    participant BSP as BSP层
    participant HW as GDSCN832R2U6芯片

    Note over Master,HW: EtherCAT 1ms严格实时通信流程

    loop 每1ms严格周期
        Master->>HW: EtherCAT数据帧(输出数据)
        HW->>BSP: 硬件DMA传输
        BSP->>HAL: 解析过程数据映射
        HAL->>Mid: 更新输出数据

        Note over Mid: 基于第17页IO地址映射
        Mid->>Mid: 解析数字输出Q0.0-Q0.7
        Mid->>Mid: 解析模拟输出QW1-QW4
        Mid->>App: 更新执行器控制命令

        App->>App: 执行控制逻辑
        App->>Mid: 传感器数据采集
        Mid->>HAL: 读取所有传感器数据

        Note over HAL: 并行采集优化
        par 液位传感器数据
            HAL->>BSP: 读取I0.0-I0.4数字输入
            HAL->>BSP: 读取IW1-IW3模拟输入
        and 温度传感器数据
            HAL->>BSP: 读取T10-T11温度输入
        and 压力传感器数据
            HAL->>BSP: 读取压力ADC通道
        end

        BSP-->>HAL: 返回原始数据
        HAL->>HAL: 数据校准和转换
        HAL-->>Mid: 返回工程量数据
        Mid->>Mid: 更新EtherCAT输入映射

        Mid->>HAL: 构造输入数据帧
        HAL->>BSP: DMA准备发送数据
        BSP->>HW: 硬件自动发送
        HW-->>Master: EtherCAT数据帧(输入数据)

        Note over Master,HW: 分布式时钟同步(<1μs误差)
        Master->>HW: 时钟同步信号
        HW->>HW: 本地时钟校准
    end
```

### 💡 LED指示状态管理流程
```mermaid
sequenceDiagram
    participant System as 系统各模块
    participant App as HMI应用层
    participant Mid as LED中间件
    participant HAL as LED HAL
    participant BSP as GPIO驱动
    participant HW as LED硬件

    Note over System,HW: 5路LED状态指示管理流程

    loop 每100ms状态更新
        System->>App: 系统状态变化事件

        App->>App: 状态映射判断
        Note over App: 基于第20页LED标识

        alt 电源状态变化
            App->>Mid: 更新2PN1*2D*1红色LED
            Note over Mid: 硬件直连24V电源
        else 网络状态变化
            App->>Mid: 更新2PN1*2D*2绿色LED
            alt 网络已连接
                Mid->>Mid: 设置LED_STATE_ON
            else 网络连接中
                Mid->>Mid: 设置LED_STATE_BLINK_SLOW(1Hz)
            else 网络断开
                Mid->>Mid: 设置LED_STATE_OFF
            else 网络错误
                Mid->>Mid: 设置LED_STATE_BLINK_FAST(2Hz)
            end
        else 系统运行状态
            App->>Mid: 更新2PN1*2D*3黄色LED
            alt 系统正常
                Mid->>Mid: 设置慢闪心跳
            else 系统繁忙
                Mid->>Mid: 设置快闪指示
            else 系统错误
                Mid->>Mid: 设置LED_STATE_OFF
            end
        else 通信状态变化
            App->>Mid: 更新2PN1*2D*4蓝色LED
            alt EtherCAT通信活跃
                Mid->>Mid: 设置LED_STATE_ON
            else TCP通信活跃
                Mid->>Mid: 设置慢闪
            else 通信错误
                Mid->>Mid: 设置超快闪(5Hz)
            end
        else 故障状态变化
            App->>Mid: 更新2PN1*2D*5白色LED
            alt 无故障
                Mid->>Mid: 设置LED_STATE_OFF
            else 警告级故障
                Mid->>Mid: 设置慢闪
            else 一般故障
                Mid->>Mid: 设置快闪
            else 严重故障
                Mid->>Mid: 设置LED_STATE_ON常亮
            end
        end

        Mid->>Mid: LED状态机处理
        Mid->>HAL: 调用GPIO控制接口
        HAL->>BSP: GPIO输出控制
        BSP->>HW: 点亮/熄灭LED

        Note over Mid: 支持PWM调光和呼吸灯效果
    end
```

### 🖥️ HMI显示系统流程
```mermaid
sequenceDiagram
    participant User as 用户操作
    participant App as HMI应用层
    participant Mid as 显示中间件
    participant HAL as 显示HAL
    participant BSP as SPI驱动
    participant HW as CH12832B-12 LCD

    Note over User,HW: 128×32点阵LCD显示系统流程

    User->>App: 按键操作(如果有)
    App->>App: 页面切换逻辑

    loop 每200ms显示更新
        App->>App: 确定当前显示页面

        alt 主页面显示
            App->>App: 构造主页内容
            Note over App: "UV Ink Service V1.0"
            App->>Mid: 温度压力液位状态
            App->>Mid: 系统网络状态字符串
        else 传感器数据页面
            App->>App: 构造传感器页面
            Note over App: 3路温度+2路压力+2路液位
            App->>Mid: "T1:40.5 T2:38.2 T3:41.0"
            App->>Mid: "P1:500.2 P2:480.5 kPa"
            App->>Mid: "L1:85.2% L2:78.5%"
        else 执行器状态页面
            App->>App: 构造执行器页面
            App->>Mid: 加热器开关状态
            App->>Mid: 泵运行状态和转速
            App->>Mid: 电磁阀开关状态
        else 网络信息页面
            App->>App: 构造网络页面
            App->>Mid: IP地址和连接状态
            App->>Mid: EtherCAT从站ID和状态
            App->>Mid: 通信速率和错误计数
        else 故障信息页面
            App->>App: 构造故障页面
            App->>Mid: 当前活跃故障列表
            App->>Mid: 故障代码和描述
            App->>Mid: 故障发生时间
        else 配置参数页面
            App->>App: 构造配置页面
            App->>Mid: PID参数显示
            App->>Mid: 目标值和报警阈值
            App->>Mid: 系统配置参数
        end

        Mid->>Mid: 页面内容格式化
        Mid->>Mid: 字符编码转换
        Mid->>HAL: 调用LCD显示接口
        HAL->>BSP: SPI数据传输
        BSP->>HW: 发送显示数据
        HW->>HW: 更新LCD显示内容

        Note over HW: 128×32=4096像素点阵显示
    end
```

### ⚠️ 故障检测与安全保护流程
```mermaid
sequenceDiagram
    participant Sensors as 传感器系统
    participant App as 安全应用层
    participant Mid as 安全中间件
    participant HAL as 安全HAL
    participant BSP as 紧急控制BSP
    participant HW as 执行器硬件

    Note over Sensors,HW: 多级安全保护完整流程

    loop 每10ms安全监控
        Sensors->>App: 传感器数据更新
        App->>Mid: 调用安全监控中间件

        Mid->>Mid: 温度安全检查
        alt 温度超过650°C
            Mid->>Mid: 触发FAULT_TEMP_OVERHEAT
            Mid->>App: 严重故障事件
            App->>App: 进入紧急状态
        else 温度超过580°C
            Mid->>Mid: 触发WARNING_TEMP_HIGH
            Mid->>App: 警告事件
        end

        Mid->>Mid: 压力安全检查
        alt 压力超过110MPa
            Mid->>Mid: 触发FAULT_PRESSURE_OVERPRESSURE
            Mid->>App: 严重故障事件
            App->>App: 进入紧急状态
        else 压力超过95MPa
            Mid->>Mid: 触发WARNING_PRESSURE_HIGH
            Mid->>App: 警告事件
        end

        Mid->>Mid: 电源安全检查
        alt 24V电源<21.6V或>26.4V
            Mid->>Mid: 触发FAULT_POWER_ABNORMAL
            Mid->>App: 严重故障事件
            App->>App: 进入紧急状态
        end

        Mid->>Mid: 通信安全检查
        alt EtherCAT断开>5s
            Mid->>Mid: 触发WARNING_COMM_TIMEOUT
            Mid->>App: 通信警告事件
        end
    end

    alt 紧急状态处理
        App->>App: 执行紧急停机程序
        Note over App: execute_emergency_shutdown()

        par 立即关闭所有加热器
            App->>HAL: 加热器紧急关闭
            HAL->>BSP: 继电器断开
            BSP->>HW: AC220V加热器断电
        and 立即停止所有泵
            App->>HAL: 泵紧急停止
            HAL->>BSP: PWM输出0%
            BSP->>HW: 泵停止运行
        and 关闭所有电磁阀
            App->>HAL: 电磁阀紧急关闭
            HAL->>BSP: 数字输出低电平
            BSP->>HW: 电磁阀断电关闭
        end

        App->>HAL: 激活故障LED常亮
        App->>HAL: LCD显示紧急停机信息
        App->>Mid: 记录紧急停机日志
        Mid->>Mid: 发送故障通报到上位机

        Note over App: 等待手动复位才能恢复运行
    end
```

### 📊 系统配置管理流程
```mermaid
sequenceDiagram
    participant User as 用户/上位机
    participant App as 配置应用层
    participant Mid as 配置中间件
    participant HAL as Flash HAL
    participant BSP as Flash驱动
    participant HW as Flash存储器

    Note over User,HW: 系统配置完整管理流程

    User->>App: 修改PID参数请求
    App->>Mid: 调用配置管理中间件

    Mid->>Mid: 参数验证检查
    alt 参数验证通过
        Mid->>Mid: 更新内存中配置
        Mid->>Mid: 计算CRC32校验值
        Mid->>HAL: 调用Flash存储HAL
        HAL->>BSP: Flash擦除扇区
        BSP->>HW: 硬件擦除操作
        HW-->>BSP: 擦除完成
        HAL->>BSP: Flash写入新配置
        BSP->>HW: 硬件写入操作
        HW-->>BSP: 写入完成

        Mid->>Mid: 创建配置备份
        Mid->>HAL: 写入备份区域
        HAL->>BSP: 备份配置存储
        BSP->>HW: 备份写入操作

        Mid->>App: 配置保存成功
        App->>User: 返回成功响应
    else 参数验证失败
        Mid->>App: 参数错误信息
        App->>User: 返回错误响应
    end

    Note over User,HW: 系统启动时配置加载

    alt 系统上电初始化
        App->>Mid: 加载系统配置
        Mid->>HAL: 从Flash读取配置
        HAL->>BSP: Flash读取操作
        BSP->>HW: 硬件读取
        HW-->>BSP: 返回配置数据
        BSP-->>HAL: 返回配置结构
        HAL-->>Mid: 返回配置数据

        Mid->>Mid: 校验CRC32
        alt CRC校验通过
            Mid->>Mid: 配置数据有效
            Mid->>App: 应用配置参数
        else CRC校验失败
            Mid->>Mid: 尝试加载备份配置
            alt 备份配置有效
                Mid->>Mid: 使用备份配置
                Mid->>App: 应用备份配置
            else 备份配置也无效
                Mid->>Mid: 恢复出厂默认配置
                Mid->>App: 应用默认配置
                App->>User: 发送配置恢复通知
            end
        end
    end
```

### 🔄 系统启动完整流程
```mermaid
sequenceDiagram
    participant Power as 电源系统
    participant Boot as 启动程序
    participant BSP as BSP层
    participant HAL as HAL层
    participant Mid as 中间件层
    participant App as 应用层

    Note over Power,App: 系统完整启动流程

    Power->>Boot: 系统上电复位
    Boot->>Boot: 复位向量执行
    Boot->>BSP: 系统基础初始化

    BSP->>BSP: 时钟系统配置200MHz
    BSP->>BSP: 内存系统初始化
    BSP->>BSP: 中断向量表配置
    BSP->>BSP: 看门狗初始化

    par BSP层硬件初始化
        BSP->>BSP: GPIO端口配置
        BSP->>BSP: ADC模块初始化
        BSP->>BSP: DAC模块初始化
        BSP->>BSP: PWM定时器配置
        BSP->>BSP: UART通信配置
        BSP->>BSP: SPI接口配置
        BSP->>BSP: I2C接口配置
    and 外部芯片初始化
        BSP->>BSP: YT8512C以太网PHY初始化
        BSP->>BSP: GDSCN832R2U6 EtherCAT初始化
        BSP->>BSP: CH12832B-12 LCD初始化
    end

    BSP->>HAL: BSP初始化完成

    par HAL层接口初始化
        HAL->>HAL: 传感器HAL接口初始化
        HAL->>HAL: 执行器HAL接口初始化
        HAL->>HAL: 通信HAL接口初始化
        HAL->>HAL: HMI HAL接口初始化
        HAL->>HAL: 系统HAL接口初始化
    end

    HAL->>Mid: HAL初始化完成

    par 中间件层初始化
        Mid->>Mid: RTOS任务调度器初始化
        Mid->>Mid: EtherCAT协议栈初始化
        Mid->>Mid: TCP/IP协议栈初始化
        Mid->>Mid: PID控制器初始化
        Mid->>Mid: 数字滤波器初始化
        Mid->>Mid: 安全监控初始化
        Mid->>Mid: 配置管理初始化
    end

    Mid->>App: 中间件初始化完成

    par 应用层初始化
        App->>App: 传感器应用初始化
        App->>App: 执行器应用初始化
        App->>App: 控制应用初始化
        App->>App: 通信应用初始化
        App->>App: HMI应用初始化
        App->>App: 系统应用初始化
    end

    App->>Mid: 创建系统任务
    Note over Mid: 按优先级创建任务队列

    par 任务创建
        Mid->>Mid: 创建EtherCAT任务(优先级1)
        Mid->>Mid: 创建安全监控任务(优先级2)
        Mid->>Mid: 创建看门狗任务(优先级3)
        Mid->>Mid: 创建控制任务(优先级4)
        Mid->>Mid: 创建ADC采集任务(优先级5)
        Mid->>Mid: 创建其他任务(优先级6-14)
    end

    Mid->>Mid: 启动任务调度器
    Note over Mid: 系统进入运行态，开始任务调度

    loop 系统正常运行
        Mid->>App: 按优先级调度执行应用任务
        App->>Mid: 调用中间件服务
        Mid->>HAL: 调用硬件抽象接口
        HAL->>BSP: 调用底层驱动
        BSP->>BSP: 硬件操作执行
    end
```

## ⚙️ 系统状态机

```mermaid
stateDiagram-v2
    [*] --> SystemInit: 上电复位
    SystemInit --> SystemNormal: 初始化完成

    SystemNormal --> SystemWarning: 检测到警告
    SystemNormal --> SystemFault: 检测到故障
    SystemNormal --> SystemMaintenance: 手动维护模式

    SystemWarning --> SystemNormal: 警告消除
    SystemWarning --> SystemFault: 警告升级为故障

    SystemFault --> SystemEmergency: 严重故障
    SystemFault --> SystemNormal: 故障恢复

    SystemEmergency --> SystemNormal: 手动复位
    SystemMaintenance --> SystemNormal: 退出维护模式

    state SystemNormal {
        [*] --> Running
        Running --> ControlActive: 控制回路激活
        ControlActive --> Running: 控制周期完成

        state ControlActive {
            [*] --> SensorRead
            SensorRead --> PIDCalculate
            PIDCalculate --> ActuatorOutput
            ActuatorOutput --> [*]
        }
    }

    state SystemWarning {
        [*] --> MonitoringActive
        MonitoringActive --> LoggingWarning
        LoggingWarning --> LEDWarning
        LEDWarning --> [*]
    }

    state SystemEmergency {
        [*] --> ShutdownAll
        ShutdownAll --> SafeState
        SafeState --> WaitingReset
    }
```

## 📈 性能监控要点

```mermaid
mindmap
  root((性能监控))
    实时性监控
      EtherCAT周期时间
      任务执行时间
      中断响应时间
      系统抖动监测

    资源使用监控
      CPU使用率
      内存使用率
      栈使用深度
      任务切换频率

    硬件健康监控
      MCU温度
      供电电压
      Flash写入次数
      看门狗复位次数

    通信性能监控
      网络吞吐量
      数据包丢失率
      通信延迟
      协议错误率

    控制性能监控
      传感器数据质量
      控制精度
      系统稳定性
      响应速度
```

---

## 🎛️ 关键设计要点

### ⚡ **实时性保证**
- EtherCAT任务优先级1，1ms严格周期
- 硬件定时器触发，微秒级精度
- 关键代码段禁用中断保护

### 🏗️ **四层架构优势**
- 清晰的调用关系：应用层→中间件层→HAL层→BSP层
- 单向依赖，避免架构腐化
- 便于测试、维护和移植

### 🛡️ **安全设计**
- 多级安全保护机制
- 硬件+软件双重保护
- 故障快速检测和恢复

### 🌐 **通信架构**
- 支持三种组网模式
- EtherCAT实时总线优先级最高
- 灵活的协议栈中间件

### 📊 **数据处理流程**
- 15bit ADC高精度采集
- 多重数字滤波算法
- 自适应PID控制优化

这个思维导图展示了整个供墨系统控制板卡的程序运行架构和关键执行流程，为开发和维护提供了清晰的指导。

---

## 🔧 **完整系统功能覆盖**

### 📊 **传感器系统 (100%覆盖)**
- ✅ **温度控制**: FTT518 PT100传感器，三线制补偿，Callendar-Van Dusen转换
- ✅ **液位控制**: FRD-8061传感器，4-20mA信号，精密电阻转换
- ✅ **压力控制**: HP10MY传感器，双路压力，一阶低通滤波

### ⚙️ **执行器系统 (100%覆盖)**
- ✅ **加热器控制**: MRA-23D3固态继电器，AC220V功率调节
- ✅ **调速泵控制**: MPB025BBB变频泵，DAC电压控制(0.2-5V)
- ✅ **电磁阀控制**: DC24V电磁阀，位置反馈，互锁保护

### 🌐 **通信系统 (100%覆盖)**
- ✅ **EtherCAT实时通信**: GDSCN832R2U6芯片，1ms严格周期，分布式时钟
- ✅ **TCP/IP网络**: YT8512C PHY芯片，Modbus TCP协议，网络重连
- ✅ **串行通信**: RS485/RS232接口，协议处理

### 💡 **人机界面系统 (100%覆盖)**
- ✅ **LED指示**: 5路状态LED，多种闪烁模式，PWM调光
- ✅ **LCD显示**: CH12832B-12点阵屏，6种显示页面，200ms更新
- ✅ **用户交互**: 按键处理，页面切换，参数设置

### 🛡️ **安全保护系统 (100%覆盖)**
- ✅ **故障检测**: 多级安全监控，10ms检查周期，故障分类
- ✅ **紧急保护**: 立即断电，并行执行，手动复位
- ✅ **系统监控**: 看门狗，任务超时，性能统计

### 📊 **数据管理系统 (100%覆盖)**
- ✅ **配置管理**: Flash存储，CRC校验，备份恢复
- ✅ **日志记录**: 5级日志，环形缓冲，批量存储
- ✅ **性能监控**: CPU使用率，内存监控，通信统计

### 🔄 **系统服务 (100%覆盖)**
- ✅ **任务调度**: 15级优先级，时间片轮转，实时保证
- ✅ **启动流程**: 四层初始化，并行启动，错误处理
- ✅ **状态机**: 6种系统状态，状态转换，异常恢复

## 🎯 **关键技术指标**

| 技术指标 | 设计值 | 实现方式 | 备注 |
|---------|--------|----------|------|
| **EtherCAT周期** | 1ms | 硬件定时器+优先级1 | 严格实时保证 |
| **控制精度** | 温度±2°C | 自适应PID算法 | 模糊逻辑整定 |
| **ADC精度** | 15bit | 多重滤波+校准 | 信号质量保证 |
| **响应时间** | <100ms | 多级任务调度 | 实时性保证 |
| **安全响应** | <10ms | 硬件+软件保护 | 紧急停机 |
| **网络性能** | 100Mbps | 双PHY芯片 | 冗余通信 |
| **存储可靠性** | CRC32校验 | 双备份机制 | 数据完整性 |
| **系统可用性** | >99.9% | 多重保护+监控 | 工业级可靠性 |

## 💼 **开发团队使用指南**

### 🏗️ **架构理解**
1. **四层调用关系**: 严格单向调用，禁止跨层
2. **优先级系统**: EtherCAT最高，紧急处理优先
3. **时序要求**: 关键任务固定周期，非关键任务灵活调度

### 🔍 **调试指南**
1. **问题定位**: 按层次逐级排查(BSP→HAL→中间件→应用)
2. **性能分析**: 使用性能监控数据，关注CPU和内存使用
3. **通信调试**: 区分EtherCAT和TCP问题，检查网络状态

### 🚀 **扩展开发**
1. **新增传感器**: 在HAL层添加接口，中间件添加处理，应用层调用
2. **新增控制算法**: 在中间件层实现，通过标准接口提供服务
3. **新增通信协议**: 在协议栈中间件扩展，保持接口兼容

### 🧪 **测试策略**
1. **单元测试**: 按层次分别测试，重点测试算法正确性
2. **集成测试**: 测试层间接口，验证数据流正确性
3. **系统测试**: 完整功能测试，长时间稳定性测试

### 📋 **维护要点**
1. **定期检查**: 系统性能指标，硬件健康状态
2. **日志分析**: 定期分析系统日志，发现潜在问题
3. **配置备份**: 定期备份系统配置，确保数据安全
4. **固件更新**: 通过网络远程更新，保持系统最新

## 🎯 **总结**

这个完整的程序运行思维导图为什方科技InkCore供墨系统提供了：

- 🎯 **清晰的程序执行流程** - 从系统启动到正常运行的完整路径
- 📋 **明确的模块调用关系** - 四层架构的严格调用规范
- ⏰ **准确的时序要求** - 每个任务的精确执行周期
- 🛡️ **完整的安全保护机制** - 多级保护确保系统安全
- 📊 **系统性能监控要点** - 全方位监控系统运行状态
- 🔧 **全面的功能覆盖** - 所有传感器、执行器、通信的完整流程
- 💼 **实用的开发指导** - 为团队提供开发、调试、维护指南

**适用场景**:
- 🎓 团队培训和新人上手
- 🔍 系统调试和问题定位
- 📈 性能优化和系统监控
- 🚀 功能扩展和版本升级
- 🧪 测试用例设计和验证
- 📖 技术文档编写和审查

这份思维导图是供墨系统控制板卡开发的核心技术指导文档！