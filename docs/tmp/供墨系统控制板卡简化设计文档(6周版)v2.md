# 供墨系统控制板卡简化设计文档 (6周个人开发版) v2

## 文档概述

本文档基于《供墨系统控制板卡综合技术设计文档(分层版)v1》，专为个人开发者设计的6周完成版本。大幅简化了原有设计的复杂度，只保留核心必需功能，适合个人快速原型开发。

## 📋 简化设计原则

### 核心原则
- **MVP(最小可行产品)优先**: 只实现核心功能，去除高级特性
- **单一平台**: 专注GD32F407平台(更常见，成本更低)
- **简化通信**: 仅保留TCP/IP，移除EtherCAT
- **减少传感器**: 从多路传感器简化为关键传感器
- **标准库优先**: 使用标准库，避免复杂中间件

---

# 第一章 系统总体架构设计

## 1.1 简化系统概述

**产品定位**: 个人开发版供墨系统控制器
**应用场景**: 单工位供墨控制，基础温度/压力/液位监控
**设计理念**: 简单可靠、快速开发、成本控制

### 1.1.1 核心技术参数 (简化版)

| 参数类型 | 技术规格 | 性能指标 | 备注 |
|----------|----------|----------|------|
| **主控芯片** | GD32F407VET6 | 168MHz, 512K Flash, 100PIN | 成本更低，功能够用 |
| **通信协议** | TCP/IP | 100Mbps以太网 | 移除EtherCAT，降低复杂度 |
| **模拟采集** | 12bit ADC | 3通道采集 | 简化为3路传感器 |
| **数字IO** | 标准GPIO | 8路数字IO | 减少IO路数 |
| **显示接口** | OLED显示屏 | 128×64像素 | 使用常见OLED |

### 1.1.2 简化系统功能块

```
┌─────────────────────────────────────────────────────────────────┐
│                    简化版供墨控制系统 V2.0                        │
├─────────────────┬─────────────────┬─────────────────┬─────────────┤
│   电源管理      │    主控处理      │    网络通信      │   信号采集   │
│                │                │                │             │
│  DC24V输入      │  GD32F407VET6   │  TCP/IP        │  12bit ADC  │
│  DC5V/3.3V转换  │  ARM Cortex-M4  │  W5500网络芯片  │  3路模拟量   │
│  电源监控       │  168MHz主频     │  标准以太网     │  简单调理    │
├─────────────────┼─────────────────┼─────────────────┼─────────────┤
│   执行器控制    │    状态指示      │    用户界面      │   系统保护   │
│                │                │                │             │
│  继电器控制     │  3路LED指示     │  OLED显示       │  软件看门狗  │
│  PWM调速        │  红绿蓝三色     │  2个按键        │  简单保护    │
│  基础保护       │  状态指示       │  菜单操作       │  故障记录    │
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
```

## 1.2 简化软件架构设计

基于GD32F407平台的三层软件架构（简化为三层）：

### 1.2.1 三层架构结构

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用层 (Application Layer)                │
├─────────────────┬─────────────────┬─────────────────┬─────────────┤
│   控制应用      │    显示应用      │   网络应用       │   配置管理   │
│                │                │                │             │
│  • 温度控制PID  │  • OLED显示管理 │  • TCP服务器    │  • 基础配置  │
│  • 液位监控     │  • 按键处理     │  • 数据上报     │  • 参数存储  │
│  • 泵控制      │  • 菜单系统     │  • 远程控制     │  • 默认值    │
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                      中间件层 (Middleware Layer)                  │
├─────────────────┬─────────────────┬─────────────────┬─────────────┤
│   任务调度      │    网络协议      │    数据处理     │   系统服务   │
│                │                │                │             │
│  • 简单调度器   │  • TCP/IP协议   │  • 数字滤波     │  • 看门狗    │
│  • 定时任务     │  • JSON数据     │  • 数据校准     │  • 日志记录  │
│  • 状态机管理   │  • 简单协议     │  • 状态管理     │  • 错误处理  │
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                    硬件抽象层 (HAL Layer)                        │
├─────────────────┬─────────────────┬─────────────────┬─────────────┤
│   传感器驱动    │    执行器驱动    │    通信驱动     │   系统驱动   │
│                │                │                │             │
│  • ADC采集     │  • GPIO控制     │  • SPI驱动     │  • 定时器    │
│  • 信号转换    │  • PWM输出      │  • 网络芯片    │  • 看门狗    │
│  • 数据缓存    │  • 继电器控制   │  • UART调试    │  • Flash操作 │
└─────────────────┴─────────────────┴─────────────────┴─────────────┘
```

---

# 第二章 简化硬件接口设计

## 2.1 传感器系统设计 (简化版)

### 2.1.1 温度传感器 - DS18B20 (简化选择)

**为什么选择DS18B20**:
- 数字输出，无需复杂模拟电路
- 单总线协议，节省IO
- 精度±0.5°C，满足基本需求
- 成本低廉，开发简单

```c
// 温度传感器配置 (DS18B20数字温度传感器)
typedef struct {
    char model[16];           // "DS18B20"
    float range_min;          // -55°C
    float range_max;          // 125°C
    float accuracy;           // ±0.5°C
    uint8_t resolution;       // 12bit
    uint16_t conversion_time; // 750ms (12bit)
    bool parasitic_power;     // false (外部供电)
} temperature_sensor_simple_t;

// 简化的温度读取函数
float read_temperature_ds18b20(uint8_t sensor_id) {
    uint8_t rom_code[8];
    uint8_t data[9];

    // 1. 发送温度转换命令
    ds18b20_start_conversion(sensor_id);

    // 2. 等待转换完成
    delay_ms(750);

    // 3. 读取温度数据
    ds18b20_read_scratchpad(sensor_id, data);

    // 4. 计算温度值
    int16_t raw_temp = (data[1] << 8) | data[0];
    float temperature = (float)raw_temp / 16.0f;

    return temperature;
}
```

### 2.1.2 压力传感器 - 简化4-20mA (保留一路)

```c
// 简化压力传感器 (只保留一路)
typedef struct {
    float range_min;          // 0kPa
    float range_max;          // 1000kPa (1MPa, 满足大部分需求)
    float current_min;        // 4.0mA
    float current_max;        // 20.0mA
} pressure_sensor_simple_t;

// 简化的压力传感器读取
float read_pressure_4_20ma(void) {
    // 12bit ADC读取
    uint16_t adc_value = adc_read_channel(ADC_CHANNEL_PRESSURE);

    // 转换为电压 (参考电压3.3V)
    float voltage = (float)adc_value * 3.3f / 4096.0f;

    // 通过250Ω电阻转换为电流
    float current = voltage / 250.0f * 1000.0f; // mA

    // 线性转换为压力 (4mA=0kPa, 20mA=1000kPa)
    if (current < 3.5f || current > 20.5f) {
        return -1.0f; // 传感器故障
    }

    float pressure = (current - 4.0f) * 1000.0f / 16.0f; // kPa
    return pressure;
}
```

### 2.1.3 液位传感器 - 电容式液位开关 (简化为开关量)

```c
// 简化液位检测 (使用开关量代替模拟量)
typedef enum {
    LIQUID_LEVEL_LOW = 0,     // 低液位
    LIQUID_LEVEL_OK,          // 正常液位
    LIQUID_LEVEL_HIGH,        // 高液位
    LIQUID_LEVEL_ERROR        // 传感器故障
} liquid_level_status_t;

// 简化液位检测
liquid_level_status_t read_liquid_level_switches(void) {
    bool level_low = gpio_read_pin(LIQUID_LEVEL_LOW_PIN);
    bool level_high = gpio_read_pin(LIQUID_LEVEL_HIGH_PIN);

    if (!level_low && !level_high) return LIQUID_LEVEL_LOW;
    if (level_low && !level_high) return LIQUID_LEVEL_OK;
    if (level_low && level_high) return LIQUID_LEVEL_HIGH;

    return LIQUID_LEVEL_ERROR; // 不可能的状态
}
```

## 2.2 执行器控制系统 (简化版)

### 2.2.1 加热器控制 - 简化SSR控制

```c
// 简化加热器控制
typedef struct {
    float target_temperature;    // 目标温度
    float current_temperature;   // 当前温度
    bool heater_enabled;         // 加热器使能
    uint8_t pwm_duty;           // PWM占空比 (0-100%)
    uint32_t last_update_time;  // 上次更新时间
} heater_controller_simple_t;

// 简化的加热器控制 (简单开关控制)
void simple_heater_control(heater_controller_simple_t *heater) {
    float temp_diff = heater->target_temperature - heater->current_temperature;

    if (temp_diff > 2.0f) {
        // 温差大于2度，开启加热器
        gpio_write_pin(HEATER_CONTROL_PIN, GPIO_HIGH);
        heater->heater_enabled = true;
    } else if (temp_diff < -1.0f) {
        // 温度超过目标1度，关闭加热器
        gpio_write_pin(HEATER_CONTROL_PIN, GPIO_LOW);
        heater->heater_enabled = false;
    }
    // 在1-2度之间保持当前状态 (简单滞环控制)
}
```

### 2.2.2 泵控制 - 简化PWM调速

```c
// 简化泵控制
typedef struct {
    uint8_t speed_percent;      // 转速百分比 (0-100%)
    bool pump_enabled;          // 泵使能状态
    uint32_t run_time;          // 运行时间统计
} pump_controller_simple_t;

// 简化泵速度控制
void set_pump_speed_simple(uint8_t pump_id, uint8_t speed_percent) {
    if (speed_percent > 100) speed_percent = 100;

    // 计算PWM占空比 (速度0%对应占空比10%, 速度100%对应占空比90%)
    uint16_t pwm_duty = 100 + (speed_percent * 800 / 100); // 100-900 对应 10%-90%

    // 设置PWM输出
    timer_set_pwm_duty(PUMP_PWM_TIMER, PUMP_PWM_CHANNEL, pwm_duty);

    // 更新状态
    pump_controllers[pump_id].speed_percent = speed_percent;
    pump_controllers[pump_id].pump_enabled = (speed_percent > 0);
}
```

---

# 第三章 简化人机界面

## 3.1 LED指示系统 (简化为3路)

### 3.1.1 简化LED功能定义

```c
// 简化LED功能 (只保留3路)
typedef enum {
    LED_POWER = 0,        // 电源指示 (绿色) - 常亮表示系统正常
    LED_STATUS,           // 状态指示 (黄色) - 闪烁表示运行状态
    LED_ALARM,            // 故障指示 (红色) - 亮起表示故障
    LED_COUNT_MAX = 3
} led_id_simple_t;

// 简化LED控制
void led_simple_update(void) {
    static uint32_t blink_counter = 0;
    blink_counter++;

    // 电源LED - 常亮 (系统正常时)
    gpio_write_pin(LED_POWER_PIN, system_status == SYSTEM_OK ? GPIO_HIGH : GPIO_LOW);

    // 状态LED - 1Hz闪烁
    if (system_status == SYSTEM_RUNNING) {
        gpio_write_pin(LED_STATUS_PIN, (blink_counter % 500) < 250 ? GPIO_HIGH : GPIO_LOW);
    } else {
        gpio_write_pin(LED_STATUS_PIN, GPIO_LOW);
    }

    // 故障LED - 故障时常亮
    gpio_write_pin(LED_ALARM_PIN, (fault_status != FAULT_NONE) ? GPIO_HIGH : GPIO_LOW);
}
```

## 3.2 OLED显示系统 (简化显示)

### 3.2.1 简化显示页面

```c
// 简化显示页面 (只保留3个页面)
typedef enum {
    DISPLAY_PAGE_MAIN = 0,    // 主页面 - 核心数据
    DISPLAY_PAGE_CONTROL,     // 控制页面 - 设定值调整
    DISPLAY_PAGE_STATUS,      // 状态页面 - 系统状态
    DISPLAY_PAGE_MAX = 3
} display_page_simple_t;

// 主页面显示内容
void display_main_page_simple(void) {
    char line_buffer[32];

    // 第1行: 标题
    oled_show_string(0, 0, "Ink Supply V2.0", 12);

    // 第2行: 温度
    snprintf(line_buffer, sizeof(line_buffer), "Temp: %.1fC", current_temperature);
    oled_show_string(0, 16, line_buffer, 12);

    // 第3行: 压力
    snprintf(line_buffer, sizeof(line_buffer), "Press: %.1fkPa", current_pressure);
    oled_show_string(0, 32, line_buffer, 12);

    // 第4行: 液位状态
    snprintf(line_buffer, sizeof(line_buffer), "Level: %s",
             get_liquid_level_string(current_liquid_level));
    oled_show_string(0, 48, line_buffer, 12);
}

// 简化按键处理
void handle_key_press_simple(uint8_t key_id) {
    static uint8_t current_page = 0;

    if (key_id == KEY_1) {
        // 页面切换
        current_page = (current_page + 1) % DISPLAY_PAGE_MAX;
        display_update_flag = true;
    } else if (key_id == KEY_2) {
        // 确认/设置
        handle_page_action(current_page);
    }
}
```

---

# 第四章 简化通信系统

## 4.1 TCP/IP网络通信 (基于W5500)

### 4.1.1 简化网络配置

```c
// 简化网络配置 (固定IP配置)
typedef struct {
    uint8_t mac_address[6];     // MAC地址
    uint8_t ip_address[4];      // IP地址 (默认192.168.1.100)
    uint8_t subnet_mask[4];     // 子网掩码 (255.255.255.0)
    uint8_t gateway[4];         // 网关 (192.168.1.1)
    uint16_t server_port;       // 服务器端口 (默认8080)
} network_config_simple_t;

// 初始化网络 (使用W5500芯片)
bool network_init_simple(void) {
    // 配置默认网络参数
    network_config_simple_t config = {
        .mac_address = {0x00, 0x08, 0xDC, 0x12, 0x34, 0x56},
        .ip_address = {192, 168, 1, 100},
        .subnet_mask = {255, 255, 255, 0},
        .gateway = {192, 168, 1, 1},
        .server_port = 8080
    };

    // 初始化W5500芯片
    w5500_init();
    w5500_set_mac(config.mac_address);
    w5500_set_ip(config.ip_address);
    w5500_set_subnet(config.subnet_mask);
    w5500_set_gateway(config.gateway);

    // 创建TCP服务器
    return w5500_create_server(config.server_port);
}
```

### 4.1.2 简化数据通信协议

```c
// 简化JSON数据格式
typedef struct {
    float temperature;          // 温度值
    float pressure;            // 压力值
    uint8_t liquid_level;      // 液位状态
    uint8_t heater_status;     // 加热器状态
    uint8_t pump_speed;        // 泵速度
    uint8_t system_status;     // 系统状态
    uint32_t timestamp;        // 时间戳
} sensor_data_simple_t;

// 简化数据上报
void send_sensor_data_simple(sensor_data_simple_t *data) {
    char json_buffer[256];

    // 构造JSON字符串
    snprintf(json_buffer, sizeof(json_buffer),
        "{"
        "\"temp\":%.1f,"
        "\"press\":%.1f,"
        "\"level\":%d,"
        "\"heater\":%d,"
        "\"pump\":%d,"
        "\"status\":%d,"
        "\"time\":%u"
        "}",
        data->temperature,
        data->pressure,
        data->liquid_level,
        data->heater_status,
        data->pump_speed,
        data->system_status,
        data->timestamp
    );

    // 发送数据
    w5500_send_data(json_buffer, strlen(json_buffer));
}
```

---

# 第五章 简化任务调度

## 5.1 简单任务调度器 (无RTOS)

### 5.1.1 基于时间片的简单调度

```c
// 简化任务定义
typedef struct {
    void (*task_function)(void);    // 任务函数
    uint32_t period_ms;            // 任务周期
    uint32_t last_run_time;        // 上次运行时间
    bool enabled;                  // 任务使能
} simple_task_t;

// 系统任务列表 (简化版)
static simple_task_t system_tasks[] = {
    {sensor_task,           100,  0, true},   // 传感器任务 - 100ms
    {control_task,          200,  0, true},   // 控制任务 - 200ms
    {display_task,          500,  0, true},   // 显示任务 - 500ms
    {network_task,          1000, 0, true},   // 网络任务 - 1s
    {led_task,              100,  0, true},   // LED任务 - 100ms
    {watchdog_task,         1000, 0, true},   // 看门狗任务 - 1s
};

#define TASK_COUNT (sizeof(system_tasks) / sizeof(simple_task_t))

// 简化任务调度器
void simple_scheduler(void) {
    uint32_t current_time = get_system_tick();

    for (int i = 0; i < TASK_COUNT; i++) {
        simple_task_t *task = &system_tasks[i];

        if (!task->enabled) continue;

        if (current_time - task->last_run_time >= task->period_ms) {
            task->task_function();
            task->last_run_time = current_time;
        }
    }
}
```

### 5.1.2 主要任务实现

```c
// 传感器任务 (100ms执行)
void sensor_task(void) {
    // 读取温度
    current_temperature = read_temperature_ds18b20(0);

    // 读取压力
    current_pressure = read_pressure_4_20ma();

    // 读取液位状态
    current_liquid_level = read_liquid_level_switches();

    // 简单数据验证
    if (current_temperature < -50.0f || current_temperature > 150.0f) {
        set_fault_flag(FAULT_TEMPERATURE_SENSOR);
    }

    if (current_pressure < -10.0f) {
        set_fault_flag(FAULT_PRESSURE_SENSOR);
    }
}

// 控制任务 (200ms执行)
void control_task(void) {
    static heater_controller_simple_t heater = {50.0f, 0.0f, false, 0, 0};

    // 更新当前温度
    heater.current_temperature = current_temperature;

    // 执行加热器控制
    simple_heater_control(&heater);

    // 泵速度控制 (基于液位)
    if (current_liquid_level == LIQUID_LEVEL_LOW) {
        set_pump_speed_simple(0, 80);  // 低液位时高速运行
    } else if (current_liquid_level == LIQUID_LEVEL_OK) {
        set_pump_speed_simple(0, 40);  // 正常液位时中速运行
    } else {
        set_pump_speed_simple(0, 0);   // 高液位时停止
    }
}

// 网络任务 (1s执行)
void network_task(void) {
    static sensor_data_simple_t data;

    // 更新传感器数据
    data.temperature = current_temperature;
    data.pressure = current_pressure;
    data.liquid_level = current_liquid_level;
    data.heater_status = heater_status;
    data.pump_speed = pump_speed;
    data.system_status = system_status;
    data.timestamp = get_system_tick();

    // 发送数据
    send_sensor_data_simple(&data);
}
```

---

# 第六章 系统配置与存储

## 6.1 简化配置管理

### 6.1.1 基础配置参数

```c
// 简化系统配置 (只保留必要参数)
typedef struct {
    // 配置头部
    uint32_t config_magic;          // 配置魔术字 0x12345678
    uint16_t config_version;        // 配置版本号
    uint16_t config_size;           // 配置大小
    uint32_t config_crc;            // CRC校验

    // 控制参数
    float target_temperature;       // 目标温度 (°C)
    float target_pressure;          // 目标压力 (kPa)
    uint8_t pump_default_speed;     // 泵默认速度 (%)

    // 报警参数
    float temp_alarm_high;          // 温度高报警 (°C)
    float temp_alarm_low;           // 温度低报警 (°C)
    float pressure_alarm_high;      // 压力高报警 (kPa)
    float pressure_alarm_low;       // 压力低报警 (kPa)

    // 网络参数
    uint8_t ip_address[4];          // IP地址
    uint16_t server_port;           // 服务器端口
    uint16_t report_interval;       // 数据上报间隔 (s)

    // 系统参数
    uint8_t display_brightness;     // 显示亮度 (0-100%)
    bool auto_control_enabled;      // 自动控制使能
    uint16_t system_id;             // 系统ID

} system_config_simple_t;

// 默认配置
static const system_config_simple_t default_config = {
    .config_magic = 0x12345678,
    .config_version = 1,
    .config_size = sizeof(system_config_simple_t),
    .config_crc = 0,

    .target_temperature = 50.0f,
    .target_pressure = 500.0f,
    .pump_default_speed = 50,

    .temp_alarm_high = 80.0f,
    .temp_alarm_low = 10.0f,
    .pressure_alarm_high = 900.0f,
    .pressure_alarm_low = 50.0f,

    .ip_address = {192, 168, 1, 100},
    .server_port = 8080,
    .report_interval = 10,

    .display_brightness = 80,
    .auto_control_enabled = true,
    .system_id = 1,
};
```

### 6.1.2 简化存储操作

```c
// 简化Flash存储 (使用内部Flash最后一页)
#define CONFIG_FLASH_PAGE_SIZE  2048
#define CONFIG_FLASH_ADDRESS    (FLASH_END_ADDRESS - CONFIG_FLASH_PAGE_SIZE)

// 保存配置到Flash
bool config_save_simple(const system_config_simple_t *config) {
    system_config_simple_t temp_config = *config;

    // 计算CRC
    temp_config.config_crc = 0;
    temp_config.config_crc = crc32_calculate((uint8_t*)&temp_config,
                                           sizeof(system_config_simple_t) - 4);

    // 擦除Flash页
    flash_erase_page(CONFIG_FLASH_ADDRESS);

    // 写入配置
    return flash_write_data(CONFIG_FLASH_ADDRESS,
                           (uint8_t*)&temp_config,
                           sizeof(system_config_simple_t));
}

// 从Flash加载配置
bool config_load_simple(system_config_simple_t *config) {
    // 读取配置
    flash_read_data(CONFIG_FLASH_ADDRESS,
                   (uint8_t*)config,
                   sizeof(system_config_simple_t));

    // 检查魔术字
    if (config->config_magic != 0x12345678) {
        // 使用默认配置
        *config = default_config;
        return config_save_simple(config);
    }

    // 验证CRC
    uint32_t calculated_crc = config->config_crc;
    config->config_crc = 0;
    uint32_t actual_crc = crc32_calculate((uint8_t*)config,
                                        sizeof(system_config_simple_t) - 4);

    if (calculated_crc != actual_crc) {
        // CRC错误，使用默认配置
        *config = default_config;
        return config_save_simple(config);
    }

    config->config_crc = calculated_crc;
    return true;
}
```

---

# 第七章 安全保护与故障处理

## 7.1 简化安全保护

### 7.1.1 基础故障代码

```c
// 简化故障代码定义
typedef enum {
    FAULT_NONE = 0x0000,

    // 传感器故障
    FAULT_TEMPERATURE_SENSOR = 0x0001,
    FAULT_PRESSURE_SENSOR = 0x0002,
    FAULT_LIQUID_LEVEL_SENSOR = 0x0003,

    // 执行器故障
    FAULT_HEATER_FAULT = 0x0010,
    FAULT_PUMP_FAULT = 0x0011,

    // 系统故障
    FAULT_POWER_VOLTAGE = 0x0020,
    FAULT_COMMUNICATION = 0x0021,
    FAULT_MEMORY_ERROR = 0x0022,

    FAULT_MAX = 0xFFFF
} fault_code_simple_t;

// 故障状态管理
static struct {
    fault_code_simple_t current_fault;
    uint32_t fault_count[16];        // 故障计数器
    uint32_t last_fault_time;        // 最后故障时间
    bool emergency_stop;             // 紧急停止标志
} fault_manager = {0};
```

### 7.1.2 简化保护逻辑

```c
// 安全监控任务 (1s执行)
void safety_monitor_task(void) {
    // 温度保护
    if (current_temperature > 90.0f) {
        set_fault(FAULT_TEMPERATURE_SENSOR);
        // 立即关闭加热器
        gpio_write_pin(HEATER_CONTROL_PIN, GPIO_LOW);
    }

    // 压力保护
    if (current_pressure > 1200.0f || current_pressure < -50.0f) {
        set_fault(FAULT_PRESSURE_SENSOR);
        // 停止泵运行
        set_pump_speed_simple(0, 0);
    }

    // 电源电压监控 (通过ADC监控3.3V)
    float vdd_voltage = read_vdd_voltage();
    if (vdd_voltage < 3.0f || vdd_voltage > 3.6f) {
        set_fault(FAULT_POWER_VOLTAGE);
    }

    // 通信超时检测
    if (network_timeout_check()) {
        set_fault(FAULT_COMMUNICATION);
    }

    // 紧急停止处理
    if (fault_manager.emergency_stop) {
        emergency_shutdown_simple();
    }
}

// 简化紧急停止处理
void emergency_shutdown_simple(void) {
    // 关闭所有执行器
    gpio_write_pin(HEATER_CONTROL_PIN, GPIO_LOW);
    set_pump_speed_simple(0, 0);

    // 点亮报警LED
    gpio_write_pin(LED_ALARM_PIN, GPIO_HIGH);

    // 记录故障日志
    log_error("Emergency shutdown activated");

    // 发送报警信息
    send_alarm_message();
}
```

---

# 第八章 文件目录结构 (简化版)

## 8.1 简化目录结构

基于三层架构的简化目录组织：

```
ink_supply_simple/
├── src/                                    # 源代码目录
│   ├── main.c                             # 主程序
│   │
│   ├── hal/                               # 硬件抽象层
│   │   ├── adc_hal.c/h                    # ADC驱动
│   │   ├── gpio_hal.c/h                   # GPIO驱动
│   │   ├── pwm_hal.c/h                    # PWM驱动
│   │   ├── spi_hal.c/h                    # SPI驱动
│   │   ├── uart_hal.c/h                   # UART驱动
│   │   ├── timer_hal.c/h                  # 定时器驱动
│   │   ├── flash_hal.c/h                  # Flash操作
│   │   └── system_hal.c/h                 # 系统功能
│   │
│   ├── middleware/                        # 中间件层
│   │   ├── scheduler.c/h                  # 简单调度器
│   │   ├── w5500_driver.c/h               # W5500网络芯片
│   │   ├── ds18b20_driver.c/h             # DS18B20驱动
│   │   ├── oled_driver.c/h                # OLED显示驱动
│   │   ├── digital_filter.c/h             # 数字滤波
│   │   ├── crc32.c/h                      # CRC校验
│   │   └── utils.c/h                      # 工具函数
│   │
│   └── application/                       # 应用层
│       ├── sensor_app.c/h                 # 传感器应用
│       ├── control_app.c/h                # 控制应用
│       ├── display_app.c/h                # 显示应用
│       ├── network_app.c/h                # 网络应用
│       ├── config_app.c/h                 # 配置应用
│       ├── safety_app.c/h                 # 安全应用
│       └── system_app.c/h                 # 系统应用
│
├── inc/                                   # 头文件目录
│   ├── config.h                           # 系统配置
│   ├── types.h                            # 数据类型定义
│   ├── error_codes.h                      # 错误代码
│   └── version.h                          # 版本信息
│
├── lib/                                   # 第三方库
│   ├── GD32F4xx_HAL/                      # GD32 HAL库
│   └── CMSIS/                             # ARM CMSIS库
│
├── docs/                                  # 设计文档
├── test/                                  # 测试代码
├── build/                                 # 构建输出
├── Makefile                               # 构建配置
├── README.md                              # 项目说明
└── .gitignore                             # Git忽略文件
```

---

# 第九章 6周开发计划

## 9.1 开发时间规划

### 第1周: 硬件平台搭建
- **Day 1-2**: GD32F407开发板选型采购
- **Day 3-4**: 基础硬件连接 (LED, 按键, OLED)
- **Day 5-7**: 基础HAL层代码，LED闪烁，OLED显示

### 第2周: 传感器集成
- **Day 1-2**: DS18B20温度传感器驱动
- **Day 3-4**: 4-20mA压力传感器ADC采集
- **Day 5-7**: 液位开关检测，传感器数据显示

### 第3周: 执行器控制
- **Day 1-2**: GPIO控制继电器 (加热器)
- **Day 3-4**: PWM控制泵调速
- **Day 5-7**: 简单控制算法实现

### 第4周: 网络通信
- **Day 1-3**: W5500网络芯片驱动
- **Day 4-5**: TCP服务器实现
- **Day 6-7**: JSON数据格式，数据上报

### 第5周: 系统集成
- **Day 1-2**: 任务调度器实现
- **Day 3-4**: 配置管理和Flash存储
- **Day 5-7**: 人机界面完善，菜单系统

### 第6周: 测试调试
- **Day 1-3**: 功能测试，BUG修复
- **Day 4-5**: 安全保护测试
- **Day 6-7**: 性能优化，代码整理

## 9.2 关键里程碑

✅ **里程碑1 (第1周结束)**: 基础平台运行，OLED显示正常
✅ **里程碑2 (第2周结束)**: 传感器数据正常读取和显示
✅ **里程碑3 (第3周结束)**: 执行器控制正常，基础控制回路运行
✅ **里程碑4 (第4周结束)**: 网络通信正常，数据远程监控
✅ **里程碑5 (第5周结束)**: 完整系统功能集成
✅ **里程碑6 (第6周结束)**: 系统稳定运行，完成测试

## 9.3 成本估算

| 组件 | 数量 | 单价 | 小计 | 备注 |
|------|------|------|------|------|
| GD32F407开发板 | 1 | ¥80 | ¥80 | 核心控制器 |
| W5500网络模块 | 1 | ¥25 | ¥25 | 以太网通信 |
| 0.96寸OLED | 1 | ¥15 | ¥15 | 显示屏 |
| DS18B20传感器 | 2 | ¥8 | ¥16 | 温度传感器 |
| 4-20mA传感器 | 1 | ¥80 | ¥80 | 压力传感器 |
| 液位开关 | 2 | ¥20 | ¥40 | 液位检测 |
| 继电器模块 | 2 | ¥12 | ¥24 | 执行器控制 |
| 其他元件 | - | - | ¥50 | 电阻电容等 |
| **总计** | - | - | **¥330** | 个人开发成本 |

---

# 总结

## 与原版本对比

### 简化内容
1. **硬件平台**: GD32F427 → GD32F407 (成本降低)
2. **通信协议**: EtherCAT + TCP/IP → 仅TCP/IP (复杂度降低)
3. **传感器数量**: 多路模拟量 → 3路传感器 (功能简化)
4. **软件架构**: 四层架构 → 三层架构 (开发量减少)
5. **实时系统**: FreeRTOS → 简单调度器 (学习成本降低)
6. **算法复杂度**: 自适应PID → 简单控制 (实现难度降低)

### 保留核心功能
1. ✅ 温度监控与控制
2. ✅ 压力监控
3. ✅ 液位检测
4. ✅ 泵控制
5. ✅ 远程监控
6. ✅ 人机界面
7. ✅ 安全保护

### 开发优势
- **时间可控**: 6周完成，适合个人开发
- **成本可控**: 总成本约¥330，个人可承受
- **技术可控**: 避免复杂技术，专注核心功能
- **功能完整**: 覆盖供墨系统基本需求
- **易于扩展**: 预留接口，后续可升级

## 适用场景
- 个人学习项目
- 快速原型验证
- 小型实验室应用
- 概念验证系统
- 技术能力展示

本简化版本在保证核心功能的前提下，大幅降低了开发复杂度和成本，适合个人开发者在6周内完成一个功能完整的供墨控制系统。

---

**文档版本**: V2.0 (简化版)
**创建日期**: 2025-09-27
**目标周期**: 6周个人开发
**技术平台**: GD32F407 + W5500 + DS18B20
**预算成本**: ¥330
**开发难度**: 中级 (适合有嵌入式基础的开发者)