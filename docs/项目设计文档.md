# 供墨系统项目设计文档

## 文档信息
- **项目名称**: 基于GD32F427的工业供墨系统
- **版本**: V4.0
- **创建日期**: 2024-12-27
- **设计标准**: 8周v4工业级嵌入式系统标准
- **目标平台**: GD32F427VGT6 (ARM Cortex-M4F, 200MHz)
- **操作系统**: FreeRTOS

## 项目概述

### 1.1 项目目标
本项目旨在开发一套完整的工业级供墨系统，具备以下核心功能：
- **精确的温度控制**: 通过PID算法控制墨盒加热器，确保墨水温度稳定
- **智能压力管理**: 实时监控和调节供墨压力，保证供墨流量稳定
- **液位监测**: 多路液位传感器监控，防止缺墨和溢出
- **安全保护**: 多重安全检查和故障保护机制
- **通信接口**: 支持EtherCAT、UART等多种通信方式
- **人机交互**: LED指示和状态显示

### 1.2 技术特点
- **分层架构设计**: 应用层、中间件层、HAL层、驱动层四层架构
- **实时性保证**: 基于FreeRTOS实现多任务实时调度
- **模块化设计**: 高内聚低耦合的模块化架构
- **工业级可靠性**: 完善的错误处理和故障恢复机制
- **扩展性**: 支持多种传感器和执行器类型的扩展

### 1.3 主要参数
| 参数项 | 规格 |
|--------|------|
| 处理器 | GD32F427VGT6 (ARM Cortex-M4F, 200MHz) |
| 内存 | 3072KB Flash, 256KB SRAM |
| 温度控制精度 | ±1°C |
| 压力控制精度 | ±2kPa |
| 液位检测精度 | ±1mm |
| 控制周期 | 20ms (控制任务), 50ms (传感器任务) |
| 通信接口 | EtherCAT, UART, I2C |
| 传感器数量 | 液位×2, 压力×2, 温度×3 |
| 执行器数量 | 加热器×3, 泵×2, 阀门×8 |

## 系统架构

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)            │
├─────────────────────────────────────────────────────────┤
│  安全任务 │ 控制任务 │ 传感器任务 │ 执行器任务 │ 通信任务  │
│ Safety   │ Control │ Sensor    │ Actuator  │ Comm     │
│          │         │           │           │          │
├─────────────────────────────────────────────────────────┤
│                  中间件层 (Middleware Layer)             │
├─────────────────────────────────────────────────────────┤
│    PID控制器 │   数字滤波器  │  任务管理器  │ 通用工具   │
│    PID       │   Filter     │   Tasks     │  Common   │
│              │              │             │           │
├─────────────────────────────────────────────────────────┤
│                   HAL层 (Hardware Abstraction Layer)    │
├─────────────────────────────────────────────────────────┤
│  GPIO │ ADC │ PWM │ I2C │ Timer │ UART │ SPI │ Manager │
│       │     │     │     │       │      │     │         │
├─────────────────────────────────────────────────────────┤
│                    驱动层 (Driver Layer)                │
├─────────────────────────────────────────────────────────┤
│ 传感器驱动          │        执行器驱动        │ 通信驱动  │
│ FRD8061 HP10MY     │    MRA23D3 MPB025BBB   │ EtherCAT │
│ FTT518             │    阀门控制 LED控制      │ UART     │
└─────────────────────────────────────────────────────────┘
```

### 2.2 分层设计原则

#### 2.2.1 应用层 (Application Layer)
- **职责**: 实现业务逻辑，任务调度，系统控制策略
- **特点**:
  - 基于FreeRTOS的多任务设计
  - 模块间通过定义良好的接口通信
  - 具备完整的错误处理和状态管理

#### 2.2.2 中间件层 (Middleware Layer)
- **职责**: 提供通用算法、数据处理、系统服务
- **特点**:
  - 硬件无关的算法实现
  - 统一的错误处理和结果返回
  - 高效的数据结构和算法

#### 2.2.3 HAL层 (Hardware Abstraction Layer)
- **职责**: 硬件抽象，提供统一的硬件操作接口
- **特点**:
  - 硬件无关的统一接口
  - 完整的错误代码定义
  - 支持多种工作模式

#### 2.2.4 驱动层 (Driver Layer)
- **职责**: 直接操作硬件寄存器，实现底层功能
- **特点**:
  - 硬件相关的寄存器操作
  - 中断服务程序
  - 底层初始化和配置

## 任务设计

### 3.1 任务架构
| 任务名称 | 优先级 | 周期 | 栈大小 | 主要功能 |
|----------|---------|------|--------|----------|
| 安全任务 | 最高(15) | 10ms | 2KB | 系统安全监控，故障检测 |
| 控制任务 | 高(12) | 20ms | 4KB | PID控制，执行器控制 |
| 传感器任务 | 普通(8) | 50ms | 2KB | 传感器数据采集和处理 |
| 执行器任务 | 普通(8) | 10ms | 2KB | 执行器状态管理 |
| HMI任务 | 低(5) | 100ms | 2KB | 人机交互，状态显示 |
| 通信任务 | 低(5) | 50ms | 2KB | 网络通信，数据传输 |
| 配置任务 | 最低(2) | 1000ms | 1KB | 参数配置，数据存储 |

### 3.2 任务间通信
- **共享内存**: 通过互斥锁保护的全局数据结构
- **消息队列**: 用于任务间异步通信
- **信号量**: 用于任务同步和资源保护
- **事件组**: 用于系统状态和事件通知

## 硬件接口设计

### 4.1 传感器接口
| 传感器 | 型号 | 接口类型 | 数量 | 测量范围 | 精度 |
|--------|------|----------|------|----------|------|
| 液位传感器 | FRD-8061 | 4-20mA/ADC | 2 | 0-200mm | ±1mm |
| 压力传感器 | HP10MY | 4-20mA/ADC | 2 | 0-100kPa | ±0.5kPa |
| 温度传感器 | FTT518(PT100) | RTD/ADC | 3 | -50~150°C | ±0.1°C |

### 4.2 执行器接口
| 执行器 | 型号 | 接口类型 | 数量 | 控制范围 | 响应时间 |
|--------|------|----------|------|----------|----------|
| 加热器 | MRA-23D3 | PWM | 3 | 0-100% | <1s |
| 泵 | MPB025BBB | PWM | 2 | 0-5000RPM | <2s |
| 电磁阀 | - | GPIO | 8 | 开/关 | <100ms |
| LED指示灯 | - | GPIO | 多个 | 开/关/闪烁 | <1ms |

### 4.3 通信接口
| 接口 | 协议 | 波特率/速率 | 用途 |
|------|------|-------------|------|
| EtherCAT | EtherCAT | 100Mbps | 主要通信接口 |
| UART1 | RS232/485 | 115200 | 调试和配置 |
| UART2 | Modbus RTU | 9600 | 外部设备通信 |
| I2C | I2C | 400kHz | 板载器件通信 |

## 关键算法设计

### 5.1 PID控制算法
```c
// PID控制器结构
typedef struct {
    float kp, ki, kd;           // PID参数
    float setpoint;             // 设定值
    float integral;             // 积分项
    float prev_error;           // 上次误差
    float output_min, output_max; // 输出限制
    float integral_min, integral_max; // 积分限制
    bool initialized;           // 初始化标志
    bool enabled;               // 使能标志
} pid_controller_t;

// PID计算函数
float pid_compute(pid_controller_t* pid, float feedback);
```

**PID控制特点**:
- 支持积分限幅，防止积分饱和
- 输出限制，确保执行器安全
- 参数可在线调整
- 支持自适应参数调整

### 5.2 数字滤波算法
```c
// 移动平均滤波器
typedef struct {
    float buffer[MW_MAX_FILTER_SIZE];
    uint16_t size;
    uint16_t index;
    float sum;
    bool filled;
} moving_average_filter_t;

// 滤波处理函数
float moving_average_filter_update(moving_average_filter_t* filter, float input);
```

**滤波器特点**:
- 支持可配置窗口大小
- 高效的实时滤波处理
- 多种滤波算法可选

### 5.3 安全保护算法
- **传感器故障检测**: 范围检查、变化率检查、超时检查
- **执行器保护**: 过流保护、过温保护、运行时间限制
- **系统级保护**: 急停处理、安全联锁、故障降级

## 文件结构说明

### 6.1 目录结构
```
ink_supply_system_gd32f427/
├── include/                 # 头文件目录
│   ├── app/                # 应用层头文件
│   ├── middleware/         # 中间件头文件
│   ├── hal/               # HAL层头文件
│   ├── drivers/           # 驱动层头文件
│   ├── config/            # 配置头文件
│   └── system/            # 系统头文件
├── src/                    # 源文件目录
│   ├── app/               # 应用层实现
│   ├── middleware/        # 中间件实现
│   ├── hal/               # HAL层实现
│   ├── drivers/           # 驱动层实现
│   └── system/            # 系统实现
├── config/                 # 配置文件
├── lib/                    # 第三方库
│   ├── FreeRTOS/          # FreeRTOS源码
│   ├── GD32F4xx_standard_peripheral/ # GD32外设库
│   ├── EtherCAT_Stack/    # EtherCAT协议栈
│   └── lwip/              # TCP/IP协议栈
├── docs/                   # 文档目录
├── build/                  # 构建输出目录
├── test/                   # 测试文件
└── tools/                  # 开发工具
```

### 6.2 关键文件说明
| 文件路径 | 说明 |
|----------|------|
| `src/app/app_main.c` | 应用主程序，任务创建和管理 |
| `src/app/control_task.c` | 控制任务，PID控制逻辑 |
| `src/app/sensor_task.c` | 传感器任务，数据采集和处理 |
| `src/app/safety_task.c` | 安全任务，系统保护 |
| `src/middleware/pid.c` | PID控制器实现 |
| `src/middleware/filter.c` | 数字滤波器实现 |
| `src/hal/hal_common.c` | HAL层通用功能 |
| `config/FreeRTOSConfig.h` | FreeRTOS配置 |
| `include/app/app_types.h` | 应用层类型定义 |

## 编译和部署

### 7.1 开发环境
- **IDE**: Keil MDK-ARM V5.37+ 或 IAR EWARM 8.50+
- **编译器**: ARM Compiler 6.16+ 或 GCC ARM 10.3+
- **调试器**: J-Link, ST-Link V2+
- **操作系统**: Windows 10/11, Linux, macOS

### 7.2 编译配置
```makefile
# 主要编译选项
CFLAGS = -mcpu=cortex-m4 -mthumb -mfpu=fpv4-sp-d16 -mfloat-abi=hard
CFLAGS += -Wall -Wextra -O2 -g
CFLAGS += -DGCC_ARMCM4 -DGD32F4xx -DUSE_STDPERIPH_DRIVER

# 包含路径
INCLUDES = -I./include -I./include/app -I./include/middleware
INCLUDES += -I./include/hal -I./include/drivers -I./config

# 链接选项
LDFLAGS = -T./GD32F427VGT6.ld -Wl,--gc-sections
```

### 7.3 部署步骤
1. **环境准备**: 安装开发环境和工具链
2. **代码下载**: 获取源代码并解压
3. **配置修改**: 根据硬件配置修改配置文件
4. **编译构建**: 使用Makefile或IDE编译项目
5. **程序下载**: 通过调试器下载到目标板
6. **功能测试**: 运行系统测试程序

## 测试和验证

### 8.1 单元测试
- **PID控制器测试**: 验证PID算法的准确性和稳定性
- **滤波器测试**: 验证数字滤波器的效果
- **HAL层测试**: 验证硬件抽象层接口的正确性

### 8.2 集成测试
- **任务调度测试**: 验证FreeRTOS任务调度的实时性
- **传感器集成测试**: 验证传感器数据采集的准确性
- **执行器集成测试**: 验证执行器控制的响应性

### 8.3 系统测试
- **温度控制测试**: 验证温度控制系统的精度和稳定性
- **压力控制测试**: 验证压力控制系统的响应特性
- **安全保护测试**: 验证各种故障场景下的安全保护功能

## 维护和扩展

### 9.1 维护指南
- **日志记录**: 系统运行日志的查看和分析
- **故障诊断**: 常见故障的诊断方法和解决方案
- **参数调整**: PID参数和系统参数的优化方法

### 9.2 扩展指南
- **新增传感器**: 传感器驱动的开发和集成方法
- **新增执行器**: 执行器驱动的开发和集成方法
- **通信协议扩展**: 新通信协议的集成方法

## 附录

### A. 错误代码表
详见 `config/error_config.h`

### B. 配置参数表
详见 `config/system_config.h`

### C. 接口函数表
详见各模块头文件

### D. 版本更新记录
- V1.0: 基础功能实现
- V2.0: 增加EtherCAT通信
- V3.0: 优化控制算法
- V4.0: 8周v4标准架构重构

---
**文档版本**: V4.0
**最后更新**: 2024-12-27
**维护者**: ink_supply_system开发团队