# 墨路控制系统详细设计文档

## 1. 系统概述

### 1.1 技术选型
- **MCU**: GD32F427
- **操作系统**: FreeRTOS
- **网络协议栈**: lwIP
- **通信协议**: EtherCAT开源库
- **HAL库**: GD32 HAL库

### 1.2 系统架构
采用四层分层架构设计：
```
应用层 (Application Layer)
    ↓
中间件层 (Middleware Layer)
    ↓
HAL层 (Hardware Abstraction Layer)
    ↓
驱动层 (Driver Layer)
```

## 2. 应用层详细设计

### 2.1 任务架构

#### 2.1.1 任务优先级分配
| 任务名称 | 优先级 | 周期 | 栈大小 | 功能描述 |
|---------|-------|------|--------|----------|
| Emergency Task | 20 | 事件触发 | 1024 | 紧急安全处理 |
| EtherCAT Task | 18 | 1ms | 2048 | EtherCAT通信处理 |
| Safety Task | 15 | 10ms | 1024 | 安全监控 |
| Control Task | 12 | 20ms | 1536 | 控制逻辑 |
| Sensor Task | 8 | 50ms | 1024 | 数据采集 |
| Actuator Task | 8 | 10ms | 1024 | 执行器管理 |
| TCP Task | 5 | 50ms | 2048 | TCP通信处理 |
| LED Task | 5 | 100ms | 512 | LED状态指示 |
| HMI Task | 5 | 100ms | 1024 | 人机交互 |
| Config Task | 2 | 1000ms | 1024 | 配置管理 |

#### 2.1.2 任务间通信机制
```c
// 消息队列定义
#define MSG_QUEUE_SIZE 16

typedef enum {
    MSG_SENSOR_DATA,
    MSG_CONTROL_CMD,
    MSG_SAFETY_ALARM,
    MSG_CONFIG_UPDATE,
    MSG_COMM_DATA
} msg_type_t;

typedef struct {
    msg_type_t type;
    uint32_t timestamp;
    uint16_t data_len;
    uint8_t data[64];
} system_msg_t;

// 全局消息队列
extern QueueHandle_t g_sensor_queue;
extern QueueHandle_t g_control_queue;
extern QueueHandle_t g_safety_queue;
extern QueueHandle_t g_comm_queue;
```

### 2.2 安全监控任务设计 (Safety Task)

#### 2.2.1 任务结构
```c
typedef struct {
    uint32_t check_interval;      // 检查间隔
    uint32_t timeout_threshold;   // 超时阈值
    bool (*check_function)(void); // 检查函数
    void (*alarm_handler)(void);  // 告警处理
} safety_check_item_t;

typedef struct {
    // 传感器状态
    bool temp_sensor_ok[3];       // 3路温度传感器状态
    bool pressure_sensor_ok[4];   // 4路压力传感器状态
    bool level_sensor_ok[3];      // 3路液位传感器状态
    bool flow_sensor_ok;          // 流量传感器状态

    // 执行器状态
    bool valve_status[2];         // 电磁阀状态
    bool heater_status[3];        // 加热器状态
    bool pump_status[4];          // 泵状态

    // 通信状态
    uint32_t ethercat_last_comm;  // EtherCAT最后通信时间
    uint32_t tcp_last_comm;       // TCP最后通信时间

    // 安全参数
    float temp_max[3];            // 温度上限
    float temp_min[3];            // 温度下限
    float pressure_max[4];        // 压力上限
    float pressure_min[4];        // 压力下限
    float level_max[3];           // 液位上限
    float level_min[3];           // 液位下限
} safety_context_t;
```

#### 2.2.2 安全检查项目
| 检查项目 | 检查频率 | 阈值设置 | 处理动作 |
|---------|---------|----------|----------|
| 传感器健康检查 | 10ms | 连续3次读取失败 | 切换到安全模式 |
| 执行器状态检查 | 10ms | 反馈信号异常 | 停止相关控制 |
| 温度过限检查 | 10ms | ±5°C超出设定值 | 关闭加热/启动冷却 |
| 压力过限检查 | 10ms | ±10kPa超出设定值 | 关闭相关阀门 |
| 液位异常检查 | 10ms | 超出安全范围 | 停止相关泵 |
| 通信超时检查 | 50ms | 500ms无通信 | 进入离线模式 |

#### 2.2.3 安全状态机
```c
typedef enum {
    SAFETY_STATE_NORMAL,      // 正常运行
    SAFETY_STATE_WARNING,     // 警告状态
    SAFETY_STATE_ALARM,       // 告警状态
    SAFETY_STATE_EMERGENCY,   // 紧急停机
    SAFETY_STATE_MAINTENANCE  // 维护模式
} safety_state_t;

typedef struct {
    safety_state_t current_state;
    safety_state_t prev_state;
    uint32_t state_enter_time;
    uint32_t alarm_count;
} safety_state_machine_t;
```

### 2.3 传感器任务设计 (Sensor Task)

#### 2.3.1 传感器配置
```c
typedef struct {
    uint8_t channel;              // ADC通道
    float scale_factor;           // 标定系数
    float offset;                 // 零点偏移
    float filter_coefficient;     // 滤波系数
    uint16_t sample_count;        // 采样次数
} sensor_config_t;

// 传感器类型定义
typedef enum {
    SENSOR_TEMP_1,    // 温度传感器1 (FTT518 Pt100)
    SENSOR_TEMP_2,    // 温度传感器2
    SENSOR_TEMP_3,    // 温度传感器3
    SENSOR_PRESSURE_1, // 压力传感器1 (HP10MY)
    SENSOR_PRESSURE_2, // 压力传感器2
    SENSOR_PRESSURE_3, // 压力传感器3
    SENSOR_PRESSURE_4, // 压力传感器4
    SENSOR_LEVEL_1,   // 液位传感器1 (FRD-8061)
    SENSOR_LEVEL_2,   // 液位传感器2
    SENSOR_LEVEL_3,   // 液位传感器3
    SENSOR_LEVEL_ANALOG, // 模拟量液位
    SENSOR_FLOW,      // 流量传感器(I2C)
    SENSOR_COUNT
} sensor_type_t;
```

#### 2.3.2 数据采集与处理
```c
typedef struct {
    float raw_value;              // 原始值
    float filtered_value;         // 滤波后值
    float calibrated_value;       // 标定后值
    uint32_t timestamp;           // 时间戳
    bool valid;                   // 数据有效性
    uint16_t error_count;         // 错误计数
} sensor_data_t;

typedef struct {
    sensor_data_t sensors[SENSOR_COUNT];
    float temp_values[3];         // °C
    float pressure_values[4];     // kPa
    float level_values[4];        // mm
    float flow_value;             // L/min
} sensor_context_t;
```

#### 2.3.3 滤波算法
```c
// 滑动平均滤波
typedef struct {
    float buffer[16];
    uint8_t index;
    uint8_t count;
    float sum;
} moving_average_filter_t;

// 卡尔曼滤波器
typedef struct {
    float Q;     // 过程噪声
    float R;     // 测量噪声
    float P;     // 估计误差协方差
    float K;     // 卡尔曼增益
    float X;     // 状态估计
} kalman_filter_t;
```

### 2.4 控制任务设计 (Control Task)

#### 2.4.1 控制器配置
```c
typedef struct {
    // PID参数
    float kp, ki, kd;             // PID系数
    float setpoint;               // 设定值
    float output_min, output_max; // 输出限幅
    float integral_min, integral_max; // 积分限幅

    // 状态变量
    float previous_error;
    float integral;
    float derivative;
    float previous_input;

    // 控制模式
    bool auto_mode;
    bool reverse_action;
} pid_controller_t;

// 控制回路定义
typedef enum {
    CTRL_TEMP_1,      // 温度控制回路1
    CTRL_TEMP_2,      // 温度控制回路2
    CTRL_TEMP_3,      // 温度控制回路3
    CTRL_PRESSURE_1,  // 压力控制回路1
    CTRL_PRESSURE_2,  // 压力控制回路2
    CTRL_LEVEL_1,     // 液位控制回路1
    CTRL_LEVEL_2,     // 液位控制回路2
    CTRL_FLOW,        // 流量控制回路
    CTRL_COUNT
} control_loop_t;
```

#### 2.4.2 执行器控制
```c
typedef struct {
    uint8_t channel;              // 输出通道
    float current_output;         // 当前输出值
    float target_output;          // 目标输出值
    bool enabled;                 // 使能状态
    uint32_t last_update;         // 最后更新时间
} actuator_config_t;

// 执行器类型
typedef enum {
    ACTUATOR_VALVE_1,     // 电磁阀1 (24V)
    ACTUATOR_VALVE_2,     // 电磁阀2 (24V)
    ACTUATOR_HEATER_1,    // 加热器1 (继电器)
    ACTUATOR_HEATER_2,    // 加热器2 (继电器)
    ACTUATOR_HEATER_3,    // 加热器3 (继电器)
    ACTUATOR_PUMP_SPEED_1, // 调速泵1 (PWM)
    ACTUATOR_PUMP_SPEED_2, // 调速泵2 (PWM)
    ACTUATOR_PUMP_DC_1,   // 直流泵1 (IO)
    ACTUATOR_PUMP_DC_2,   // 直流泵2 (IO)
    ACTUATOR_COUNT
} actuator_type_t;
```

### 2.5 HMI任务设计 (HMI Task)

#### 2.5.1 显示器接口 (CH12832B-12)
```c
typedef struct {
    uint8_t width;                // 128像素
    uint8_t height;               // 32像素
    uint8_t framebuffer[512];     // 显存 (128*32/8)
    bool dirty;                   // 刷新标志
} lcd_context_t;

typedef enum {
    DISPLAY_PAGE_MAIN,        // 主页面
    DISPLAY_PAGE_TEMP,        // 温度页面
    DISPLAY_PAGE_PRESSURE,    // 压力页面
    DISPLAY_PAGE_LEVEL,       // 液位页面
    DISPLAY_PAGE_FLOW,        // 流量页面
    DISPLAY_PAGE_CONTROL,     // 控制页面
    DISPLAY_PAGE_ALARM,       // 告警页面
    DISPLAY_PAGE_CONFIG,      // 配置页面
    DISPLAY_PAGE_COUNT
} display_page_t;
```

#### 2.5.2 用户界面设计
```c
typedef struct {
    display_page_t current_page;
    display_page_t prev_page;
    uint8_t cursor_position;
    uint32_t page_timeout;
    bool backlight_on;
    uint8_t contrast;
} ui_context_t;

// 页面元素
typedef struct {
    uint8_t x, y;                 // 位置
    uint8_t width, height;        // 尺寸
    char text[32];                // 文本内容
    bool selected;                // 选中状态
    bool visible;                 // 可见性
} ui_element_t;
```

### 2.6 LED任务设计 (LED Task)

#### 2.6.1 LED指示配置
```c
typedef enum {
    LED_LEVEL_LOW_1,      // 液位低位指示1 (红)
    LED_LEVEL_HIGH_1,     // 液位高位指示1 (绿)
    LED_LEVEL_LOW_2,      // 液位低位指示2 (红)
    LED_LEVEL_HIGH_2,     // 液位高位指示2 (绿)
    LED_LEVEL_LOW_3,      // 液位低位指示3 (红)
    LED_LEVEL_HIGH_3,     // 液位高位指示3 (绿)
    LED_LEVEL_ANALOG,     // 模拟液位指示 (蓝)
    LED_TEMP_1,           // 温度传感器1 (绿/红)
    LED_TEMP_2,           // 温度传感器2 (绿/红)
    LED_TEMP_3,           // 温度传感器3 (绿/红)
    LED_PRESSURE_1,       // 压力传感器1 (绿/红)
    LED_PRESSURE_2,       // 压力传感器2 (绿/红)
    LED_PRESSURE_3,       // 压力传感器3 (绿/红)
    LED_PRESSURE_4,       // 压力传感器4 (绿/红)
    LED_FLOW,             // 流量指示 (绿/红)
    LED_OUTPUT_1,         // 输出指示1 (黄)
    LED_OUTPUT_2,         // 输出指示2 (黄)
    LED_OUTPUT_3,         // 输出指示3 (黄)
    LED_OUTPUT_4,         // 输出指示4 (黄)
    LED_OUTPUT_5,         // 输出指示5 (黄)
    LED_OUTPUT_6,         // 输出指示6 (黄)
    LED_OUTPUT_7,         // 输出指示7 (黄)
    LED_OUTPUT_8,         // 输出指示8 (黄)
    LED_OUTPUT_9,         // 输出指示9 (黄)
    LED_POWER,            // 电源指示 (绿)
    LED_COMM,             // 通信指示 (红)
    LED_COUNT
} led_type_t;

typedef struct {
    uint8_t gpio_port;
    uint8_t gpio_pin;
    bool state;
    bool blink_enable;
    uint16_t blink_period;
    uint16_t blink_duty;
    uint32_t last_toggle;
} led_config_t;
```

### 2.7 通信任务设计

#### 2.7.1 EtherCAT通信任务
```c
typedef struct {
    uint16_t vendor_id;           // 厂商ID
    uint16_t product_code;        // 产品代码
    uint32_t revision;            // 版本号
    uint16_t pdo_input_size;      // 输入PDO大小
    uint16_t pdo_output_size;     // 输出PDO大小
} ethercat_config_t;

// PDO映射
typedef struct {
    // 输入PDO (主站->从站)
    float temp_setpoint[3];       // 温度设定值
    float pressure_setpoint[4];   // 压力设定值
    float level_setpoint[3];      // 液位设定值
    float flow_setpoint;          // 流量设定值
    uint16_t control_word;        // 控制字

    // 输出PDO (从站->主站)
    float temp_actual[3];         // 温度实际值
    float pressure_actual[4];     // 压力实际值
    float level_actual[3];        // 液位实际值
    float flow_actual;            // 流量实际值
    uint16_t status_word;         // 状态字
    uint16_t alarm_word;          // 告警字
} ethercat_pdo_t;
```

#### 2.7.2 TCP通信任务
```c
// 基础协议帧结构 (已定义)
typedef struct {
    uint16_t sync_word;       // 同步字 0xAA55
    uint16_t length;          // 帧长度(包含帧头)
    uint8_t  cmd;             // 命令字
    uint8_t  index;           // 索引
    uint16_t checksum;        // 校验和
} __attribute__((packed)) tcp_frame_header_t;

typedef struct {
    tcp_frame_header_t header;
    uint8_t data[];
} __attribute__((packed)) tcp_protocol_frame_t;

// 命令定义
typedef enum {
    CMD_READ_SENSOR = 0x01,       // 读取传感器数据
    CMD_WRITE_SETPOINT = 0x02,    // 写入设定值
    CMD_READ_STATUS = 0x03,       // 读取状态
    CMD_WRITE_CONTROL = 0x04,     // 写入控制命令
    CMD_READ_CONFIG = 0x05,       // 读取配置
    CMD_WRITE_CONFIG = 0x06,      // 写入配置
    CMD_ALARM_ACK = 0x07,         // 告警确认
    CMD_RESET = 0x08,             // 系统复位
} tcp_command_t;

// 错误码定义
typedef enum {
    ERR_OK = 0x00,                // 成功
    ERR_INVALID_CMD = 0x01,       // 无效命令
    ERR_INVALID_PARAM = 0x02,     // 无效参数
    ERR_DEVICE_BUSY = 0x03,       // 设备忙
    ERR_TIMEOUT = 0x04,           // 超时
    ERR_CHECKSUM = 0x05,          // 校验错误
    ERR_PERMISSION = 0x06,        // 权限不足
} tcp_error_code_t;
```

### 2.8 配置任务设计 (Config Task)

#### 2.8.1 配置参数结构
```c
typedef struct {
    // 传感器配置
    sensor_config_t sensor_configs[SENSOR_COUNT];

    // 控制器配置
    pid_controller_t controllers[CTRL_COUNT];

    // 安全参数
    safety_context_t safety_params;

    // 通信配置
    struct {
        uint32_t ip_address;
        uint16_t tcp_port;
        uint16_t ethercat_address;
        uint32_t baudrate;
    } comm_config;

    // 系统配置
    struct {
        uint16_t system_id;
        char device_name[32];
        char version[16];
        uint32_t config_crc;
        uint32_t config_version;
    } system_config;
} system_configuration_t;
```

#### 2.8.2 参数存储
```c
// EEPROM/Flash存储管理
typedef struct {
    uint32_t base_address;        // 基地址
    uint32_t sector_size;         // 扇区大小
    uint32_t backup_address;      // 备份地址
    bool write_protection;        // 写保护
} config_storage_t;

// 配置管理接口
typedef enum {
    CONFIG_LOAD_DEFAULT,          // 加载默认配置
    CONFIG_LOAD_FROM_STORAGE,     // 从存储加载
    CONFIG_SAVE_TO_STORAGE,       // 保存到存储
    CONFIG_BACKUP,                // 备份配置
    CONFIG_RESTORE,               // 恢复配置
    CONFIG_VALIDATE,              // 验证配置
} config_operation_t;
```

## 3. 中间件层设计

### 3.1 PID控制器
```c
typedef struct {
    float (*compute)(pid_controller_t* pid, float input);
    void (*set_tunings)(pid_controller_t* pid, float kp, float ki, float kd);
    void (*set_output_limits)(pid_controller_t* pid, float min, float max);
    void (*set_mode)(pid_controller_t* pid, bool automatic);
    void (*initialize)(pid_controller_t* pid);
} pid_interface_t;
```

### 3.2 数字滤波器
```c
typedef struct {
    float (*moving_average)(moving_average_filter_t* filter, float input);
    float (*kalman_filter)(kalman_filter_t* filter, float measurement);
    float (*low_pass_filter)(float input, float prev_output, float alpha);
    float (*median_filter)(float* buffer, uint8_t size);
} filter_interface_t;
```

### 3.3 任务管理器
```c
typedef struct {
    TaskHandle_t handle;
    char name[16];
    uint32_t stack_size;
    UBaseType_t priority;
    uint32_t run_count;
    uint32_t max_execution_time;
    uint32_t avg_execution_time;
    bool enabled;
} task_info_t;

typedef struct {
    task_info_t tasks[10];
    uint8_t task_count;
    uint32_t system_tick;
    uint32_t cpu_usage;
    uint32_t free_heap;
} task_manager_t;
```

## 4. 系统集成

### 4.1 启动序列
```c
typedef enum {
    BOOT_STAGE_HARDWARE_INIT,     // 硬件初始化
    BOOT_STAGE_RTOS_INIT,         // RTOS初始化
    BOOT_STAGE_MIDDLEWARE_INIT,   // 中间件初始化
    BOOT_STAGE_APP_INIT,          // 应用初始化
    BOOT_STAGE_SELF_TEST,         // 自检
    BOOT_STAGE_READY,             // 准备就绪
} boot_stage_t;
```

### 4.2 错误处理
```c
typedef enum {
    ERROR_NONE = 0,
    ERROR_SENSOR_FAULT,
    ERROR_ACTUATOR_FAULT,
    ERROR_COMMUNICATION_FAULT,
    ERROR_SAFETY_VIOLATION,
    ERROR_SYSTEM_OVERLOAD,
    ERROR_CONFIG_INVALID,
    ERROR_HARDWARE_FAULT,
} system_error_t;

typedef struct {
    system_error_t error_code;
    uint32_t timestamp;
    char description[64];
    uint8_t severity;             // 0-3: 信息,警告,错误,严重
    bool acknowledged;
} error_record_t;
```

### 4.3 性能监控
```c
typedef struct {
    uint32_t cpu_usage_percent;
    uint32_t memory_usage_bytes;
    uint32_t free_stack_min[10];  // 各任务最小剩余栈
    uint32_t task_switch_count;
    uint32_t interrupt_count;
    uint32_t max_interrupt_time;
} performance_metrics_t;
```

## 5. 测试与验证

### 5.1 单元测试
- 各传感器数据采集精度测试
- PID控制器响应特性测试
- 安全监控功能测试
- 通信协议正确性测试

### 5.2 集成测试
- 多任务协同工作测试
- 实时性能测试
- 故障恢复测试
- 长期稳定性测试

### 5.3 系统测试
- 完整工艺流程测试
- 极限工况测试
- 电磁兼容性测试
- 安全认证测试

---

*本文档版本: v1.0*
*最后更新: 2025-09-28*