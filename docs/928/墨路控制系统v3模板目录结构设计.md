# å¢¨è·¯æ§åˆ¶ç³»ç»Ÿv3æ¨¡æ¿ç›®å½•ç»“æ„è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºç°æœ‰`ink_supply_template_simple`ç»“æ„ï¼Œç»“åˆè®¾è®¡æ–‡æ¡£v2çš„å››å±‚æ¶æ„è¦æ±‚ï¼Œåˆ¶å®šv3æ¨¡æ¿ç›®å½•ç»“æ„ã€‚v3ç‰ˆæœ¬å……åˆ†è€ƒè™‘ç°æœ‰ç»“æ„çš„çº¦æŸï¼Œåœ¨ä¸ç ´åç°æœ‰ç»“æ„çš„åŸºç¡€ä¸Šï¼Œå®ç°è®¾è®¡æ–‡æ¡£v2çš„åˆ†å±‚ç†å¿µã€‚

## 2. ç°æœ‰ç»“æ„åˆ†æä¸v2è®¾è®¡çš„å¯¹æ¯”

### 2.1 ç°æœ‰ink_supply_template_simpleç»“æ„
```
ink_supply_template_simple/
â”œâ”€â”€ USER/          # ç”¨æˆ·åº”ç”¨å±‚ + å·¥ç¨‹é…ç½®
â”œâ”€â”€ drivers/       # å¤–è®¾é©±åŠ¨å±‚ (å¯¹åº”v2çš„drivers/)
â”œâ”€â”€ middleware/    # ç³»ç»Ÿä¸­é—´ä»¶ (å¯¹åº”v2çš„middleware/)
â”œâ”€â”€ lib/           # å‚å•†HALåº“ (å¯¹åº”v2çš„lib/)
â”œâ”€â”€ app/           # åº”ç”¨å±‚ (ç©ºï¼Œå¾…å¡«å……)
â”œâ”€â”€ hal/           # è‡ªå®šä¹‰HALæŠ½è±¡å±‚ (ç©ºï¼Œå¾…å¡«å……)
â”œâ”€â”€ include/       # å¤´æ–‡ä»¶ç›®å½• (ç©ºï¼Œå¾…å¡«å……)
â”œâ”€â”€ config/        # é…ç½®æ–‡ä»¶ç›®å½•
â”œâ”€â”€ OBJ/           # ç¼–è¯‘è¾“å‡º
â””â”€â”€ USMART/        # è°ƒè¯•å·¥å…·
```

### 2.2 v2è®¾è®¡å››å±‚æ¶æ„æ˜ å°„åˆ°ç°æœ‰ç»“æ„
| v2è®¾è®¡å±‚æ¬¡ | ç°æœ‰ç»“æ„å¯¹åº” | v3è°ƒæ•´æ–¹æ¡ˆ | è¯´æ˜ |
|-----------|-------------|-----------|------|
| åº”ç”¨å±‚ (src/app/) | `app/` + `USER/main.c` | æ‰©å……`app/`ç›®å½• | ä¿ç•™USER/é…ç½®ï¼Œmain.cè¿ç§»åˆ°app/ |
| ä¸­é—´ä»¶å±‚ (src/middleware/) | `middleware/` | æ‰©å……ç°æœ‰middleware/ | ä¿æŒç°æœ‰ç»“æ„ï¼Œå¢åŠ PIDã€æ»¤æ³¢ç­‰ |
| HALå±‚ (src/hal/) | `hal/` | å¡«å……hal/ç›®å½• | åŸºäºlib/å°è£…é¡¹ç›®ä¸“ç”¨HAL |
| é©±åŠ¨å±‚ (src/drivers/) | `drivers/` | æ‰©å……ç°æœ‰drivers/ | ä¿æŒç°æœ‰ç»“æ„ï¼ŒæŒ‰ä¼ æ„Ÿå™¨/æ‰§è¡Œå™¨åˆ†ç±» |

## 3. v3æ¨¡æ¿å®Œæ•´ç›®å½•ç»“æ„

### 3.1 è°ƒæ•´åçš„å®Œæ•´ç›®å½•æ ‘
```
ink_supply_gd32f427_v3/
â”œâ”€â”€ ğŸ“ app/                                # åº”ç”¨å±‚ (æ‰©å……ç°æœ‰app/)
â”‚   â”œâ”€â”€ ğŸ“„ main.c                          # ä¸»ç¨‹åº (ä»USER/è¿ç§»)
â”‚   â”œâ”€â”€ ğŸ“„ app_main.c/h                    # åº”ç”¨ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ ğŸ“„ sensor_task.c/h                 # ä¼ æ„Ÿå™¨ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ actuator_task.c/h               # æ‰§è¡Œå™¨ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ control_task.c/h                # æ§åˆ¶ä»»åŠ¡ (PIDæ§åˆ¶)
â”‚   â”œâ”€â”€ ğŸ“„ safety_task.c/h                 # å®‰å…¨ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ hmi_task.c/h                    # HMIä»»åŠ¡ (LCD+LED)
â”‚   â”œâ”€â”€ ğŸ“„ comm_task.c/h                   # é€šä¿¡ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ config_task.c/h                 # é…ç½®ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ ethercat_app.c/h                # EtherCATåº”ç”¨
â”‚   â””â”€â”€ ğŸ“„ tcp_server.c/h                  # TCPæœåŠ¡å™¨
â”‚
â”œâ”€â”€ ğŸ“ hal/                                # HALæŠ½è±¡å±‚ (å¡«å……ç°æœ‰hal/)
â”‚   â”œâ”€â”€ ğŸ“„ hal_common.c/h                  # HALå…¬å…±åŠŸèƒ½
â”‚   â”œâ”€â”€ ğŸ“„ hal_manager.c/h                 # HALç®¡ç†å™¨
â”‚   â”œâ”€â”€ ğŸ“„ adc_hal.c/h                     # ADCç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ pwm_hal.c/h                     # PWMç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ gpio_hal.c/h                    # GPIOç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ uart_hal.c/h                    # UARTç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ spi_hal.c/h                     # SPIç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ i2c_hal.c/h                     # I2Cç¡¬ä»¶æŠ½è±¡ (å°è£…ç°æœ‰IIC)
â”‚   â”œâ”€â”€ ğŸ“„ eth_hal.c/h                     # ä»¥å¤ªç½‘ç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ flash_hal.c/h                   # Flashç¡¬ä»¶æŠ½è±¡
â”‚   â””â”€â”€ ğŸ“„ timer_hal.c/h                   # å®šæ—¶å™¨ç¡¬ä»¶æŠ½è±¡
â”‚
â”œâ”€â”€ ğŸ“ middleware/                         # ä¸­é—´ä»¶å±‚ (æ‰©å……ç°æœ‰middleware/)
â”‚   â”œâ”€â”€ ğŸ“ delay/                          # å»¶æ—¶åŠŸèƒ½ (ä¿æŒç°æœ‰)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ delay.c/h                   # å»¶æ—¶å®ç°
â”‚   â”œâ”€â”€ ğŸ“ sys/                            # ç³»ç»ŸåŠŸèƒ½ (ä¿æŒç°æœ‰)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ sys.c/h                     # ç³»ç»Ÿé…ç½®
â”‚   â”œâ”€â”€ ğŸ“ usart/                          # ä¸²å£åŠŸèƒ½ (ä¿æŒç°æœ‰)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ usart.c/h                   # ä¸²å£é©±åŠ¨
â”‚   â”œâ”€â”€ ğŸ“„ middleware_common.c/h           # ä¸­é—´ä»¶å…¬å…±åŠŸèƒ½
â”‚   â”œâ”€â”€ ğŸ“„ tasks.c/h                       # FreeRTOSä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ ğŸ“„ pid.c/h                         # PIDç®—æ³•å®ç°
â”‚   â”œâ”€â”€ ğŸ“„ filter.c/h                      # æ•°å­—æ»¤æ³¢ç®—æ³•
â”‚   â””â”€â”€ ğŸ“„ protocol.c/h                    # é€šä¿¡åè®®è§£æ
â”‚
â”œâ”€â”€ ğŸ“ drivers/                            # é©±åŠ¨å±‚ (æ‰©å……ç°æœ‰drivers/)
â”‚   â”œâ”€â”€ ğŸ“ sensors/                        # ä¼ æ„Ÿå™¨é©±åŠ¨ (æ–°å¢åˆ†ç±»)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ frd8061_driver.c/h          # FRD8061æ¶²ä½ä¼ æ„Ÿå™¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ftt518_driver.c/h           # FTT518æ¸©åº¦ä¼ æ„Ÿå™¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ hp10my_driver.c/h           # HP10MYå‹åŠ›ä¼ æ„Ÿå™¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ sensor_common.c/h           # ä¼ æ„Ÿå™¨å…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ actuators/                      # æ‰§è¡Œå™¨é©±åŠ¨ (æ–°å¢åˆ†ç±»)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ mra23d3_driver.c/h          # MRA23D3ç”µæœºé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ mpb025bbb_driver.c/h        # MPB025BBBæ³µé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ valve_control.c/h           # é˜€é—¨æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ led_control.c/h             # LEDæ§åˆ¶ (ä»ç°æœ‰LED/è¿ç§»)
â”‚   â”‚   â””â”€â”€ ğŸ“„ actuator_common.c/h         # æ‰§è¡Œå™¨å…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ display/                        # æ˜¾ç¤ºé©±åŠ¨ (é‡ç»„ç°æœ‰LCD/)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ lcd_driver.c/h              # LCDé©±åŠ¨ (ä»ç°æœ‰LCD/è¿ç§»)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ oled_driver.c/h             # OLEDé©±åŠ¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ display_common.c/h          # æ˜¾ç¤ºå…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ input/                          # è¾“å…¥è®¾å¤‡é©±åŠ¨ (é‡ç»„ç°æœ‰KEY/)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ key_driver.c/h              # æŒ‰é”®é©±åŠ¨ (ä»ç°æœ‰KEY/è¿ç§»)
â”‚   â”‚   â””â”€â”€ ğŸ“„ input_common.c/h            # è¾“å…¥å…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ storage/                        # å­˜å‚¨é©±åŠ¨ (é‡ç»„ç°æœ‰24CXX/)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ 24cxx_driver.c/h            # EEPROMé©±åŠ¨ (ä»ç°æœ‰24CXX/è¿ç§»)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ flash_driver.c/h            # å†…éƒ¨Flashé©±åŠ¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ storage_common.c/h          # å­˜å‚¨å…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ communication/                  # é€šä¿¡é©±åŠ¨ (é‡ç»„ç°æœ‰IIC/)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ iic_driver.c/h              # I2Cé©±åŠ¨ (ä»ç°æœ‰IIC/è¿ç§»)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ can_driver.c/h              # CANé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ethernet_driver.c/h         # ä»¥å¤ªç½‘é©±åŠ¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ comm_common.c/h             # é€šä¿¡å…¬å…±æ¥å£
â”‚   â””â”€â”€ ğŸ“„ driver_manager.c/h              # é©±åŠ¨ç®¡ç†å™¨
â”‚
â”œâ”€â”€ ğŸ“ lib/                                # ç¬¬ä¸‰æ–¹åº“ (ä¿æŒç°æœ‰ç»“æ„)
â”‚   â”œâ”€â”€ ğŸ“ STM32F4xx_HAL_Driver/           # STM32 HALåº“ (ä¿æŒç°æœ‰)
â”‚   â”‚   â”œâ”€â”€ ğŸ“ Inc/                        # HALåº“å¤´æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ ğŸ“ Src/                        # HALåº“æºæ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ CMSIS/                          # ARM CMSISåº“ (ä¿æŒç°æœ‰)
â”‚   â”œâ”€â”€ ğŸ“ FreeRTOS/                       # FreeRTOSå®æ—¶æ“ä½œç³»ç»Ÿ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ ğŸ“ Source/                     # RTOSæºç 
â”‚   â”‚   â””â”€â”€ ğŸ“ portable/                   # GD32F427ç§»æ¤å±‚
â”‚   â”œâ”€â”€ ğŸ“ lwip/                           # lwIPç½‘ç»œåè®®æ ˆ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ ğŸ“ src/                        # lwIPæºç 
â”‚   â”‚   â””â”€â”€ ğŸ“ port/                       # GD32F427ç§»æ¤ä»£ç 
â”‚   â””â”€â”€ ğŸ“ ethercat/                       # EtherCATå¼€æºåº“ (æ–°å¢)
â”‚       â”œâ”€â”€ ğŸ“ master/                     # ä¸»ç«™åº“
â”‚       â””â”€â”€ ğŸ“ slave/                      # ä»ç«™åº“
â”‚
â”œâ”€â”€ ğŸ“ include/                            # å¤´æ–‡ä»¶ç›®å½• (å¡«å……ç°æœ‰include/)
â”‚   â”œâ”€â”€ ğŸ“ app/                            # åº”ç”¨å±‚å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ hal/                            # HALå±‚å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ middleware/                     # ä¸­é—´ä»¶å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ drivers/                        # é©±åŠ¨å±‚å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ common/                         # å…¬å…±å¤´æ–‡ä»¶
â”‚   â””â”€â”€ ğŸ“„ project_config.h                # é¡¹ç›®å…¨å±€é…ç½®
â”‚
â”œâ”€â”€ ğŸ“ config/                             # é…ç½®æ–‡ä»¶ (æ‰©å……ç°æœ‰config/)
â”‚   â”œâ”€â”€ ğŸ“„ FreeRTOSConfig.h                # FreeRTOSé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ lwipopts.h                      # lwIPé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ gd32f4xx_hal_conf.h            # GD32 HALé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ system_config.h                 # ç³»ç»Ÿå‚æ•°é…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ app_config.h                    # åº”ç”¨é…ç½®
â”‚   â””â”€â”€ ğŸ“„ sensor_config.h                 # ä¼ æ„Ÿå™¨é…ç½®
â”‚
â”œâ”€â”€ ğŸ“ USER/                               # å·¥ç¨‹é…ç½®å±‚ (ä¿æŒç°æœ‰ï¼Œç®€åŒ–å†…å®¹)
â”‚   â”œâ”€â”€ ğŸ“ DebugConfig/                    # è°ƒè¯•é…ç½® (ä¿æŒ)
â”‚   â”œâ”€â”€ ğŸ“„ gd32f407xx.h                    # GD32F407å®šä¹‰ (ä¿æŒ)
â”‚   â”œâ”€â”€ ğŸ“„ gd32f4xx.h                      # GD32F4xxæ€»å¤´æ–‡ä»¶ (ä¿æŒ)
â”‚   â”œâ”€â”€ ğŸ“„ gd32f4xx_it.c/h                # ä¸­æ–­æœåŠ¡å‡½æ•° (ä¿æŒ)
â”‚   â”œâ”€â”€ ğŸ“„ stm32f4xx_hal_conf.h           # HALé…ç½® (ä¿æŒ)
â”‚   â”œâ”€â”€ ğŸ“„ stm32f4xx_hal_msp.c            # HAL MSPé…ç½® (ä¿æŒ)
â”‚   â”œâ”€â”€ ğŸ“„ system_gd32f4xx.c/h            # ç³»ç»Ÿæ—¶é’Ÿé…ç½® (ä¿æŒ)
â”‚   â”œâ”€â”€ ğŸ“„ InkSupplySystem.uvprojx         # Keilå·¥ç¨‹æ–‡ä»¶ (ä¿æŒ)
â”‚   â””â”€â”€ ğŸ“„ main.h                          # ä¸»ç¨‹åºå¤´æ–‡ä»¶ (ç®€åŒ–ï¼Œå®é™…main.cåœ¨app/)
â”‚
â”œâ”€â”€ ğŸ“ USMART/                             # è°ƒè¯•å·¥å…· (ä¿æŒç°æœ‰)
â”‚   â”œâ”€â”€ ğŸ“„ usmart.c/h                      # USMARTæ ¸å¿ƒ
â”‚   â”œâ”€â”€ ğŸ“„ usmart_config.c                 # USMARTé…ç½®
â”‚   â””â”€â”€ ğŸ“„ usmart_str.c/h                  # å­—ç¬¦ä¸²å¤„ç†
â”‚
â”œâ”€â”€ ğŸ“ docs/                               # æ–‡æ¡£ç›®å½• (æ–°å¢)
â”‚   â”œâ”€â”€ ğŸ“„ design_v3.md                    # v3è®¾è®¡æ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ“„ api_reference.md                # APIå‚è€ƒæ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ“„ migration_guide.md              # è¿ç§»æŒ‡å—
â”‚   â””â”€â”€ ğŸ“„ development_guide.md            # å¼€å‘æŒ‡å—
â”‚
â”œâ”€â”€ ğŸ“ tools/                              # å·¥å…·ç›®å½• (æ–°å¢)
â”‚   â”œâ”€â”€ ğŸ“„ build.py                        # æ„å»ºè„šæœ¬
â”‚   â””â”€â”€ ğŸ“„ config_generator.py             # é…ç½®ç”Ÿæˆå·¥å…·
â”‚
â”œâ”€â”€ ğŸ“ OBJ/                                # ç¼–è¯‘è¾“å‡º (ä¿æŒç°æœ‰)
â”‚   â”œâ”€â”€ ğŸ“ Debug/                          # è°ƒè¯•ç‰ˆæœ¬
â”‚   â””â”€â”€ ğŸ“ Release/                        # å‘å¸ƒç‰ˆæœ¬
â”‚
â”œâ”€â”€ ğŸ“„ README.md                           # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ ğŸ“„ CHANGELOG.md                        # ç‰ˆæœ¬å˜æ›´æ—¥å¿—
â”œâ”€â”€ ğŸ“„ CMakeLists.txt                      # CMakeæ„å»ºæ”¯æŒ (æ–°å¢)
â””â”€â”€ ğŸ“„ .gitignore                          # Gitå¿½ç•¥é…ç½®
```

## 4. v3æ¨¡æ¿çš„å…³é”®è°ƒæ•´ç­–ç•¥

### 4.1 ä¿æŒç°æœ‰ç»“æ„ç¨³å®šæ€§
**ä¿æŒä¸å˜çš„éƒ¨åˆ†ï¼š**
- `USER/` - å·¥ç¨‹é…ç½®å’Œç³»ç»Ÿæ–‡ä»¶ä¿æŒåŸæœ‰ç»“æ„
- `lib/STM32F4xx_HAL_Driver/` - å‚å•†HALåº“ä¿æŒä¸å˜
- `USMART/` - è°ƒè¯•å·¥å…·ä¿æŒä¸å˜
- `OBJ/` - ç¼–è¯‘è¾“å‡ºä¿æŒä¸å˜
- `middleware/delay/`, `middleware/sys/`, `middleware/usart/` - ç°æœ‰ä¸­é—´ä»¶ä¿æŒä¸å˜

### 4.2 æ¸è¿›å¼æ‰©å±•ç­–ç•¥
**å¡«å……ç©ºç›®å½•ï¼š**
- `app/` - ä»ç©ºç›®å½•æ‰©å±•ä¸ºå®Œæ•´åº”ç”¨å±‚
- `hal/` - ä»ç©ºç›®å½•æ‰©å±•ä¸ºHALæŠ½è±¡å±‚
- `include/` - ä»ç©ºç›®å½•æ‰©å±•ä¸ºå¤´æ–‡ä»¶ç®¡ç†

**é‡ç»„ç°æœ‰é©±åŠ¨ï¼š**
```
ç°æœ‰drivers/LED/     â†’ drivers/actuators/led_control.c/h
ç°æœ‰drivers/KEY/     â†’ drivers/input/key_driver.c/h
ç°æœ‰drivers/LCD/     â†’ drivers/display/lcd_driver.c/h
ç°æœ‰drivers/IIC/     â†’ drivers/communication/iic_driver.c/h
ç°æœ‰drivers/24CXX/   â†’ drivers/storage/24cxx_driver.c/h
```

### 4.3 åˆ†å±‚æ¶æ„å®ç°
```
åº”ç”¨å±‚    â”‚ app/ + USER/main.c            # åº”ç”¨é€»è¾‘å’Œå·¥ç¨‹é…ç½®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
HALæŠ½è±¡å±‚ â”‚ hal/                          # é¡¹ç›®ä¸“ç”¨HALæŠ½è±¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä¸­é—´ä»¶å±‚  â”‚ middleware/ (ç°æœ‰+æ‰©å±•)         # ç³»ç»ŸæœåŠ¡å’Œç®—æ³•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é©±åŠ¨å±‚    â”‚ drivers/ (é‡ç»„+æ‰©å±•)           # è®¾å¤‡é©±åŠ¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åº“å±‚      â”‚ lib/ (ç°æœ‰+æ–°å¢)              # å‚å•†åº“å’Œç¬¬ä¸‰æ–¹åº“
```

## 5. è¿ç§»å’Œå®æ–½è®¡åˆ’

### 5.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„è°ƒæ•´ (1-2å‘¨)
**ç›®æ ‡ï¼š** å»ºç«‹å››å±‚æ¶æ„æ¡†æ¶ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½

1. **åˆ›å»ºåº”ç”¨å±‚ç»“æ„**
   ```bash
   # åˆ›å»ºappç›®å½•ä¸‹çš„æ–‡ä»¶
   app/main.c           # ä»USER/main.cè¿ç§»ä¸»è¦é€»è¾‘
   app/app_main.c/h     # åº”ç”¨ä¸»ç¨‹åºæ¡†æ¶
   ```

2. **å»ºç«‹HALæŠ½è±¡å±‚**
   ```bash
   # åˆ›å»ºhalç›®å½•ä¸‹çš„åŸºç¡€æ–‡ä»¶
   hal/hal_common.c/h   # å…¬å…±å®šä¹‰å’Œæ¥å£
   hal/gpio_hal.c/h     # åŸºäºlib/HALçš„GPIOæŠ½è±¡
   hal/uart_hal.c/h     # åŸºäºlib/HALçš„UARTæŠ½è±¡
   ```

3. **é‡ç»„ç°æœ‰é©±åŠ¨**
   ```bash
   # åˆ›å»ºæ–°çš„é©±åŠ¨åˆ†ç±»ç›®å½•ï¼Œä¿æŒåŸæœ‰é©±åŠ¨åŠŸèƒ½
   mkdir drivers/actuators drivers/sensors drivers/display
   mkdir drivers/input drivers/storage drivers/communication
   ```

### 5.2 ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½æ¨¡å—å¼€å‘ (2-3å‘¨)
**ç›®æ ‡ï¼š** å®ç°ä¼ æ„Ÿå™¨ã€æ‰§è¡Œå™¨ã€æ§åˆ¶ç®—æ³•ç­‰æ ¸å¿ƒåŠŸèƒ½

1. **å¼€å‘ä¼ æ„Ÿå™¨é©±åŠ¨**
   ```
   drivers/sensors/frd8061_driver.c/h    # FRD8061æ¶²ä½ä¼ æ„Ÿå™¨
   drivers/sensors/ftt518_driver.c/h     # FTT518æ¸©åº¦ä¼ æ„Ÿå™¨
   drivers/sensors/hp10my_driver.c/h     # HP10MYå‹åŠ›ä¼ æ„Ÿå™¨
   ```

2. **å¼€å‘æ‰§è¡Œå™¨é©±åŠ¨**
   ```
   drivers/actuators/mra23d3_driver.c/h    # MRA23D3ç”µæœº
   drivers/actuators/mpb025bbb_driver.c/h  # MPB025BBBæ³µ
   drivers/actuators/valve_control.c/h     # é˜€é—¨æ§åˆ¶
   ```

3. **å®ç°æ§åˆ¶ç®—æ³•**
   ```
   middleware/pid.c/h       # PIDæ§åˆ¶ç®—æ³•
   middleware/filter.c/h    # æ•°å­—æ»¤æ³¢ç®—æ³•
   ```

### 5.3 ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½é›†æˆ (2-3å‘¨)
**ç›®æ ‡ï¼š** é›†æˆé€šä¿¡åè®®ã€å®‰å…¨æœºåˆ¶ã€HMIç­‰é«˜çº§åŠŸèƒ½

1. **é€šä¿¡ç³»ç»Ÿå¼€å‘**
   ```
   app/ethercat_app.c/h     # EtherCATåº”ç”¨
   app/tcp_server.c/h       # TCPæœåŠ¡å™¨
   middleware/protocol.c/h  # åè®®è§£æ
   ```

2. **å®‰å…¨å’Œç›‘æ§ç³»ç»Ÿ**
   ```
   app/safety_task.c/h      # å®‰å…¨ç›‘æ§ä»»åŠ¡
   app/hmi_task.c/h         # äººæœºç•Œé¢ä»»åŠ¡
   ```

3. **ç¬¬ä¸‰æ–¹åº“é›†æˆ**
   ```
   lib/FreeRTOS/           # å®æ—¶æ“ä½œç³»ç»Ÿ
   lib/lwip/               # ç½‘ç»œåè®®æ ˆ
   lib/ethercat/           # EtherCATåº“
   ```

## 6. v3æ¨¡æ¿ä¼˜åŠ¿ç‰¹ç‚¹

### 6.1 å…¼å®¹æ€§ä¼˜åŠ¿
- **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰USER/ã€USMART/ã€lib/ç»“æ„ä¸å˜
- **æ¸è¿›è¿ç§»**ï¼šå¯é€æ­¥è¿ç§»åŠŸèƒ½ï¼Œä¸å½±å“ç°æœ‰ä»£ç 
- **å·¥å…·æ”¯æŒ**ï¼šç»§ç»­ä½¿ç”¨ç°æœ‰Keilå·¥ç¨‹å’ŒUSMARTè°ƒè¯•

### 6.2 æ¶æ„ä¼˜åŠ¿
- **å››å±‚åˆ†ç¦»**ï¼šå®ç°v2è®¾è®¡çš„åˆ†å±‚æ¶æ„ç†å¿µ
- **æ¨¡å—åŒ–**ï¼šé©±åŠ¨æŒ‰åŠŸèƒ½åˆ†ç±»ï¼Œä¾¿äºç®¡ç†å’Œæ‰©å±•
- **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„æ¥å£è®¾è®¡ï¼Œæé«˜ä»£ç å¤ç”¨æ€§

### 6.3 æ‰©å±•ä¼˜åŠ¿
- **ç¡¬ä»¶é€‚é…**ï¼šHALæŠ½è±¡å±‚ä¾¿äºç§»æ¤åˆ°å…¶ä»–MCU
- **åŠŸèƒ½æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡æ˜“äºæ·»åŠ æ–°ä¼ æ„Ÿå™¨/æ‰§è¡Œå™¨
- **åè®®æ”¯æŒ**ï¼šæ”¯æŒå¤šç§é€šä¿¡åè®®å’Œç½‘ç»œåŠŸèƒ½

### 6.4 ç»´æŠ¤ä¼˜åŠ¿
- **æ–‡æ¡£å®Œæ•´**ï¼šåŒ…å«å®Œæ•´çš„å¼€å‘å’Œè¿ç§»æŒ‡å—
- **è°ƒè¯•ä¾¿åˆ©**ï¼šä¿æŒUSMARTè°ƒè¯•å·¥å…·ï¼Œå¢åŠ æ—¥å¿—ç³»ç»Ÿ
- **ç‰ˆæœ¬ç®¡ç†**ï¼šé‡‡ç”¨Gitè¿›è¡Œç‰ˆæœ¬æ§åˆ¶

## 7. å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ

### 7.1 ç¼–ç è§„èŒƒ
```c
// æ–‡ä»¶å‘½åè§„èŒƒ
sensor_task.c/h         // æ¨¡å—å_åŠŸèƒ½å
frd8061_driver.c/h      // è®¾å¤‡å‹å·_driver

// å‡½æ•°å‘½åè§„èŒƒ
hal_gpio_init()         // å±‚æ¬¡å‰ç¼€_æ¨¡å—_åŠŸèƒ½
sensor_read_temperature() // æ¨¡å—_åŠ¨ä½œ_å¯¹è±¡

// å˜é‡å‘½åè§„èŒƒ
g_sensor_data          // å…¨å±€å˜é‡å‰ç¼€g_
sensor_config_t        // ç±»å‹åç¼€_t
SENSOR_MAX_COUNT       // å¸¸é‡å…¨å¤§å†™
```

### 7.2 æ¥å£è®¾è®¡åŸåˆ™
```c
// ç»Ÿä¸€çš„è¿”å›å€¼ç±»å‹
typedef enum {
    HAL_OK = 0,
    HAL_ERROR,
    HAL_BUSY,
    HAL_TIMEOUT
} hal_status_t;

// ç»Ÿä¸€çš„æ¥å£æ¨¡å¼
hal_status_t xxx_init(const xxx_config_t* config);
hal_status_t xxx_read(xxx_data_t* data);
hal_status_t xxx_write(const xxx_data_t* data);
hal_status_t xxx_control(uint32_t cmd, void* arg);
```

### 7.3 é”™è¯¯å¤„ç†ç­–ç•¥
```c
// ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
#define CHECK_PARAM(param) \
    do { if (!(param)) return HAL_ERROR; } while(0)

#define LOG_ERROR(msg, ...) \
    printf("[ERROR] %s:%d " msg "\r\n", __FILE__, __LINE__, ##__VA_ARGS__)

// ç¤ºä¾‹ä½¿ç”¨
hal_status_t sensor_read(sensor_type_t type, float* value)
{
    CHECK_PARAM(value != NULL);
    CHECK_PARAM(type < SENSOR_COUNT);

    if (sensor_status[type] != SENSOR_READY) {
        LOG_ERROR("Sensor %d not ready", type);
        return HAL_ERROR;
    }

    // å®é™…è¯»å–æ“ä½œ...
    return HAL_OK;
}
```

## 8. æ€»ç»“

v3æ¨¡æ¿è®¾è®¡å……åˆ†è€ƒè™‘äº†ç°æœ‰`ink_supply_template_simple`ç»“æ„çš„çº¦æŸï¼Œé€šè¿‡æ¸è¿›å¼æ‰©å±•çš„æ–¹å¼ï¼Œå®ç°äº†v2è®¾è®¡æ–‡æ¡£çš„å››å±‚æ¶æ„ç†å¿µã€‚

**ä¸»è¦ç‰¹ç‚¹ï¼š**
- âœ… **å…¼å®¹æ€§å¼º** - ä¿æŒç°æœ‰ç»“æ„ç¨³å®šï¼Œå‘åå…¼å®¹
- âœ… **æ¶æ„æ¸…æ™°** - å®ç°å››å±‚åˆ†ç¦»ï¼ŒèŒè´£æ˜ç¡®
- âœ… **æ‰©å±•çµæ´»** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºåŠŸèƒ½æ‰©å±•
- âœ… **å®æ–½å¯è¡Œ** - æ¸è¿›è¿ç§»ï¼Œé™ä½å¼€å‘é£é™©
- âœ… **å·¥å…·å®Œå¤‡** - ä¿æŒç°æœ‰è°ƒè¯•å·¥å…·ï¼Œå¢åŠ æ–°çš„å¼€å‘æ”¯æŒ

**é€‚ç”¨åœºæ™¯ï¼š**
- ğŸ¯ åŸºäºç°æœ‰template_simpleçš„å¢¨æ°´ä¾›åº”ç³»ç»Ÿå¼€å‘
- ğŸ¯ éœ€è¦ä¿æŒç°æœ‰ä»£ç å…¼å®¹æ€§çš„é¡¹ç›®å‡çº§
- ğŸ¯ æ¸è¿›å¼æ¶æ„é‡æ„å’ŒåŠŸèƒ½æ‰©å±•
- ğŸ¯ å¤šMCUå¹³å°çš„äº§å“å¼€å‘

é€šè¿‡v3æ¨¡æ¿ï¼Œå¼€å‘è€…å¯ä»¥åœ¨ä¿æŒç°æœ‰æŠ•èµ„çš„åŸºç¡€ä¸Šï¼Œé€æ­¥å®ç°æ›´å…ˆè¿›çš„ç³»ç»Ÿæ¶æ„å’ŒåŠŸèƒ½ç‰¹æ€§ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v3.0*
*åˆ›å»ºæ—¶é—´: 2025-09-29*
*åŸºäºink_supply_template_simpleç°æœ‰ç»“æ„å’Œè®¾è®¡æ–‡æ¡£v2éœ€æ±‚ç¼–å†™*