# 墨路控制系统v3模板目录结构设计文档

## 1. 概述

本文档基于现有`ink_supply_template_simple`结构，结合设计文档v2的四层架构要求，制定v3模板目录结构。v3版本充分考虑现有结构的约束，在不破坏现有结构的基础上，实现设计文档v2的分层理念。

## 2. 现有结构分析与v2设计的对比

### 2.1 现有ink_supply_template_simple结构
```
ink_supply_template_simple/
├── USER/          # 用户应用层 + 工程配置
├── drivers/       # 外设驱动层 (对应v2的drivers/)
├── middleware/    # 系统中间件 (对应v2的middleware/)
├── lib/           # 厂商HAL库 (对应v2的lib/)
├── app/           # 应用层 (空，待填充)
├── hal/           # 自定义HAL抽象层 (空，待填充)
├── include/       # 头文件目录 (空，待填充)
├── config/        # 配置文件目录
├── OBJ/           # 编译输出
└── USMART/        # 调试工具
```

### 2.2 v2设计四层架构映射到现有结构
| v2设计层次 | 现有结构对应 | v3调整方案 | 说明 |
|-----------|-------------|-----------|------|
| 应用层 (src/app/) | `app/` + `USER/main.c` | 扩充`app/`目录 | 保留USER/配置，main.c迁移到app/ |
| 中间件层 (src/middleware/) | `middleware/` | 扩充现有middleware/ | 保持现有结构，增加PID、滤波等 |
| HAL层 (src/hal/) | `hal/` | 填充hal/目录 | 基于lib/封装项目专用HAL |
| 驱动层 (src/drivers/) | `drivers/` | 扩充现有drivers/ | 保持现有结构，按传感器/执行器分类 |

## 3. v3模板完整目录结构

### 3.1 调整后的完整目录树
```
ink_supply_gd32f427_v3/
├── 📁 app/                                # 应用层 (扩充现有app/)
│   ├── 📄 main.c                          # 主程序 (从USER/迁移)
│   ├── 📄 app_main.c/h                    # 应用主程序
│   ├── 📄 sensor_task.c/h                 # 传感器任务
│   ├── 📄 actuator_task.c/h               # 执行器任务
│   ├── 📄 control_task.c/h                # 控制任务 (PID控制)
│   ├── 📄 safety_task.c/h                 # 安全任务
│   ├── 📄 hmi_task.c/h                    # HMI任务 (LCD+LED)
│   ├── 📄 comm_task.c/h                   # 通信任务
│   ├── 📄 config_task.c/h                 # 配置任务
│   ├── 📄 ethercat_app.c/h                # EtherCAT应用
│   └── 📄 tcp_server.c/h                  # TCP服务器
│
├── 📁 hal/                                # HAL抽象层 (填充现有hal/)
│   ├── 📄 hal_common.c/h                  # HAL公共功能
│   ├── 📄 hal_manager.c/h                 # HAL管理器
│   ├── 📄 adc_hal.c/h                     # ADC硬件抽象
│   ├── 📄 pwm_hal.c/h                     # PWM硬件抽象
│   ├── 📄 gpio_hal.c/h                    # GPIO硬件抽象
│   ├── 📄 uart_hal.c/h                    # UART硬件抽象
│   ├── 📄 spi_hal.c/h                     # SPI硬件抽象
│   ├── 📄 i2c_hal.c/h                     # I2C硬件抽象 (封装现有IIC)
│   ├── 📄 eth_hal.c/h                     # 以太网硬件抽象
│   ├── 📄 flash_hal.c/h                   # Flash硬件抽象
│   └── 📄 timer_hal.c/h                   # 定时器硬件抽象
│
├── 📁 middleware/                         # 中间件层 (扩充现有middleware/)
│   ├── 📁 delay/                          # 延时功能 (保持现有)
│   │   ├── 📄 delay.c/h                   # 延时实现
│   ├── 📁 sys/                            # 系统功能 (保持现有)
│   │   ├── 📄 sys.c/h                     # 系统配置
│   ├── 📁 usart/                          # 串口功能 (保持现有)
│   │   ├── 📄 usart.c/h                   # 串口驱动
│   ├── 📄 middleware_common.c/h           # 中间件公共功能
│   ├── 📄 tasks.c/h                       # FreeRTOS任务管理
│   ├── 📄 pid.c/h                         # PID算法实现
│   ├── 📄 filter.c/h                      # 数字滤波算法
│   └── 📄 protocol.c/h                    # 通信协议解析
│
├── 📁 drivers/                            # 驱动层 (扩充现有drivers/)
│   ├── 📁 sensors/                        # 传感器驱动 (新增分类)
│   │   ├── 📄 frd8061_driver.c/h          # FRD8061液位传感器
│   │   ├── 📄 ftt518_driver.c/h           # FTT518温度传感器
│   │   ├── 📄 hp10my_driver.c/h           # HP10MY压力传感器
│   │   └── 📄 sensor_common.c/h           # 传感器公共接口
│   ├── 📁 actuators/                      # 执行器驱动 (新增分类)
│   │   ├── 📄 mra23d3_driver.c/h          # MRA23D3电机驱动
│   │   ├── 📄 mpb025bbb_driver.c/h        # MPB025BBB泵驱动
│   │   ├── 📄 valve_control.c/h           # 阀门控制
│   │   ├── 📄 led_control.c/h             # LED控制 (从现有LED/迁移)
│   │   └── 📄 actuator_common.c/h         # 执行器公共接口
│   ├── 📁 display/                        # 显示驱动 (重组现有LCD/)
│   │   ├── 📄 lcd_driver.c/h              # LCD驱动 (从现有LCD/迁移)
│   │   ├── 📄 oled_driver.c/h             # OLED驱动
│   │   └── 📄 display_common.c/h          # 显示公共接口
│   ├── 📁 input/                          # 输入设备驱动 (重组现有KEY/)
│   │   ├── 📄 key_driver.c/h              # 按键驱动 (从现有KEY/迁移)
│   │   └── 📄 input_common.c/h            # 输入公共接口
│   ├── 📁 storage/                        # 存储驱动 (重组现有24CXX/)
│   │   ├── 📄 24cxx_driver.c/h            # EEPROM驱动 (从现有24CXX/迁移)
│   │   ├── 📄 flash_driver.c/h            # 内部Flash驱动
│   │   └── 📄 storage_common.c/h          # 存储公共接口
│   ├── 📁 communication/                  # 通信驱动 (重组现有IIC/)
│   │   ├── 📄 iic_driver.c/h              # I2C驱动 (从现有IIC/迁移)
│   │   ├── 📄 can_driver.c/h              # CAN驱动
│   │   ├── 📄 ethernet_driver.c/h         # 以太网驱动
│   │   └── 📄 comm_common.c/h             # 通信公共接口
│   └── 📄 driver_manager.c/h              # 驱动管理器
│
├── 📁 lib/                                # 第三方库 (保持现有结构)
│   ├── 📁 STM32F4xx_HAL_Driver/           # STM32 HAL库 (保持现有)
│   │   ├── 📁 Inc/                        # HAL库头文件
│   │   └── 📁 Src/                        # HAL库源文件
│   ├── 📁 CMSIS/                          # ARM CMSIS库 (保持现有)
│   ├── 📁 FreeRTOS/                       # FreeRTOS实时操作系统 (新增)
│   │   ├── 📁 Source/                     # RTOS源码
│   │   └── 📁 portable/                   # GD32F427移植层
│   ├── 📁 lwip/                           # lwIP网络协议栈 (新增)
│   │   ├── 📁 src/                        # lwIP源码
│   │   └── 📁 port/                       # GD32F427移植代码
│   └── 📁 ethercat/                       # EtherCAT开源库 (新增)
│       ├── 📁 master/                     # 主站库
│       └── 📁 slave/                      # 从站库
│
├── 📁 include/                            # 头文件目录 (填充现有include/)
│   ├── 📁 app/                            # 应用层头文件
│   ├── 📁 hal/                            # HAL层头文件
│   ├── 📁 middleware/                     # 中间件头文件
│   ├── 📁 drivers/                        # 驱动层头文件
│   ├── 📁 common/                         # 公共头文件
│   └── 📄 project_config.h                # 项目全局配置
│
├── 📁 config/                             # 配置文件 (扩充现有config/)
│   ├── 📄 FreeRTOSConfig.h                # FreeRTOS配置
│   ├── 📄 lwipopts.h                      # lwIP配置
│   ├── 📄 gd32f4xx_hal_conf.h            # GD32 HAL配置
│   ├── 📄 system_config.h                 # 系统参数配置
│   ├── 📄 app_config.h                    # 应用配置
│   └── 📄 sensor_config.h                 # 传感器配置
│
├── 📁 USER/                               # 工程配置层 (保持现有，简化内容)
│   ├── 📁 DebugConfig/                    # 调试配置 (保持)
│   ├── 📄 gd32f407xx.h                    # GD32F407定义 (保持)
│   ├── 📄 gd32f4xx.h                      # GD32F4xx总头文件 (保持)
│   ├── 📄 gd32f4xx_it.c/h                # 中断服务函数 (保持)
│   ├── 📄 stm32f4xx_hal_conf.h           # HAL配置 (保持)
│   ├── 📄 stm32f4xx_hal_msp.c            # HAL MSP配置 (保持)
│   ├── 📄 system_gd32f4xx.c/h            # 系统时钟配置 (保持)
│   ├── 📄 InkSupplySystem.uvprojx         # Keil工程文件 (保持)
│   └── 📄 main.h                          # 主程序头文件 (简化，实际main.c在app/)
│
├── 📁 USMART/                             # 调试工具 (保持现有)
│   ├── 📄 usmart.c/h                      # USMART核心
│   ├── 📄 usmart_config.c                 # USMART配置
│   └── 📄 usmart_str.c/h                  # 字符串处理
│
├── 📁 docs/                               # 文档目录 (新增)
│   ├── 📄 design_v3.md                    # v3设计文档
│   ├── 📄 api_reference.md                # API参考文档
│   ├── 📄 migration_guide.md              # 迁移指南
│   └── 📄 development_guide.md            # 开发指南
│
├── 📁 tools/                              # 工具目录 (新增)
│   ├── 📄 build.py                        # 构建脚本
│   └── 📄 config_generator.py             # 配置生成工具
│
├── 📁 OBJ/                                # 编译输出 (保持现有)
│   ├── 📁 Debug/                          # 调试版本
│   └── 📁 Release/                        # 发布版本
│
├── 📄 README.md                           # 项目说明
├── 📄 CHANGELOG.md                        # 版本变更日志
├── 📄 CMakeLists.txt                      # CMake构建支持 (新增)
└── 📄 .gitignore                          # Git忽略配置
```

## 4. v3模板的关键调整策略

### 4.1 保持现有结构稳定性
**保持不变的部分：**
- `USER/` - 工程配置和系统文件保持原有结构
- `lib/STM32F4xx_HAL_Driver/` - 厂商HAL库保持不变
- `USMART/` - 调试工具保持不变
- `OBJ/` - 编译输出保持不变
- `middleware/delay/`, `middleware/sys/`, `middleware/usart/` - 现有中间件保持不变

### 4.2 渐进式扩展策略
**填充空目录：**
- `app/` - 从空目录扩展为完整应用层
- `hal/` - 从空目录扩展为HAL抽象层
- `include/` - 从空目录扩展为头文件管理

**重组现有驱动：**
```
现有drivers/LED/     → drivers/actuators/led_control.c/h
现有drivers/KEY/     → drivers/input/key_driver.c/h
现有drivers/LCD/     → drivers/display/lcd_driver.c/h
现有drivers/IIC/     → drivers/communication/iic_driver.c/h
现有drivers/24CXX/   → drivers/storage/24cxx_driver.c/h
```

### 4.3 分层架构实现
```
应用层    │ app/ + USER/main.c            # 应用逻辑和工程配置
─────────┼─────────────────────────────────
HAL抽象层 │ hal/                          # 项目专用HAL抽象
─────────┼─────────────────────────────────
中间件层  │ middleware/ (现有+扩展)         # 系统服务和算法
─────────┼─────────────────────────────────
驱动层    │ drivers/ (重组+扩展)           # 设备驱动
─────────┼─────────────────────────────────
库层      │ lib/ (现有+新增)              # 厂商库和第三方库
```

## 5. 迁移和实施计划

### 5.1 第一阶段：基础架构调整 (1-2周)
**目标：** 建立四层架构框架，不破坏现有功能

1. **创建应用层结构**
   ```bash
   # 创建app目录下的文件
   app/main.c           # 从USER/main.c迁移主要逻辑
   app/app_main.c/h     # 应用主程序框架
   ```

2. **建立HAL抽象层**
   ```bash
   # 创建hal目录下的基础文件
   hal/hal_common.c/h   # 公共定义和接口
   hal/gpio_hal.c/h     # 基于lib/HAL的GPIO抽象
   hal/uart_hal.c/h     # 基于lib/HAL的UART抽象
   ```

3. **重组现有驱动**
   ```bash
   # 创建新的驱动分类目录，保持原有驱动功能
   mkdir drivers/actuators drivers/sensors drivers/display
   mkdir drivers/input drivers/storage drivers/communication
   ```

### 5.2 第二阶段：功能模块开发 (2-3周)
**目标：** 实现传感器、执行器、控制算法等核心功能

1. **开发传感器驱动**
   ```
   drivers/sensors/frd8061_driver.c/h    # FRD8061液位传感器
   drivers/sensors/ftt518_driver.c/h     # FTT518温度传感器
   drivers/sensors/hp10my_driver.c/h     # HP10MY压力传感器
   ```

2. **开发执行器驱动**
   ```
   drivers/actuators/mra23d3_driver.c/h    # MRA23D3电机
   drivers/actuators/mpb025bbb_driver.c/h  # MPB025BBB泵
   drivers/actuators/valve_control.c/h     # 阀门控制
   ```

3. **实现控制算法**
   ```
   middleware/pid.c/h       # PID控制算法
   middleware/filter.c/h    # 数字滤波算法
   ```

### 5.3 第三阶段：高级功能集成 (2-3周)
**目标：** 集成通信协议、安全机制、HMI等高级功能

1. **通信系统开发**
   ```
   app/ethercat_app.c/h     # EtherCAT应用
   app/tcp_server.c/h       # TCP服务器
   middleware/protocol.c/h  # 协议解析
   ```

2. **安全和监控系统**
   ```
   app/safety_task.c/h      # 安全监控任务
   app/hmi_task.c/h         # 人机界面任务
   ```

3. **第三方库集成**
   ```
   lib/FreeRTOS/           # 实时操作系统
   lib/lwip/               # 网络协议栈
   lib/ethercat/           # EtherCAT库
   ```

## 6. v3模板优势特点

### 6.1 兼容性优势
- **向后兼容**：保持现有USER/、USMART/、lib/结构不变
- **渐进迁移**：可逐步迁移功能，不影响现有代码
- **工具支持**：继续使用现有Keil工程和USMART调试

### 6.2 架构优势
- **四层分离**：实现v2设计的分层架构理念
- **模块化**：驱动按功能分类，便于管理和扩展
- **标准化**：统一的接口设计，提高代码复用性

### 6.3 扩展优势
- **硬件适配**：HAL抽象层便于移植到其他MCU
- **功能扩展**：模块化设计易于添加新传感器/执行器
- **协议支持**：支持多种通信协议和网络功能

### 6.4 维护优势
- **文档完整**：包含完整的开发和迁移指南
- **调试便利**：保持USMART调试工具，增加日志系统
- **版本管理**：采用Git进行版本控制

## 7. 开发规范和最佳实践

### 7.1 编码规范
```c
// 文件命名规范
sensor_task.c/h         // 模块名_功能名
frd8061_driver.c/h      // 设备型号_driver

// 函数命名规范
hal_gpio_init()         // 层次前缀_模块_功能
sensor_read_temperature() // 模块_动作_对象

// 变量命名规范
g_sensor_data          // 全局变量前缀g_
sensor_config_t        // 类型后缀_t
SENSOR_MAX_COUNT       // 常量全大写
```

### 7.2 接口设计原则
```c
// 统一的返回值类型
typedef enum {
    HAL_OK = 0,
    HAL_ERROR,
    HAL_BUSY,
    HAL_TIMEOUT
} hal_status_t;

// 统一的接口模式
hal_status_t xxx_init(const xxx_config_t* config);
hal_status_t xxx_read(xxx_data_t* data);
hal_status_t xxx_write(const xxx_data_t* data);
hal_status_t xxx_control(uint32_t cmd, void* arg);
```

### 7.3 错误处理策略
```c
// 统一的错误处理
#define CHECK_PARAM(param) \
    do { if (!(param)) return HAL_ERROR; } while(0)

#define LOG_ERROR(msg, ...) \
    printf("[ERROR] %s:%d " msg "\r\n", __FILE__, __LINE__, ##__VA_ARGS__)

// 示例使用
hal_status_t sensor_read(sensor_type_t type, float* value)
{
    CHECK_PARAM(value != NULL);
    CHECK_PARAM(type < SENSOR_COUNT);

    if (sensor_status[type] != SENSOR_READY) {
        LOG_ERROR("Sensor %d not ready", type);
        return HAL_ERROR;
    }

    // 实际读取操作...
    return HAL_OK;
}
```

## 8. 总结

v3模板设计充分考虑了现有`ink_supply_template_simple`结构的约束，通过渐进式扩展的方式，实现了v2设计文档的四层架构理念。

**主要特点：**
- ✅ **兼容性强** - 保持现有结构稳定，向后兼容
- ✅ **架构清晰** - 实现四层分离，职责明确
- ✅ **扩展灵活** - 模块化设计，易于功能扩展
- ✅ **实施可行** - 渐进迁移，降低开发风险
- ✅ **工具完备** - 保持现有调试工具，增加新的开发支持

**适用场景：**
- 🎯 基于现有template_simple的墨水供应系统开发
- 🎯 需要保持现有代码兼容性的项目升级
- 🎯 渐进式架构重构和功能扩展
- 🎯 多MCU平台的产品开发

通过v3模板，开发者可以在保持现有投资的基础上，逐步实现更先进的系统架构和功能特性。

---

*文档版本: v3.0*
*创建时间: 2025-09-29*
*基于ink_supply_template_simple现有结构和设计文档v2需求编写*