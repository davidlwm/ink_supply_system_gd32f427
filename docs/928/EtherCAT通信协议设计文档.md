# 墨路控制系统 EtherCAT 通信协议设计文档

## 1. 概述

### 1.1 文档说明
本文档定义了墨路控制系统的EtherCAT通信协议，包括从站设备描述、PDO映射、SDO对象字典以及具体的数据格式。

### 1.2 系统信息
- **设备名称**: 墨路控制系统从站
- **制造商**: 待定
- **设备类型**: 过程控制设备
- **EtherCAT协议版本**: CoE (CAN Application Protocol over EtherCAT)
- **主控芯片**: GD32F427

### 1.3 从站标识信息
| 参数 | 值 | 说明 |
|------|-----|------|
| Vendor ID | 0x00000001 | 厂商识别码 |
| Product Code | 0x00000100 | 产品代码 |
| Revision Number | 0x00010000 | 版本号 v1.0 |
| Serial Number | 唯一序列号 | 从Flash读取 |
| Device Name | "InkSupply_Slave" | 设备名称 |

---

## 2. PDO 映射设计

### 2.1 TxPDO (从站→主站) - 过程数据输出

#### 2.1.1 TxPDO 1 - 传感器数据 (0x1A00)
**数据周期**: 1ms
**总字节数**: 62 bytes

| 偏移 | 名称 | 类型 | 字节数 | 单位 | 范围 | 说明 |
|------|------|------|--------|------|------|------|
| 0 | 温度传感器1 | INT16 | 2 | 0.1°C | -500~3000 | FTT518 Pt100 温度1 |
| 2 | 温度传感器2 | INT16 | 2 | 0.1°C | -500~3000 | FTT518 Pt100 温度2 |
| 4 | 温度传感器3 | INT16 | 2 | 0.1°C | -500~3000 | FTT518 Pt100 温度3 |
| 6 | 压力传感器1 | UINT16 | 2 | 0.1kPa | 0~65535 | HP10MY 压力1 |
| 8 | 压力传感器2 | UINT16 | 2 | 0.1kPa | 0~65535 | HP10MY 压力2 |
| 10 | 压力传感器3 | UINT16 | 2 | 0.1kPa | 0~65535 | HP10MY 压力3 |
| 12 | 压力传感器4 | UINT16 | 2 | 0.1kPa | 0~65535 | HP10MY 压力4 |
| 14 | 液位传感器1 | UINT16 | 2 | 0.1mm | 0~5000 | FRD8061 液位1 |
| 16 | 液位传感器2 | UINT16 | 2 | 0.1mm | 0~5000 | FRD8061 液位2 |
| 18 | 液位传感器3 | UINT16 | 2 | 0.1mm | 0~5000 | FRD8061 液位3 |
| 20 | 模拟液位传感器 | UINT16 | 2 | 0.1mm | 0~5000 | 模拟量液位 |
| 22 | 流量传感器 | UINT16 | 2 | 0.01L/min | 0~65535 | I2C流量传感器 |
| 24 | 液位开关状态 | UINT16 | 2 | - | bit0~13 | 14路液位开关状态 |
| 26 | 执行器反馈1 | UINT16 | 2 | - | - | 电磁阀/泵状态 |
| 28 | 执行器反馈2 | UINT16 | 2 | - | - | 加热器状态 |
| 30 | 加热器1电流 | UINT16 | 2 | 0.01A | 0~5000 | 加热器1实际电流 |
| 32 | 加热器2电流 | UINT16 | 2 | 0.01A | 0~5000 | 加热器2实际电流 |
| 34 | 加热器3电流 | UINT16 | 2 | 0.01A | 0~5000 | 加热器3实际电流 |
| 36 | 调速泵1反馈 | UINT16 | 2 | 0.1% | 0~1000 | 泵1实际转速百分比 |
| 38 | 调速泵2反馈 | UINT16 | 2 | 0.1% | 0~1000 | 泵2实际转速百分比 |
| 40 | PID输出值1 | INT16 | 2 | 0.1% | -1000~1000 | 温度控制输出1 |
| 42 | PID输出值2 | INT16 | 2 | 0.1% | -1000~1000 | 温度控制输出2 |
| 44 | PID输出值3 | INT16 | 2 | 0.1% | -1000~1000 | 温度控制输出3 |
| 46 | 状态字 | UINT16 | 2 | - | - | 系统状态字 |
| 48 | 告警字1 | UINT16 | 2 | - | - | 告警信息1 |
| 50 | 告警字2 | UINT16 | 2 | - | - | 告警信息2 |
| 52 | 诊断计数器 | UINT32 | 4 | - | - | 任务循环计数 |
| 56 | 系统时间戳 | UINT32 | 4 | ms | - | 系统运行时间 |
| 60 | CRC校验 | UINT16 | 2 | - | - | PDO数据CRC16 |

**液位开关状态位定义 (偏移24)**:
```
Bit 0:  液位低位指示1
Bit 1:  液位高位指示1
Bit 2:  液位低位指示2
Bit 3:  液位高位指示2
Bit 4:  液位低位指示3
Bit 5:  液位高位指示3
Bit 6-13: 预留
```

**执行器反馈1位定义 (偏移26)**:
```
Bit 0:  电磁阀1状态 (1=开启)
Bit 1:  电磁阀2状态 (1=开启)
Bit 2:  直流泵1状态 (1=运行)
Bit 3:  直流泵2状态 (1=运行)
Bit 4:  调速泵1使能 (1=使能)
Bit 5:  调速泵2使能 (1=使能)
Bit 6-15: 预留
```

**执行器反馈2位定义 (偏移28)**:
```
Bit 0:  加热器1状态 (1=加热中)
Bit 1:  加热器2状态 (1=加热中)
Bit 2:  加热器3状态 (1=加热中)
Bit 3-15: 预留
```

**状态字定义 (偏移46)**:
```
Bit 0-2:  运行状态 (0=初始化, 1=就绪, 2=运行, 3=停止, 4=告警, 5=故障)
Bit 3:    安全模式 (1=安全模式激活)
Bit 4:    手动模式 (1=手动, 0=自动)
Bit 5:    配置有效 (1=配置已加载)
Bit 6:    自检通过 (1=自检OK)
Bit 7:    EtherCAT通信正常 (1=正常)
Bit 8:    传感器故障 (1=存在故障传感器)
Bit 9:    执行器故障 (1=存在故障执行器)
Bit 10:   超温告警 (1=存在超温)
Bit 11:   超压告警 (1=存在超压)
Bit 12:   液位异常 (1=存在液位异常)
Bit 13:   通信超时 (1=TCP通信超时)
Bit 14:   参数超限 (1=参数越界)
Bit 15:   系统错误 (1=系统级错误)
```

**告警字1定义 (偏移48)**:
```
Bit 0:  温度传感器1故障
Bit 1:  温度传感器2故障
Bit 2:  温度传感器3故障
Bit 3:  压力传感器1故障
Bit 4:  压力传感器2故障
Bit 5:  压力传感器3故障
Bit 6:  压力传感器4故障
Bit 7:  液位传感器1故障
Bit 8:  液位传感器2故障
Bit 9:  液位传感器3故障
Bit 10: 模拟液位传感器故障
Bit 11: 流量传感器故障
Bit 12: 温度1超限
Bit 13: 温度2超限
Bit 14: 温度3超限
Bit 15: 压力1超限
```

**告警字2定义 (偏移50)**:
```
Bit 0:  压力2超限
Bit 1:  压力3超限
Bit 2:  压力4超限
Bit 3:  液位1超限
Bit 4:  液位2超限
Bit 5:  液位3超限
Bit 6:  加热器1过流
Bit 7:  加热器2过流
Bit 8:  加热器3过流
Bit 9:  泵1故障
Bit 10: 泵2故障
Bit 11: 电磁阀1故障
Bit 12: 电磁阀2故障
Bit 13: 配置错误
Bit 14: Flash读写错误
Bit 15: 系统看门狗复位
```

#### 2.1.2 TxPDO 2 - 扩展诊断数据 (0x1A01)
**数据周期**: 100ms
**总字节数**: 32 bytes

| 偏移 | 名称 | 类型 | 字节数 | 单位 | 说明 |
|------|------|------|--------|------|------|
| 0 | CPU使用率 | UINT16 | 2 | 0.01% | 0~10000 |
| 2 | 任务最大执行时间 | UINT16 | 2 | μs | 控制任务最大执行时间 |
| 4 | 堆内存使用 | UINT32 | 4 | bytes | 剩余堆内存 |
| 8 | 传感器采样周期 | UINT16 | 2 | 0.1ms | 实际采样周期 |
| 10 | EtherCAT丢包计数 | UINT16 | 2 | - | 丢包累计 |
| 12 | EtherCAT延迟 | UINT16 | 2 | μs | 通信延迟 |
| 14 | 芯片温度 | INT16 | 2 | 0.1°C | MCU内部温度 |
| 16 | 电源电压 | UINT16 | 2 | 0.01V | 系统电压 |
| 18 | 运行时间 | UINT32 | 4 | 秒 | 系统运行总时间 |
| 22 | 错误计数器 | UINT16 | 2 | - | 错误累计次数 |
| 24 | 重启次数 | UINT16 | 2 | - | 系统重启累计 |
| 26 | 配置版本 | UINT16 | 2 | - | 当前配置版本号 |
| 28 | 软件版本 | UINT32 | 4 | - | 固件版本 (主.次.修订) |

---

### 2.2 RxPDO (主站→从站) - 过程数据输入

#### 2.2.1 RxPDO 1 - 控制命令 (0x1600)
**数据周期**: 1ms
**总字节数**: 44 bytes

| 偏移 | 名称 | 类型 | 字节数 | 单位 | 范围 | 说明 |
|------|------|------|--------|------|------|------|
| 0 | 温度设定值1 | INT16 | 2 | 0.1°C | -500~3000 | 温度控制目标1 |
| 2 | 温度设定值2 | INT16 | 2 | 0.1°C | -500~3000 | 温度控制目标2 |
| 4 | 温度设定值3 | INT16 | 2 | 0.1°C | -500~3000 | 温度控制目标3 |
| 6 | 压力设定值1 | UINT16 | 2 | 0.1kPa | 0~65535 | 压力控制目标1 |
| 8 | 压力设定值2 | UINT16 | 2 | 0.1kPa | 0~65535 | 压力控制目标2 |
| 10 | 压力设定值3 | UINT16 | 2 | 0.1kPa | 0~65535 | 压力控制目标3 |
| 12 | 压力设定值4 | UINT16 | 2 | 0.1kPa | 0~65535 | 压力控制目标4 |
| 14 | 液位设定值1 | UINT16 | 2 | 0.1mm | 0~5000 | 液位控制目标1 |
| 16 | 液位设定值2 | UINT16 | 2 | 0.1mm | 0~5000 | 液位控制目标2 |
| 18 | 液位设定值3 | UINT16 | 2 | 0.1mm | 0~5000 | 液位控制目标3 |
| 20 | 流量设定值 | UINT16 | 2 | 0.01L/min | 0~65535 | 流量控制目标 |
| 22 | 调速泵1速度 | UINT16 | 2 | 0.1% | 0~1000 | 泵1速度设定 |
| 24 | 调速泵2速度 | UINT16 | 2 | 0.1% | 0~1000 | 泵2速度设定 |
| 26 | 控制字 | UINT16 | 2 | - | - | 控制命令字 |
| 28 | 执行器控制1 | UINT16 | 2 | - | - | 阀门/泵开关控制 |
| 30 | 执行器控制2 | UINT16 | 2 | - | - | 加热器控制 |
| 32 | PID模式选择 | UINT16 | 2 | - | - | 各回路PID模式 |
| 34 | 告警确认 | UINT16 | 2 | - | - | 告警复位位 |
| 36 | 看门狗 | UINT16 | 2 | - | - | 通信看门狗计数 |
| 38 | 参数索引 | UINT16 | 2 | - | - | SDO快速访问索引 |
| 40 | 参数值 | INT32 | 4 | - | - | SDO快速访问数据 |

**控制字定义 (偏移26)**:
```
Bit 0:  系统使能 (1=使能, 0=停止)
Bit 1:  复位命令 (1=执行复位)
Bit 2:  启动命令 (1=启动系统)
Bit 3:  停止命令 (1=停止系统)
Bit 4:  紧急停止 (1=紧急停止所有执行器)
Bit 5:  自动模式 (1=自动, 0=手动)
Bit 6:  参数保存 (1=保存当前参数)
Bit 7:  参数加载 (1=加载默认参数)
Bit 8:  自检启动 (1=启动自检)
Bit 9:  告警全部清除 (1=清除所有告警)
Bit 10: PID自整定 (1=启动自整定)
Bit 11: 强制安全模式 (1=进入安全模式)
Bit 12: 配置锁定 (1=锁定配置修改)
Bit 13: 调试模式 (1=启用调试输出)
Bit 14: 数据记录 (1=启动数据记录)
Bit 15: 预留
```

**执行器控制1定义 (偏移28)**:
```
Bit 0:  电磁阀1控制 (1=开启)
Bit 1:  电磁阀2控制 (1=开启)
Bit 2:  直流泵1控制 (1=启动)
Bit 3:  直流泵2控制 (1=启动)
Bit 4:  调速泵1使能 (1=使能)
Bit 5:  调速泵2使能 (1=使能)
Bit 6:  阀门1手动覆盖 (1=手动模式)
Bit 7:  阀门2手动覆盖 (1=手动模式)
Bit 8-15: 预留
```

**执行器控制2定义 (偏移30)**:
```
Bit 0:  加热器1控制 (1=开启)
Bit 1:  加热器2控制 (1=开启)
Bit 2:  加热器3控制 (1=开启)
Bit 3:  加热器1手动覆盖 (1=手动模式)
Bit 4:  加热器2手动覆盖 (1=手动模式)
Bit 5:  加热器3手动覆盖 (1=手动模式)
Bit 6-15: 预留
```

**PID模式选择定义 (偏移32)**:
```
Bit 0-1:  温度回路1模式 (00=关闭, 01=手动, 10=自动, 11=级联)
Bit 2-3:  温度回路2模式
Bit 4-5:  温度回路3模式
Bit 6-7:  压力回路1模式
Bit 8-9:  压力回路2模式
Bit 10-11: 液位回路1模式
Bit 12-13: 液位回路2模式
Bit 14-15: 流量回路模式
```

---

## 3. SDO 对象字典 (CoE)

### 3.1 通信参数区域 (0x1000-0x1FFF)

#### 3.1.1 设备标识 (0x1000-0x1018)
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 说明 |
|-------|-----|------|------|------|--------|------|
| 0x1000 | 0 | Device Type | UINT32 | RO | 0x00000191 | 设备类型 (过程控制) |
| 0x1008 | 0 | Device Name | STRING | RO | "InkSupply_Slave" | 设备名称 |
| 0x1009 | 0 | Hardware Version | STRING | RO | "v1.0" | 硬件版本 |
| 0x100A | 0 | Software Version | STRING | RO | "v3.0.0" | 软件版本 |
| 0x1018 | 0 | Identity Object | STRUCT | RO | - | 标识对象 |
| 0x1018 | 1 | Vendor ID | UINT32 | RO | 0x00000001 | 厂商ID |
| 0x1018 | 2 | Product Code | UINT32 | RO | 0x00000100 | 产品代码 |
| 0x1018 | 3 | Revision Number | UINT32 | RO | 0x00010000 | 版本号 |
| 0x1018 | 4 | Serial Number | UINT32 | RO | 从Flash读取 | 序列号 |

#### 3.1.2 同步管理器配置 (0x1C00-0x1C13)
| Index | Sub | 名称 | 访问 | 说明 |
|-------|-----|------|------|------|
| 0x1C00 | 0-4 | Sync Manager 0 | RO | Mailbox Out |
| 0x1C01 | 0-4 | Sync Manager 1 | RO | Mailbox In |
| 0x1C02 | 0-4 | Sync Manager 2 | RO | Process Data Out |
| 0x1C03 | 0-4 | Sync Manager 3 | RO | Process Data In |

#### 3.1.3 PDO映射配置 (0x1A00-0x1BFF, 0x1600-0x17FF)
**TxPDO映射 (从站→主站)**:
- 0x1A00: TxPDO 1 映射 (传感器数据)
- 0x1A01: TxPDO 2 映射 (诊断数据)

**RxPDO映射 (主站→从站)**:
- 0x1600: RxPDO 1 映射 (控制命令)

---

### 3.2 应用参数区域 (0x2000-0x5FFF)

#### 3.2.1 传感器配置 (0x2000-0x20FF)

**温度传感器配置 (0x2000)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x2000 | 0 | 温度传感器数量 | UINT8 | RO | 3 | - | 温度传感器数量 |
| 0x2000 | 1 | 温度1标定系数 | REAL32 | RW | 1.0 | - | Pt100标定系数 |
| 0x2000 | 2 | 温度1零点偏移 | REAL32 | RW | 0.0 | °C | 零点偏移 |
| 0x2000 | 3 | 温度1滤波系数 | REAL32 | RW | 0.1 | - | 一阶滤波系数 (0~1) |
| 0x2000 | 4 | 温度1采样周期 | UINT16 | RW | 50 | ms | 采样周期 |
| 0x2000 | 5 | 温度1上限 | REAL32 | RW | 200.0 | °C | 温度上限告警 |
| 0x2000 | 6 | 温度1下限 | REAL32 | RW | -10.0 | °C | 温度下限告警 |
| 0x2000 | 7 | 温度1使能 | BOOL | RW | TRUE | - | 传感器使能 |
| 0x2000 | 8 | 温度2标定系数 | REAL32 | RW | 1.0 | - | - |
| ... | ... | (温度2, 温度3参数同上) | ... | ... | ... | ... | ... |

**压力传感器配置 (0x2010)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x2010 | 0 | 压力传感器数量 | UINT8 | RO | 4 | - | 压力传感器数量 |
| 0x2010 | 1 | 压力1标定系数 | REAL32 | RW | 1.0 | - | HP10MY标定系数 |
| 0x2010 | 2 | 压力1零点偏移 | REAL32 | RW | 0.0 | kPa | 零点偏移 |
| 0x2010 | 3 | 压力1滤波系数 | REAL32 | RW | 0.2 | - | 滤波系数 |
| 0x2010 | 4 | 压力1采样周期 | UINT16 | RW | 50 | ms | 采样周期 |
| 0x2010 | 5 | 压力1上限 | REAL32 | RW | 1000.0 | kPa | 压力上限告警 |
| 0x2010 | 6 | 压力1下限 | REAL32 | RW | 0.0 | kPa | 压力下限告警 |
| 0x2010 | 7 | 压力1使能 | BOOL | RW | TRUE | - | 传感器使能 |
| ... | ... | (压力2, 3, 4参数同上) | ... | ... | ... | ... | ... |

**液位传感器配置 (0x2020)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x2020 | 0 | 液位传感器数量 | UINT8 | RO | 4 | - | 含3路数字+1路模拟 |
| 0x2020 | 1 | 液位1标定系数 | REAL32 | RW | 1.0 | - | FRD8061标定系数 |
| 0x2020 | 2 | 液位1零点偏移 | REAL32 | RW | 0.0 | mm | 零点偏移 |
| 0x2020 | 3 | 液位1滤波系数 | REAL32 | RW | 0.15 | - | 滤波系数 |
| 0x2020 | 4 | 液位1采样周期 | UINT16 | RW | 100 | ms | 采样周期 |
| 0x2020 | 5 | 液位1上限 | REAL32 | RW | 500.0 | mm | 液位上限告警 |
| 0x2020 | 6 | 液位1下限 | REAL32 | RW | 10.0 | mm | 液位下限告警 |
| 0x2020 | 7 | 液位1使能 | BOOL | RW | TRUE | - | 传感器使能 |
| ... | ... | (液位2, 3, 4参数同上) | ... | ... | ... | ... | ... |

**流量传感器配置 (0x2030)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x2030 | 1 | 流量标定系数 | REAL32 | RW | 1.0 | - | I2C流量计标定 |
| 0x2030 | 2 | 流量零点偏移 | REAL32 | RW | 0.0 | L/min | 零点偏移 |
| 0x2030 | 3 | 流量滤波系数 | REAL32 | RW | 0.1 | - | 滤波系数 |
| 0x2030 | 4 | 流量采样周期 | UINT16 | RW | 100 | ms | 采样周期 |
| 0x2030 | 5 | 流量上限 | REAL32 | RW | 100.0 | L/min | 流量上限告警 |
| 0x2030 | 6 | 流量下限 | REAL32 | RW | 0.0 | L/min | 流量下限告警 |

#### 3.2.2 PID控制器参数 (0x3000-0x30FF)

**温度控制回路1 (0x3000)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x3000 | 1 | PID使能 | BOOL | RW | TRUE | - | 控制回路使能 |
| 0x3000 | 2 | Kp比例系数 | REAL32 | RW | 2.0 | - | 比例增益 |
| 0x3000 | 3 | Ki积分系数 | REAL32 | RW | 0.5 | - | 积分增益 |
| 0x3000 | 4 | Kd微分系数 | REAL32 | RW | 0.1 | - | 微分增益 |
| 0x3000 | 5 | 输出上限 | REAL32 | RW | 100.0 | % | 输出饱和上限 |
| 0x3000 | 6 | 输出下限 | REAL32 | RW | 0.0 | % | 输出饱和下限 |
| 0x3000 | 7 | 积分上限 | REAL32 | RW | 50.0 | - | 积分限幅 |
| 0x3000 | 8 | 积分下限 | REAL32 | RW | -50.0 | - | 积分限幅 |
| 0x3000 | 9 | 控制周期 | UINT16 | RW | 20 | ms | PID计算周期 |
| 0x3000 | 10 | 设定值 | REAL32 | RW | 25.0 | °C | 目标温度 |
| 0x3000 | 11 | 死区 | REAL32 | RW | 0.5 | °C | 控制死区 |
| 0x3000 | 12 | 反向作用 | BOOL | RW | FALSE | - | 反向控制 |
| 0x3000 | 13 | 自动模式 | BOOL | RW | TRUE | - | 自动/手动 |
| 0x3000 | 14 | 手动输出值 | REAL32 | RW | 0.0 | % | 手动模式输出 |

**温度控制回路2 (0x3010)**: (参数同0x3000)
**温度控制回路3 (0x3020)**: (参数同0x3000)

**压力控制回路1 (0x3030)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x3030 | 1-14 | (参数同温度回路) | ... | ... | ... | kPa | 压力控制参数 |

**压力控制回路2 (0x3040)**: (参数同0x3030)

**液位控制回路1 (0x3050)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x3050 | 1-14 | (参数同温度回路) | ... | ... | ... | mm | 液位控制参数 |

**液位控制回路2 (0x3060)**: (参数同0x3050)

**流量控制回路 (0x3070)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x3070 | 1-14 | (参数同温度回路) | ... | ... | ... | L/min | 流量控制参数 |

#### 3.2.3 执行器配置 (0x4000-0x40FF)

**电磁阀配置 (0x4000)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 说明 |
|-------|-----|------|------|------|--------|------|
| 0x4000 | 1 | 阀门1使能 | BOOL | RW | TRUE | 阀门1使能状态 |
| 0x4000 | 2 | 阀门1响应时间 | UINT16 | RW | 100 | 阀门动作时间(ms) |
| 0x4000 | 3 | 阀门1故障检测使能 | BOOL | RW | TRUE | 反馈检测使能 |
| 0x4000 | 4 | 阀门2使能 | BOOL | RW | TRUE | - |
| 0x4000 | 5 | 阀门2响应时间 | UINT16 | RW | 100 | ms |
| 0x4000 | 6 | 阀门2故障检测使能 | BOOL | RW | TRUE | - |

**加热器配置 (0x4010)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x4010 | 1 | 加热器1使能 | BOOL | RW | TRUE | - | 加热器1使能 |
| 0x4010 | 2 | 加热器1额定功率 | UINT16 | RW | 1000 | W | 额定功率 |
| 0x4010 | 3 | 加热器1额定电流 | UINT16 | RW | 5000 | mA | 额定电流 |
| 0x4010 | 4 | 加热器1过流阈值 | UINT16 | RW | 6000 | mA | 过流保护阈值 |
| 0x4010 | 5 | 加热器1PWM频率 | UINT16 | RW | 1000 | Hz | PWM频率(若使用PWM) |
| 0x4010 | 6-10 | (加热器2参数同上) | ... | ... | ... | ... | ... |
| 0x4010 | 11-15 | (加热器3参数同上) | ... | ... | ... | ... | ... |

**调速泵配置 (0x4020)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x4020 | 1 | 调速泵1使能 | BOOL | RW | TRUE | - | 泵1使能 |
| 0x4020 | 2 | 调速泵1最小速度 | UINT16 | RW | 100 | 0.1% | 最小转速限制 |
| 0x4020 | 3 | 调速泵1最大速度 | UINT16 | RW | 1000 | 0.1% | 最大转速限制 |
| 0x4020 | 4 | 调速泵1PWM频率 | UINT16 | RW | 25000 | Hz | PWM频率 |
| 0x4020 | 5 | 调速泵1加速时间 | UINT16 | RW | 1000 | ms | 启动加速时间 |
| 0x4020 | 6 | 调速泵1减速时间 | UINT16 | RW | 1000 | ms | 停止减速时间 |
| 0x4020 | 7-12 | (调速泵2参数同上) | ... | ... | ... | ... | ... |

**直流泵配置 (0x4030)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 说明 |
|-------|-----|------|------|------|--------|------|
| 0x4030 | 1 | 直流泵1使能 | BOOL | RW | TRUE | 泵1使能 |
| 0x4030 | 2 | 直流泵1延时启动 | UINT16 | RW | 0 | 启动延时(ms) |
| 0x4030 | 3 | 直流泵2使能 | BOOL | RW | TRUE | 泵2使能 |
| 0x4030 | 4 | 直流泵2延时启动 | UINT16 | RW | 0 | ms |

#### 3.2.4 安全参数 (0x5000-0x50FF)

**安全限值配置 (0x5000)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x5000 | 1 | 全局安全使能 | BOOL | RW | TRUE | - | 安全功能总使能 |
| 0x5000 | 2 | 看门狗超时 | UINT16 | RW | 500 | ms | EtherCAT通信看门狗 |
| 0x5000 | 3 | 传感器故障计数阈值 | UINT8 | RW | 3 | - | 连续故障判定阈值 |
| 0x5000 | 4 | 紧急停机模式 | UINT8 | RW | 1 | - | 0=快速停止,1=安全停止 |
| 0x5000 | 5 | 自动恢复使能 | BOOL | RW | FALSE | - | 故障自动恢复 |
| 0x5000 | 6 | 告警延迟 | UINT16 | RW | 100 | ms | 告警产生延迟 |

**温度安全限值 (0x5010)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x5010 | 1 | 温度1最高限 | REAL32 | RW | 150.0 | °C | 绝对上限 |
| 0x5010 | 2 | 温度1最低限 | REAL32 | RW | -20.0 | °C | 绝对下限 |
| 0x5010 | 3 | 温度1告警上限 | REAL32 | RW | 120.0 | °C | 告警上限 |
| 0x5010 | 4 | 温度1告警下限 | REAL32 | RW | 0.0 | °C | 告警下限 |
| 0x5010 | 5-8 | (温度2安全限值) | ... | ... | ... | °C | ... |
| 0x5010 | 9-12 | (温度3安全限值) | ... | ... | ... | °C | ... |

**压力安全限值 (0x5020)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x5020 | 1 | 压力1最高限 | REAL32 | RW | 1500.0 | kPa | 绝对上限 |
| 0x5020 | 2 | 压力1最低限 | REAL32 | RW | 0.0 | kPa | 绝对下限 |
| 0x5020 | 3 | 压力1告警上限 | REAL32 | RW | 1200.0 | kPa | 告警上限 |
| 0x5020 | 4 | 压力1告警下限 | REAL32 | RW | 10.0 | kPa | 告警下限 |
| ... | ... | (压力2, 3, 4安全限值) | ... | ... | ... | kPa | ... |

**液位安全限值 (0x5030)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 单位 | 说明 |
|-------|-----|------|------|------|--------|------|------|
| 0x5030 | 1 | 液位1最高限 | REAL32 | RW | 600.0 | mm | 绝对上限 |
| 0x5030 | 2 | 液位1最低限 | REAL32 | RW | 0.0 | mm | 绝对下限 |
| 0x5030 | 3 | 液位1告警上限 | REAL32 | RW | 550.0 | mm | 告警上限 |
| 0x5030 | 4 | 液位1告警下限 | REAL32 | RW | 5.0 | mm | 告警下限 |
| ... | ... | (液位2, 3安全限值) | ... | ... | ... | mm | ... |

#### 3.2.5 系统配置 (0x6000-0x60FF)

**网络配置 (0x6000)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 说明 |
|-------|-----|------|------|------|--------|------|
| 0x6000 | 1 | IP地址 | UINT32 | RW | 192.168.1.100 | 从站IP地址 |
| 0x6000 | 2 | 子网掩码 | UINT32 | RW | 255.255.255.0 | 子网掩码 |
| 0x6000 | 3 | 网关地址 | UINT32 | RW | 192.168.1.1 | 网关 |
| 0x6000 | 4 | MAC地址高位 | UINT32 | RO | - | MAC地址[0-3] |
| 0x6000 | 5 | MAC地址低位 | UINT16 | RO | - | MAC地址[4-5] |
| 0x6000 | 6 | EtherCAT从站地址 | UINT16 | RW | 1 | 从站地址 |
| 0x6000 | 7 | TCP端口 | UINT16 | RW | 502 | TCP服务器端口 |

**系统参数 (0x6010)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 说明 |
|-------|-----|------|------|------|--------|------|
| 0x6010 | 1 | 设备ID | UINT16 | RW | 1 | 设备唯一ID |
| 0x6010 | 2 | 设备名称 | STRING | RW | "InkSupply" | 自定义设备名 |
| 0x6010 | 3 | 配置版本 | UINT16 | RO | 1 | 当前配置版本 |
| 0x6010 | 4 | 系统时钟频率 | UINT32 | RO | 200000000 | 系统主频(Hz) |
| 0x6010 | 5 | FreeRTOS Tick频率 | UINT16 | RO | 1000 | RTOS时钟频率(Hz) |

**日志配置 (0x6020)**:
| Index | Sub | 名称 | 类型 | 访问 | 默认值 | 说明 |
|-------|-----|------|------|------|--------|------|
| 0x6020 | 1 | 日志使能 | BOOL | RW | TRUE | 日志功能使能 |
| 0x6020 | 2 | 日志级别 | UINT8 | RW | 2 | 0=关闭,1=错误,2=警告,3=信息,4=调试 |
| 0x6020 | 3 | 日志存储位置 | UINT8 | RW | 1 | 0=RAM,1=Flash,2=网络 |
| 0x6020 | 4 | 日志最大条数 | UINT16 | RW | 1000 | 最大存储日志条数 |

---

### 3.3 厂商特定参数 (0xA000-0xAFFF)

**调试与诊断 (0xA000)**:
| Index | Sub | 名称 | 类型 | 访问 | 说明 |
|-------|-----|------|------|------|------|
| 0xA000 | 1 | CPU使用率 | UINT16 | RO | CPU使用率(0.01%) |
| 0xA000 | 2 | 剩余堆内存 | UINT32 | RO | 剩余堆内存(bytes) |
| 0xA000 | 3 | 最小堆内存 | UINT32 | RO | 历史最小堆内存 |
| 0xA000 | 4 | 任务数量 | UINT8 | RO | 当前运行任务数 |
| 0xA000 | 5 | 最大任务执行时间 | UINT16 | RO | 最大任务执行时间(μs) |
| 0xA000 | 6 | 平均任务执行时间 | UINT16 | RO | 平均任务执行时间(μs) |
| 0xA000 | 7 | 中断计数 | UINT32 | RO | 中断总计数 |
| 0xA000 | 8 | 任务切换计数 | UINT32 | RO | 任务切换总次数 |

**故障记录 (0xA010)**:
| Index | Sub | 名称 | 类型 | 访问 | 说明 |
|-------|-----|------|------|------|------|
| 0xA010 | 0 | 故障记录数量 | UINT8 | RO | 当前故障记录条数 |
| 0xA010 | 1 | 最近故障码 | UINT16 | RO | 最近一次故障码 |
| 0xA010 | 2 | 最近故障时间 | UINT32 | RO | 故障发生时间戳(秒) |
| 0xA010 | 3 | 历史故障计数 | UINT32 | RO | 累计故障次数 |
| 0xA010 | 4 | 清除故障记录 | BOOL | WO | 写1清除故障历史 |

**校准与测试 (0xA020)**:
| Index | Sub | 名称 | 类型 | 访问 | 说明 |
|-------|-----|------|------|------|------|
| 0xA020 | 1 | 进入校准模式 | BOOL | WO | 写1进入校准模式 |
| 0xA020 | 2 | 校准传感器索引 | UINT8 | RW | 选择要校准的传感器 |
| 0xA020 | 3 | 校准点1值 | REAL32 | WO | 第一校准点实际值 |
| 0xA020 | 4 | 校准点2值 | REAL32 | WO | 第二校准点实际值 |
| 0xA020 | 5 | 执行校准 | BOOL | WO | 写1执行两点校准 |
| 0xA020 | 6 | 校准状态 | UINT8 | RO | 0=未校准,1=校准中,2=成功,3=失败 |
| 0xA020 | 7 | 自检命令 | UINT8 | WO | 0=全部,1=传感器,2=执行器,3=通信 |
| 0xA020 | 8 | 自检结果 | UINT16 | RO | bit位对应各部分自检结果 |

**参数存储管理 (0xA030)**:
| Index | Sub | 名称 | 类型 | 访问 | 说明 |
|-------|-----|------|------|------|------|
| 0xA030 | 1 | 保存参数到Flash | BOOL | WO | 写1保存当前参数 |
| 0xA030 | 2 | 从Flash加载参数 | BOOL | WO | 写1加载保存的参数 |
| 0xA030 | 3 | 恢复出厂设置 | BOOL | WO | 写1恢复默认参数 |
| 0xA030 | 4 | 参数校验和 | UINT32 | RO | 当前参数CRC32校验值 |
| 0xA030 | 5 | 存储状态 | UINT8 | RO | 0=空闲,1=保存中,2=加载中,3=错误 |
| 0xA030 | 6 | 参数锁定 | BOOL | RW | 参数锁定保护 |

---

## 4. 通信时序与周期

### 4.1 同步模式配置
- **DC模式**: 分布式时钟同步，精度±1μs
- **主周期**: 1ms
- **Sync0事件**: 每1ms产生，触发快速PDO交换
- **Sync1事件**: 每100ms产生，触发诊断PDO交换

### 4.2 PDO交换周期
| PDO类型 | 同步事件 | 周期 | 优先级 | 说明 |
|---------|---------|------|--------|------|
| RxPDO 1 (控制命令) | Sync0 | 1ms | 高 | 实时控制数据 |
| TxPDO 1 (传感器数据) | Sync0 | 1ms | 高 | 实时过程数据 |
| TxPDO 2 (诊断数据) | Sync1 | 100ms | 低 | 系统诊断信息 |

### 4.3 看门狗配置
- **EtherCAT通信看门狗**: 500ms (可配置)
- **超时动作**:
  - 第一阶段: 切换到安全值输出
  - 第二阶段(1秒): 关闭所有执行器
  - 第三阶段: 进入安全停机状态

---

## 5. 状态机与启动流程

### 5.1 EtherCAT状态机
```
INIT → PRE-OP → SAFE-OP → OP
  ↓       ↓         ↓       ↓
BOOT ← ERROR ← ERROR ← ERROR
```

**各状态功能**:
- **INIT**: 初始化，仅Mailbox通信
- **PRE-OP**: 预运行，支持SDO配置
- **SAFE-OP**: 安全运行，PDO映射完成，输出为安全值
- **OP**: 运行状态，完整控制功能
- **BOOT**: 引导模式，固件更新

### 5.2 应用层启动流程
1. **硬件初始化** (INIT状态)
   - MCU外设初始化
   - EtherCAT从站协议栈初始化
   - 加载从EEPROM的配置

2. **参数配置** (PRE-OP状态)
   - 主站通过SDO配置传感器参数
   - 配置PID控制器参数
   - 配置安全限值
   - 配置执行器参数

3. **自检** (PRE-OP → SAFE-OP)
   - 传感器连接检查
   - 执行器功能测试
   - 内存测试
   - 通信测试

4. **准备运行** (SAFE-OP状态)
   - PDO映射激活
   - 控制任务启动
   - 输出保持安全值

5. **正常运行** (OP状态)
   - 实时控制循环运行
   - 安全监控激活
   - 完整功能运行

---

## 6. 数据编码与解码

### 6.1 定点数编码
**温度数据** (INT16, 分辨率0.1°C):
```c
// 编码: 实际温度 → EtherCAT值
int16_t temp_ethercat = (int16_t)(actual_temp * 10.0f);

// 解码: EtherCAT值 → 实际温度
float actual_temp = (float)temp_ethercat / 10.0f;

// 示例: 25.3°C → 253 (0x00FD)
//       -10.5°C → -105 (0xFF97)
```

**压力数据** (UINT16, 分辨率0.1kPa):
```c
// 编码
uint16_t pressure_ethercat = (uint16_t)(actual_pressure * 10.0f);

// 解码
float actual_pressure = (float)pressure_ethercat / 10.0f;

// 示例: 125.6kPa → 1256 (0x04E8)
```

**液位数据** (UINT16, 分辨率0.1mm):
```c
// 编码
uint16_t level_ethercat = (uint16_t)(actual_level * 10.0f);

// 解码
float actual_level = (float)level_ethercat / 10.0f;

// 示例: 234.5mm → 2345 (0x0929)
```

**百分比数据** (UINT16, 分辨率0.1%):
```c
// 编码 (0~100% → 0~1000)
uint16_t percent_ethercat = (uint16_t)(percent * 10.0f);

// 解码
float percent = (float)percent_ethercat / 10.0f;

// 示例: 65.3% → 653 (0x028D)
```

### 6.2 浮点数编码
**SDO参数使用REAL32格式** (IEEE 754单精度):
```c
// C语言直接使用float类型
float kp_value = 2.5f;

// 通过SDO直接读写
ec_SDOwrite(slave, 0x3000, 2, FALSE, sizeof(float), &kp_value, EC_TIMEOUTRXM);
```

### 6.3 CRC校验计算
**PDO数据完整性校验** (CRC16-CCITT):
```c
uint16_t calculate_crc16(uint8_t *data, uint16_t length) {
    uint16_t crc = 0xFFFF;
    for (uint16_t i = 0; i < length; i++) {
        crc ^= (uint16_t)data[i] << 8;
        for (uint8_t j = 0; j < 8; j++) {
            if (crc & 0x8000)
                crc = (crc << 1) ^ 0x1021;
            else
                crc <<= 1;
        }
    }
    return crc;
}

// 使用示例
uint16_t pdo_crc = calculate_crc16((uint8_t*)&txpdo_data, sizeof(txpdo_data) - 2);
txpdo_data.crc = pdo_crc;
```

---

## 7. 错误处理与诊断

### 7.1 错误代码定义
| 错误码 | 名称 | 严重级别 | 说明 |
|-------|------|---------|------|
| 0x0000 | NO_ERROR | 0 | 无错误 |
| 0x1001 | TEMP_SENSOR_FAULT | 2 | 温度传感器故障 |
| 0x1002 | PRESSURE_SENSOR_FAULT | 2 | 压力传感器故障 |
| 0x1003 | LEVEL_SENSOR_FAULT | 2 | 液位传感器故障 |
| 0x1004 | FLOW_SENSOR_FAULT | 1 | 流量传感器故障 |
| 0x2001 | VALVE_FAULT | 2 | 电磁阀故障 |
| 0x2002 | HEATER_FAULT | 3 | 加热器故障 |
| 0x2003 | PUMP_FAULT | 2 | 泵故障 |
| 0x3001 | TEMP_OVER_LIMIT | 3 | 温度超限 |
| 0x3002 | PRESSURE_OVER_LIMIT | 3 | 压力超限 |
| 0x3003 | LEVEL_ABNORMAL | 2 | 液位异常 |
| 0x4001 | COMM_TIMEOUT | 2 | 通信超时 |
| 0x4002 | PDO_CRC_ERROR | 1 | PDO校验错误 |
| 0x5001 | CONFIG_INVALID | 2 | 配置无效 |
| 0x5002 | FLASH_ERROR | 2 | Flash读写错误 |
| 0x6001 | SYSTEM_OVERLOAD | 3 | 系统过载 |
| 0x6002 | WATCHDOG_RESET | 1 | 看门狗复位 |

**严重级别定义**:
- 0: 信息
- 1: 警告 (系统继续运行)
- 2: 错误 (部分功能受限)
- 3: 严重 (进入安全模式)

### 7.2 诊断流程
1. **错误检测**
   - 周期性传感器数据有效性检查
   - 执行器反馈验证
   - 参数越界检测
   - 通信超时监控

2. **错误记录**
   - 错误码
   - 时间戳
   - 相关参数值
   - 系统状态快照

3. **错误响应**
   - 设置告警字位
   - 执行安全动作
   - 记录日志
   - 通知主站

4. **错误恢复**
   - 等待告警确认
   - 验证故障已消除
   - 清除告警状态
   - 恢复正常运行

---

## 8. 安全功能

### 8.1 安全输入/输出
- **STO (Safe Torque Off)**: 通过硬件急停输入直接断开执行器电源
- **SS1 (Safe Stop 1)**: 受控停止后断电
- **SLS (Safely Limited Speed)**: 泵速度安全限制

### 8.2 故障安全状态
**传感器故障响应**:
- 温度传感器故障: 关闭对应加热器
- 压力传感器故障: 关闭相关阀门和泵
- 液位传感器故障: 停止相关液体输送

**通信丢失响应**:
- 看门狗触发后500ms内: 保持最后有效控制值
- 500ms~1s: 切换到预设安全值
- 1s以上: 关闭所有执行器

**超限响应**:
- 温度超上限: 立即关闭加热器
- 压力超上限: 打开泄压阀，停止加压泵
- 液位超上限: 停止进液泵

### 8.3 安全完整性等级
- **目标SIL等级**: SIL 2
- **诊断覆盖率**: DC ≥ 90%
- **平均故障间隔时间**: MTBF ≥ 10000小时

---

## 9. 固件更新 (FoE)

### 9.1 固件更新流程
1. 主站发送切换到BOOT状态命令
2. 从站进入引导模式
3. 主站通过FoE协议传输固件文件
4. 从站校验固件完整性
5. 写入Flash存储区
6. 复位并从新固件启动

### 9.2 固件文件格式
- **文件名**: "inkSupply_firmware_vX.Y.Z.bin"
- **文件头**: 包含版本号、大小、CRC32校验
- **代码段**: 应用程序二进制代码
- **配置段**: 默认配置参数

### 9.3 固件版本管理
- **Major版本**: 不兼容的API更改
- **Minor版本**: 向后兼容的功能增加
- **Patch版本**: 向后兼容的问题修复

---

## 10. 实现示例代码

### 10.1 从站应用层实现 (app/ethercat_app.c)
```c
#include "ethercat_app.h"
#include "sensor_task.h"
#include "control_task.h"
#include "actuator_task.h"

// EtherCAT PDO数据结构
typedef struct __attribute__((packed)) {
    // TxPDO 1 (从站→主站)
    int16_t temp_sensor[3];
    uint16_t pressure_sensor[4];
    uint16_t level_sensor[4];
    uint16_t flow_sensor;
    uint16_t level_switch_status;
    uint16_t actuator_feedback1;
    uint16_t actuator_feedback2;
    uint16_t heater_current[3];
    uint16_t pump_speed_feedback[2];
    int16_t pid_output[3];
    uint16_t status_word;
    uint16_t alarm_word1;
    uint16_t alarm_word2;
    uint32_t diagnostic_counter;
    uint32_t timestamp;
    uint16_t crc;
} TxPDO1_t;

typedef struct __attribute__((packed)) {
    // RxPDO 1 (主站→从站)
    int16_t temp_setpoint[3];
    uint16_t pressure_setpoint[4];
    uint16_t level_setpoint[3];
    uint16_t flow_setpoint;
    uint16_t pump_speed_cmd[2];
    uint16_t control_word;
    uint16_t actuator_control1;
    uint16_t actuator_control2;
    uint16_t pid_mode_select;
    uint16_t alarm_ack;
    uint16_t watchdog;
    uint16_t param_index;
    int32_t param_value;
} RxPDO1_t;

// 全局PDO缓冲区
static TxPDO1_t g_txpdo1;
static RxPDO1_t g_rxpdo1;

// EtherCAT循环任务
void ethercat_cyclic_task(void)
{
    // 读取主站命令
    ec_slave[0].inputs = (uint8_t*)&g_rxpdo1;
    ec_receive_processdata(EC_TIMEOUTRET);

    // 处理控制命令
    process_control_commands(&g_rxpdo1);

    // 更新传感器数据到TxPDO
    update_sensor_data_to_pdo(&g_txpdo1);

    // 更新执行器反馈到TxPDO
    update_actuator_feedback_to_pdo(&g_txpdo1);

    // 更新状态和告警信息
    update_status_alarm_to_pdo(&g_txpdo1);

    // 计算CRC
    g_txpdo1.crc = calculate_crc16((uint8_t*)&g_txpdo1, sizeof(TxPDO1_t) - 2);

    // 发送过程数据到主站
    ec_slave[0].outputs = (uint8_t*)&g_txpdo1;
    ec_send_processdata();
}

// 处理控制命令
static void process_control_commands(RxPDO1_t *rxpdo)
{
    // 解析控制字
    if (rxpdo->control_word & CTRL_BIT_ENABLE) {
        // 系统使能
    }

    if (rxpdo->control_word & CTRL_BIT_EMERGENCY_STOP) {
        // 紧急停止
        emergency_stop_all_actuators();
        return;
    }

    // 更新PID设定值
    for (int i = 0; i < 3; i++) {
        float temp_sp = (float)rxpdo->temp_setpoint[i] / 10.0f;
        set_temperature_setpoint(i, temp_sp);
    }

    // 更新执行器控制
    update_valve_control(rxpdo->actuator_control1);
    update_heater_control(rxpdo->actuator_control2);
    update_pump_speed(rxpdo->pump_speed_cmd);
}

// 更新传感器数据到PDO
static void update_sensor_data_to_pdo(TxPDO1_t *txpdo)
{
    sensor_context_t *sensors = get_sensor_context();

    // 温度传感器
    for (int i = 0; i < 3; i++) {
        txpdo->temp_sensor[i] = (int16_t)(sensors->temp_values[i] * 10.0f);
    }

    // 压力传感器
    for (int i = 0; i < 4; i++) {
        txpdo->pressure_sensor[i] = (uint16_t)(sensors->pressure_values[i] * 10.0f);
    }

    // 液位传感器
    for (int i = 0; i < 3; i++) {
        txpdo->level_sensor[i] = (uint16_t)(sensors->level_values[i] * 10.0f);
    }

    // 流量传感器
    txpdo->flow_sensor = (uint16_t)(sensors->flow_value * 100.0f);

    // 时间戳
    txpdo->timestamp = HAL_GetTick();
    txpdo->diagnostic_counter++;
}
```

### 10.2 主站配置示例 (TwinCAT/Python)
```python
# Python示例: 使用pysoem库控制墨路系统

import pysoem
import struct
import time

def main():
    # 初始化EtherCAT主站
    master = pysoem.Master()
    master.open('\\Device\\NPF_{YOUR_ADAPTER_ID}')

    # 配置网络
    if master.config_init() > 0:
        print(f'发现 {master.slave_count} 个从站设备')

        # 配置从站1 (墨路控制系统)
        slave = master.slaves[0]
        print(f'从站1: {slave.name}')

        # 配置PDO映射
        master.config_map()

        # 切换到SAFE-OP状态
        master.state_check(pysoem.SAFEOP_STATE, 50000)

        # 切换到OP状态
        master.state = pysoem.OP_STATE
        master.write_state()
        master.state_check(pysoem.OP_STATE, 50000)

        print('EtherCAT主站进入OP状态')

        # 循环控制
        try:
            while True:
                # 接收过程数据
                master.receive_processdata(10000)

                # 解析TxPDO (从站数据)
                rxdata = slave.input  # 主站接收=从站发送
                temp1 = struct.unpack_from('h', rxdata, 0)[0] / 10.0  # 温度1
                pressure1 = struct.unpack_from('H', rxdata, 6)[0] / 10.0  # 压力1
                status_word = struct.unpack_from('H', rxdata, 46)[0]

                print(f'温度1: {temp1}°C, 压力1: {pressure1}kPa, 状态: {status_word:04X}')

                # 构造RxPDO (主站命令)
                txdata = bytearray(44)
                struct.pack_into('h', txdata, 0, int(60.0 * 10))  # 温度设定60°C
                struct.pack_into('H', txdata, 6, int(500.0 * 10))  # 压力设定500kPa
                struct.pack_into('H', txdata, 26, 0x0001)  # 控制字: 使能
                struct.pack_into('H', txdata, 28, 0x0001)  # 打开阀门1

                slave.output = bytes(txdata)

                # 发送过程数据
                master.send_processdata()

                time.sleep(0.001)  # 1ms周期

        except KeyboardInterrupt:
            print('停止控制')

        # 切换到INIT状态
        master.state = pysoem.INIT_STATE
        master.write_state()
        master.close()

    else:
        print('未发现EtherCAT从站设备')

if __name__ == '__main__':
    main()
```

---

## 11. 测试与验证

### 11.1 功能测试项
1. **PDO数据完整性测试**
   - 数据编码/解码正确性
   - CRC校验功能
   - 数据刷新频率

2. **SDO参数访问测试**
   - 所有对象字典条目可读写
   - 参数范围校验
   - 参数持久化

3. **状态机测试**
   - 各状态转换正常
   - 错误状态恢复
   - 紧急停止响应

4. **实时性能测试**
   - PDO交换周期稳定性
   - DC同步精度
   - 最大延迟测量

5. **故障注入测试**
   - 传感器断线
   - 通信中断
   - 参数越界
   - 看门狗超时

### 11.2 性能指标
| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| PDO循环时间 | 1ms ± 50μs | 示波器测量Sync0信号 |
| DC同步精度 | ± 1μs | TwinCAT实时监控 |
| 看门狗响应时间 | < 10ms | 主站断线测试 |
| CPU使用率 | < 60% | FreeRTOS任务监控 |
| 内存使用 | < 80% | 运行时内存统计 |

### 11.3 兼容性测试
- **主站软件**: TwinCAT 3, CODESYS, IGH EtherCAT Master
- **网络配置**: 100Mbps Full Duplex
- **拓扑结构**: 线型、星型、树型
- **从站数量**: 1~32个设备混合组网

---

## 12. 附录

### 12.1 缩写术语表
- **CoE**: CAN Application Protocol over EtherCAT
- **PDO**: Process Data Object (过程数据对象)
- **SDO**: Service Data Object (服务数据对象)
- **DC**: Distributed Clock (分布式时钟)
- **FoE**: File over EtherCAT (文件传输协议)
- **SIL**: Safety Integrity Level (安全完整性等级)
- **STO**: Safe Torque Off (安全力矩关断)
- **MTBF**: Mean Time Between Failures (平均故障间隔时间)

### 12.2 参考文档
1. IEC 61158 - 工业通信网络现场总线规范
2. IEC 61784 - 工业通信网络配置文件
3. ETG.1000 - EtherCAT规范
4. ETG.2000 - EtherCAT实现指南
5. GD32F427数据手册
6. SOEM开源EtherCAT主站库文档

### 12.3 相关文件
- `墨路控制系统详细设计文档v3.md` - 系统总体设计
- `ESI配置文件.xml` - EtherCAT从站描述文件
- `app/ethercat_app.c/h` - EtherCAT应用层实现
- `config/ethercat_config.h` - EtherCAT配置参数

---

**文档版本**: v1.0
**编写日期**: 2025-09-30
**编写依据**: 墨路通信协议表格 + 墨路控制系统详细设计文档v3
**适用固件版本**: v3.0.0及以上