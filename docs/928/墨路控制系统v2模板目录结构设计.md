# 墨路控制系统v2模板目录结构设计文档

## 1. 概述

本文档基于设计文档v2的四层架构要求，结合现有 `ink_supply_template_simple` 模板，设计适用于v2版本的标准化目录结构。

## 2. 层次架构对应关系

### 2.1 设计文档v2四层架构
```
应用层 (Application Layer)     ← 业务逻辑和任务管理
    ↓
中间件层 (Middleware Layer)    ← 算法和系统服务
    ↓
HAL层 (Hardware Abstraction Layer) ← 硬件抽象接口
    ↓
驱动层 (Driver Layer)         ← 设备驱动程序
```

### 2.2 template_simple与v2层次对应
| v2设计层次 | template_simple | 功能对应 | 备注 |
|-----------|----------------|----------|------|
| `src/app/` | `USER/` | 应用层 | 主程序、任务调度 |
| `src/middleware/` | `SYSTEM/` | 中间件层 | 系统服务、算法 |
| `src/hal/` | `HALLIB/` | HAL层 | 硬件抽象层 |
| `src/drivers/` | `HARDWARE/` | 驱动层 | 硬件驱动 |
| `lib/` | `CORE/` | 库文件 | 内核和第三方库 |
| `config/` | `config/` | 配置 | 系统配置文件 |

## 3. v2推荐模板目录结构

### 3.1 完整目录树
```
ink_supply_gd32f427_v2/
├── 📁 src/                                # 源代码目录
│   ├── 📄 main.c                          # 主程序入口
│   │
│   ├── 📁 app/                            # 应用层 (对应template的USER/)
│   │   ├── 📄 app_main.c/h                # 应用主程序
│   │   ├── 📄 sensor_task.c/h             # 传感器任务 (3种传感器集成)
│   │   ├── 📄 actuator_task.c/h           # 执行器任务 (电机+泵+阀门)
│   │   ├── 📄 control_task.c/h            # 控制任务 (PID控制算法)
│   │   ├── 📄 safety_task.c/h             # 安全任务 (故障检测+保护)
│   │   ├── 📄 hmi_task.c/h                # HMI任务 (LCD+LED显示)
│   │   ├── 📄 comm_task.c/h               # 通信任务 (双协议通信)
│   │   ├── 📄 config_task.c/h             # 配置任务 (参数管理)
│   │   ├── 📄 ethercat_app.c/h            # EtherCAT应用
│   │   └── 📄 tcp_server.c/h              # TCP服务器
│   │
│   ├── 📁 middleware/                     # 中间件层 (对应template的SYSTEM/)
│   │   ├── 📄 middleware_common.c/h       # 中间件公共功能
│   │   ├── 📄 tasks.c/h                   # FreeRTOS任务管理
│   │   ├── 📄 pid.c/h                     # PID算法实现
│   │   ├── 📄 filter.c/h                  # 数字滤波算法
│   │   ├── 📄 delay.c/h                   # 延时功能 (从template移植)
│   │   ├── 📄 sys.c/h                     # 系统功能 (从template移植)
│   │   └── 📄 usart.c/h                   # 串口功能 (从template移植)
│   │
│   ├── 📁 hal/                            # HAL层 (对应template的HALLIB/)
│   │   ├── 📄 hal_common.c/h              # HAL公共功能
│   │   ├── 📄 hal_manager.c/h             # HAL管理器
│   │   ├── 📄 adc_hal.c/h                 # ADC硬件抽象
│   │   ├── 📄 pwm_hal.c/h                 # PWM硬件抽象
│   │   ├── 📄 gpio_hal.c/h                # GPIO硬件抽象
│   │   ├── 📄 uart_hal.c/h                # UART硬件抽象
│   │   ├── 📄 spi_hal.c/h                 # SPI硬件抽象
│   │   ├── 📄 i2c_hal.c/h                 # I2C硬件抽象
│   │   ├── 📄 eth_hal.c/h                 # 以太网硬件抽象
│   │   ├── 📄 flash_hal.c/h               # Flash硬件抽象
│   │   └── 📄 timer_hal.c/h               # 定时器硬件抽象
│   │
│   ├── 📁 drivers/                        # 驱动层 (对应template的HARDWARE/)
│   │   ├── 📁 sensors/                    # 传感器驱动
│   │   │   ├── 📄 frd8061_driver.c/h      # FRD8061液位传感器
│   │   │   ├── 📄 ftt518_driver.c/h       # FTT518温度传感器
│   │   │   └── 📄 hp10my_driver.c/h       # HP10MY压力传感器
│   │   ├── 📁 actuators/                  # 执行器驱动
│   │   │   ├── 📄 mra23d3_driver.c/h      # MRA23D3电机驱动
│   │   │   ├── 📄 mpb025bbb_driver.c/h    # MPB025BBB泵驱动
│   │   │   ├── 📄 valve_control.c/h       # 阀门控制
│   │   │   └── 📄 led_control.c/h         # LED控制
│   │   ├── 📁 communication/              # 通信驱动
│   │   │   ├── 📄 can_driver.c/h          # CAN总线驱动
│   │   │   └── 📄 ethernet_driver.c/h     # 以太网驱动
│   │   └── 📁 display/                    # 显示驱动
│   │       ├── 📄 lcd_driver.c/h          # LCD显示驱动
│   │       └── 📄 oled_driver.c/h         # OLED显示驱动
│   │
│   ├── 📁 board/                          # 板级支持包
│   │   └── 📄 board_init.c/h              # 板级初始化
│   │
│   └── 📁 system/                         # 系统管理
│       ├── 📄 system_manager.c/h          # 系统管理器
│       ├── 📄 error_handler.c/h           # 错误处理
│       └── 📄 task_scheduler.c/h          # 任务调度器
│
├── 📁 include/                            # 头文件目录
│   ├── 📁 app/                            # 应用层头文件
│   ├── 📁 middleware/                     # 中间件头文件
│   ├── 📁 hal/                            # HAL层头文件
│   ├── 📁 drivers/                        # 驱动层头文件
│   ├── 📁 board/                          # 板级头文件
│   ├── 📁 system/                         # 系统头文件
│   └── 📁 common/                         # 公共头文件
│
├── 📁 lib/                                # 第三方库 (对应template的CORE/)
│   ├── 📁 GD32F4xx_HAL/                   # GD32官方HAL库
│   │   ├── 📁 Inc/                        # HAL库头文件
│   │   └── 📁 Src/                        # HAL库源文件
│   ├── 📁 CMSIS/                          # ARM CMSIS库
│   │   ├── 📄 core_cm4.h                  # Cortex-M4内核
│   │   └── 📄 system_gd32f4xx.c/h         # 系统文件
│   ├── 📁 FreeRTOS/                       # FreeRTOS实时操作系统
│   │   ├── 📁 Source/                     # RTOS源码
│   │   └── 📁 portable/                   # 移植层
│   ├── 📁 lwip/                           # lwIP网络协议栈
│   │   ├── 📁 src/                        # lwIP源码
│   │   └── 📁 port/                       # 移植代码
│   ├── 📁 ethercat/                       # EtherCAT开源库
│   │   ├── 📁 master/                     # 主站库
│   │   └── 📁 slave/                      # 从站库
│   └── 📁 usmart/                         # 调试工具 (从template移植)
│
├── 📁 config/                             # 配置文件 (对应template的config/)
│   ├── 📄 FreeRTOSConfig.h                # FreeRTOS配置
│   ├── 📄 lwipopts.h                      # lwIP配置
│   ├── 📄 gd32f4xx_hal_conf.h            # GD32 HAL配置
│   ├── 📄 system_config.h                 # 系统参数配置
│   ├── 📄 app_config.h                    # 应用配置
│   └── 📄 project_config.h                # 项目特定配置
│
├── 📁 docs/                               # 文档目录
│   ├── 📄 design.md                       # 设计文档
│   ├── 📄 api.md                          # API文档
│   └── 📄 user_manual.md                  # 用户手册
│
├── 📁 tools/                              # 工具目录
│   ├── 📄 build.py                        # 构建脚本
│   └── 📄 flash.py                        # 烧录脚本
│
├── 📁 obj/                                # 编译输出 (对应template的OBJ/)
│   ├── 📁 Debug/                          # 调试版本输出
│   └── 📁 Release/                        # 发布版本输出
│
├── 📄 CMakeLists.txt                      # CMake构建脚本
├── 📄 Makefile                            # Make构建脚本
├── 📄 project.uvprojx                     # Keil uVision项目文件
├── 📄 README.md                           # 项目说明文档
├── 📄 CHANGELOG.md                        # 版本变更日志
└── 📄 .gitignore                          # Git忽略配置
```

## 4. 从template_simple迁移到v2模板的映射

### 4.1 直接映射关系
```
template_simple/          →  v2_template/
├── USER/                 →  src/app/
├── SYSTEM/               →  src/middleware/
├── HALLIB/               →  lib/GD32F4xx_HAL/
├── HARDWARE/             →  src/drivers/
├── CORE/                 →  lib/CMSIS/
├── config/               →  config/
├── OBJ/                  →  obj/
└── USMART/               →  lib/usmart/
```

### 4.2 功能模块迁移指导

#### 4.2.1 应用层迁移 (USER/ → src/app/)
- `main.c` → `src/main.c` + `src/app/app_main.c`
- 用户应用代码 → 按功能拆分为各任务模块

#### 4.2.2 中间件层迁移 (SYSTEM/ → src/middleware/)
- `delay/` → `src/middleware/delay.c/h`
- `sys/` → `src/middleware/sys.c/h`
- `usart/` → `src/middleware/usart.c/h`
- 新增PID、滤波等算法模块

#### 4.2.3 HAL层迁移 (HALLIB/ → lib/GD32F4xx_HAL/)
- 保持原有结构，但增加自定义HAL抽象层在`src/hal/`

#### 4.2.4 驱动层迁移 (HARDWARE/ → src/drivers/)
```
HARDWARE/24CXX/    → src/drivers/sensors/ (如果是传感器)
HARDWARE/IIC/      → src/hal/i2c_hal.c/h
HARDWARE/KEY/      → src/drivers/input/
HARDWARE/LCD/      → src/drivers/display/
HARDWARE/LED/      → src/drivers/actuators/led_control.c/h
```

## 5. v2模板的优势特点

### 5.1 层次清晰
- 严格按照四层架构组织代码
- 每层职责明确，接口标准化
- 易于理解和维护

### 5.2 模块化设计
- 功能模块独立，降低耦合
- 标准化接口，便于扩展
- 支持组件复用

### 5.3 扩展性强
- 易于添加新的传感器和执行器
- 支持多种通信协议
- 灵活的配置管理

### 5.4 工程化程度高
- 完整的构建系统支持
- 标准化的文档结构
- 完善的版本管理

## 6. 实施建议

### 6.1 迁移步骤
1. **创建v2目录结构**: 按照上述模板创建完整目录
2. **迁移核心文件**: 先迁移CORE和HALLIB等基础库
3. **重构应用代码**: 按层次重新组织USER中的代码
4. **适配硬件驱动**: 将HARDWARE中的驱动按新结构归类
5. **配置构建系统**: 设置CMake/Makefile等构建配置
6. **测试验证**: 逐层测试确保功能正确

### 6.2 开发规范
- 统一的命名约定
- 完整的接口文档
- 模块化的设计原则
- 标准化的错误处理

### 6.3 质量保证
- 分层测试策略
- 代码审查机制
- 持续集成支持
- 性能监控体系

## 7. 总结

v2模板目录结构相比template_simple具有更清晰的层次架构、更强的扩展性和更高的工程化程度。通过系统的迁移和重构，可以构建一个更加规范、可维护的墨路控制系统项目。

---

*文档版本: v1.0*
*创建时间: 2025-09-29*
*基于设计文档v2和ink_supply_template_simple分析编写*