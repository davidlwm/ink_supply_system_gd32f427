# Bootloader工程编译说明

## 工程已配置完成！

### 工程结构

```
bootloader_gd32f427/
├── USER/
│   ├── Bootloader.uvprojx    ← Keil工程文件
│   ├── main.c
│   ├── gd32f4xx_it.c
│   └── system_gd32f4xx.c
├── bootloader/               ← Bootloader核心代码
│   ├── bootloader.c
│   ├── bootloader.h
│   ├── boot_config.c
│   └── boot_config.h (in config/)
├── utils/                    ← 工具模块
│   ├── crc32.c/h
│   └── flash_hal.c/h
├── config/                   ← 配置文件
│   ├── flash_layout.h
│   ├── boot_config.h
│   └── gd32f427_bootloader.ld
├── CORE/                     ← Cortex-M4核心 (已复制)
├── HALLIB/                   ← GD32F4 HAL库 (已复制)
├── SYSTEM/                   ← 系统代码 (已复制)
├── HARDWARE/                 ← 硬件驱动 (已复制)
└── OBJ/                      ← 编译输出目录
```

## 编译步骤

### 方法1：使用Keil MDK编译

1. **打开工程**
   - 启动Keil MDK
   - 打开 `USER/Bootloader.uvprojx`

2. **编译工程**
   - 点击菜单 `Project -> Build Target` (或按F7)
   - 或点击工具栏的编译按钮

3. **输出文件**
   编译成功后在 `OBJ/` 目录生成：
   - `Bootloader.axf` - ELF可执行文件
   - `Bootloader.hex` - Intel HEX格式
   - `Bootloader.bin` - 二进制格式 (用于烧录)

### 方法2：命令行编译 (需要配置环境变量)

```batch
cd USER
uvision -b Bootloader.uvprojx -o build.log
```

## 工程配置说明

### 1. Flash配置
- **起始地址**: 0x08000000
- **大小**: 64KB (0x10000)
- **链接脚本**: config/gd32f427_bootloader.ld

### 2. 编译选项
- **优化等级**: -O2
- **C标准**: C99
- **定义宏**: `GD32F427`, `USE_STDPERIPH_DRIVER`

### 3. 包含路径
已自动配置以下头文件路径：
- `../CORE`
- `../USER`
- `../SYSTEM/delay`
- `../SYSTEM/sys`
- `../SYSTEM/usart`
- `../HALLIB/STM32F4xx_HAL_Driver/Inc`
- `../HARDWARE/LED`
- `../HARDWARE/KEY`
- `../config`
- `../bootloader`
- `../utils`

## 烧录说明

### 使用J-Link烧录

```bash
# 进入OBJ目录
cd OBJ

# 使用J-Flash或命令行
JLinkExe -device GD32F427VE -if SWD -speed 4000
> connect
> loadbin Bootloader.bin 0x08000000
> verifybin Bootloader.bin 0x08000000
> reset
> go
> exit
```

### 使用ST-Link烧录

```bash
STM32_Programmer_CLI -c port=SWD -w Bootloader.hex -rst
```

## 常见问题

### Q1: 编译错误 "cannot open source input file"
**解决**: 检查所有源文件路径是否正确，确保CORE、HALLIB等文件夹已复制

### Q2: 链接错误 "undefined reference to xxx"
**解决**:
1. 确保所有.c文件都已添加到工程
2. 检查头文件路径是否正确配置
3. 检查函数声明和定义是否匹配

### Q3: Flash空间不足
**解决**:
- 当前配置为64KB
- 如需更多空间，修改工程配置中的IROM大小
- 注意：Bootloader应尽量精简

### Q4: gd32f4xx.h找不到
**解决**:
- 确保复制了完整的HALLIB文件夹
- 检查Include路径中是否有HALLIB/STM32F4xx_HAL_Driver/Inc

## 调试说明

### 启用调试输出

1. 在工程中添加宏定义 `BOOTLOADER_DEBUG`:
   - 右键工程 -> `Options for Target`
   - `C/C++` -> `Define` 添加: `BOOTLOADER_DEBUG`

2. 调试信息通过UART0输出 (PA9/PA10)
   - 波特率: 115200
   - 数据位: 8
   - 停止位: 1
   - 无校验

### Keil调试器配置

1. `Options for Target` -> `Debug`
2. 选择 `J-Link/J-Trace Cortex`
3. `Settings` -> 设置 `Port: SW`, `Max Clock: 10MHz`
4. 点击OK保存

## 生成固件包

编译成功后可以生成完整的固件包：

```bash
# 创建发布目录
mkdir release
cd release

# 复制必要文件
copy ..\OBJ\Bootloader.bin Bootloader_v1.0.0.bin
copy ..\OBJ\Bootloader.hex Bootloader_v1.0.0.hex

# 打包
tar -czf Bootloader_v1.0.0.tar.gz *
```

## 下一步

编译成功后：
1. ✅ 烧录Bootloader到0x08000000
2. ✅ 修改应用程序链接脚本（起始地址0x08014000）
3. ✅ 测试Bootloader启动和跳转
4. ✅ 实现OTA升级功能

## 技术支持

- 参考文档: `README.md`
- OTA设计: `../OTA固件升级设计方案.md`
- 快速开始: `快速开始.md`

---
工程配置完成日期: 2025-09-30
Bootloader版本: v1.0.0