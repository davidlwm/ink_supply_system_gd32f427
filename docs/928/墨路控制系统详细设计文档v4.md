# å¢¨è·¯æ§åˆ¶ç³»ç»Ÿè¯¦ç»†è®¾è®¡æ–‡æ¡£ v4

> **ç‰ˆæœ¬**: v4.0
> **æ›´æ–°å†…å®¹**: é›†æˆå®Œæ•´çš„ç½‘ç»œé€šä¿¡è®¾è®¡(EtherCAT/TCPå…¼å®¹æ–¹æ¡ˆ)
> **æ›´æ–°æ—¥æœŸ**: 2025-09-30
> **è®¾è®¡ä¾æ®**: å¢¨è·¯é€šä¿¡åè®®è¡¨æ ¼ + v3ç³»ç»Ÿè®¾è®¡

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 æŠ€æœ¯é€‰å‹
- **MCU**: GD32F427
- **æ“ä½œç³»ç»Ÿ**: FreeRTOS
- **ç½‘ç»œåè®®æ ˆ**: lwIP
- **é€šä¿¡åè®®**: EtherCATå¼€æºåº“ + è‡ªå®šä¹‰TCPåè®®
- **HALåº“**: STM32 HALåº“

### 1.2 ç³»ç»Ÿæ¶æ„
é‡‡ç”¨å››å±‚åˆ†å±‚æ¶æ„è®¾è®¡ï¼š
```
åº”ç”¨å±‚ (Application Layer)
    â†“
ä¸­é—´ä»¶å±‚ (Middleware Layer) â† æ–°å¢ç½‘ç»œé€šä¿¡ä¸­é—´ä»¶
    â†“
HALå±‚ (Hardware Abstraction Layer)
    â†“
é©±åŠ¨å±‚ (Driver Layer)
```

### 1.3 ä»£ç ç›®å½•ç»“æ„

```
ink_supply_gd32f427/
â”œâ”€â”€ ğŸ“ app/                                # åº”ç”¨å±‚
â”‚   â”œâ”€â”€ ğŸ“„ main.c                          # ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ ğŸ“„ app_main.c/h                    # åº”ç”¨ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ ğŸ“„ sensor_task.c/h                 # ä¼ æ„Ÿå™¨ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ actuator_task.c/h               # æ‰§è¡Œå™¨ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ control_task.c/h                # æ§åˆ¶ä»»åŠ¡ (PIDæ§åˆ¶)
â”‚   â”œâ”€â”€ ğŸ“„ safety_task.c/h                 # å®‰å…¨ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ hmi_task.c/h                    # HMIä»»åŠ¡ (LCD+LED)
â”‚   â”œâ”€â”€ ğŸ“„ comm_task.c/h                   # é€šä¿¡ä»»åŠ¡ (è°ƒç”¨ä¸­é—´ä»¶)
â”‚   â”œâ”€â”€ ğŸ“„ config_task.c/h                 # é…ç½®ä»»åŠ¡
â”‚   â”œâ”€â”€ ğŸ“„ ethercat_app.c/h                # EtherCATåº”ç”¨
â”‚   â””â”€â”€ ğŸ“„ tcp_server.c/h                  # TCPæœåŠ¡å™¨
â”‚
â”œâ”€â”€ ğŸ“ hal/                                # HALæŠ½è±¡å±‚
â”‚   â”œâ”€â”€ ğŸ“„ hal_common.c/h                  # HALå…¬å…±åŠŸèƒ½
â”‚   â”œâ”€â”€ ğŸ“„ hal_manager.c/h                 # HALç®¡ç†å™¨
â”‚   â”œâ”€â”€ ğŸ“„ adc_hal.c/h                     # ADCç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ pwm_hal.c/h                     # PWMç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ gpio_hal.c/h                    # GPIOç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ uart_hal.c/h                    # UARTç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ spi_hal.c/h                     # SPIç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ i2c_hal.c/h                     # I2Cç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ eth_hal.c/h                     # ä»¥å¤ªç½‘ç¡¬ä»¶æŠ½è±¡
â”‚   â”œâ”€â”€ ğŸ“„ flash_hal.c/h                   # Flashç¡¬ä»¶æŠ½è±¡
â”‚   â””â”€â”€ ğŸ“„ timer_hal.c/h                   # å®šæ—¶å™¨ç¡¬ä»¶æŠ½è±¡
â”‚
â”œâ”€â”€ ğŸ“ middleware/                         # ä¸­é—´ä»¶å±‚
â”‚   â”œâ”€â”€ ğŸ“ network/                        # ç½‘ç»œé€šä¿¡ä¸­é—´ä»¶ âœ¨æ–°å¢
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ comm_manager.c/h            # é€šä¿¡ç®¡ç†å™¨(æ ¸å¿ƒ)
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ protocol_adapter.c/h        # åè®®é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ tcp_protocol.c/h            # TCPåè®®å®ç°
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ethercat_protocol.c/h       # EtherCATåè®®å®ç°
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ message_queue.c/h           # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”‚   â””â”€â”€ ğŸ“„ network_config.c/h          # ç½‘ç»œé…ç½®
â”‚   â”œâ”€â”€ ğŸ“ delay/                          # å»¶æ—¶åŠŸèƒ½
â”‚   â”‚   â””â”€â”€ ğŸ“„ delay.c/h                   # å»¶æ—¶å®ç°
â”‚   â”œâ”€â”€ ğŸ“ sys/                            # ç³»ç»ŸåŠŸèƒ½
â”‚   â”‚   â””â”€â”€ ğŸ“„ sys.c/h                     # ç³»ç»Ÿé…ç½®
â”‚   â”œâ”€â”€ ğŸ“ usart/                          # ä¸²å£åŠŸèƒ½
â”‚   â”‚   â””â”€â”€ ğŸ“„ usart.c/h                   # ä¸²å£é©±åŠ¨
â”‚   â”œâ”€â”€ ğŸ“„ middleware_common.c/h           # ä¸­é—´ä»¶å…¬å…±åŠŸèƒ½
â”‚   â”œâ”€â”€ ğŸ“„ tasks.c/h                       # FreeRTOSä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ ğŸ“„ pid.c/h                         # PIDç®—æ³•å®ç°
â”‚   â””â”€â”€ ğŸ“„ filter.c/h                      # æ•°å­—æ»¤æ³¢ç®—æ³•
â”‚
â”œâ”€â”€ ğŸ“ drivers/                            # é©±åŠ¨å±‚
â”‚   â”œâ”€â”€ ğŸ“ sensors/                        # ä¼ æ„Ÿå™¨é©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ frd8061_driver.c/h          # FRD8061æ¶²ä½ä¼ æ„Ÿå™¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ftt518_driver.c/h           # FTT518æ¸©åº¦ä¼ æ„Ÿå™¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ hp10my_driver.c/h           # HP10MYå‹åŠ›ä¼ æ„Ÿå™¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ sensor_common.c/h           # ä¼ æ„Ÿå™¨å…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ actuators/                      # æ‰§è¡Œå™¨é©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ mra23d3_driver.c/h          # MRA23D3ç”µæœºé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ mpb025bbb_driver.c/h        # MPB025BBBæ³µé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ valve_control.c/h           # é˜€é—¨æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ led_control.c/h             # LEDæ§åˆ¶
â”‚   â”‚   â””â”€â”€ ğŸ“„ actuator_common.c/h         # æ‰§è¡Œå™¨å…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ display/                        # æ˜¾ç¤ºé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ lcd_driver.c/h              # LCDé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ oled_driver.c/h             # OLEDé©±åŠ¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ display_common.c/h          # æ˜¾ç¤ºå…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ input/                          # è¾“å…¥è®¾å¤‡é©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ key_driver.c/h              # æŒ‰é”®é©±åŠ¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ input_common.c/h            # è¾“å…¥å…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ storage/                        # å­˜å‚¨é©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ 24cxx_driver.c/h            # EEPROMé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ flash_driver.c/h            # å†…éƒ¨Flashé©±åŠ¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ storage_common.c/h          # å­˜å‚¨å…¬å…±æ¥å£
â”‚   â”œâ”€â”€ ğŸ“ communication/                  # é€šä¿¡é©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ iic_driver.c/h              # I2Cé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ can_driver.c/h              # CANé©±åŠ¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ethernet_driver.c/h         # ä»¥å¤ªç½‘é©±åŠ¨
â”‚   â”‚   â””â”€â”€ ğŸ“„ comm_common.c/h             # é€šä¿¡å…¬å…±æ¥å£
â”‚   â””â”€â”€ ğŸ“„ driver_manager.c/h              # é©±åŠ¨ç®¡ç†å™¨
â”‚
â”œâ”€â”€ ğŸ“ lib/                                # ç¬¬ä¸‰æ–¹åº“
â”‚   â”œâ”€â”€ ğŸ“ STM32F4xx_HAL_Driver/           # STM32 HALåº“
â”‚   â”‚   â”œâ”€â”€ ğŸ“ Inc/                        # HALåº“å¤´æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ ğŸ“ Src/                        # HALåº“æºæ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ CMSIS/                          # ARM CMSISåº“
â”‚   â”œâ”€â”€ ğŸ“ FreeRTOS/                       # FreeRTOSå®æ—¶æ“ä½œç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ ğŸ“ Source/                     # RTOSæºç 
â”‚   â”‚   â””â”€â”€ ğŸ“ portable/                   # GD32F427ç§»æ¤å±‚
â”‚   â”œâ”€â”€ ğŸ“ lwip/                           # lwIPç½‘ç»œåè®®æ ˆ
â”‚   â”‚   â”œâ”€â”€ ğŸ“ src/                        # lwIPæºç 
â”‚   â”‚   â””â”€â”€ ğŸ“ port/                       # GD32F427ç§»æ¤ä»£ç 
â”‚   â””â”€â”€ ğŸ“ ethercat/                       # EtherCATå¼€æºåº“
â”‚       â””â”€â”€ ğŸ“ slave/                      # ä»ç«™åº“
â”‚
â”œâ”€â”€ ğŸ“ include/                            # å¤´æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“ app/                            # åº”ç”¨å±‚å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ hal/                            # HALå±‚å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ middleware/                     # ä¸­é—´ä»¶å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ drivers/                        # é©±åŠ¨å±‚å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“ common/                         # å…¬å…±å¤´æ–‡ä»¶ âœ¨æ–°å¢
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ protocol_data.h             # åè®®æ•°æ®ç»“æ„å®šä¹‰
â”‚   â”‚   â””â”€â”€ ğŸ“„ tcp_protocol.h              # TCPåè®®å®šä¹‰
â”‚   â””â”€â”€ ğŸ“„ project_config.h                # é¡¹ç›®å…¨å±€é…ç½®
â”‚
â”œâ”€â”€ ğŸ“ config/                             # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“„ FreeRTOSConfig.h                # FreeRTOSé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ lwipopts.h                      # lwIPé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ gd32f4xx_hal_conf.h             # GD32 HALé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ system_config.h                 # ç³»ç»Ÿå‚æ•°é…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ app_config.h                    # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ sensor_config.h                 # ä¼ æ„Ÿå™¨é…ç½®
â”‚   â””â”€â”€ ğŸ“„ network_config.h                # ç½‘ç»œé…ç½® âœ¨æ–°å¢
â”‚
â”œâ”€â”€ ğŸ“ USER/                               # å·¥ç¨‹é…ç½®å±‚
â”‚   â”œâ”€â”€ ğŸ“ DebugConfig/                    # è°ƒè¯•é…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ gd32f407xx.h                    # GD32F407å®šä¹‰
â”‚   â”œâ”€â”€ ğŸ“„ gd32f4xx.h                      # GD32F4xxæ€»å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“„ gd32f4xx_it.c/h                # ä¸­æ–­æœåŠ¡å‡½æ•°
â”‚   â”œâ”€â”€ ğŸ“„ stm32f4xx_hal_conf.h           # HALé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ stm32f4xx_hal_msp.c            # HAL MSPé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ system_gd32f4xx.c/h            # ç³»ç»Ÿæ—¶é’Ÿé…ç½®
â”‚   â”œâ”€â”€ ğŸ“„ InkSupplySystem.uvprojx         # Keilå·¥ç¨‹æ–‡ä»¶
â”‚   â””â”€â”€ ğŸ“„ main.h                          # ä¸»ç¨‹åºå¤´æ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ“ USMART/                             # è°ƒè¯•å·¥å…·
â”‚   â”œâ”€â”€ ğŸ“„ usmart.c/h                      # USMARTæ ¸å¿ƒ
â”‚   â”œâ”€â”€ ğŸ“„ usmart_config.c                 # USMARTé…ç½®
â”‚   â””â”€â”€ ğŸ“„ usmart_str.c/h                  # å­—ç¬¦ä¸²å¤„ç†
â”‚
â”œâ”€â”€ ğŸ“ docs/                               # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ design.md                       # è®¾è®¡æ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ“„ api_reference.md                # APIå‚è€ƒæ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ“„ migration_guide.md              # è¿ç§»æŒ‡å—
â”‚   â”œâ”€â”€ ğŸ“„ development_guide.md            # å¼€å‘æŒ‡å—
â”‚   â””â”€â”€ ğŸ“„ network_communication_design.md # ç½‘ç»œé€šä¿¡è®¾è®¡ âœ¨æ–°å¢
â”‚
â”œâ”€â”€ ğŸ“ tools/                              # å·¥å…·ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ build.py                        # æ„å»ºè„šæœ¬
â”‚   â””â”€â”€ ğŸ“„ config_generator.py             # é…ç½®ç”Ÿæˆå·¥å…·
â”‚
â”œâ”€â”€ ğŸ“ OBJ/                                # ç¼–è¯‘è¾“å‡º
â”‚   â”œâ”€â”€ ğŸ“ Debug/                          # è°ƒè¯•ç‰ˆæœ¬
â”‚   â””â”€â”€ ğŸ“ Release/                        # å‘å¸ƒç‰ˆæœ¬
â”‚
â”œâ”€â”€ ğŸ“„ README.md                           # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ ğŸ“„ CHANGELOG.md                        # ç‰ˆæœ¬å˜æ›´æ—¥å¿—
â””â”€â”€ ğŸ“„ .gitignore                          # Gitå¿½ç•¥é…ç½®
```

### 1.4 æ¨¡å—åŒ–è®¾è®¡ç†å¿µ

- **åˆ†å±‚æ¸…æ™°**: ä¸¥æ ¼æŒ‰ç…§åº”ç”¨å±‚ã€ä¸­é—´ä»¶å±‚ã€HALå±‚ã€é©±åŠ¨å±‚å››å±‚æ¶æ„
- **èŒè´£åˆ†ç¦»**: æ¯ä¸ªæ¨¡å—ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½ï¼Œé™ä½è€¦åˆåº¦
- **æ¥å£æ ‡å‡†åŒ–**: ç»Ÿä¸€çš„æ¥å£è®¾è®¡ï¼Œä¾¿äºæ¨¡å—é—´åä½œ
- **åè®®å…¼å®¹**: ç½‘ç»œä¸­é—´ä»¶æ”¯æŒEtherCATå’ŒTCP/IPåŒåè®® âœ¨
- **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„ä¼ æ„Ÿå™¨ã€æ‰§è¡Œå™¨æˆ–åŠŸèƒ½æ¨¡å—

---

## 2. ç½‘ç»œé€šä¿¡æ¶æ„è®¾è®¡ âœ¨æ–°å¢ç« èŠ‚

### 2.1 é€šä¿¡åè®®æ•°æ®ç»“æ„ (åŸºäºåè®®è¡¨æ ¼)

#### 2.1.1 æ ¸å¿ƒæ•°æ®ç»“æ„å®šä¹‰

è¯¦ç»†å®šä¹‰å‚è§ `include/common/protocol_data.h`:

```c
//==============================================================================
// ä¼ æ„Ÿå™¨æ•°æ®ç»“æ„ (å¯¹åº”åè®®è¡¨è¡Œ0-11)
//==============================================================================
typedef struct {
    int16_t  temperature[3];        // æ¸©åº¦ä¼ æ„Ÿå™¨ 0.1Â°C (-50.0~300.0Â°C)
    uint16_t pressure[4];           // å‹åŠ›ä¼ æ„Ÿå™¨ 0.1kPa
    uint16_t level[3];              // æ¶²ä½ä¼ æ„Ÿå™¨ 0.1mm
    uint16_t level_analog;          // æ¨¡æ‹Ÿæ¶²ä½ 0.1mm
    uint16_t flow_rate;             // æµé‡ 0.01L/min
    uint16_t level_switch_status;   // æ¶²ä½å¼€å…³çŠ¶æ€ä½
} __attribute__((packed)) sensor_data_t;  // 26å­—èŠ‚

//==============================================================================
// æ‰§è¡Œå™¨çŠ¶æ€ç»“æ„ (å¯¹åº”åè®®è¡¨è¡Œ18-29)
//==============================================================================
typedef struct {
    uint16_t actuator_status1;      // é˜€é—¨+æ³µçŠ¶æ€ä½
    uint16_t actuator_status2;      // åŠ çƒ­å™¨çŠ¶æ€ä½
    uint16_t pump_speed[2];         // è°ƒé€Ÿæ³µé€Ÿåº¦ 0.1%
    uint16_t heater_current[3];     // åŠ çƒ­å™¨ç”µæµ 0.01A
} __attribute__((packed)) actuator_status_t;  // 10å­—èŠ‚

//==============================================================================
// æ§åˆ¶è®¾å®šå€¼ç»“æ„ (å¯¹åº”åè®®è¡¨è¡Œ30-40)
//==============================================================================
typedef struct {
    int16_t  temp_setpoint[3];      // æ¸©åº¦è®¾å®š 0.1Â°C
    uint16_t pressure_setpoint[4];  // å‹åŠ›è®¾å®š 0.1kPa
    uint16_t level_setpoint[3];     // æ¶²ä½è®¾å®š 0.1mm
    uint16_t flow_setpoint;         // æµé‡è®¾å®š 0.01L/min
} __attribute__((packed)) control_setpoint_t;  // 22å­—èŠ‚

//==============================================================================
// ç³»ç»ŸçŠ¶æ€ç»“æ„
//==============================================================================
typedef struct {
    uint16_t status_word;           // ç³»ç»ŸçŠ¶æ€å­—
    uint16_t alarm_word1;           // å‘Šè­¦å­—1
    uint16_t alarm_word2;           // å‘Šè­¦å­—2
    uint32_t timestamp;             // æ—¶é—´æˆ³(ms)
    uint16_t cycle_counter;         // å¾ªç¯è®¡æ•°å™¨
} __attribute__((packed)) system_status_t;  // 12å­—èŠ‚

//==============================================================================
// å®Œæ•´å®æ—¶æ•°æ®åŒ… (ä¼ æ„Ÿå™¨+æ‰§è¡Œå™¨+çŠ¶æ€)
//==============================================================================
typedef struct {
    sensor_data_t       sensors;        // 26å­—èŠ‚
    actuator_status_t   actuators;      // 10å­—èŠ‚
    system_status_t     system;         // 12å­—èŠ‚
} __attribute__((packed)) realtime_data_t;  // æ€»è®¡: 48å­—èŠ‚

//==============================================================================
// å®Œæ•´æ§åˆ¶æ•°æ®åŒ… (è®¾å®šå€¼+æ§åˆ¶å‘½ä»¤+æ§åˆ¶å­—)
//==============================================================================
typedef struct {
    control_setpoint_t  setpoints;      // 22å­—èŠ‚
    actuator_control_t  controls;       // 6å­—èŠ‚
    uint16_t            control_word;   // 2å­—èŠ‚
} __attribute__((packed)) control_data_t;   // æ€»è®¡: 30å­—èŠ‚
```

#### 2.1.2 çŠ¶æ€å­—å’Œæ§åˆ¶å­—ä½å®šä¹‰

```c
// ç³»ç»ŸçŠ¶æ€å­— (status_word)
#define STATUS_BIT_READY            (1 << 0)    // ç³»ç»Ÿå°±ç»ª
#define STATUS_BIT_RUNNING          (1 << 1)    // ç³»ç»Ÿè¿è¡Œä¸­
#define STATUS_BIT_ALARM            (1 << 2)    // å­˜åœ¨å‘Šè­¦
#define STATUS_BIT_FAULT            (1 << 3)    // å­˜åœ¨æ•…éšœ
#define STATUS_BIT_SAFE_MODE        (1 << 4)    // å®‰å…¨æ¨¡å¼
#define STATUS_BIT_MANUAL_MODE      (1 << 5)    // æ‰‹åŠ¨æ¨¡å¼
#define STATUS_BIT_AUTO_MODE        (1 << 6)    // è‡ªåŠ¨æ¨¡å¼
#define STATUS_BIT_COMM_OK          (1 << 7)    // é€šä¿¡æ­£å¸¸
#define STATUS_BIT_SENSOR_FAULT     (1 << 8)    // ä¼ æ„Ÿå™¨æ•…éšœ
#define STATUS_BIT_ACTUATOR_FAULT   (1 << 9)    // æ‰§è¡Œå™¨æ•…éšœ
#define STATUS_BIT_TEMP_OVER        (1 << 10)   // æ¸©åº¦è¶…é™
#define STATUS_BIT_PRESSURE_OVER    (1 << 11)   // å‹åŠ›è¶…é™
#define STATUS_BIT_LEVEL_ABNORMAL   (1 << 12)   // æ¶²ä½å¼‚å¸¸

// æ§åˆ¶å­— (control_word)
#define CTRL_BIT_ENABLE             (1 << 0)    // ç³»ç»Ÿä½¿èƒ½
#define CTRL_BIT_RESET              (1 << 1)    // å¤ä½å‘½ä»¤
#define CTRL_BIT_START              (1 << 2)    // å¯åŠ¨å‘½ä»¤
#define CTRL_BIT_STOP               (1 << 3)    // åœæ­¢å‘½ä»¤
#define CTRL_BIT_EMERGENCY_STOP     (1 << 4)    // ç´§æ€¥åœæ­¢
#define CTRL_BIT_AUTO_MODE          (1 << 5)    // åˆ‡æ¢è‡ªåŠ¨æ¨¡å¼
#define CTRL_BIT_MANUAL_MODE        (1 << 6)    // åˆ‡æ¢æ‰‹åŠ¨æ¨¡å¼
#define CTRL_BIT_PARAM_SAVE         (1 << 7)    // ä¿å­˜å‚æ•°
#define CTRL_BIT_ALARM_ACK          (1 << 9)    // å‘Šè­¦ç¡®è®¤
#define CTRL_BIT_PID_AUTOTUNE       (1 << 11)   // PIDè‡ªæ•´å®š
```

### 2.2 TCP/IPé€šä¿¡åè®®

#### 2.2.1 TCPåè®®å¸§æ ¼å¼

```c
// TCPå¸§å¤´å®šä¹‰ (10å­—èŠ‚)
typedef struct {
    uint16_t sync_word;         // åŒæ­¥å­— 0xAA55
    uint8_t  version;           // åè®®ç‰ˆæœ¬ 0x01
    uint8_t  cmd;               // å‘½ä»¤å­—
    uint16_t length;            // æ•°æ®é•¿åº¦
    uint16_t sequence;          // åºåˆ—å·
    uint16_t checksum;          // å¸§å¤´CRC16
} __attribute__((packed)) tcp_frame_header_t;

// å®Œæ•´TCPå¸§
typedef struct {
    tcp_frame_header_t header;  // 10å­—èŠ‚å¸§å¤´
    uint8_t data[256];          // æœ€å¤§256å­—èŠ‚æ•°æ®
    uint16_t crc16;             // æ•´å¸§CRC16æ ¡éªŒ
} __attribute__((packed)) tcp_protocol_frame_t;
```

#### 2.2.2 TCPå‘½ä»¤å­—å®šä¹‰

```c
typedef enum {
    // æ•°æ®è¯»å–å‘½ä»¤ (0x01-0x0F)
    CMD_READ_REALTIME_DATA      = 0x01,     // è¯»å–å®æ—¶æ•°æ®(48å­—èŠ‚)
    CMD_READ_SENSOR_DATA        = 0x02,     // è¯»å–ä¼ æ„Ÿå™¨æ•°æ®
    CMD_READ_ACTUATOR_STATUS    = 0x03,     // è¯»å–æ‰§è¡Œå™¨çŠ¶æ€
    CMD_READ_SYSTEM_STATUS      = 0x04,     // è¯»å–ç³»ç»ŸçŠ¶æ€
    CMD_READ_ALARM_INFO         = 0x05,     // è¯»å–å‘Šè­¦ä¿¡æ¯

    // æ•°æ®å†™å…¥å‘½ä»¤ (0x10-0x1F)
    CMD_WRITE_SETPOINT          = 0x10,     // å†™å…¥è®¾å®šå€¼(22å­—èŠ‚)
    CMD_WRITE_ACTUATOR_CONTROL  = 0x11,     // å†™å…¥æ‰§è¡Œå™¨æ§åˆ¶
    CMD_WRITE_CONTROL_WORD      = 0x12,     // å†™å…¥æ§åˆ¶å­—
    CMD_WRITE_CONTROL_DATA      = 0x13,     // å†™å…¥å®Œæ•´æ§åˆ¶æ•°æ®(30å­—èŠ‚)

    // å‚æ•°é…ç½®å‘½ä»¤ (0x20-0x2F)
    CMD_READ_PID_PARAMS         = 0x20,     // è¯»å–PIDå‚æ•°
    CMD_WRITE_PID_PARAMS        = 0x21,     // å†™å…¥PIDå‚æ•°
    CMD_READ_SENSOR_CONFIG      = 0x22,     // è¯»å–ä¼ æ„Ÿå™¨é…ç½®
    CMD_WRITE_SENSOR_CONFIG     = 0x23,     // å†™å…¥ä¼ æ„Ÿå™¨é…ç½®

    // ç³»ç»Ÿæ§åˆ¶å‘½ä»¤ (0x30-0x3F)
    CMD_SYSTEM_RESET            = 0x30,     // ç³»ç»Ÿå¤ä½
    CMD_SYSTEM_START            = 0x31,     // ç³»ç»Ÿå¯åŠ¨
    CMD_SYSTEM_STOP             = 0x32,     // ç³»ç»Ÿåœæ­¢
    CMD_EMERGENCY_STOP          = 0x33,     // ç´§æ€¥åœæ­¢
    CMD_ALARM_ACK               = 0x34,     // å‘Šè­¦ç¡®è®¤

    // é…ç½®ç®¡ç†å‘½ä»¤ (0x40-0x4F)
    CMD_SAVE_CONFIG             = 0x40,     // ä¿å­˜é…ç½®åˆ°Flash
    CMD_LOAD_CONFIG             = 0x41,     // ä»FlashåŠ è½½é…ç½®
    CMD_RESTORE_DEFAULT         = 0x42,     // æ¢å¤é»˜è®¤é…ç½®

    // å“åº”å‘½ä»¤ (0x80-0xFF)
    CMD_RESPONSE_OK             = 0x80,     // å“åº”æˆåŠŸ
    CMD_RESPONSE_ERROR          = 0x81,     // å“åº”é”™è¯¯
    CMD_RESPONSE_DATA           = 0x82,     // å“åº”æ•°æ®
} tcp_command_t;
```

#### 2.2.3 TCPé€šä¿¡ç¤ºä¾‹

**ä¸Šä½æœºè¯»å–å®æ—¶æ•°æ®**:
```
è¯·æ±‚å¸§ (12å­—èŠ‚):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0xAA55 â”‚0x01â”‚0x01â”‚0x0000â”‚ åºåˆ—å· â”‚ CRC16-H â”‚ CRC16  â”‚
â”‚  åŒæ­¥  â”‚ç‰ˆæœ¬â”‚å‘½ä»¤â”‚ é•¿åº¦ â”‚        â”‚ å¸§å¤´æ ¡éªŒâ”‚ å¸§æ ¡éªŒ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å“åº”å¸§ (60å­—èŠ‚):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0xAA55 â”‚0x01â”‚0x82â”‚0x0030â”‚ åºåˆ—å· â”‚ CRC16-H â”‚48å­—èŠ‚æ•°æ®â”‚ CRC16  â”‚
â”‚  åŒæ­¥  â”‚ç‰ˆæœ¬â”‚å“åº”â”‚é•¿åº¦48â”‚        â”‚ å¸§å¤´æ ¡éªŒâ”‚realtime_tâ”‚ å¸§æ ¡éªŒ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 EtherCATé€šä¿¡åè®®

#### 2.3.1 EtherCAT PDOæ˜ å°„

**TxPDO 1 (ä»ç«™â†’ä¸»ç«™) - 54å­—èŠ‚å®æ—¶æ•°æ®**

```c
typedef struct __attribute__((packed)) {
    // ä¼ æ„Ÿå™¨æ•°æ® (26å­—èŠ‚) - åç§»0
    int16_t  temperature[3];        // åç§»0:  æ¸©åº¦ 6å­—èŠ‚
    uint16_t pressure[4];           // åç§»6:  å‹åŠ› 8å­—èŠ‚
    uint16_t level[3];              // åç§»14: æ¶²ä½ 6å­—èŠ‚
    uint16_t level_analog;          // åç§»20: æ¨¡æ‹Ÿæ¶²ä½ 2å­—èŠ‚
    uint16_t flow_rate;             // åç§»22: æµé‡ 2å­—èŠ‚
    uint16_t level_switch_status;   // åç§»24: æ¶²ä½å¼€å…³ 2å­—èŠ‚

    // æ‰§è¡Œå™¨çŠ¶æ€ (10å­—èŠ‚) - åç§»26
    uint16_t actuator_status1;      // åç§»26: é˜€é—¨+æ³µçŠ¶æ€ 2å­—èŠ‚
    uint16_t actuator_status2;      // åç§»28: åŠ çƒ­å™¨çŠ¶æ€ 2å­—èŠ‚
    uint16_t pump_speed[2];         // åç§»30: æ³µé€Ÿåº¦åé¦ˆ 4å­—èŠ‚
    uint16_t heater_current[3];     // åç§»34: åŠ çƒ­å™¨ç”µæµ 6å­—èŠ‚

    // ç³»ç»ŸçŠ¶æ€ (12å­—èŠ‚) - åç§»40
    uint16_t status_word;           // åç§»40: çŠ¶æ€å­— 2å­—èŠ‚
    uint16_t alarm_word1;           // åç§»42: å‘Šè­¦å­—1 2å­—èŠ‚
    uint16_t alarm_word2;           // åç§»44: å‘Šè­¦å­—2 2å­—èŠ‚
    uint32_t timestamp;             // åç§»46: æ—¶é—´æˆ³ 4å­—èŠ‚
    uint16_t cycle_counter;         // åç§»50: å¾ªç¯è®¡æ•° 2å­—èŠ‚

    uint16_t crc16;                 // åç§»52: CRCæ ¡éªŒ 2å­—èŠ‚
} EtherCAT_TxPDO1_t;  // æ€»è®¡54å­—èŠ‚
```

**RxPDO 1 (ä¸»ç«™â†’ä»ç«™) - 34å­—èŠ‚æ§åˆ¶æ•°æ®**

```c
typedef struct __attribute__((packed)) {
    // è®¾å®šå€¼ (22å­—èŠ‚) - åç§»0
    int16_t  temp_setpoint[3];      // åç§»0:  æ¸©åº¦è®¾å®š 6å­—èŠ‚
    uint16_t pressure_setpoint[4];  // åç§»6:  å‹åŠ›è®¾å®š 8å­—èŠ‚
    uint16_t level_setpoint[3];     // åç§»14: æ¶²ä½è®¾å®š 6å­—èŠ‚
    uint16_t flow_setpoint;         // åç§»20: æµé‡è®¾å®š 2å­—èŠ‚

    // æ§åˆ¶å‘½ä»¤ (6å­—èŠ‚) - åç§»22
    uint16_t actuator_control1;     // åç§»22: é˜€é—¨+æ³µæ§åˆ¶ 2å­—èŠ‚
    uint16_t actuator_control2;     // åç§»24: åŠ çƒ­å™¨æ§åˆ¶ 2å­—èŠ‚
    uint16_t pump_speed_cmd[2];     // åç§»26: æ³µé€Ÿåº¦å‘½ä»¤ 4å­—èŠ‚

    // æ§åˆ¶å­— (4å­—èŠ‚) - åç§»30
    uint16_t control_word;          // åç§»30: æ§åˆ¶å­— 2å­—èŠ‚
    uint16_t watchdog;              // åç§»32: çœ‹é—¨ç‹—è®¡æ•° 2å­—èŠ‚
} EtherCAT_RxPDO1_t;  // æ€»è®¡34å­—èŠ‚
```

### 2.4 ç½‘ç»œä¸­é—´ä»¶å±‚è®¾è®¡

#### 2.4.1 é€šä¿¡ç®¡ç†å™¨æ¥å£

```c
// middleware/network/comm_manager.h

// åè®®ç±»å‹å®šä¹‰
typedef enum {
    COMM_PROTOCOL_NONE = 0,
    COMM_PROTOCOL_TCP,              // TCP/IPåè®®
    COMM_PROTOCOL_ETHERCAT,         // EtherCATåè®®
} comm_protocol_t;

// é€šä¿¡æ¨¡å¼å®šä¹‰
typedef enum {
    COMM_MODE_TCP_ONLY,             // çº¯TCPæ¨¡å¼
    COMM_MODE_ETHERCAT_ONLY,        // çº¯EtherCATæ¨¡å¼
    COMM_MODE_AUTO_SELECT,          // è‡ªåŠ¨é€‰æ‹©
} comm_mode_t;

//==============================================================================
// ç»Ÿä¸€é€šä¿¡æ¥å£ (åº”ç”¨å±‚è°ƒç”¨)
//==============================================================================
// åˆå§‹åŒ–
hal_status_t comm_manager_init(comm_mode_t mode);

// å‘é€æ¥å£ (è‡ªåŠ¨é€‰æ‹©åè®®)
hal_status_t comm_send_realtime_data(const realtime_data_t *data);
hal_status_t comm_send_sensor_data(const sensor_data_t *data);
hal_status_t comm_send_system_status(const system_status_t *status);

// æ¥æ”¶æ¥å£ (é€šè¿‡å›è°ƒè¿”å›æ•°æ®)
typedef void (*comm_data_callback_t)(const void *data, uint16_t len,
                                     comm_protocol_t from_protocol);

hal_status_t comm_register_control_callback(comm_data_callback_t callback);
hal_status_t comm_register_setpoint_callback(comm_data_callback_t callback);

// åè®®ç®¡ç†
hal_status_t comm_switch_protocol(comm_protocol_t protocol);
comm_status_t* comm_get_status(void);
```

#### 2.4.2 åè®®é€‚é…å™¨

```c
// middleware/network/protocol_adapter.h

typedef struct {
    comm_protocol_t type;

    // ç”Ÿå‘½å‘¨æœŸæ¥å£
    hal_status_t (*init)(void);
    hal_status_t (*start)(void);
    hal_status_t (*stop)(void);

    // æ•°æ®æ¥å£
    hal_status_t (*send_realtime)(const realtime_data_t *data);
    hal_status_t (*receive)(void *buffer, uint16_t *len);

    // çŠ¶æ€æ¥å£
    bool (*is_connected)(void);

} protocol_adapter_t;

// TCPé€‚é…å™¨å’ŒEtherCATé€‚é…å™¨
extern protocol_adapter_t tcp_adapter;
extern protocol_adapter_t ethercat_adapter;
```

### 2.5 åè®®å…¼å®¹æ€§è®¾è®¡

#### 2.5.1 æ•°æ®æ˜ å°„å…³ç³»

| æ•°æ®é¡¹ | åè®®è¡¨æ ¼ | realtime_data_t | TCPå‘½ä»¤ | EtherCAT PDO |
|--------|---------|----------------|---------|--------------|
| æ¸©åº¦ä¼ æ„Ÿå™¨ | è¡Œ0-2 | sensors.temperature[3] | CMD_READ_REALTIME | TxPDOåç§»0 |
| å‹åŠ›ä¼ æ„Ÿå™¨ | è¡Œ3-6 | sensors.pressure[4] | CMD_READ_REALTIME | TxPDOåç§»6 |
| æ¶²ä½ä¼ æ„Ÿå™¨ | è¡Œ7-10 | sensors.level[4] | CMD_READ_REALTIME | TxPDOåç§»14 |
| æµé‡ä¼ æ„Ÿå™¨ | è¡Œ11 | sensors.flow_rate | CMD_READ_REALTIME | TxPDOåç§»22 |
| æ¸©åº¦è®¾å®š | è¡Œ30-32 | setpoints.temp_setpoint[3] | CMD_WRITE_SETPOINT | RxPDOåç§»0 |
| å‹åŠ›è®¾å®š | è¡Œ33-36 | setpoints.pressure_setpoint[4] | CMD_WRITE_SETPOINT | RxPDOåç§»6 |

**å…³é”®ç‚¹**: æ‰€æœ‰æ•°æ®é¡¹åœ¨TCPå’ŒEtherCATä¸­ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ•°æ®ç»“æ„

#### 2.5.2 åè®®åˆ‡æ¢ç­–ç•¥

```c
// ç¼–è¯‘æ—¶é€‰æ‹©
#define ACTIVE_PROTOCOL COMM_PROTOCOL_ETHERCAT  // æˆ– COMM_PROTOCOL_TCP

// è¿è¡Œæ—¶åˆ‡æ¢
comm_mode_t mode = get_config_comm_mode();  // ä»é…ç½®è¯»å–
comm_manager_init(mode);

// è‡ªåŠ¨é€‰æ‹©æ¨¡å¼
comm_set_mode(COMM_MODE_AUTO_SELECT);
// ç³»ç»Ÿæ ¹æ®è¿æ¥çŠ¶æ€è‡ªåŠ¨é€‰æ‹©:
// - EtherCATä¸»ç«™è¿æ¥ â†’ ä½¿ç”¨EtherCAT
// - æ— EtherCATè¿æ¥ â†’ ä½¿ç”¨TCP
```

#### 2.5.3 å®æ—¶æ€§å¯¹æ¯”

| åè®® | æ•°æ®å‘¨æœŸ | å»¶è¿Ÿ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|---------|
| EtherCAT | 1ms | <1ms | å®æ—¶æ§åˆ¶,ç”Ÿäº§ç¯å¢ƒ |
| TCP/IP | 50-100ms | 10-50ms | è¿œç¨‹ç›‘æ§,è°ƒè¯•æµ‹è¯• |

---

## 3. åº”ç”¨å±‚è¯¦ç»†è®¾è®¡

### 3.1 ä»»åŠ¡æ¶æ„

#### 3.1.1 ä»»åŠ¡ä¼˜å…ˆçº§åˆ†é…
| ä»»åŠ¡åç§° | ä¼˜å…ˆçº§ | å‘¨æœŸ | æ ˆå¤§å° | åŠŸèƒ½æè¿° | å¯¹åº”æºæ–‡ä»¶ |
|---------|-------|------|--------|----------|-----------|
| Emergency Task | 20 | äº‹ä»¶è§¦å‘ | 1024 | ç´§æ€¥å®‰å…¨å¤„ç† | app/safety_task.c |
| EtherCAT Task | 18 | 1ms | 2048 | EtherCATé€šä¿¡å¤„ç† | app/ethercat_app.c |
| Safety Task | 15 | 10ms | 1024 | å®‰å…¨ç›‘æ§ | app/safety_task.c |
| Control Task | 12 | 20ms | 1536 | æ§åˆ¶é€»è¾‘ | app/control_task.c |
| Sensor Task | 8 | 50ms | 1024 | æ•°æ®é‡‡é›† | app/sensor_task.c |
| Actuator Task | 8 | 10ms | 1024 | æ‰§è¡Œå™¨ç®¡ç† | app/actuator_task.c |
| Comm Task | 5 | 10ms | 2048 | é€šä¿¡å¤„ç†(è°ƒç”¨ä¸­é—´ä»¶) | app/comm_task.c âœ¨ |
| TCP Task | 5 | 50ms | 2048 | TCPé€šä¿¡å¤„ç† | app/tcp_server.c |
| HMI Task | 5 | 100ms | 1024 | äººæœºäº¤äº’ | app/hmi_task.c |
| Config Task | 2 | 1000ms | 1024 | é…ç½®ç®¡ç† | app/config_task.c |

### 3.2 ä¼ æ„Ÿå™¨ä»»åŠ¡ (app/sensor_task.c/h)

#### 3.2.1 ä»»åŠ¡å®ç° âœ¨é›†æˆç½‘ç»œé€šä¿¡

```c
// app/sensor_task.c
#include "comm_manager.h"  // å¼•å…¥é€šä¿¡ç®¡ç†å™¨
#include "protocol_data.h"  // å¼•å…¥åè®®æ•°æ®ç»“æ„

void sensor_task(void *pvParameters)
{
    realtime_data_t rt_data;  // ä½¿ç”¨ç»Ÿä¸€æ•°æ®ç»“æ„

    while(1) {
        // 1. é‡‡é›†æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®
        collect_temperature_sensors(rt_data.sensors.temperature);
        collect_pressure_sensors(rt_data.sensors.pressure);
        collect_level_sensors(rt_data.sensors.level);
        collect_flow_sensor(&rt_data.sensors.flow_rate);
        collect_level_switches(&rt_data.sensors.level_switch_status);

        // 2. é‡‡é›†æ‰§è¡Œå™¨çŠ¶æ€
        get_actuator_status(&rt_data.actuators);

        // 3. é‡‡é›†ç³»ç»ŸçŠ¶æ€
        get_system_status(&rt_data.system);

        // 4. é€šè¿‡ç»Ÿä¸€æ¥å£å‘é€ (è‡ªåŠ¨é€‚é…TCPæˆ–EtherCAT)
        comm_send_realtime_data(&rt_data);

        vTaskDelay(pdMS_TO_TICKS(50));  // 50mså‘¨æœŸ
    }
}
```

### 3.3 æ§åˆ¶ä»»åŠ¡ (app/control_task.c/h)

#### 3.3.1 æ§åˆ¶æ•°æ®æ¥æ”¶ âœ¨é›†æˆç½‘ç»œé€šä¿¡

```c
// app/control_task.c
#include "comm_manager.h"

// æ§åˆ¶æ•°æ®æ¥æ”¶å›è°ƒ
void control_data_callback(const void *data, uint16_t len,
                          comm_protocol_t from_protocol)
{
    control_data_t *ctrl_data = (control_data_t*)data;

    // å¤„ç†è®¾å®šå€¼
    for(int i = 0; i < 3; i++) {
        float temp_sp = (float)ctrl_data->setpoints.temp_setpoint[i] / 10.0f;
        set_temperature_setpoint(i, temp_sp);
    }

    for(int i = 0; i < 4; i++) {
        float pres_sp = (float)ctrl_data->setpoints.pressure_setpoint[i] / 10.0f;
        set_pressure_setpoint(i, pres_sp);
    }

    // å¤„ç†æ‰§è¡Œå™¨æ§åˆ¶
    if(ctrl_data->controls.actuator_control1 & CTRL_VALVE_1) {
        set_valve_state(0, true);
    }
    if(ctrl_data->controls.actuator_control2 & CTRL_HEATER_1) {
        set_heater_state(0, true);
    }

    // å¤„ç†æ§åˆ¶å­—
    if(ctrl_data->control_word & CTRL_BIT_EMERGENCY_STOP) {
        emergency_stop_all();
    }
    if(ctrl_data->control_word & CTRL_BIT_START) {
        system_start();
    }
}

void control_task_init(void)
{
    // æ³¨å†Œæ§åˆ¶æ•°æ®å›è°ƒ
    comm_register_control_callback(control_data_callback);
}
```

### 3.4 é€šä¿¡ä»»åŠ¡ (app/comm_task.c/h) âœ¨æ–°å¢ä»»åŠ¡

```c
// app/comm_task.c
#include "comm_manager.h"

void comm_task(void *pvParameters)
{
    // åˆå§‹åŒ–é€šä¿¡ç®¡ç†å™¨ (ä»é…ç½®è¯»å–æ¨¡å¼)
    comm_mode_t mode = get_config_comm_mode();  // ä»Flashè¯»å–
    comm_manager_init(mode);

    while(1) {
        // å‘¨æœŸå¤„ç†é€šä¿¡ (æ¥æ”¶æ•°æ®ã€åè®®åˆ‡æ¢ç­‰)
        comm_process_task();

        // ç›‘æ§é€šä¿¡çŠ¶æ€
        comm_status_t *status = comm_get_status();
        if(!status->tcp_connected && !status->ethercat_connected) {
            // é€šä¿¡æ–­å¼€å¤„ç†
            set_safe_mode();
        }

        vTaskDelay(pdMS_TO_TICKS(10));  // 10mså‘¨æœŸ
    }
}
```

### 3.5 EtherCATåº”ç”¨ (app/ethercat_app.c/h)

#### 3.5.1 PDOæ•°æ®æ˜ å°„

```c
// app/ethercat_app.c
#include "protocol_data.h"

// å…¨å±€PDOç¼“å†²åŒº
static EtherCAT_TxPDO1_t g_txpdo1;
static EtherCAT_RxPDO1_t g_rxpdo1;

// EtherCATå¾ªç¯ä»»åŠ¡ (1mså‘¨æœŸ)
void ethercat_cyclic_task(void)
{
    realtime_data_t rt_data;
    control_data_t ctrl_data;

    // 1. ä»åº”ç”¨å±‚è·å–å®æ—¶æ•°æ®
    get_realtime_data(&rt_data);

    // 2. æ˜ å°„åˆ°TxPDO
    memcpy(&g_txpdo1, &rt_data, sizeof(realtime_data_t));
    g_txpdo1.crc16 = calculate_crc16((uint8_t*)&g_txpdo1, 52);

    // 3. å‘é€PDOåˆ°ä¸»ç«™
    ec_slave[0].outputs = (uint8_t*)&g_txpdo1;
    ec_send_processdata();

    // 4. æ¥æ”¶ä¸»ç«™PDO
    ec_slave[0].inputs = (uint8_t*)&g_rxpdo1;
    ec_receive_processdata(EC_TIMEOUTRET);

    // 5. æ˜ å°„RxPDOåˆ°æ§åˆ¶æ•°æ®
    memcpy(&ctrl_data.setpoints, &g_rxpdo1, 22);
    memcpy(&ctrl_data.controls, ((uint8_t*)&g_rxpdo1)+22, 6);
    ctrl_data.control_word = g_rxpdo1.control_word;

    // 6. å¤„ç†æ§åˆ¶å‘½ä»¤
    process_control_data(&ctrl_data);
}
```

### 3.6 TCPæœåŠ¡å™¨ (app/tcp_server.c/h)

#### 3.6.1 TCPå‘½ä»¤å¤„ç†

```c
// app/tcp_server.c
#include "tcp_protocol.h"
#include "protocol_data.h"

void tcp_process_command(tcp_protocol_frame_t *frame)
{
    realtime_data_t rt_data;
    control_data_t ctrl_data;

    switch(frame->header.cmd) {
        case CMD_READ_REALTIME_DATA:
            // è¯»å–å®æ—¶æ•°æ®
            get_realtime_data(&rt_data);
            tcp_send_response(CMD_RESPONSE_DATA, ERR_OK,
                             (uint8_t*)&rt_data, sizeof(rt_data));
            break;

        case CMD_WRITE_CONTROL_DATA:
            // å†™å…¥æ§åˆ¶æ•°æ®
            memcpy(&ctrl_data, frame->data, sizeof(control_data_t));
            process_control_data(&ctrl_data);
            tcp_send_response(CMD_RESPONSE_OK, ERR_OK, NULL, 0);
            break;

        case CMD_SYSTEM_RESET:
            // ç³»ç»Ÿå¤ä½
            system_reset();
            tcp_send_response(CMD_RESPONSE_OK, ERR_OK, NULL, 0);
            break;

        default:
            tcp_send_response(CMD_RESPONSE_ERROR, ERR_INVALID_CMD, NULL, 0);
            break;
    }
}
```

### 3.7 å®‰å…¨ç›‘æ§ä»»åŠ¡ (app/safety_task.c/h)

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬2.5èŠ‚

### 3.8 HMIä»»åŠ¡ (app/hmi_task.c/h)

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬2.6èŠ‚

### 3.9 é…ç½®ä»»åŠ¡ (app/config_task.c/h)

#### 3.9.1 ç½‘ç»œé…ç½®ç®¡ç† âœ¨æ–°å¢ç½‘ç»œé…ç½®

```c
// app/config_task.h
typedef struct {
    // ä¼ æ„Ÿå™¨é…ç½®
    sensor_config_t sensor_configs[SENSOR_COUNT];

    // æ§åˆ¶å™¨é…ç½®
    pid_controller_t controllers[CTRL_COUNT];

    // å®‰å…¨å‚æ•°
    safety_context_t safety_params;

    // é€šä¿¡é…ç½® âœ¨æ‰©å±•
    struct {
        comm_mode_t mode;           // é€šä¿¡æ¨¡å¼
        uint32_t ip_address;        // IPåœ°å€
        uint16_t tcp_port;          // TCPç«¯å£
        uint16_t ethercat_address;  // EtherCATä»ç«™åœ°å€
    } comm_config;

    // ç³»ç»Ÿé…ç½®
    struct {
        uint16_t system_id;
        char device_name[32];
        char version[16];
        uint32_t config_crc;
    } system_config;
} system_configuration_t;
```

---

## 4. ä¸­é—´ä»¶å±‚è®¾è®¡

### 4.1 ç½‘ç»œä¸­é—´ä»¶ (middleware/network/) âœ¨æ–°å¢

#### 4.1.1 é€šä¿¡ç®¡ç†å™¨ (comm_manager.c/h)

è´Ÿè´£åè®®é€‰æ‹©ã€æ•°æ®è·¯ç”±ã€çŠ¶æ€ç®¡ç†

#### 4.1.2 åè®®é€‚é…å™¨ (protocol_adapter.c/h)

æä¾›TCPå’ŒEtherCATçš„ç»Ÿä¸€æ¥å£å°è£…

#### 4.1.3 TCPåè®®å®ç° (tcp_protocol.c/h)

TCPå¸§å°è£…/è§£æã€å‘½ä»¤å¤„ç†ã€CRCæ ¡éªŒ

#### 4.1.4 EtherCATåè®®å®ç° (ethercat_protocol.c/h)

PDOæ˜ å°„ã€SDOå¯¹è±¡å­—å…¸ã€çŠ¶æ€æœºç®¡ç†

#### 4.1.5 æ¶ˆæ¯é˜Ÿåˆ— (message_queue.c/h)

åè®®é—´æ¶ˆæ¯ç¼“å­˜å’Œè·¯ç”±

### 4.2 PIDæ§åˆ¶å™¨ (middleware/pid.c/h)

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬3.1èŠ‚

### 4.3 æ•°å­—æ»¤æ³¢å™¨ (middleware/filter.c/h)

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬3.2èŠ‚

### 4.4 ä»»åŠ¡ç®¡ç†å™¨ (middleware/tasks.c/h)

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬3.3èŠ‚

### 4.5 ç³»ç»Ÿä¸­é—´ä»¶å…¼å®¹

ä¿æŒç°æœ‰delayã€sysã€usartæ¨¡å—

---

## 5. HALå±‚è®¾è®¡

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬4èŠ‚

---

## 6. é©±åŠ¨å±‚è®¾è®¡

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬5èŠ‚

---

## 7. ç³»ç»Ÿé›†æˆ

### 7.1 å¯åŠ¨åºåˆ— âœ¨å¢åŠ ç½‘ç»œåˆå§‹åŒ–

```c
typedef enum {
    BOOT_STAGE_HARDWARE_INIT,     // ç¡¬ä»¶åˆå§‹åŒ–
    BOOT_STAGE_RTOS_INIT,         // RTOSåˆå§‹åŒ–
    BOOT_STAGE_MIDDLEWARE_INIT,   // ä¸­é—´ä»¶åˆå§‹åŒ–
    BOOT_STAGE_NETWORK_INIT,      // ç½‘ç»œé€šä¿¡åˆå§‹åŒ– âœ¨
    BOOT_STAGE_APP_INIT,          // åº”ç”¨åˆå§‹åŒ–
    BOOT_STAGE_SELF_TEST,         // è‡ªæ£€
    BOOT_STAGE_READY,             // å‡†å¤‡å°±ç»ª
} boot_stage_t;
```

### 7.2 é”™è¯¯å¤„ç†

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬6.2èŠ‚

---

## 8. æ„å»ºç³»ç»Ÿ

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬7èŠ‚

---

## 9. æµ‹è¯•ä¸éªŒè¯

### 9.1 ç½‘ç»œé€šä¿¡æµ‹è¯• âœ¨æ–°å¢æµ‹è¯•é¡¹

- TCPåè®®å¸§å®Œæ•´æ€§æµ‹è¯•
- EtherCAT PDOæ•°æ®æ˜ å°„æµ‹è¯•
- åè®®åˆ‡æ¢åŠŸèƒ½æµ‹è¯•
- é€šä¿¡è¶…æ—¶å’Œæ•…éšœæ¢å¤æµ‹è¯•
- TCPå’ŒEtherCATæ•°æ®ä¸€è‡´æ€§æµ‹è¯•

### 9.2 å…¶ä»–æµ‹è¯•

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬8èŠ‚

---

## 10. å¼€å‘æŒ‡å—

### 10.1 ä»£ç è§„èŒƒ

ä¿æŒv3è®¾è®¡,å‚è€ƒv3æ–‡æ¡£ç¬¬9.1èŠ‚

### 10.2 ç½‘ç»œå¼€å‘æŒ‡å— âœ¨æ–°å¢

#### æ·»åŠ æ–°çš„TCPå‘½ä»¤

1. åœ¨`tcp_protocol.h`æ·»åŠ å‘½ä»¤å®šä¹‰
2. åœ¨`tcp_server.c`æ·»åŠ å‘½ä»¤å¤„ç†å‡½æ•°
3. æ›´æ–°å‘½ä»¤æ–‡æ¡£

#### æ·»åŠ æ–°çš„PDOå­—æ®µ

1. ä¿®æ”¹`EtherCAT_TxPDO1_t`æˆ–`EtherCAT_RxPDO1_t`ç»“æ„
2. æ›´æ–°PDOæ˜ å°„è¡¨(0x1A00/0x1600)
3. é‡æ–°ç”ŸæˆESIé…ç½®æ–‡ä»¶

#### åè®®åˆ‡æ¢é…ç½®

```c
// æ–¹å¼1: ç¼–è¯‘æ—¶é…ç½®
#define ACTIVE_PROTOCOL COMM_PROTOCOL_ETHERCAT

// æ–¹å¼2: è¿è¡Œæ—¶é…ç½®
comm_set_mode(COMM_MODE_TCP_ONLY);  // çº¯TCPæ¨¡å¼
comm_set_mode(COMM_MODE_ETHERCAT_ONLY);  // çº¯EtherCATæ¨¡å¼
comm_set_mode(COMM_MODE_AUTO_SELECT);  // è‡ªåŠ¨é€‰æ‹©
```

---

## 11. v3åˆ°v4æ›´æ–°æ‘˜è¦

### 11.1 æ–°å¢å†…å®¹

âœ… **ç½‘ç»œé€šä¿¡ä¸­é—´ä»¶**: `middleware/network/` å®Œæ•´å®ç°
âœ… **åè®®æ•°æ®ç»“æ„**: `include/common/protocol_data.h` ç»Ÿä¸€å®šä¹‰
âœ… **TCPåè®®å®Œæ•´å®šä¹‰**: 50+å‘½ä»¤å­—,å®Œæ•´å¸§æ ¼å¼
âœ… **EtherCAT PDOæ˜ å°„**: TxPDO(54å­—èŠ‚)+RxPDO(34å­—èŠ‚)
âœ… **é€šä¿¡ç®¡ç†å™¨**: æ”¯æŒTCP/EtherCATåŒåè®®å…¼å®¹
âœ… **é€šä¿¡ä»»åŠ¡**: `app/comm_task.c/h` ç»Ÿä¸€é€šä¿¡å¤„ç†

### 11.2 ä¿®æ”¹å†…å®¹

ğŸ”„ **ä¼ æ„Ÿå™¨ä»»åŠ¡**: é›†æˆ`comm_send_realtime_data()`æ¥å£
ğŸ”„ **æ§åˆ¶ä»»åŠ¡**: é›†æˆ`comm_register_control_callback()`æ¥å£
ğŸ”„ **é…ç½®ä»»åŠ¡**: å¢åŠ ç½‘ç»œé€šä¿¡é…ç½®é¡¹
ğŸ”„ **ç›®å½•ç»“æ„**: å¢åŠ `middleware/network/`å’Œ`include/common/`

### 11.3 ä¿æŒä¸å˜

âœ”ï¸ HALå±‚è®¾è®¡
âœ”ï¸ é©±åŠ¨å±‚è®¾è®¡
âœ”ï¸ PID/æ»¤æ³¢å™¨ä¸­é—´ä»¶
âœ”ï¸ å®‰å…¨ç›‘æ§ä»»åŠ¡
âœ”ï¸ HMIä»»åŠ¡
âœ”ï¸ æ„å»ºç³»ç»Ÿ

---

## 12. é™„å½•

### 12.1 ç›¸å…³æ–‡æ¡£

- `å¢¨è·¯é€šä¿¡åè®®_å·¥ä½œè¡¨1.png` - åè®®æ•°æ®é¡¹å®šä¹‰
- `å¢¨è·¯ç½‘ç»œé€šä¿¡è®¾è®¡æ–¹æ¡ˆ-åŸºäºåè®®è¡¨æ ¼.md` - ç½‘ç»œè¯¦ç»†è®¾è®¡
- `å¢¨è·¯æ§åˆ¶ç³»ç»Ÿè¯¦ç»†è®¾è®¡æ–‡æ¡£v3.md` - ç³»ç»ŸåŸºç¡€è®¾è®¡

### 12.2 å…³é”®æ–‡ä»¶æ¸…å•

**ç½‘ç»œç›¸å…³**:
- `include/common/protocol_data.h` - åè®®æ•°æ®ç»“æ„
- `include/common/tcp_protocol.h` - TCPåè®®å®šä¹‰
- `middleware/network/comm_manager.h` - é€šä¿¡ç®¡ç†å™¨æ¥å£
- `middleware/network/protocol_adapter.h` - åè®®é€‚é…å™¨æ¥å£
- `config/network_config.h` - ç½‘ç»œé…ç½®

**åº”ç”¨å±‚**:
- `app/comm_task.c/h` - é€šä¿¡ä»»åŠ¡
- `app/sensor_task.c/h` - ä¼ æ„Ÿå™¨ä»»åŠ¡
- `app/control_task.c/h` - æ§åˆ¶ä»»åŠ¡
- `app/ethercat_app.c/h` - EtherCATåº”ç”¨
- `app/tcp_server.c/h` - TCPæœåŠ¡å™¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v4.0
**æœ€åæ›´æ–°**: 2025-09-30
**ç¼–å†™ä¾æ®**: å¢¨è·¯é€šä¿¡åè®®è¡¨æ ¼ + v3ç³»ç»Ÿè®¾è®¡ + ç½‘ç»œé€šä¿¡è®¾è®¡æ–¹æ¡ˆ
