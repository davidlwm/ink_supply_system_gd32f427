# 墨路控制系统详细设计文档 v4

> **版本**: v4.0
> **更新内容**: 集成完整的网络通信设计(EtherCAT/TCP兼容方案)
> **更新日期**: 2025-09-30
> **设计依据**: 墨路通信协议表格 + v3系统设计

---

## 1. 系统概述

### 1.1 技术选型
- **MCU**: GD32F427
- **操作系统**: FreeRTOS
- **网络协议栈**: lwIP
- **通信协议**: EtherCAT开源库 + 自定义TCP协议
- **HAL库**: STM32 HAL库

### 1.2 系统架构
采用四层分层架构设计：
```
应用层 (Application Layer)
    ↓
中间件层 (Middleware Layer) ← 新增网络通信中间件
    ↓
HAL层 (Hardware Abstraction Layer)
    ↓
驱动层 (Driver Layer)
```

### 1.3 代码目录结构

```
ink_supply_gd32f427/
├── 📁 app/                                # 应用层
│   ├── 📄 main.c                          # 主程序
│   ├── 📄 app_main.c/h                    # 应用主程序
│   ├── 📄 sensor_task.c/h                 # 传感器任务
│   ├── 📄 actuator_task.c/h               # 执行器任务
│   ├── 📄 control_task.c/h                # 控制任务 (PID控制)
│   ├── 📄 safety_task.c/h                 # 安全任务
│   ├── 📄 hmi_task.c/h                    # HMI任务 (LCD+LED)
│   ├── 📄 comm_task.c/h                   # 通信任务 (调用中间件)
│   ├── 📄 config_task.c/h                 # 配置任务
│   ├── 📄 ethercat_app.c/h                # EtherCAT应用
│   └── 📄 tcp_server.c/h                  # TCP服务器
│
├── 📁 hal/                                # HAL抽象层
│   ├── 📄 hal_common.c/h                  # HAL公共功能
│   ├── 📄 hal_manager.c/h                 # HAL管理器
│   ├── 📄 adc_hal.c/h                     # ADC硬件抽象
│   ├── 📄 pwm_hal.c/h                     # PWM硬件抽象
│   ├── 📄 gpio_hal.c/h                    # GPIO硬件抽象
│   ├── 📄 uart_hal.c/h                    # UART硬件抽象
│   ├── 📄 spi_hal.c/h                     # SPI硬件抽象
│   ├── 📄 i2c_hal.c/h                     # I2C硬件抽象
│   ├── 📄 eth_hal.c/h                     # 以太网硬件抽象
│   ├── 📄 flash_hal.c/h                   # Flash硬件抽象
│   └── 📄 timer_hal.c/h                   # 定时器硬件抽象
│
├── 📁 middleware/                         # 中间件层
│   ├── 📁 network/                        # 网络通信中间件 ✨新增
│   │   ├── 📄 comm_manager.c/h            # 通信管理器(核心)
│   │   ├── 📄 protocol_adapter.c/h        # 协议适配器
│   │   ├── 📄 tcp_protocol.c/h            # TCP协议实现
│   │   ├── 📄 ethercat_protocol.c/h       # EtherCAT协议实现
│   │   ├── 📄 message_queue.c/h           # 消息队列
│   │   └── 📄 network_config.c/h          # 网络配置
│   ├── 📁 delay/                          # 延时功能
│   │   └── 📄 delay.c/h                   # 延时实现
│   ├── 📁 sys/                            # 系统功能
│   │   └── 📄 sys.c/h                     # 系统配置
│   ├── 📁 usart/                          # 串口功能
│   │   └── 📄 usart.c/h                   # 串口驱动
│   ├── 📄 middleware_common.c/h           # 中间件公共功能
│   ├── 📄 tasks.c/h                       # FreeRTOS任务管理
│   ├── 📄 pid.c/h                         # PID算法实现
│   └── 📄 filter.c/h                      # 数字滤波算法
│
├── 📁 drivers/                            # 驱动层
│   ├── 📁 sensors/                        # 传感器驱动
│   │   ├── 📄 frd8061_driver.c/h          # FRD8061液位传感器
│   │   ├── 📄 ftt518_driver.c/h           # FTT518温度传感器
│   │   ├── 📄 hp10my_driver.c/h           # HP10MY压力传感器
│   │   └── 📄 sensor_common.c/h           # 传感器公共接口
│   ├── 📁 actuators/                      # 执行器驱动
│   │   ├── 📄 mra23d3_driver.c/h          # MRA23D3电机驱动
│   │   ├── 📄 mpb025bbb_driver.c/h        # MPB025BBB泵驱动
│   │   ├── 📄 valve_control.c/h           # 阀门控制
│   │   ├── 📄 led_control.c/h             # LED控制
│   │   └── 📄 actuator_common.c/h         # 执行器公共接口
│   ├── 📁 display/                        # 显示驱动
│   │   ├── 📄 lcd_driver.c/h              # LCD驱动
│   │   ├── 📄 oled_driver.c/h             # OLED驱动
│   │   └── 📄 display_common.c/h          # 显示公共接口
│   ├── 📁 input/                          # 输入设备驱动
│   │   ├── 📄 key_driver.c/h              # 按键驱动
│   │   └── 📄 input_common.c/h            # 输入公共接口
│   ├── 📁 storage/                        # 存储驱动
│   │   ├── 📄 24cxx_driver.c/h            # EEPROM驱动
│   │   ├── 📄 flash_driver.c/h            # 内部Flash驱动
│   │   └── 📄 storage_common.c/h          # 存储公共接口
│   ├── 📁 communication/                  # 通信驱动
│   │   ├── 📄 iic_driver.c/h              # I2C驱动
│   │   ├── 📄 can_driver.c/h              # CAN驱动
│   │   ├── 📄 ethernet_driver.c/h         # 以太网驱动
│   │   └── 📄 comm_common.c/h             # 通信公共接口
│   └── 📄 driver_manager.c/h              # 驱动管理器
│
├── 📁 lib/                                # 第三方库
│   ├── 📁 STM32F4xx_HAL_Driver/           # STM32 HAL库
│   │   ├── 📁 Inc/                        # HAL库头文件
│   │   └── 📁 Src/                        # HAL库源文件
│   ├── 📁 CMSIS/                          # ARM CMSIS库
│   ├── 📁 FreeRTOS/                       # FreeRTOS实时操作系统
│   │   ├── 📁 Source/                     # RTOS源码
│   │   └── 📁 portable/                   # GD32F427移植层
│   ├── 📁 lwip/                           # lwIP网络协议栈
│   │   ├── 📁 src/                        # lwIP源码
│   │   └── 📁 port/                       # GD32F427移植代码
│   └── 📁 ethercat/                       # EtherCAT开源库
│       └── 📁 slave/                      # 从站库
│
├── 📁 include/                            # 头文件目录
│   ├── 📁 app/                            # 应用层头文件
│   ├── 📁 hal/                            # HAL层头文件
│   ├── 📁 middleware/                     # 中间件头文件
│   ├── 📁 drivers/                        # 驱动层头文件
│   ├── 📁 common/                         # 公共头文件 ✨新增
│   │   ├── 📄 protocol_data.h             # 协议数据结构定义
│   │   └── 📄 tcp_protocol.h              # TCP协议定义
│   └── 📄 project_config.h                # 项目全局配置
│
├── 📁 config/                             # 配置文件
│   ├── 📄 FreeRTOSConfig.h                # FreeRTOS配置
│   ├── 📄 lwipopts.h                      # lwIP配置
│   ├── 📄 gd32f4xx_hal_conf.h             # GD32 HAL配置
│   ├── 📄 system_config.h                 # 系统参数配置
│   ├── 📄 app_config.h                    # 应用配置
│   ├── 📄 sensor_config.h                 # 传感器配置
│   └── 📄 network_config.h                # 网络配置 ✨新增
│
├── 📁 USER/                               # 工程配置层
│   ├── 📁 DebugConfig/                    # 调试配置
│   ├── 📄 gd32f407xx.h                    # GD32F407定义
│   ├── 📄 gd32f4xx.h                      # GD32F4xx总头文件
│   ├── 📄 gd32f4xx_it.c/h                # 中断服务函数
│   ├── 📄 stm32f4xx_hal_conf.h           # HAL配置
│   ├── 📄 stm32f4xx_hal_msp.c            # HAL MSP配置
│   ├── 📄 system_gd32f4xx.c/h            # 系统时钟配置
│   ├── 📄 InkSupplySystem.uvprojx         # Keil工程文件
│   └── 📄 main.h                          # 主程序头文件
│
├── 📁 USMART/                             # 调试工具
│   ├── 📄 usmart.c/h                      # USMART核心
│   ├── 📄 usmart_config.c                 # USMART配置
│   └── 📄 usmart_str.c/h                  # 字符串处理
│
├── 📁 docs/                               # 文档目录
│   ├── 📄 design.md                       # 设计文档
│   ├── 📄 api_reference.md                # API参考文档
│   ├── 📄 migration_guide.md              # 迁移指南
│   ├── 📄 development_guide.md            # 开发指南
│   └── 📄 network_communication_design.md # 网络通信设计 ✨新增
│
├── 📁 tools/                              # 工具目录
│   ├── 📄 build.py                        # 构建脚本
│   └── 📄 config_generator.py             # 配置生成工具
│
├── 📁 OBJ/                                # 编译输出
│   ├── 📁 Debug/                          # 调试版本
│   └── 📁 Release/                        # 发布版本
│
├── 📄 README.md                           # 项目说明
├── 📄 CHANGELOG.md                        # 版本变更日志
└── 📄 .gitignore                          # Git忽略配置
```

### 1.4 模块化设计理念

- **分层清晰**: 严格按照应用层、中间件层、HAL层、驱动层四层架构
- **职责分离**: 每个模块专注于特定功能，降低耦合度
- **接口标准化**: 统一的接口设计，便于模块间协作
- **协议兼容**: 网络中间件支持EtherCAT和TCP/IP双协议 ✨
- **可扩展性**: 易于添加新的传感器、执行器或功能模块

---

## 2. 网络通信架构设计 ✨新增章节

### 2.1 通信协议数据结构 (基于协议表格)

#### 2.1.1 核心数据结构定义

详细定义参见 `include/common/protocol_data.h`:

```c
//==============================================================================
// 传感器数据结构 (对应协议表行0-11)
//==============================================================================
typedef struct {
    int16_t  temperature[3];        // 温度传感器 0.1°C (-50.0~300.0°C)
    uint16_t pressure[4];           // 压力传感器 0.1kPa
    uint16_t level[3];              // 液位传感器 0.1mm
    uint16_t level_analog;          // 模拟液位 0.1mm
    uint16_t flow_rate;             // 流量 0.01L/min
    uint16_t level_switch_status;   // 液位开关状态位
} __attribute__((packed)) sensor_data_t;  // 26字节

//==============================================================================
// 执行器状态结构 (对应协议表行18-29)
//==============================================================================
typedef struct {
    uint16_t actuator_status1;      // 阀门+泵状态位
    uint16_t actuator_status2;      // 加热器状态位
    uint16_t pump_speed[2];         // 调速泵速度 0.1%
    uint16_t heater_current[3];     // 加热器电流 0.01A
} __attribute__((packed)) actuator_status_t;  // 10字节

//==============================================================================
// 控制设定值结构 (对应协议表行30-40)
//==============================================================================
typedef struct {
    int16_t  temp_setpoint[3];      // 温度设定 0.1°C
    uint16_t pressure_setpoint[4];  // 压力设定 0.1kPa
    uint16_t level_setpoint[3];     // 液位设定 0.1mm
    uint16_t flow_setpoint;         // 流量设定 0.01L/min
} __attribute__((packed)) control_setpoint_t;  // 22字节

//==============================================================================
// 系统状态结构
//==============================================================================
typedef struct {
    uint16_t status_word;           // 系统状态字
    uint16_t alarm_word1;           // 告警字1
    uint16_t alarm_word2;           // 告警字2
    uint32_t timestamp;             // 时间戳(ms)
    uint16_t cycle_counter;         // 循环计数器
} __attribute__((packed)) system_status_t;  // 12字节

//==============================================================================
// 完整实时数据包 (传感器+执行器+状态)
//==============================================================================
typedef struct {
    sensor_data_t       sensors;        // 26字节
    actuator_status_t   actuators;      // 10字节
    system_status_t     system;         // 12字节
} __attribute__((packed)) realtime_data_t;  // 总计: 48字节

//==============================================================================
// 完整控制数据包 (设定值+控制命令+控制字)
//==============================================================================
typedef struct {
    control_setpoint_t  setpoints;      // 22字节
    actuator_control_t  controls;       // 6字节
    uint16_t            control_word;   // 2字节
} __attribute__((packed)) control_data_t;   // 总计: 30字节
```

#### 2.1.2 状态字和控制字位定义

```c
// 系统状态字 (status_word)
#define STATUS_BIT_READY            (1 << 0)    // 系统就绪
#define STATUS_BIT_RUNNING          (1 << 1)    // 系统运行中
#define STATUS_BIT_ALARM            (1 << 2)    // 存在告警
#define STATUS_BIT_FAULT            (1 << 3)    // 存在故障
#define STATUS_BIT_SAFE_MODE        (1 << 4)    // 安全模式
#define STATUS_BIT_MANUAL_MODE      (1 << 5)    // 手动模式
#define STATUS_BIT_AUTO_MODE        (1 << 6)    // 自动模式
#define STATUS_BIT_COMM_OK          (1 << 7)    // 通信正常
#define STATUS_BIT_SENSOR_FAULT     (1 << 8)    // 传感器故障
#define STATUS_BIT_ACTUATOR_FAULT   (1 << 9)    // 执行器故障
#define STATUS_BIT_TEMP_OVER        (1 << 10)   // 温度超限
#define STATUS_BIT_PRESSURE_OVER    (1 << 11)   // 压力超限
#define STATUS_BIT_LEVEL_ABNORMAL   (1 << 12)   // 液位异常

// 控制字 (control_word)
#define CTRL_BIT_ENABLE             (1 << 0)    // 系统使能
#define CTRL_BIT_RESET              (1 << 1)    // 复位命令
#define CTRL_BIT_START              (1 << 2)    // 启动命令
#define CTRL_BIT_STOP               (1 << 3)    // 停止命令
#define CTRL_BIT_EMERGENCY_STOP     (1 << 4)    // 紧急停止
#define CTRL_BIT_AUTO_MODE          (1 << 5)    // 切换自动模式
#define CTRL_BIT_MANUAL_MODE        (1 << 6)    // 切换手动模式
#define CTRL_BIT_PARAM_SAVE         (1 << 7)    // 保存参数
#define CTRL_BIT_ALARM_ACK          (1 << 9)    // 告警确认
#define CTRL_BIT_PID_AUTOTUNE       (1 << 11)   // PID自整定
```

### 2.2 TCP/IP通信协议

#### 2.2.1 TCP协议帧格式

```c
// TCP帧头定义 (10字节)
typedef struct {
    uint16_t sync_word;         // 同步字 0xAA55
    uint8_t  version;           // 协议版本 0x01
    uint8_t  cmd;               // 命令字
    uint16_t length;            // 数据长度
    uint16_t sequence;          // 序列号
    uint16_t checksum;          // 帧头CRC16
} __attribute__((packed)) tcp_frame_header_t;

// 完整TCP帧
typedef struct {
    tcp_frame_header_t header;  // 10字节帧头
    uint8_t data[256];          // 最大256字节数据
    uint16_t crc16;             // 整帧CRC16校验
} __attribute__((packed)) tcp_protocol_frame_t;
```

#### 2.2.2 TCP命令字定义

```c
typedef enum {
    // 数据读取命令 (0x01-0x0F)
    CMD_READ_REALTIME_DATA      = 0x01,     // 读取实时数据(48字节)
    CMD_READ_SENSOR_DATA        = 0x02,     // 读取传感器数据
    CMD_READ_ACTUATOR_STATUS    = 0x03,     // 读取执行器状态
    CMD_READ_SYSTEM_STATUS      = 0x04,     // 读取系统状态
    CMD_READ_ALARM_INFO         = 0x05,     // 读取告警信息

    // 数据写入命令 (0x10-0x1F)
    CMD_WRITE_SETPOINT          = 0x10,     // 写入设定值(22字节)
    CMD_WRITE_ACTUATOR_CONTROL  = 0x11,     // 写入执行器控制
    CMD_WRITE_CONTROL_WORD      = 0x12,     // 写入控制字
    CMD_WRITE_CONTROL_DATA      = 0x13,     // 写入完整控制数据(30字节)

    // 参数配置命令 (0x20-0x2F)
    CMD_READ_PID_PARAMS         = 0x20,     // 读取PID参数
    CMD_WRITE_PID_PARAMS        = 0x21,     // 写入PID参数
    CMD_READ_SENSOR_CONFIG      = 0x22,     // 读取传感器配置
    CMD_WRITE_SENSOR_CONFIG     = 0x23,     // 写入传感器配置

    // 系统控制命令 (0x30-0x3F)
    CMD_SYSTEM_RESET            = 0x30,     // 系统复位
    CMD_SYSTEM_START            = 0x31,     // 系统启动
    CMD_SYSTEM_STOP             = 0x32,     // 系统停止
    CMD_EMERGENCY_STOP          = 0x33,     // 紧急停止
    CMD_ALARM_ACK               = 0x34,     // 告警确认

    // 配置管理命令 (0x40-0x4F)
    CMD_SAVE_CONFIG             = 0x40,     // 保存配置到Flash
    CMD_LOAD_CONFIG             = 0x41,     // 从Flash加载配置
    CMD_RESTORE_DEFAULT         = 0x42,     // 恢复默认配置

    // 响应命令 (0x80-0xFF)
    CMD_RESPONSE_OK             = 0x80,     // 响应成功
    CMD_RESPONSE_ERROR          = 0x81,     // 响应错误
    CMD_RESPONSE_DATA           = 0x82,     // 响应数据
} tcp_command_t;
```

#### 2.2.3 TCP通信示例

**上位机读取实时数据**:
```
请求帧 (12字节):
┌────────┬────┬────┬──────┬────────┬─────────┬────────┐
│ 0xAA55 │0x01│0x01│0x0000│ 序列号 │ CRC16-H │ CRC16  │
│  同步  │版本│命令│ 长度 │        │ 帧头校验│ 帧校验 │
└────────┴────┴────┴──────┴────────┴─────────┴────────┘

响应帧 (60字节):
┌────────┬────┬────┬──────┬────────┬─────────┬──────────┬────────┐
│ 0xAA55 │0x01│0x82│0x0030│ 序列号 │ CRC16-H │48字节数据│ CRC16  │
│  同步  │版本│响应│长度48│        │ 帧头校验│realtime_t│ 帧校验 │
└────────┴────┴────┴──────┴────────┴─────────┴──────────┴────────┘
```

### 2.3 EtherCAT通信协议

#### 2.3.1 EtherCAT PDO映射

**TxPDO 1 (从站→主站) - 54字节实时数据**

```c
typedef struct __attribute__((packed)) {
    // 传感器数据 (26字节) - 偏移0
    int16_t  temperature[3];        // 偏移0:  温度 6字节
    uint16_t pressure[4];           // 偏移6:  压力 8字节
    uint16_t level[3];              // 偏移14: 液位 6字节
    uint16_t level_analog;          // 偏移20: 模拟液位 2字节
    uint16_t flow_rate;             // 偏移22: 流量 2字节
    uint16_t level_switch_status;   // 偏移24: 液位开关 2字节

    // 执行器状态 (10字节) - 偏移26
    uint16_t actuator_status1;      // 偏移26: 阀门+泵状态 2字节
    uint16_t actuator_status2;      // 偏移28: 加热器状态 2字节
    uint16_t pump_speed[2];         // 偏移30: 泵速度反馈 4字节
    uint16_t heater_current[3];     // 偏移34: 加热器电流 6字节

    // 系统状态 (12字节) - 偏移40
    uint16_t status_word;           // 偏移40: 状态字 2字节
    uint16_t alarm_word1;           // 偏移42: 告警字1 2字节
    uint16_t alarm_word2;           // 偏移44: 告警字2 2字节
    uint32_t timestamp;             // 偏移46: 时间戳 4字节
    uint16_t cycle_counter;         // 偏移50: 循环计数 2字节

    uint16_t crc16;                 // 偏移52: CRC校验 2字节
} EtherCAT_TxPDO1_t;  // 总计54字节
```

**RxPDO 1 (主站→从站) - 34字节控制数据**

```c
typedef struct __attribute__((packed)) {
    // 设定值 (22字节) - 偏移0
    int16_t  temp_setpoint[3];      // 偏移0:  温度设定 6字节
    uint16_t pressure_setpoint[4];  // 偏移6:  压力设定 8字节
    uint16_t level_setpoint[3];     // 偏移14: 液位设定 6字节
    uint16_t flow_setpoint;         // 偏移20: 流量设定 2字节

    // 控制命令 (6字节) - 偏移22
    uint16_t actuator_control1;     // 偏移22: 阀门+泵控制 2字节
    uint16_t actuator_control2;     // 偏移24: 加热器控制 2字节
    uint16_t pump_speed_cmd[2];     // 偏移26: 泵速度命令 4字节

    // 控制字 (4字节) - 偏移30
    uint16_t control_word;          // 偏移30: 控制字 2字节
    uint16_t watchdog;              // 偏移32: 看门狗计数 2字节
} EtherCAT_RxPDO1_t;  // 总计34字节
```

### 2.4 网络中间件层设计

#### 2.4.1 通信管理器接口

```c
// middleware/network/comm_manager.h

// 协议类型定义
typedef enum {
    COMM_PROTOCOL_NONE = 0,
    COMM_PROTOCOL_TCP,              // TCP/IP协议
    COMM_PROTOCOL_ETHERCAT,         // EtherCAT协议
} comm_protocol_t;

// 通信模式定义
typedef enum {
    COMM_MODE_TCP_ONLY,             // 纯TCP模式
    COMM_MODE_ETHERCAT_ONLY,        // 纯EtherCAT模式
    COMM_MODE_AUTO_SELECT,          // 自动选择
} comm_mode_t;

//==============================================================================
// 统一通信接口 (应用层调用)
//==============================================================================
// 初始化
hal_status_t comm_manager_init(comm_mode_t mode);

// 发送接口 (自动选择协议)
hal_status_t comm_send_realtime_data(const realtime_data_t *data);
hal_status_t comm_send_sensor_data(const sensor_data_t *data);
hal_status_t comm_send_system_status(const system_status_t *status);

// 接收接口 (通过回调返回数据)
typedef void (*comm_data_callback_t)(const void *data, uint16_t len,
                                     comm_protocol_t from_protocol);

hal_status_t comm_register_control_callback(comm_data_callback_t callback);
hal_status_t comm_register_setpoint_callback(comm_data_callback_t callback);

// 协议管理
hal_status_t comm_switch_protocol(comm_protocol_t protocol);
comm_status_t* comm_get_status(void);
```

#### 2.4.2 协议适配器

```c
// middleware/network/protocol_adapter.h

typedef struct {
    comm_protocol_t type;

    // 生命周期接口
    hal_status_t (*init)(void);
    hal_status_t (*start)(void);
    hal_status_t (*stop)(void);

    // 数据接口
    hal_status_t (*send_realtime)(const realtime_data_t *data);
    hal_status_t (*receive)(void *buffer, uint16_t *len);

    // 状态接口
    bool (*is_connected)(void);

} protocol_adapter_t;

// TCP适配器和EtherCAT适配器
extern protocol_adapter_t tcp_adapter;
extern protocol_adapter_t ethercat_adapter;
```

### 2.5 协议兼容性设计

#### 2.5.1 数据映射关系

| 数据项 | 协议表格 | realtime_data_t | TCP命令 | EtherCAT PDO |
|--------|---------|----------------|---------|--------------|
| 温度传感器 | 行0-2 | sensors.temperature[3] | CMD_READ_REALTIME | TxPDO偏移0 |
| 压力传感器 | 行3-6 | sensors.pressure[4] | CMD_READ_REALTIME | TxPDO偏移6 |
| 液位传感器 | 行7-10 | sensors.level[4] | CMD_READ_REALTIME | TxPDO偏移14 |
| 流量传感器 | 行11 | sensors.flow_rate | CMD_READ_REALTIME | TxPDO偏移22 |
| 温度设定 | 行30-32 | setpoints.temp_setpoint[3] | CMD_WRITE_SETPOINT | RxPDO偏移0 |
| 压力设定 | 行33-36 | setpoints.pressure_setpoint[4] | CMD_WRITE_SETPOINT | RxPDO偏移6 |

**关键点**: 所有数据项在TCP和EtherCAT中使用完全相同的数据结构

#### 2.5.2 协议切换策略

```c
// 编译时选择
#define ACTIVE_PROTOCOL COMM_PROTOCOL_ETHERCAT  // 或 COMM_PROTOCOL_TCP

// 运行时切换
comm_mode_t mode = get_config_comm_mode();  // 从配置读取
comm_manager_init(mode);

// 自动选择模式
comm_set_mode(COMM_MODE_AUTO_SELECT);
// 系统根据连接状态自动选择:
// - EtherCAT主站连接 → 使用EtherCAT
// - 无EtherCAT连接 → 使用TCP
```

#### 2.5.3 实时性对比

| 协议 | 数据周期 | 延迟 | 适用场景 |
|------|---------|------|---------|
| EtherCAT | 1ms | <1ms | 实时控制,生产环境 |
| TCP/IP | 50-100ms | 10-50ms | 远程监控,调试测试 |

---

## 3. 应用层详细设计

### 3.1 任务架构

#### 3.1.1 任务优先级分配
| 任务名称 | 优先级 | 周期 | 栈大小 | 功能描述 | 对应源文件 |
|---------|-------|------|--------|----------|-----------|
| Emergency Task | 20 | 事件触发 | 1024 | 紧急安全处理 | app/safety_task.c |
| EtherCAT Task | 18 | 1ms | 2048 | EtherCAT通信处理 | app/ethercat_app.c |
| Safety Task | 15 | 10ms | 1024 | 安全监控 | app/safety_task.c |
| Control Task | 12 | 20ms | 1536 | 控制逻辑 | app/control_task.c |
| Sensor Task | 8 | 50ms | 1024 | 数据采集 | app/sensor_task.c |
| Actuator Task | 8 | 10ms | 1024 | 执行器管理 | app/actuator_task.c |
| Comm Task | 5 | 10ms | 2048 | 通信处理(调用中间件) | app/comm_task.c ✨ |
| TCP Task | 5 | 50ms | 2048 | TCP通信处理 | app/tcp_server.c |
| HMI Task | 5 | 100ms | 1024 | 人机交互 | app/hmi_task.c |
| Config Task | 2 | 1000ms | 1024 | 配置管理 | app/config_task.c |

### 3.2 传感器任务 (app/sensor_task.c/h)

#### 3.2.1 任务实现 ✨集成网络通信

```c
// app/sensor_task.c
#include "comm_manager.h"  // 引入通信管理器
#include "protocol_data.h"  // 引入协议数据结构

void sensor_task(void *pvParameters)
{
    realtime_data_t rt_data;  // 使用统一数据结构

    while(1) {
        // 1. 采集所有传感器数据
        collect_temperature_sensors(rt_data.sensors.temperature);
        collect_pressure_sensors(rt_data.sensors.pressure);
        collect_level_sensors(rt_data.sensors.level);
        collect_flow_sensor(&rt_data.sensors.flow_rate);
        collect_level_switches(&rt_data.sensors.level_switch_status);

        // 2. 采集执行器状态
        get_actuator_status(&rt_data.actuators);

        // 3. 采集系统状态
        get_system_status(&rt_data.system);

        // 4. 通过统一接口发送 (自动适配TCP或EtherCAT)
        comm_send_realtime_data(&rt_data);

        vTaskDelay(pdMS_TO_TICKS(50));  // 50ms周期
    }
}
```

### 3.3 控制任务 (app/control_task.c/h)

#### 3.3.1 控制数据接收 ✨集成网络通信

```c
// app/control_task.c
#include "comm_manager.h"

// 控制数据接收回调
void control_data_callback(const void *data, uint16_t len,
                          comm_protocol_t from_protocol)
{
    control_data_t *ctrl_data = (control_data_t*)data;

    // 处理设定值
    for(int i = 0; i < 3; i++) {
        float temp_sp = (float)ctrl_data->setpoints.temp_setpoint[i] / 10.0f;
        set_temperature_setpoint(i, temp_sp);
    }

    for(int i = 0; i < 4; i++) {
        float pres_sp = (float)ctrl_data->setpoints.pressure_setpoint[i] / 10.0f;
        set_pressure_setpoint(i, pres_sp);
    }

    // 处理执行器控制
    if(ctrl_data->controls.actuator_control1 & CTRL_VALVE_1) {
        set_valve_state(0, true);
    }
    if(ctrl_data->controls.actuator_control2 & CTRL_HEATER_1) {
        set_heater_state(0, true);
    }

    // 处理控制字
    if(ctrl_data->control_word & CTRL_BIT_EMERGENCY_STOP) {
        emergency_stop_all();
    }
    if(ctrl_data->control_word & CTRL_BIT_START) {
        system_start();
    }
}

void control_task_init(void)
{
    // 注册控制数据回调
    comm_register_control_callback(control_data_callback);
}
```

### 3.4 通信任务 (app/comm_task.c/h) ✨新增任务

```c
// app/comm_task.c
#include "comm_manager.h"

void comm_task(void *pvParameters)
{
    // 初始化通信管理器 (从配置读取模式)
    comm_mode_t mode = get_config_comm_mode();  // 从Flash读取
    comm_manager_init(mode);

    while(1) {
        // 周期处理通信 (接收数据、协议切换等)
        comm_process_task();

        // 监控通信状态
        comm_status_t *status = comm_get_status();
        if(!status->tcp_connected && !status->ethercat_connected) {
            // 通信断开处理
            set_safe_mode();
        }

        vTaskDelay(pdMS_TO_TICKS(10));  // 10ms周期
    }
}
```

### 3.5 EtherCAT应用 (app/ethercat_app.c/h)

#### 3.5.1 PDO数据映射

```c
// app/ethercat_app.c
#include "protocol_data.h"

// 全局PDO缓冲区
static EtherCAT_TxPDO1_t g_txpdo1;
static EtherCAT_RxPDO1_t g_rxpdo1;

// EtherCAT循环任务 (1ms周期)
void ethercat_cyclic_task(void)
{
    realtime_data_t rt_data;
    control_data_t ctrl_data;

    // 1. 从应用层获取实时数据
    get_realtime_data(&rt_data);

    // 2. 映射到TxPDO
    memcpy(&g_txpdo1, &rt_data, sizeof(realtime_data_t));
    g_txpdo1.crc16 = calculate_crc16((uint8_t*)&g_txpdo1, 52);

    // 3. 发送PDO到主站
    ec_slave[0].outputs = (uint8_t*)&g_txpdo1;
    ec_send_processdata();

    // 4. 接收主站PDO
    ec_slave[0].inputs = (uint8_t*)&g_rxpdo1;
    ec_receive_processdata(EC_TIMEOUTRET);

    // 5. 映射RxPDO到控制数据
    memcpy(&ctrl_data.setpoints, &g_rxpdo1, 22);
    memcpy(&ctrl_data.controls, ((uint8_t*)&g_rxpdo1)+22, 6);
    ctrl_data.control_word = g_rxpdo1.control_word;

    // 6. 处理控制命令
    process_control_data(&ctrl_data);
}
```

### 3.6 TCP服务器 (app/tcp_server.c/h)

#### 3.6.1 TCP命令处理

```c
// app/tcp_server.c
#include "tcp_protocol.h"
#include "protocol_data.h"

void tcp_process_command(tcp_protocol_frame_t *frame)
{
    realtime_data_t rt_data;
    control_data_t ctrl_data;

    switch(frame->header.cmd) {
        case CMD_READ_REALTIME_DATA:
            // 读取实时数据
            get_realtime_data(&rt_data);
            tcp_send_response(CMD_RESPONSE_DATA, ERR_OK,
                             (uint8_t*)&rt_data, sizeof(rt_data));
            break;

        case CMD_WRITE_CONTROL_DATA:
            // 写入控制数据
            memcpy(&ctrl_data, frame->data, sizeof(control_data_t));
            process_control_data(&ctrl_data);
            tcp_send_response(CMD_RESPONSE_OK, ERR_OK, NULL, 0);
            break;

        case CMD_SYSTEM_RESET:
            // 系统复位
            system_reset();
            tcp_send_response(CMD_RESPONSE_OK, ERR_OK, NULL, 0);
            break;

        default:
            tcp_send_response(CMD_RESPONSE_ERROR, ERR_INVALID_CMD, NULL, 0);
            break;
    }
}
```

### 3.7 安全监控任务 (app/safety_task.c/h)

保持v3设计,参考v3文档第2.5节

### 3.8 HMI任务 (app/hmi_task.c/h)

保持v3设计,参考v3文档第2.6节

### 3.9 配置任务 (app/config_task.c/h)

#### 3.9.1 网络配置管理 ✨新增网络配置

```c
// app/config_task.h
typedef struct {
    // 传感器配置
    sensor_config_t sensor_configs[SENSOR_COUNT];

    // 控制器配置
    pid_controller_t controllers[CTRL_COUNT];

    // 安全参数
    safety_context_t safety_params;

    // 通信配置 ✨扩展
    struct {
        comm_mode_t mode;           // 通信模式
        uint32_t ip_address;        // IP地址
        uint16_t tcp_port;          // TCP端口
        uint16_t ethercat_address;  // EtherCAT从站地址
    } comm_config;

    // 系统配置
    struct {
        uint16_t system_id;
        char device_name[32];
        char version[16];
        uint32_t config_crc;
    } system_config;
} system_configuration_t;
```

---

## 4. 中间件层设计

### 4.1 网络中间件 (middleware/network/) ✨新增

#### 4.1.1 通信管理器 (comm_manager.c/h)

负责协议选择、数据路由、状态管理

#### 4.1.2 协议适配器 (protocol_adapter.c/h)

提供TCP和EtherCAT的统一接口封装

#### 4.1.3 TCP协议实现 (tcp_protocol.c/h)

TCP帧封装/解析、命令处理、CRC校验

#### 4.1.4 EtherCAT协议实现 (ethercat_protocol.c/h)

PDO映射、SDO对象字典、状态机管理

#### 4.1.5 消息队列 (message_queue.c/h)

协议间消息缓存和路由

### 4.2 PID控制器 (middleware/pid.c/h)

保持v3设计,参考v3文档第3.1节

### 4.3 数字滤波器 (middleware/filter.c/h)

保持v3设计,参考v3文档第3.2节

### 4.4 任务管理器 (middleware/tasks.c/h)

保持v3设计,参考v3文档第3.3节

### 4.5 系统中间件兼容

保持现有delay、sys、usart模块

---

## 5. HAL层设计

保持v3设计,参考v3文档第4节

---

## 6. 驱动层设计

保持v3设计,参考v3文档第5节

---

## 7. 系统集成

### 7.1 启动序列 ✨增加网络初始化

```c
typedef enum {
    BOOT_STAGE_HARDWARE_INIT,     // 硬件初始化
    BOOT_STAGE_RTOS_INIT,         // RTOS初始化
    BOOT_STAGE_MIDDLEWARE_INIT,   // 中间件初始化
    BOOT_STAGE_NETWORK_INIT,      // 网络通信初始化 ✨
    BOOT_STAGE_APP_INIT,          // 应用初始化
    BOOT_STAGE_SELF_TEST,         // 自检
    BOOT_STAGE_READY,             // 准备就绪
} boot_stage_t;
```

### 7.2 错误处理

保持v3设计,参考v3文档第6.2节

---

## 8. 构建系统

保持v3设计,参考v3文档第7节

---

## 9. 测试与验证

### 9.1 网络通信测试 ✨新增测试项

- TCP协议帧完整性测试
- EtherCAT PDO数据映射测试
- 协议切换功能测试
- 通信超时和故障恢复测试
- TCP和EtherCAT数据一致性测试

### 9.2 其他测试

保持v3设计,参考v3文档第8节

---

## 10. 开发指南

### 10.1 代码规范

保持v3设计,参考v3文档第9.1节

### 10.2 网络开发指南 ✨新增

#### 添加新的TCP命令

1. 在`tcp_protocol.h`添加命令定义
2. 在`tcp_server.c`添加命令处理函数
3. 更新命令文档

#### 添加新的PDO字段

1. 修改`EtherCAT_TxPDO1_t`或`EtherCAT_RxPDO1_t`结构
2. 更新PDO映射表(0x1A00/0x1600)
3. 重新生成ESI配置文件

#### 协议切换配置

```c
// 方式1: 编译时配置
#define ACTIVE_PROTOCOL COMM_PROTOCOL_ETHERCAT

// 方式2: 运行时配置
comm_set_mode(COMM_MODE_TCP_ONLY);  // 纯TCP模式
comm_set_mode(COMM_MODE_ETHERCAT_ONLY);  // 纯EtherCAT模式
comm_set_mode(COMM_MODE_AUTO_SELECT);  // 自动选择
```

---

## 11. v3到v4更新摘要

### 11.1 新增内容

✅ **网络通信中间件**: `middleware/network/` 完整实现
✅ **协议数据结构**: `include/common/protocol_data.h` 统一定义
✅ **TCP协议完整定义**: 50+命令字,完整帧格式
✅ **EtherCAT PDO映射**: TxPDO(54字节)+RxPDO(34字节)
✅ **通信管理器**: 支持TCP/EtherCAT双协议兼容
✅ **通信任务**: `app/comm_task.c/h` 统一通信处理

### 11.2 修改内容

🔄 **传感器任务**: 集成`comm_send_realtime_data()`接口
🔄 **控制任务**: 集成`comm_register_control_callback()`接口
🔄 **配置任务**: 增加网络通信配置项
🔄 **目录结构**: 增加`middleware/network/`和`include/common/`

### 11.3 保持不变

✔️ HAL层设计
✔️ 驱动层设计
✔️ PID/滤波器中间件
✔️ 安全监控任务
✔️ HMI任务
✔️ 构建系统

---

## 12. 附录

### 12.1 相关文档

- `墨路通信协议_工作表1.png` - 协议数据项定义
- `墨路网络通信设计方案-基于协议表格.md` - 网络详细设计
- `墨路控制系统详细设计文档v3.md` - 系统基础设计

### 12.2 关键文件清单

**网络相关**:
- `include/common/protocol_data.h` - 协议数据结构
- `include/common/tcp_protocol.h` - TCP协议定义
- `middleware/network/comm_manager.h` - 通信管理器接口
- `middleware/network/protocol_adapter.h` - 协议适配器接口
- `config/network_config.h` - 网络配置

**应用层**:
- `app/comm_task.c/h` - 通信任务
- `app/sensor_task.c/h` - 传感器任务
- `app/control_task.c/h` - 控制任务
- `app/ethercat_app.c/h` - EtherCAT应用
- `app/tcp_server.c/h` - TCP服务器

---

**文档版本**: v4.0
**最后更新**: 2025-09-30
**编写依据**: 墨路通信协议表格 + v3系统设计 + 网络通信设计方案
