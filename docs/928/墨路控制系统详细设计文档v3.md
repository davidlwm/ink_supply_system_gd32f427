# 墨路控制系统详细设计文档 v3

## 1. 系统概述

### 1.1 技术选型
- **MCU**: GD32F427
- **操作系统**: FreeRTOS
- **网络协议栈**: lwIP
- **通信协议**: EtherCAT开源库
- **HAL库**: GD32 HAL库

### 1.2 系统架构
采用四层分层架构设计：
```
应用层 (Application Layer)
    ↓
中间件层 (Middleware Layer)
    ↓
HAL层 (Hardware Abstraction Layer)
    ↓
驱动层 (Driver Layer)
```

### 1.3 代码目录结构
```
ink_supply_gd32f427_v3/
├── 📁 app/                                # 应用层 (扩充现有app/)
│   ├── 📄 main.c                          # 主程序 (从USER/迁移)
│   ├── 📄 app_main.c/h                    # 应用主程序
│   ├── 📄 sensor_task.c/h                 # 传感器任务
│   ├── 📄 actuator_task.c/h               # 执行器任务
│   ├── 📄 control_task.c/h                # 控制任务 (PID控制)
│   ├── 📄 safety_task.c/h                 # 安全任务
│   ├── 📄 hmi_task.c/h                    # HMI任务 (LCD+LED)
│   ├── 📄 comm_task.c/h                   # 通信任务
│   ├── 📄 config_task.c/h                 # 配置任务
│   ├── 📄 ethercat_app.c/h                # EtherCAT应用
│   └── 📄 tcp_server.c/h                  # TCP服务器
│
├── 📁 hal/                                # HAL抽象层 (填充现有hal/)
│   ├── 📄 hal_common.c/h                  # HAL公共功能
│   ├── 📄 hal_manager.c/h                 # HAL管理器
│   ├── 📄 adc_hal.c/h                     # ADC硬件抽象
│   ├── 📄 pwm_hal.c/h                     # PWM硬件抽象
│   ├── 📄 gpio_hal.c/h                    # GPIO硬件抽象
│   ├── 📄 uart_hal.c/h                    # UART硬件抽象
│   ├── 📄 spi_hal.c/h                     # SPI硬件抽象
│   ├── 📄 i2c_hal.c/h                     # I2C硬件抽象 (封装现有IIC)
│   ├── 📄 eth_hal.c/h                     # 以太网硬件抽象
│   ├── 📄 flash_hal.c/h                   # Flash硬件抽象
│   └── 📄 timer_hal.c/h                   # 定时器硬件抽象
│
├── 📁 middleware/                         # 中间件层 (扩充现有middleware/)
│   ├── 📁 delay/                          # 延时功能 (保持现有)
│   │   ├── 📄 delay.c/h                   # 延时实现
│   ├── 📁 sys/                            # 系统功能 (保持现有)
│   │   ├── 📄 sys.c/h                     # 系统配置
│   ├── 📁 usart/                          # 串口功能 (保持现有)
│   │   ├── 📄 usart.c/h                   # 串口驱动
│   ├── 📄 middleware_common.c/h           # 中间件公共功能
│   ├── 📄 tasks.c/h                       # FreeRTOS任务管理
│   ├── 📄 pid.c/h                         # PID算法实现
│   ├── 📄 filter.c/h                      # 数字滤波算法
│   └── 📄 protocol.c/h                    # 通信协议解析
│
├── 📁 drivers/                            # 驱动层 (扩充现有drivers/)
│   ├── 📁 sensors/                        # 传感器驱动 (新增分类)
│   │   ├── 📄 frd8061_driver.c/h          # FRD8061液位传感器
│   │   ├── 📄 ftt518_driver.c/h           # FTT518温度传感器
│   │   ├── 📄 hp10my_driver.c/h           # HP10MY压力传感器
│   │   └── 📄 sensor_common.c/h           # 传感器公共接口
│   ├── 📁 actuators/                      # 执行器驱动 (新增分类)
│   │   ├── 📄 mra23d3_driver.c/h          # MRA23D3电机驱动
│   │   ├── 📄 mpb025bbb_driver.c/h        # MPB025BBB泵驱动
│   │   ├── 📄 valve_control.c/h           # 阀门控制
│   │   ├── 📄 led_control.c/h             # LED控制 (从现有LED/迁移)
│   │   └── 📄 actuator_common.c/h         # 执行器公共接口
│   ├── 📁 display/                        # 显示驱动 (重组现有LCD/)
│   │   ├── 📄 lcd_driver.c/h              # LCD驱动 (从现有LCD/迁移)
│   │   ├── 📄 oled_driver.c/h             # OLED驱动
│   │   └── 📄 display_common.c/h          # 显示公共接口
│   ├── 📁 input/                          # 输入设备驱动 (重组现有KEY/)
│   │   ├── 📄 key_driver.c/h              # 按键驱动 (从现有KEY/迁移)
│   │   └── 📄 input_common.c/h            # 输入公共接口
│   ├── 📁 storage/                        # 存储驱动 (重组现有24CXX/)
│   │   ├── 📄 24cxx_driver.c/h            # EEPROM驱动 (从现有24CXX/迁移)
│   │   ├── 📄 flash_driver.c/h            # 内部Flash驱动
│   │   └── 📄 storage_common.c/h          # 存储公共接口
│   ├── 📁 communication/                  # 通信驱动 (重组现有IIC/)
│   │   ├── 📄 iic_driver.c/h              # I2C驱动 (从现有IIC/迁移)
│   │   ├── 📄 can_driver.c/h              # CAN驱动
│   │   ├── 📄 ethernet_driver.c/h         # 以太网驱动
│   │   └── 📄 comm_common.c/h             # 通信公共接口
│   └── 📄 driver_manager.c/h              # 驱动管理器
│
├── 📁 lib/                                # 第三方库 (保持现有结构)
│   ├── 📁 STM32F4xx_HAL_Driver/           # STM32 HAL库 (保持现有)
│   │   ├── 📁 Inc/                        # HAL库头文件
│   │   └── 📁 Src/                        # HAL库源文件
│   ├── 📁 CMSIS/                          # ARM CMSIS库 (保持现有)
│   ├── 📁 FreeRTOS/                       # FreeRTOS实时操作系统 (新增)
│   │   ├── 📁 Source/                     # RTOS源码
│   │   └── 📁 portable/                   # GD32F427移植层
│   ├── 📁 lwip/                           # lwIP网络协议栈 (新增)
│   │   ├── 📁 src/                        # lwIP源码
│   │   └── 📁 port/                       # GD32F427移植代码
│   └── 📁 ethercat/                       # EtherCAT开源库 (新增)
│       ├── 📁 master/                     # 主站库
│       └── 📁 slave/                      # 从站库
│
├── 📁 include/                            # 头文件目录 (填充现有include/)
│   ├── 📁 app/                            # 应用层头文件
│   ├── 📁 hal/                            # HAL层头文件
│   ├── 📁 middleware/                     # 中间件头文件
│   ├── 📁 drivers/                        # 驱动层头文件
│   ├── 📁 common/                         # 公共头文件
│   └── 📄 project_config.h                # 项目全局配置
│
├── 📁 config/                             # 配置文件 (扩充现有config/)
│   ├── 📄 FreeRTOSConfig.h                # FreeRTOS配置
│   ├── 📄 lwipopts.h                      # lwIP配置
│   ├── 📄 gd32f4xx_hal_conf.h            # GD32 HAL配置
│   ├── 📄 system_config.h                 # 系统参数配置
│   ├── 📄 app_config.h                    # 应用配置
│   └── 📄 sensor_config.h                 # 传感器配置
│
├── 📁 USER/                               # 工程配置层 (保持现有，简化内容)
│   ├── 📁 DebugConfig/                    # 调试配置 (保持)
│   ├── 📄 gd32f407xx.h                    # GD32F407定义 (保持)
│   ├── 📄 gd32f4xx.h                      # GD32F4xx总头文件 (保持)
│   ├── 📄 gd32f4xx_it.c/h                # 中断服务函数 (保持)
│   ├── 📄 stm32f4xx_hal_conf.h           # HAL配置 (保持)
│   ├── 📄 stm32f4xx_hal_msp.c            # HAL MSP配置 (保持)
│   ├── 📄 system_gd32f4xx.c/h            # 系统时钟配置 (保持)
│   ├── 📄 InkSupplySystem.uvprojx         # Keil工程文件 (保持)
│   └── 📄 main.h                          # 主程序头文件 (简化，实际main.c在app/)
│
├── 📁 USMART/                             # 调试工具 (保持现有)
│   ├── 📄 usmart.c/h                      # USMART核心
│   ├── 📄 usmart_config.c                 # USMART配置
│   └── 📄 usmart_str.c/h                  # 字符串处理
│
├── 📁 docs/                               # 文档目录 (新增)
│   ├── 📄 design_v3.md                    # v3设计文档
│   ├── 📄 api_reference.md                # API参考文档
│   ├── 📄 migration_guide.md              # 迁移指南
│   └── 📄 development_guide.md            # 开发指南
│
├── 📁 tools/                              # 工具目录 (新增)
│   ├── 📄 build.py                        # 构建脚本
│   └── 📄 config_generator.py             # 配置生成工具
│
├── 📁 OBJ/                                # 编译输出 (保持现有)
│   ├── 📁 Debug/                          # 调试版本
│   └── 📁 Release/                        # 发布版本
│
├── 📄 README.md                           # 项目说明
├── 📄 CHANGELOG.md                        # 版本变更日志
├── 📄 CMakeLists.txt                      # CMake构建支持 (新增)
└── 📄 .gitignore                          # Git忽略配置
```

### 1.4 模块化设计理念
基于v3模板目录结构，系统采用高度模块化设计：

- **分层清晰**: 严格按照应用层、中间件层、HAL层、驱动层四层架构
- **职责分离**: 每个模块专注于特定功能，降低耦合度
- **接口标准化**: 统一的接口设计，便于模块间协作
- **可扩展性**: 易于添加新的传感器、执行器或功能模块
- **兼容现有**: 保持现有template_simple结构稳定性

## 2. 应用层详细设计

### 2.1 任务架构

#### 2.1.1 任务优先级分配
| 任务名称 | 优先级 | 周期 | 栈大小 | 功能描述 | 对应源文件 |
|---------|-------|------|--------|----------|-----------|
| Emergency Task | 20 | 事件触发 | 1024 | 紧急安全处理 | app/safety_task.c |
| EtherCAT Task | 18 | 1ms | 2048 | EtherCAT通信处理 | app/ethercat_app.c |
| Safety Task | 15 | 10ms | 1024 | 安全监控 | app/safety_task.c |
| Control Task | 12 | 20ms | 1536 | 控制逻辑 | app/control_task.c |
| Sensor Task | 8 | 50ms | 1024 | 数据采集 | app/sensor_task.c |
| Actuator Task | 8 | 10ms | 1024 | 执行器管理 | app/actuator_task.c |
| TCP Task | 5 | 50ms | 2048 | TCP通信处理 | app/tcp_server.c |
| LED Task | 5 | 100ms | 512 | LED状态指示 | app/hmi_task.c |
| HMI Task | 5 | 100ms | 1024 | 人机交互 | app/hmi_task.c |
| Config Task | 2 | 1000ms | 1024 | 配置管理 | app/config_task.c |

#### 2.1.2 任务间通信机制
```c
// 消息队列定义 (在 app/app_main.h 中)
#define MSG_QUEUE_SIZE 16

typedef enum {
    MSG_SENSOR_DATA,
    MSG_CONTROL_CMD,
    MSG_SAFETY_ALARM,
    MSG_CONFIG_UPDATE,
    MSG_COMM_DATA
} msg_type_t;

typedef struct {
    msg_type_t type;
    uint32_t timestamp;
    uint16_t data_len;
    uint8_t data[64];
} system_msg_t;

// 全局消息队列 (在 app/app_main.c 中实现)
extern QueueHandle_t g_sensor_queue;
extern QueueHandle_t g_control_queue;
extern QueueHandle_t g_safety_queue;
extern QueueHandle_t g_comm_queue;
```

### 2.2 传感器任务设计 (app/sensor_task.c/h)

#### 2.2.1 传感器配置
```c
// 在 app/sensor_task.h 中定义
typedef struct {
    uint8_t channel;              // ADC通道
    float scale_factor;           // 标定系数
    float offset;                 // 零点偏移
    float filter_coefficient;     // 滤波系数
    uint16_t sample_count;        // 采样次数
} sensor_config_t;

// 传感器类型定义
typedef enum {
    SENSOR_TEMP_1,    // 温度传感器1 (FTT518 Pt100)
    SENSOR_TEMP_2,    // 温度传感器2
    SENSOR_TEMP_3,    // 温度传感器3
    SENSOR_PRESSURE_1, // 压力传感器1 (HP10MY)
    SENSOR_PRESSURE_2, // 压力传感器2
    SENSOR_PRESSURE_3, // 压力传感器3
    SENSOR_PRESSURE_4, // 压力传感器4
    SENSOR_LEVEL_1,   // 液位传感器1 (FRD-8061)
    SENSOR_LEVEL_2,   // 液位传感器2
    SENSOR_LEVEL_3,   // 液位传感器3
    SENSOR_LEVEL_ANALOG, // 模拟量液位
    SENSOR_FLOW,      // 流量传感器(I2C)
    SENSOR_COUNT
} sensor_type_t;
```

#### 2.2.2 数据采集与处理
```c
// 在 app/sensor_task.h 中定义
typedef struct {
    float raw_value;              // 原始值
    float filtered_value;         // 滤波后值
    float calibrated_value;       // 标定后值
    uint32_t timestamp;           // 时间戳
    bool valid;                   // 数据有效性
    uint16_t error_count;         // 错误计数
} sensor_data_t;

typedef struct {
    sensor_data_t sensors[SENSOR_COUNT];
    float temp_values[3];         // °C
    float pressure_values[4];     // kPa
    float level_values[4];        // mm
    float flow_value;             // L/min
} sensor_context_t;
```

#### 2.2.3 传感器驱动集成
- **FRD8061液位传感器**: 驱动位于 `drivers/sensors/frd8061_driver.c/h`
- **FTT518温度传感器**: 驱动位于 `drivers/sensors/ftt518_driver.c/h`
- **HP10MY压力传感器**: 驱动位于 `drivers/sensors/hp10my_driver.c/h`

### 2.3 执行器任务设计 (app/actuator_task.c/h)

#### 2.3.1 执行器配置
```c
// 在 app/actuator_task.h 中定义
typedef struct {
    uint8_t channel;              // 输出通道
    float current_output;         // 当前输出值
    float target_output;          // 目标输出值
    bool enabled;                 // 使能状态
    uint32_t last_update;         // 最后更新时间
} actuator_config_t;

// 执行器类型
typedef enum {
    ACTUATOR_VALVE_1,     // 电磁阀1 (24V)
    ACTUATOR_VALVE_2,     // 电磁阀2 (24V)
    ACTUATOR_HEATER_1,    // 加热器1 (继电器)
    ACTUATOR_HEATER_2,    // 加热器2 (继电器)
    ACTUATOR_HEATER_3,    // 加热器3 (继电器)
    ACTUATOR_PUMP_SPEED_1, // 调速泵1 (PWM)
    ACTUATOR_PUMP_SPEED_2, // 调速泵2 (PWM)
    ACTUATOR_PUMP_DC_1,   // 直流泵1 (IO)
    ACTUATOR_PUMP_DC_2,   // 直流泵2 (IO)
    ACTUATOR_COUNT
} actuator_type_t;
```

#### 2.3.2 执行器驱动集成
- **MRA23D3电机驱动**: 驱动位于 `drivers/actuators/mra23d3_driver.c/h`
- **MPB025BBB泵驱动**: 驱动位于 `drivers/actuators/mpb025bbb_driver.c/h`
- **阀门控制**: 驱动位于 `drivers/actuators/valve_control.c/h`
- **LED控制**: 驱动位于 `drivers/actuators/led_control.c/h`

### 2.4 控制任务设计 (app/control_task.c/h)

#### 2.4.1 控制器配置
```c
// 在 app/control_task.h 中定义
typedef struct {
    // PID参数
    float kp, ki, kd;             // PID系数
    float setpoint;               // 设定值
    float output_min, output_max; // 输出限幅
    float integral_min, integral_max; // 积分限幅

    // 状态变量
    float previous_error;
    float integral;
    float derivative;
    float previous_input;

    // 控制模式
    bool auto_mode;
    bool reverse_action;
} pid_controller_t;

// 控制回路定义
typedef enum {
    CTRL_TEMP_1,      // 温度控制回路1
    CTRL_TEMP_2,      // 温度控制回路2
    CTRL_TEMP_3,      // 温度控制回路3
    CTRL_PRESSURE_1,  // 压力控制回路1
    CTRL_PRESSURE_2,  // 压力控制回路2
    CTRL_LEVEL_1,     // 液位控制回路1
    CTRL_LEVEL_2,     // 液位控制回路2
    CTRL_FLOW,        // 流量控制回路
    CTRL_COUNT
} control_loop_t;
```

### 2.5 安全监控任务设计 (app/safety_task.c/h)

#### 2.5.1 任务结构
```c
// 在 app/safety_task.h 中定义
typedef struct {
    uint32_t check_interval;      // 检查间隔
    uint32_t timeout_threshold;   // 超时阈值
    bool (*check_function)(void); // 检查函数
    void (*alarm_handler)(void);  // 告警处理
} safety_check_item_t;

typedef struct {
    // 传感器状态
    bool temp_sensor_ok[3];       // 3路温度传感器状态
    bool pressure_sensor_ok[4];   // 4路压力传感器状态
    bool level_sensor_ok[3];      // 3路液位传感器状态
    bool flow_sensor_ok;          // 流量传感器状态

    // 执行器状态
    bool valve_status[2];         // 电磁阀状态
    bool heater_status[3];        // 加热器状态
    bool pump_status[4];          // 泵状态

    // 通信状态
    uint32_t ethercat_last_comm;  // EtherCAT最后通信时间
    uint32_t tcp_last_comm;       // TCP最后通信时间

    // 安全参数
    float temp_max[3];            // 温度上限
    float temp_min[3];            // 温度下限
    float pressure_max[4];        // 压力上限
    float pressure_min[4];        // 压力下限
    float level_max[3];           // 液位上限
    float level_min[3];           // 液位下限
} safety_context_t;
```

#### 2.5.2 安全检查项目
| 检查项目 | 检查频率 | 阈值设置 | 处理动作 |
|---------|---------|----------|----------|
| 传感器健康检查 | 10ms | 连续3次读取失败 | 切换到安全模式 |
| 执行器状态检查 | 10ms | 反馈信号异常 | 停止相关控制 |
| 温度过限检查 | 10ms | ±5°C超出设定值 | 关闭加热/启动冷却 |
| 压力过限检查 | 10ms | ±10kPa超出设定值 | 关闭相关阀门 |
| 液位异常检查 | 10ms | 超出安全范围 | 停止相关泵 |
| 通信超时检查 | 50ms | 500ms无通信 | 进入离线模式 |

#### 2.5.3 安全状态机
```c
// 在 app/safety_task.h 中定义
typedef enum {
    SAFETY_STATE_NORMAL,      // 正常运行
    SAFETY_STATE_WARNING,     // 警告状态
    SAFETY_STATE_ALARM,       // 告警状态
    SAFETY_STATE_EMERGENCY,   // 紧急停机
    SAFETY_STATE_MAINTENANCE  // 维护模式
} safety_state_t;

typedef struct {
    safety_state_t current_state;
    safety_state_t prev_state;
    uint32_t state_enter_time;
    uint32_t alarm_count;
} safety_state_machine_t;
```

### 2.6 HMI任务设计 (app/hmi_task.c/h)

#### 2.6.1 显示器接口
```c
// 在 app/hmi_task.h 中定义
typedef struct {
    uint8_t width;                // 128像素
    uint8_t height;               // 32像素
    uint8_t framebuffer[512];     // 显存 (128*32/8)
    bool dirty;                   // 刷新标志
} lcd_context_t;

typedef enum {
    DISPLAY_PAGE_MAIN,        // 主页面
    DISPLAY_PAGE_TEMP,        // 温度页面
    DISPLAY_PAGE_PRESSURE,    // 压力页面
    DISPLAY_PAGE_LEVEL,       // 液位页面
    DISPLAY_PAGE_FLOW,        // 流量页面
    DISPLAY_PAGE_CONTROL,     // 控制页面
    DISPLAY_PAGE_ALARM,       // 告警页面
    DISPLAY_PAGE_CONFIG,      // 配置页面
    DISPLAY_PAGE_COUNT
} display_page_t;
```

#### 2.6.2 LED指示配置
```c
// 在 app/hmi_task.h 中定义
typedef enum {
    LED_LEVEL_LOW_1,      // 液位低位指示1 (红)
    LED_LEVEL_HIGH_1,     // 液位高位指示1 (绿)
    LED_LEVEL_LOW_2,      // 液位低位指示2 (红)
    LED_LEVEL_HIGH_2,     // 液位高位指示2 (绿)
    LED_LEVEL_LOW_3,      // 液位低位指示3 (红)
    LED_LEVEL_HIGH_3,     // 液位高位指示3 (绿)
    LED_LEVEL_ANALOG,     // 模拟液位指示 (蓝)
    LED_TEMP_1,           // 温度传感器1 (绿/红)
    LED_TEMP_2,           // 温度传感器2 (绿/红)
    LED_TEMP_3,           // 温度传感器3 (绿/红)
    LED_PRESSURE_1,       // 压力传感器1 (绿/红)
    LED_PRESSURE_2,       // 压力传感器2 (绿/红)
    LED_PRESSURE_3,       // 压力传感器3 (绿/红)
    LED_PRESSURE_4,       // 压力传感器4 (绿/红)
    LED_FLOW,             // 流量指示 (绿/红)
    LED_OUTPUT_1,         // 输出指示1 (黄)
    LED_OUTPUT_2,         // 输出指示2 (黄)
    LED_OUTPUT_3,         // 输出指示3 (黄)
    LED_OUTPUT_4,         // 输出指示4 (黄)
    LED_OUTPUT_5,         // 输出指示5 (黄)
    LED_OUTPUT_6,         // 输出指示6 (黄)
    LED_OUTPUT_7,         // 输出指示7 (黄)
    LED_OUTPUT_8,         // 输出指示8 (黄)
    LED_OUTPUT_9,         // 输出指示9 (黄)
    LED_POWER,            // 电源指示 (绿)
    LED_COMM,             // 通信指示 (红)
    LED_COUNT
} led_type_t;

typedef struct {
    uint8_t gpio_port;
    uint8_t gpio_pin;
    bool state;
    bool blink_enable;
    uint16_t blink_period;
    uint16_t blink_duty;
    uint32_t last_toggle;
} led_config_t;
```

### 2.7 通信任务设计

#### 2.7.1 EtherCAT通信任务 (app/ethercat_app.c/h)
```c
// 在 app/ethercat_app.h 中定义
typedef struct {
    uint16_t vendor_id;           // 厂商ID
    uint16_t product_code;        // 产品代码
    uint32_t revision;            // 版本号
    uint16_t pdo_input_size;      // 输入PDO大小
    uint16_t pdo_output_size;     // 输出PDO大小
} ethercat_config_t;

// PDO映射
typedef struct {
    // 输入PDO (主站->从站)
    float temp_setpoint[3];       // 温度设定值
    float pressure_setpoint[4];   // 压力设定值
    float level_setpoint[3];      // 液位设定值
    float flow_setpoint;          // 流量设定值
    uint16_t control_word;        // 控制字

    // 输出PDO (从站->主站)
    float temp_actual[3];         // 温度实际值
    float pressure_actual[4];     // 压力实际值
    float level_actual[3];        // 液位实际值
    float flow_actual;            // 流量实际值
    uint16_t status_word;         // 状态字
    uint16_t alarm_word;          // 告警字
} ethercat_pdo_t;
```

#### 2.7.2 TCP通信任务 (app/tcp_server.c/h)
```c
// 在 app/tcp_server.h 中定义
// 基础协议帧结构
typedef struct {
    uint16_t sync_word;       // 同步字 0xAA55
    uint16_t length;          // 帧长度(包含帧头)
    uint8_t  cmd;             // 命令字
    uint8_t  index;           // 索引
    uint16_t checksum;        // 校验和
} __attribute__((packed)) tcp_frame_header_t;

typedef struct {
    tcp_frame_header_t header;
    uint8_t data[];
} __attribute__((packed)) tcp_protocol_frame_t;

// 命令定义
typedef enum {
    CMD_READ_SENSOR = 0x01,       // 读取传感器数据
    CMD_WRITE_SETPOINT = 0x02,    // 写入设定值
    CMD_READ_STATUS = 0x03,       // 读取状态
    CMD_WRITE_CONTROL = 0x04,     // 写入控制命令
    CMD_READ_CONFIG = 0x05,       // 读取配置
    CMD_WRITE_CONFIG = 0x06,      // 写入配置
    CMD_ALARM_ACK = 0x07,         // 告警确认
    CMD_RESET = 0x08,             // 系统复位
} tcp_command_t;

// 错误码定义
typedef enum {
    ERR_OK = 0x00,                // 成功
    ERR_INVALID_CMD = 0x01,       // 无效命令
    ERR_INVALID_PARAM = 0x02,     // 无效参数
    ERR_DEVICE_BUSY = 0x03,       // 设备忙
    ERR_TIMEOUT = 0x04,           // 超时
    ERR_CHECKSUM = 0x05,          // 校验错误
    ERR_PERMISSION = 0x06,        // 权限不足
} tcp_error_code_t;
```

### 2.8 配置任务设计 (app/config_task.c/h)

#### 2.8.1 配置参数结构
```c
// 在 app/config_task.h 中定义
typedef struct {
    // 传感器配置
    sensor_config_t sensor_configs[SENSOR_COUNT];

    // 控制器配置
    pid_controller_t controllers[CTRL_COUNT];

    // 安全参数
    safety_context_t safety_params;

    // 通信配置
    struct {
        uint32_t ip_address;
        uint16_t tcp_port;
        uint16_t ethercat_address;
        uint32_t baudrate;
    } comm_config;

    // 系统配置
    struct {
        uint16_t system_id;
        char device_name[32];
        char version[16];
        uint32_t config_crc;
        uint32_t config_version;
    } system_config;
} system_configuration_t;
```

#### 2.8.2 参数存储
```c
// 在 app/config_task.h 中定义
// EEPROM/Flash存储管理
typedef struct {
    uint32_t base_address;        // 基地址
    uint32_t sector_size;         // 扇区大小
    uint32_t backup_address;      // 备份地址
    bool write_protection;        // 写保护
} config_storage_t;

// 配置管理接口
typedef enum {
    CONFIG_LOAD_DEFAULT,          // 加载默认配置
    CONFIG_LOAD_FROM_STORAGE,     // 从存储加载
    CONFIG_SAVE_TO_STORAGE,       // 保存到存储
    CONFIG_BACKUP,                // 备份配置
    CONFIG_RESTORE,               // 恢复配置
    CONFIG_VALIDATE,              // 验证配置
} config_operation_t;
```

## 3. 中间件层设计

### 3.1 PID控制器 (middleware/pid.c/h)
```c
// 在 middleware/pid.h 中定义
typedef struct {
    float (*compute)(pid_controller_t* pid, float input);
    void (*set_tunings)(pid_controller_t* pid, float kp, float ki, float kd);
    void (*set_output_limits)(pid_controller_t* pid, float min, float max);
    void (*set_mode)(pid_controller_t* pid, bool automatic);
    void (*initialize)(pid_controller_t* pid);
} pid_interface_t;
```

### 3.2 数字滤波器 (middleware/filter.c/h)
```c
// 在 middleware/filter.h 中定义
// 滑动平均滤波
typedef struct {
    float buffer[16];
    uint8_t index;
    uint8_t count;
    float sum;
} moving_average_filter_t;

// 卡尔曼滤波器
typedef struct {
    float Q;     // 过程噪声
    float R;     // 测量噪声
    float P;     // 估计误差协方差
    float K;     // 卡尔曼增益
    float X;     // 状态估计
} kalman_filter_t;

typedef struct {
    float (*moving_average)(moving_average_filter_t* filter, float input);
    float (*kalman_filter)(kalman_filter_t* filter, float measurement);
    float (*low_pass_filter)(float input, float prev_output, float alpha);
    float (*median_filter)(float* buffer, uint8_t size);
} filter_interface_t;
```

### 3.3 任务管理器 (middleware/tasks.c/h)
```c
// 在 middleware/tasks.h 中定义
typedef struct {
    TaskHandle_t handle;
    char name[16];
    uint32_t stack_size;
    UBaseType_t priority;
    uint32_t run_count;
    uint32_t max_execution_time;
    uint32_t avg_execution_time;
    bool enabled;
} task_info_t;

typedef struct {
    task_info_t tasks[10];
    uint8_t task_count;
    uint32_t system_tick;
    uint32_t cpu_usage;
    uint32_t free_heap;
} task_manager_t;
```

### 3.4 系统中间件保持兼容
- **middleware/delay/**: 保持现有延时功能实现
- **middleware/sys/**: 保持现有系统配置功能
- **middleware/usart/**: 保持现有串口通信功能

## 4. HAL层设计

### 4.1 HAL层架构 (hal/)
基于GD32F427 HAL库和现有template结构封装，提供统一的硬件访问接口：

- **hal_manager.c/h**: HAL层管理器，统一初始化和管理各HAL模块
- **hal_common.c/h**: HAL层公共功能和通用定义
- **adc_hal.c/h**: ADC硬件抽象，支持多通道传感器采集
- **pwm_hal.c/h**: PWM硬件抽象，支持执行器控制
- **gpio_hal.c/h**: GPIO硬件抽象，数字IO控制
- **uart_hal.c/h**: UART硬件抽象，调试和通信接口
- **spi_hal.c/h**: SPI硬件抽象，LCD显示接口
- **i2c_hal.c/h**: I2C硬件抽象，基于现有IIC驱动封装
- **eth_hal.c/h**: 以太网硬件抽象，网络通信支持
- **flash_hal.c/h**: Flash硬件抽象，配置存储管理
- **timer_hal.c/h**: 定时器硬件抽象，精确时序控制

### 4.2 HAL接口标准化
```c
// 在 hal/hal_common.h 中定义
typedef enum {
    HAL_OK = 0,
    HAL_ERROR,
    HAL_BUSY,
    HAL_TIMEOUT
} hal_status_t;

typedef struct {
    hal_status_t (*init)(void* config);
    hal_status_t (*deinit)(void);
    hal_status_t (*read)(void* data, uint32_t size);
    hal_status_t (*write)(const void* data, uint32_t size);
    hal_status_t (*control)(uint32_t cmd, void* arg);
} hal_interface_t;
```

## 5. 驱动层设计

### 5.1 传感器驱动 (drivers/sensors/)
- **frd8061_driver.c/h**: FRD8061液位传感器专用驱动
- **ftt518_driver.c/h**: FTT518温度传感器(Pt100)专用驱动
- **hp10my_driver.c/h**: HP10MY压力传感器专用驱动
- **sensor_common.c/h**: 传感器公共接口和通用功能

### 5.2 执行器驱动 (drivers/actuators/)
- **mra23d3_driver.c/h**: MRA23D3电机专用驱动
- **mpb025bbb_driver.c/h**: MPB025BBB泵专用驱动
- **valve_control.c/h**: 电磁阀控制驱动
- **led_control.c/h**: LED指示灯控制驱动 (从现有LED/迁移)
- **actuator_common.c/h**: 执行器公共接口和通用功能

### 5.3 显示驱动 (drivers/display/)
- **lcd_driver.c/h**: LCD显示驱动 (从现有LCD/迁移改进)
- **oled_driver.c/h**: OLED显示驱动
- **display_common.c/h**: 显示设备公共接口

### 5.4 输入驱动 (drivers/input/)
- **key_driver.c/h**: 按键驱动 (从现有KEY/迁移改进)
- **input_common.c/h**: 输入设备公共接口

### 5.5 存储驱动 (drivers/storage/)
- **24cxx_driver.c/h**: EEPROM驱动 (从现有24CXX/迁移改进)
- **flash_driver.c/h**: 内部Flash驱动
- **storage_common.c/h**: 存储设备公共接口

### 5.6 通信驱动 (drivers/communication/)
- **iic_driver.c/h**: I2C驱动 (从现有IIC/迁移改进)
- **can_driver.c/h**: CAN总线驱动
- **ethernet_driver.c/h**: 以太网驱动
- **comm_common.c/h**: 通信设备公共接口

### 5.7 驱动接口统一化
```c
// 在 drivers/driver_manager.h 中定义
typedef struct {
    hal_status_t (*init)(void* config);
    hal_status_t (*read)(float* value);
    hal_status_t (*write)(float value);
    hal_status_t (*calibrate)(void* params);
    hal_status_t (*self_test)(void);
} sensor_driver_interface_t;

typedef struct {
    hal_status_t (*init)(void* config);
    hal_status_t (*set_output)(float value);
    hal_status_t (*get_status)(uint32_t* status);
    hal_status_t (*enable)(bool enable);
    hal_status_t (*self_test)(void);
} actuator_driver_interface_t;
```

## 6. 系统集成

### 6.1 启动序列
```c
// 在 app/app_main.h 中定义
typedef enum {
    BOOT_STAGE_HARDWARE_INIT,     // 硬件初始化
    BOOT_STAGE_RTOS_INIT,         // RTOS初始化
    BOOT_STAGE_MIDDLEWARE_INIT,   // 中间件初始化
    BOOT_STAGE_APP_INIT,          // 应用初始化
    BOOT_STAGE_SELF_TEST,         // 自检
    BOOT_STAGE_READY,             // 准备就绪
} boot_stage_t;
```

### 6.2 错误处理
```c
// 在 include/common/ 中定义
typedef enum {
    ERROR_NONE = 0,
    ERROR_SENSOR_FAULT,
    ERROR_ACTUATOR_FAULT,
    ERROR_COMMUNICATION_FAULT,
    ERROR_SAFETY_VIOLATION,
    ERROR_SYSTEM_OVERLOAD,
    ERROR_CONFIG_INVALID,
    ERROR_HARDWARE_FAULT,
} system_error_t;

typedef struct {
    system_error_t error_code;
    uint32_t timestamp;
    char description[64];
    uint8_t severity;             // 0-3: 信息,警告,错误,严重
    bool acknowledged;
} error_record_t;
```

### 6.3 性能监控
```c
// 在 app/app_main.h 中定义
typedef struct {
    uint32_t cpu_usage_percent;
    uint32_t memory_usage_bytes;
    uint32_t free_stack_min[10];  // 各任务最小剩余栈
    uint32_t task_switch_count;
    uint32_t interrupt_count;
    uint32_t max_interrupt_time;
} performance_metrics_t;
```

## 7. 构建系统

### 7.1 现有Keil工程保持
项目继续使用现有Keil工程文件：
- `USER/InkSupplySystem.uvprojx` - Keil工程文件
- 保持现有编译配置和调试设置
- 支持USMART调试系统

### 7.2 新增CMake构建支持
```cmake
# 主要构建目标
project(ink_supply_system_gd32f427_v3)

# v3源文件组织
add_subdirectory(app)
add_subdirectory(hal)
add_subdirectory(middleware)
add_subdirectory(drivers)

# 现有结构保持
add_subdirectory(USER)
add_subdirectory(USMART)

# 第三方库集成
add_subdirectory(lib/STM32F4xx_HAL_Driver)
add_subdirectory(lib/FreeRTOS)
add_subdirectory(lib/lwip)
add_subdirectory(lib/ethercat)
```

### 7.3 配置文件管理
系统配置文件位于多个目录：

**config/ 目录：**
- **FreeRTOSConfig.h**: FreeRTOS系统配置
- **lwipopts.h**: lwIP网络栈配置
- **gd32f4xx_hal_conf.h**: GD32 HAL库配置
- **system_config.h**: 系统参数配置
- **app_config.h**: 应用层配置
- **sensor_config.h**: 传感器配置

**USER/ 目录 (保持现有):**
- **stm32f4xx_hal_conf.h**: HAL库配置
- **gd32f4xx.h**: 芯片总头文件

## 8. 测试与验证

### 8.1 单元测试
- 各传感器数据采集精度测试
- PID控制器响应特性测试
- 安全监控功能测试
- 通信协议正确性测试

### 8.2 集成测试
- 多任务协同工作测试
- 实时性能测试
- 故障恢复测试
- 长期稳定性测试

### 8.3 系统测试
- 完整工艺流程测试
- 极限工况测试
- 电磁兼容性测试
- 安全认证测试

### 8.4 兼容性测试
- 现有USMART调试工具功能验证
- Keil工程编译和调试验证
- 现有中间件功能保持性测试

## 9. 开发指南

### 9.1 代码规范
- 遵循MISRA C编码标准
- 统一的命名约定和文件组织
- 完整的接口文档和注释
- 模块化设计和接口抽象

### 9.2 调试支持
- 保持现有USMART调试工具
- 统一的错误处理和日志系统
- 性能监控和资源使用统计
- 在线调试和参数调整接口
- 故障诊断和恢复机制

### 9.3 扩展性设计
- 标准化的驱动接口，易于添加新设备
- 模块化的任务架构，支持功能扩展
- 灵活的配置系统，支持不同应用场景
- 开放的通信协议，支持系统集成

### 9.4 迁移指南
- 渐进式迁移：保持现有功能稳定
- 分阶段实施：优先核心功能，逐步完善
- 向后兼容：继续支持现有工具和流程
- 文档完备：提供详细的迁移和开发文档

---

*本文档版本: v3.0*
*最后更新: 2025-09-29*
*基于v3模板目录结构和现有ink_supply_template_simple结构编写*