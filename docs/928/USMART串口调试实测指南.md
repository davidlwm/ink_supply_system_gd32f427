# USMARTä¸²å£è°ƒè¯•å®æµ‹æŒ‡å—

## 1. ç°çŠ¶åˆ†æ

æ£€æŸ¥äº†ç°æœ‰ä»£ç ï¼Œå‘ç°ï¼š

### âœ… å·²ç»é…ç½®å¥½çš„éƒ¨åˆ†ï¼š
- ä¸²å£åˆå§‹åŒ–ï¼š`uart_init(115200)` âœ…
- USMARTåˆå§‹åŒ–ï¼š`usmart_dev.init(84)` âœ…
- ä¸²å£ä¸­æ–­æ¥æ”¶ï¼šé…ç½®æ­£ç¡® âœ…
- åŸºç¡€å‡½æ•°æ³¨å†Œï¼šå·²æ³¨å†Œ6ä¸ªå‡½æ•° âœ…

### âŒ éœ€è¦ä¿®æ”¹çš„å…³é”®é—®é¢˜ï¼š
- **ä¸»å¾ªç¯ç¼ºå°‘`usmart_dev.scan()`è°ƒç”¨** - è¿™æ˜¯USMARTå·¥ä½œçš„æ ¸å¿ƒï¼

## 2. å¿…é¡»ä¿®æ”¹çš„ä»£ç 

### 2.1 ä¿®æ”¹main.c - æ·»åŠ USMARTæ‰«æ

**æ–‡ä»¶ä½ç½®ï¼š** `USER/main.c`

**åœ¨ä¸»å¾ªç¯ä¸­æ·»åŠ usmartæ‰«æï¼š**

```c
// æ‰¾åˆ°mainå‡½æ•°ä¸­çš„while(1)å¾ªç¯ï¼Œåœ¨å¾ªç¯æœ«å°¾æ·»åŠ ï¼š

/* ä¸»å¾ªç¯ */
while (1)
{
    key = KEY_Scan(0);

    /* æŒ‰é”®å¤„ç† */
    if (key == WKUP_PRES)
    {
        // ... ç°æœ‰ä»£ç ä¿æŒä¸å˜
    }

    if (key == KEY0_PRES)
    {
        // ... ç°æœ‰ä»£ç ä¿æŒä¸å˜
    }

    /* ç³»ç»Ÿè®¡æ•°å’ŒçŠ¶æ€æ˜¾ç¤º */
    system_counter++;

    /* LEDé—ªçƒæŒ‡ç¤ºç³»ç»Ÿè¿è¡Œ */
    led_counter++;
    if (led_counter >= 50)
    {
        LED0 = !LED0;
        led_counter = 0;

        if (system_counter % 500 == 0)
        {
            printf("System running... Counter: %lu\r\n", system_counter);
        }
    }

    // ========== æ·»åŠ è¿™ä¸€è¡Œ ==========
    usmart_dev.scan();    // USMARTå‘½ä»¤æ‰«æ - è¿™æ˜¯å…³é”®ï¼
    // ================================

    delay_ms(10);
}
```

**å®Œæ•´çš„ä¿®æ”¹ä½ç½®ï¼š**
åœ¨`delay_ms(10);`è¿™è¡Œ**ä¹‹å‰**æ·»åŠ ï¼š
```c
usmart_dev.scan();    // USMARTå‘½ä»¤æ‰«æ
```

### 2.2 å¢åŠ æ›´å¤šæµ‹è¯•å‡½æ•°ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `USMART/usmart_config.c`

**åœ¨ç°æœ‰å‡½æ•°æ³¨å†Œè¡¨ä¸­æ·»åŠ æ›´å¤šå¯æµ‹è¯•çš„å‡½æ•°ï¼š**

```c
// æ‰¾åˆ°usmart_nametab[]æ•°ç»„ï¼Œæ·»åŠ æ›´å¤šå‡½æ•°
struct _m_usmart_nametab usmart_nametab[]=
{
#if USMART_USE_WRFUNS==1
    (void*)read_addr,"u32 read_addr(u32 addr)",
    (void*)write_addr,"void write_addr(u32 addr,u32 val)",
#endif
    (void*)delay_ms,"void delay_ms(u16 nms)",
    (void*)delay_us,"void delay_us(u32 nus)",
    (void*)AT24CXX_ReadOneByte,"u8 AT24CXX_ReadOneByte(u16 ReadAddr)",
    (void*)AT24CXX_WriteOneByte,"void AT24CXX_WriteOneByte(u16 WriteAddr,u8 DataToWrite)",

    // ========== æ·»åŠ è¿™äº›å‡½æ•° (éœ€è¦åŒ…å«å¯¹åº”å¤´æ–‡ä»¶) ==========
    (void*)LED_Init,"void LED_Init(void)",
    (void*)KEY_Scan,"u8 KEY_Scan(u8 mode)",
    // ====================================================
};
```

**æ³¨æ„ï¼š** å¦‚æœæ·»åŠ LED_Initå’ŒKEY_Scanï¼Œéœ€è¦åœ¨usmart_config.cæ–‡ä»¶å¼€å¤´æ·»åŠ ï¼š
```c
#include "led.h"
#include "key.h"
```

## 3. å®Œæ•´æµ‹è¯•æ­¥éª¤

### 3.1 ç¡¬ä»¶è¿æ¥

```
USBè½¬ä¸²å£æ¨¡å—     GD32å¼€å‘æ¿
VCC (3.3V)   â†’   3.3V
GND          â†’   GND
TXD          â†’   PA10 (USART1_RX)
RXD          â†’   PA9  (USART1_TX)
```

### 3.2 è½¯ä»¶é…ç½®

#### æ­¥éª¤1ï¼šä¸‹è½½ä¸²å£è°ƒè¯•å·¥å…·
æ¨èä½¿ç”¨ï¼š
- **ä¸²å£è°ƒè¯•åŠ©æ‰‹** (æœç´¢"ä¸²å£è°ƒè¯•åŠ©æ‰‹"ä¸‹è½½)
- **PuTTY** (ä¸“ä¸šç”¨æˆ·)

#### æ­¥éª¤2ï¼šé…ç½®ä¸²å£å‚æ•°
```
æ³¢ç‰¹ç‡ï¼š115200
æ•°æ®ä½ï¼š8
åœæ­¢ä½ï¼š1
æ ¡éªŒä½ï¼šæ— 
æµæ§åˆ¶ï¼šæ— 
```

#### æ­¥éª¤3ï¼šç¼–è¯‘çƒ§å½•ç¨‹åº
1. ä¿®æ”¹main.cæ·»åŠ `usmart_dev.scan();`
2. ç¼–è¯‘å·¥ç¨‹
3. çƒ§å½•åˆ°å¼€å‘æ¿

### 3.3 æµ‹è¯•éªŒè¯

#### æ­¥éª¤1ï¼šè¿æ¥éªŒè¯
1. æ‰“å¼€ä¸²å£è°ƒè¯•å·¥å…·
2. é€‰æ‹©æ­£ç¡®çš„COMå£
3. è®¾ç½®æ³¢ç‰¹ç‡115200
4. ç‚¹å‡»"æ‰“å¼€ä¸²å£"

**æœŸæœ›çœ‹åˆ°ï¼š**
```
Ink Supply System Template Ready!
System Clock: 168MHz
Hardware: GD32F427VET6
Template: Based on IIC Experiment
System running... Counter: 500
```

#### æ­¥éª¤2ï¼šUSMARTåŠŸèƒ½æµ‹è¯•

**æµ‹è¯•1ï¼šæŸ¥çœ‹å¸®åŠ©**
åœ¨å‘é€åŒºè¾“å…¥ï¼š
```
help
```
ç‚¹å‡»å‘é€

**æœŸæœ›è¿”å›ï¼š**
```
USMART V3.1
å‡½æ•°åˆ—è¡¨:
u32 read_addr(u32 addr)
void write_addr(u32 addr,u32 val)
void delay_ms(u16 nms)
void delay_us(u32 nus)
u8 AT24CXX_ReadOneByte(u16 ReadAddr)
void AT24CXX_WriteOneByte(u16 WriteAddr,u8 DataToWrite)
void LED_Init(void)
u8 KEY_Scan(u8 mode)
```

**æµ‹è¯•2ï¼šå»¶æ—¶å‡½æ•°**
åœ¨å‘é€åŒºè¾“å…¥ï¼š
```
delay_ms(1000)
```
ç‚¹å‡»å‘é€

**æœŸæœ›ç°è±¡ï¼š**
- å¼€å‘æ¿æš‚åœ1ç§’ï¼ˆLEDåœæ­¢é—ªçƒ1ç§’ï¼‰
- ä¸²å£è¿”å›ï¼š`delay_ms(1000) executed`

**æµ‹è¯•3ï¼šæŒ‰é”®æ£€æµ‹**
åœ¨å‘é€åŒºè¾“å…¥ï¼š
```
KEY_Scan(0)
```
ç‚¹å‡»å‘é€

**æœŸæœ›è¿”å›ï¼š**
- æ²¡æŒ‰é”®ï¼š`KEY_Scan(0) = 0`
- æŒ‰ä¸‹WKUPï¼š`KEY_Scan(0) = 2`
- æŒ‰ä¸‹KEY0ï¼š`KEY_Scan(0) = 1`

**æµ‹è¯•4ï¼šEEPROMè¯»å†™**
```
# è¯»å–EEPROMåœ°å€0
AT24CXX_ReadOneByte(0)
è¿”å›ï¼šAT24CXX_ReadOneByte(0) = 255

# å†™å…¥æ•°æ®0x55åˆ°åœ°å€0
AT24CXX_WriteOneByte(0,85)
è¿”å›ï¼šAT24CXX_WriteOneByte(0,85) executed

# å†æ¬¡è¯»å–éªŒè¯
AT24CXX_ReadOneByte(0)
è¿”å›ï¼šAT24CXX_ReadOneByte(0) = 85
```

**æµ‹è¯•5ï¼šå†…å­˜æ“ä½œ**
```
# è¯»å–å†…å­˜åœ°å€
read_addr(0x20000000)
è¿”å›ï¼šread_addr(0x20000000) = 0x12345678

# å†™å…¥å†…å­˜
write_addr(0x20000000,305419896)
è¿”å›ï¼šwrite_addr(0x20000000,305419896) executed

# å†æ¬¡è¯»å–éªŒè¯
read_addr(0x20000000)
è¿”å›ï¼šread_addr(0x20000000) = 305419896
```

## 4. å¸¸è§é—®é¢˜æ’æŸ¥

### 4.1 é—®é¢˜ï¼šä¸²å£æ— å“åº”

**å¯èƒ½åŸå› ï¼š**
- ä¸²å£è¿æ¥é”™è¯¯
- æ³¢ç‰¹ç‡ä¸åŒ¹é…
- å¿˜è®°æ·»åŠ `usmart_dev.scan();`

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ç¡¬ä»¶è¿æ¥ï¼ˆTXâ†”RXäº¤å‰è¿æ¥ï¼‰
2. ç¡®è®¤æ³¢ç‰¹ç‡115200
3. **ç¡®è®¤å·²åœ¨main.cä¸»å¾ªç¯ä¸­æ·»åŠ `usmart_dev.scan();`**

### 4.2 é—®é¢˜ï¼šè¿”å›"å‡½æ•°é”™è¯¯"

**å¯èƒ½åŸå› ï¼š**
- å‡½æ•°åæ‹¼å†™é”™è¯¯
- å‡½æ•°æœªæ³¨å†Œ

**è§£å†³æ–¹æ³•ï¼š**
1. å‘é€`help`æŸ¥çœ‹å¯ç”¨å‡½æ•°
2. æ£€æŸ¥æ‹¼å†™å’Œå¤§å°å†™
3. ç¡®è®¤å‡½æ•°å·²åœ¨usmart_config.cä¸­æ³¨å†Œ

### 4.3 é—®é¢˜ï¼šè¿”å›"å‚æ•°é”™è¯¯"

**å¯èƒ½åŸå› ï¼š**
- å‚æ•°æ•°é‡ä¸å¯¹
- å‚æ•°ç±»å‹é”™è¯¯
- è¯­æ³•é”™è¯¯

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥å‚æ•°æ•°é‡
2. ç¡®è®¤æ‹¬å·å’Œé€—å·
3. å‚è€ƒhelpä¸­çš„å‡½æ•°åŸå‹

## 5. å®æµ‹å‘½ä»¤æ¸…å•

å¤åˆ¶ç²˜è´´ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå¿«é€Ÿæµ‹è¯•ï¼š

```bash
# åŸºç¡€æµ‹è¯•
help
delay_ms(500)
KEY_Scan(0)

# EEPROMæµ‹è¯•
AT24CXX_ReadOneByte(0)
AT24CXX_WriteOneByte(0,170)
AT24CXX_ReadOneByte(0)

# å†…å­˜æµ‹è¯•
read_addr(0x20000100)
write_addr(0x20000100,12345678)
read_addr(0x20000100)

# LEDæµ‹è¯•ï¼ˆå¦‚æœæ·»åŠ äº†LED_Initï¼‰
LED_Init()

# æ€§èƒ½æµ‹è¯•
runtime 1
delay_ms(100)
runtime 0
```

## 6. æ‰©å±•æµ‹è¯•

### 6.1 æ·»åŠ è‡ªå®šä¹‰æµ‹è¯•å‡½æ•°

å¦‚æœæƒ³æµ‹è¯•æ›´å¤šåŠŸèƒ½ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­æ·»åŠ è‡ªå®šä¹‰å‡½æ•°ï¼š

```c
// åœ¨main.cæˆ–å…¶ä»–æ–‡ä»¶ä¸­æ·»åŠ æµ‹è¯•å‡½æ•°
void test_system_status(void)
{
    printf("=== System Status ===\r\n");
    printf("LED0 State: %d\r\n", LED0);
    printf("System Counter: %lu\r\n", system_counter);
    printf("==================\r\n");
}

// åœ¨usmart_config.cä¸­æ³¨å†Œ
(void*)test_system_status,"void test_system_status(void)",
```

### 6.2 æµ‹è¯•LCDæ˜¾ç¤º

```c
// æ·»åŠ LCDæµ‹è¯•å‡½æ•°
void test_lcd_display(void)
{
    LCD_ShowString(30, 150, 200, 16, 16, "USMART Test OK!");
}

// æ³¨å†Œåˆ°USMART
(void*)test_lcd_display,"void test_lcd_display(void)",
```

## 7. æ€»ç»“

**å…³é”®ä¿®æ”¹ï¼š**
1. âœ… **å¿…é¡»åœ¨main.cä¸»å¾ªç¯æ·»åŠ `usmart_dev.scan();`**
2. ğŸ”§ å¯é€‰æ·»åŠ æ›´å¤šæµ‹è¯•å‡½æ•°

**æµ‹è¯•æµç¨‹ï¼š**
1. ç¡¬ä»¶è¿æ¥ï¼ˆä¸²å£çº¿ï¼‰
2. æ‰“å¼€ä¸²å£å·¥å…·ï¼ˆ115200æ³¢ç‰¹ç‡ï¼‰
3. å‘é€`help`æŸ¥çœ‹å‡½æ•°åˆ—è¡¨
4. é€ä¸ªæµ‹è¯•å„ç§å‡½æ•°

é€šè¿‡è¿™ä¸ªæµ‹è¯•ï¼Œä½ å¯ä»¥éªŒè¯USMARTç³»ç»Ÿçš„å®Œæ•´åŠŸèƒ½ï¼Œä¸ºåç»­çš„å¢¨è·¯æ§åˆ¶ç³»ç»Ÿå¼€å‘æ‰“ä¸‹åŸºç¡€ï¼

---

*æµ‹è¯•æŒ‡å—ç‰ˆæœ¬: v1.0*
*é€‚ç”¨é¡¹ç›®: ink_supply_template_simple*
*æœ€åæ›´æ–°: 2025-09-29*