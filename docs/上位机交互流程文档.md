# 上位机交互流程文档

## 版本信息
- **版本**: V4.0
- **日期**: 2025-09-27
- **项目**: ink_supply_system_gd32f427
- **标准**: 8周v4标准

## 1. 文档概述

本文档详细描述了供墨系统与上位机的交互流程，包括不同协议的交互序列、状态机设计、数据交换模式和系统集成方案。与通信协议规范文档配合使用，为上位机软件开发提供完整的交互指导。

## 2. 系统交互架构

### 2.1 交互架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   EtherCAT      │    │    Modbus       │    │    Custom       │
│   上位机        │    │    上位机       │    │    TCP上位机    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │ EtherCAT             │ Modbus TCP            │ TCP/IP
         │ 1ms周期              │ 100ms周期             │ 50ms周期
         │                      │                       │
         └──────────────────────┼───────────────────────┘
                                │
         ┌─────────────────────────────────────────────┐
         │          供墨系统控制器                      │
         │         (GD32F427VGT6)                     │
         │                                            │
         │  ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
         │  │   EtherCAT  │ │   Modbus    │ │  TCP    │ │
         │  │   从站      │ │   从站      │ │ 服务器  │ │
         │  └─────────────┘ └─────────────┘ └─────────┘ │
         │            │            │            │       │
         │  ┌─────────────────────────────────────────┐ │
         │  │          通信任务管理器                 │ │
         │  └─────────────────────────────────────────┘ │
         │            │            │            │       │
         │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────┐ │
         │  │ 传感器  │ │ 控制器  │ │ 执行器  │ │安全 │ │
         │  │ 任务    │ │ 任务    │ │ 任务    │ │任务 │ │
         │  └─────────┘ └─────────┘ └─────────┘ └─────┘ │
         └─────────────────────────────────────────────┘
```

### 2.2 交互层次结构

```
应用层交互 (上位机软件)
    ↕
协议层交互 (EtherCAT/Modbus/TCP)
    ↕
传输层交互 (以太网物理层)
    ↕
设备层交互 (供墨系统控制器)
```

## 3. EtherCAT交互流程

### 3.1 EtherCAT启动序列

```mermaid
sequenceDiagram
    participant Master as EtherCAT主站
    participant Slave as 供墨系统从站

    Note over Master,Slave: 1. 系统初始化阶段
    Master->>Slave: INIT → PREOP命令
    Slave->>Master: 状态确认 (AL Status = PREOP)
    Master->>Slave: 配置SDO参数
    Slave->>Master: SDO响应确认

    Note over Master,Slave: 2. 配置阶段
    Master->>Slave: 配置FMMU映射
    Master->>Slave: 配置Sync Manager
    Master->>Slave: 配置PDO映射
    Slave->>Master: 配置完成确认

    Note over Master,Slave: 3. 安全运行阶段
    Master->>Slave: PREOP → SAFEOP命令
    Slave->>Master: 状态确认 (AL Status = SAFEOP)
    Master->>Slave: 开始同步测试
    Slave->>Master: 同步就绪信号

    Note over Master,Slave: 4. 运行阶段
    Master->>Slave: SAFEOP → OP命令
    Slave->>Master: 状态确认 (AL Status = OP)

    Note over Master,Slave: 5. 循环数据交换
    loop 每1ms周期
        Master->>Slave: PDO输出数据 (控制命令)
        Slave->>Master: PDO输入数据 (状态+传感器)
    end
```

### 3.2 EtherCAT异常处理流程

```mermaid
stateDiagram-v2
    [*] --> Normal_Operation
    Normal_Operation --> Fault_Detected: 故障检测
    Fault_Detected --> Emergency_Stop: 紧急故障
    Fault_Detected --> Fault_Recovery: 可恢复故障
    Emergency_Stop --> Safe_State: 进入安全状态
    Fault_Recovery --> Normal_Operation: 故障清除
    Safe_State --> Manual_Reset: 手动复位
    Manual_Reset --> Normal_Operation: 复位完成

    Normal_Operation : 正常运行模式
    Normal_Operation : - PDO循环交换
    Normal_Operation : - 实时控制

    Fault_Detected : 故障检测
    Fault_Detected : - 传感器故障
    Fault_Detected : - 通信超时
    Fault_Detected : - 系统错误

    Emergency_Stop : 紧急停机
    Emergency_Stop : - 切断所有输出
    Emergency_Stop : - 发送故障报告

    Safe_State : 安全状态
    Safe_State : - 最小化功能
    Safe_State : - 等待复位命令
```

### 3.3 EtherCAT数据交换时序

```
时间轴 (1ms周期):
    0μs     250μs    500μs    750μs    1000μs
     │        │        │        │         │
     ├────────┼────────┼────────┼─────────┤
     │ PDO TX │ 处理   │ PDO RX │  等待    │ 下个周期
     │ 发送   │ 数据   │ 接收   │  同步    │
     │        │        │        │         │

详细时序:
- 0-50μs:    接收上位机控制命令
- 50-200μs:  数据处理和控制算法执行
- 200-250μs: 准备发送数据
- 250-300μs: 发送状态和传感器数据
- 300-1000μs: 空闲时间，用于其他任务
```

## 4. Modbus交互流程

### 4.1 Modbus连接建立流程

```mermaid
sequenceDiagram
    participant Client as Modbus客户端
    participant Server as 供墨系统服务器

    Note over Client,Server: TCP连接建立
    Client->>Server: TCP SYN
    Server->>Client: TCP SYN+ACK
    Client->>Server: TCP ACK

    Note over Client,Server: Modbus功能验证
    Client->>Server: Read Holding Register (地址0x0000)
    Server->>Client: 设备ID和版本信息

    Note over Client,Server: 系统状态查询
    Client->>Server: Read Input Register (0x1000-0x101F)
    Server->>Client: 传感器数据

    Client->>Server: Read Holding Register (0x2000-0x200F)
    Server->>Client: 系统状态

    Note over Client,Server: 控制参数设置
    Client->>Server: Write Holding Register (0x3000)
    Server->>Client: 设置确认
```

### 4.2 Modbus数据轮询模式

```mermaid
graph TD
    A[开始轮询] --> B[读取传感器数据]
    B --> C[读取系统状态]
    C --> D[读取故障信息]
    D --> E[检查控制需求]
    E --> F{需要写入控制参数?}
    F -->|是| G[写入控制参数]
    F -->|否| H[等待轮询间隔]
    G --> H
    H --> I{连接状态正常?}
    I -->|是| B
    I -->|否| J[重新连接]
    J --> A
```

### 4.3 Modbus异常响应处理

```
异常代码处理流程:

01 (非法功能码)
├── 记录错误日志
├── 返回异常响应
└── 继续处理其他请求

02 (非法数据地址)
├── 检查地址范围
├── 返回异常响应
└── 建议正确地址范围

03 (非法数据值)
├── 检查数据范围和格式
├── 返回异常响应
└── 提供有效数据范围

04 (从站设备故障)
├── 触发系统自检
├── 返回异常响应
├── 记录故障信息
└── 通知上位机故障详情

06 (从站忙)
├── 返回异常响应
├── 建议重试延时
└── 优先处理高优先级请求
```

## 5. 自定义TCP交互流程

### 5.1 TCP连接管理流程

```mermaid
stateDiagram-v2
    [*] --> Listening
    Listening --> Connected: 客户端连接
    Connected --> Authenticated: 身份验证
    Authenticated --> Active: 开始通信
    Active --> Heartbeat_Lost: 心跳超时
    Active --> Disconnected: 客户端断开
    Heartbeat_Lost --> Reconnecting: 尝试重连
    Reconnecting --> Active: 重连成功
    Reconnecting --> Disconnected: 重连失败
    Disconnected --> Listening: 等待新连接

    Listening : 监听状态
    Listening : - 监听端口8080
    Listening : - 等待连接请求

    Connected : 已连接
    Connected : - TCP连接建立
    Connected : - 等待认证

    Authenticated : 已认证
    Authenticated : - 身份验证完成
    Authenticated : - 协议版本协商

    Active : 活跃通信
    Active : - 数据正常交换
    Active : - 心跳监控
```

### 5.2 自定义协议消息流程

```mermaid
sequenceDiagram
    participant Client as TCP客户端
    participant Server as 供墨系统服务器

    Note over Client,Server: 连接和认证
    Client->>Server: 连接请求
    Server->>Client: 连接确认
    Client->>Server: 认证请求 (用户名/密码)
    Server->>Client: 认证响应 (Token)

    Note over Client,Server: 系统信息查询
    Client->>Server: 系统状态查询
    Server->>Client: 系统状态响应
    Client->>Server: 传感器数据查询
    Server->>Client: 传感器数据响应

    Note over Client,Server: 控制命令发送
    Client->>Server: 设置温度目标
    Server->>Client: 设置确认
    Client->>Server: 启动控制系统
    Server->>Client: 启动确认

    Note over Client,Server: 实时数据订阅
    Client->>Server: 订阅实时数据
    Server->>Client: 订阅确认

    loop 每50ms
        Server->>Client: 实时数据推送
    end

    Note over Client,Server: 心跳保持
    loop 每5秒
        Client->>Server: 心跳请求
        Server->>Client: 心跳响应
    end
```

### 5.3 数据推送和订阅机制

```
数据推送流程:

1. 客户端订阅
   ├── 发送订阅请求
   ├── 指定数据类型和频率
   └── 接收订阅确认

2. 服务器处理
   ├── 验证客户端权限
   ├── 检查系统资源
   ├── 建立推送队列
   └── 启动推送定时器

3. 数据推送
   ├── 采集最新数据
   ├── 打包数据帧
   ├── 发送数据
   └── 检查客户端响应

4. 异常处理
   ├── 网络中断 → 暂停推送
   ├── 缓冲区满 → 丢弃旧数据
   ├── 客户端无响应 → 断开连接
   └── 系统过载 → 降低推送频率
```

## 6. 多协议并发交互

### 6.1 协议优先级管理

```
优先级层次 (高到低):
1. EtherCAT实时控制    - 最高优先级，1ms严格实时
2. 安全紧急停机       - 紧急优先级，立即响应
3. TCP控制命令        - 高优先级，50ms响应
4. Modbus状态查询     - 中等优先级，100ms响应
5. 系统诊断和维护     - 低优先级，1s响应

资源分配策略:
├── CPU时间片分配: EtherCAT(40%) + TCP(30%) + Modbus(20%) + 其他(10%)
├── 内存缓冲区: 独立缓冲区避免冲突
├── 网络带宽: 动态QoS管理
└── 中断优先级: EtherCAT > 安全 > TCP > Modbus
```

### 6.2 协议冲突处理

```mermaid
graph TD
    A[多协议请求] --> B{检查优先级}
    B --> C[EtherCAT请求]
    B --> D[TCP请求]
    B --> E[Modbus请求]

    C --> F[立即处理]
    D --> G{EtherCAT忙?}
    E --> H{高优先级忙?}

    G -->|是| I[加入TCP队列]
    G -->|否| J[立即处理]

    H -->|是| K[加入Modbus队列]
    H -->|否| L[立即处理]

    I --> M[等待时间片]
    K --> M

    F --> N[执行完成]
    J --> N
    L --> N
    M --> N
```

### 6.3 数据一致性保证

```
数据同步机制:

1. 原子操作保护
   ├── 关键数据结构使用互斥锁
   ├── 读写操作原子化
   └── 避免数据竞争

2. 数据版本控制
   ├── 每次更新增加版本号
   ├── 客户端检查版本一致性
   └── 版本冲突时重新获取

3. 缓存管理
   ├── 每种协议独立缓存
   ├── 定期同步缓存数据
   └── 缓存过期自动刷新

4. 事务处理
   ├── 批量操作事务化
   ├── 失败时回滚状态
   └── 确保数据完整性
```

## 7. 状态机和流程控制

### 7.1 系统全局状态机

```mermaid
stateDiagram-v2
    [*] --> System_Init
    System_Init --> System_Ready: 初始化完成
    System_Ready --> System_Running: 启动命令
    System_Running --> System_Paused: 暂停命令
    System_Running --> System_Emergency: 紧急情况
    System_Paused --> System_Running: 恢复命令
    System_Paused --> System_Stopped: 停止命令
    System_Emergency --> System_Safe: 安全处理
    System_Safe --> System_Ready: 故障清除
    System_Stopped --> System_Ready: 重新启动

    System_Init : 系统初始化
    System_Init : - 硬件自检
    System_Init : - 网络初始化
    System_Init : - 协议栈启动

    System_Ready : 系统就绪
    System_Ready : - 等待启动命令
    System_Ready : - 接受配置参数
    System_Ready : - 状态查询响应

    System_Running : 系统运行
    System_Running : - 正常控制循环
    System_Running : - 实时数据交换
    System_Running : - 所有协议活跃

    System_Emergency : 紧急状态
    System_Emergency : - 停止所有输出
    System_Emergency : - 优先安全协议
    System_Emergency : - 故障信息广播
```

### 7.2 通信状态机

```mermaid
stateDiagram-v2
    [*] --> Comm_Init
    Comm_Init --> Comm_Ready: 通信初始化完成
    Comm_Ready --> EtherCAT_Active: EtherCAT连接
    Comm_Ready --> TCP_Active: TCP客户端连接
    Comm_Ready --> Modbus_Active: Modbus客户端连接

    EtherCAT_Active --> Multi_Protocol: 其他协议连接
    TCP_Active --> Multi_Protocol: 其他协议连接
    Modbus_Active --> Multi_Protocol: 其他协议连接

    Multi_Protocol --> Comm_Fault: 通信故障
    EtherCAT_Active --> Comm_Fault: 通信故障
    TCP_Active --> Comm_Fault: 通信故障
    Modbus_Active --> Comm_Fault: 通信故障

    Comm_Fault --> Comm_Recovery: 故障恢复
    Comm_Recovery --> Comm_Ready: 恢复成功
    Comm_Recovery --> Comm_Fault: 恢复失败

    Multi_Protocol : 多协议并发
    Multi_Protocol : - 协议优先级管理
    Multi_Protocol : - 资源分配调度
    Multi_Protocol : - 数据一致性保证
```

## 8. 性能监控和诊断

### 8.1 性能指标监控

```
实时性能监控指标:

1. EtherCAT性能
   ├── 循环时间: ≤1ms (目标: 0.8ms)
   ├── 抖动: ≤10μs
   ├── 丢包率: ≤0.01%
   └── 同步精度: ≤1μs

2. TCP性能
   ├── 响应时间: ≤50ms
   ├── 吞吐量: ≥1Mbps
   ├── 并发连接: ≤10个
   └── 重连次数: 监控统计

3. Modbus性能
   ├── 查询响应时间: ≤100ms
   ├── 成功率: ≥99.9%
   ├── 异常响应率: ≤0.1%
   └── 超时次数: 监控统计

4. 系统资源
   ├── CPU使用率: ≤80%
   ├── 内存使用率: ≤70%
   ├── 网络带宽: 监控使用情况
   └── 任务响应时间: 各任务独立监控
```

### 8.2 诊断和调试接口

```
诊断功能实现:

1. 通信诊断
   ├── 协议层统计信息
   ├── 错误计数和分类
   ├── 性能指标历史
   └── 网络状态检测

2. 系统诊断
   ├── 任务运行状态
   ├── 资源使用情况
   ├── 硬件状态检查
   └── 内存泄漏检测

3. 远程调试
   ├── 日志远程查看
   ├── 参数在线调整
   ├── 状态实时监控
   └── 远程重启功能

4. 故障分析
   ├── 故障事件记录
   ├── 故障模式识别
   ├── 根因分析辅助
   └── 预防性维护建议
```

## 9. 安全和认证机制

### 9.1 安全层次结构

```
安全防护层次:

1. 物理安全
   ├── 硬件防护
   ├── 访问控制
   └── 环境监控

2. 网络安全
   ├── 防火墙规则
   ├── 网络分段
   ├── 流量监控
   └── 入侵检测

3. 协议安全
   ├── 数据加密 (AES-256)
   ├── 消息认证 (HMAC)
   ├── 重放攻击防护
   └── 完整性校验

4. 应用安全
   ├── 用户身份验证
   ├── 权限管理
   ├── 操作日志
   └── 安全审计
```

### 9.2 认证流程

```mermaid
sequenceDiagram
    participant Client as 上位机客户端
    participant Auth as 认证服务
    participant System as 供墨系统

    Note over Client,System: 初始认证
    Client->>Auth: 认证请求 (用户名/密码)
    Auth->>Auth: 验证凭据
    Auth->>Client: 认证响应 (Token/状态)

    Note over Client,System: 权限验证
    Client->>System: 操作请求 + Token
    System->>Auth: Token验证
    Auth->>System: 权限确认
    System->>Client: 操作响应

    Note over Client,System: Token刷新
    Client->>Auth: Token刷新请求
    Auth->>Client: 新Token

    Note over Client,System: 会话管理
    loop 定期检查
        System->>Auth: 会话状态查询
        Auth->>System: 会话有效性
    end
```

## 10. 错误处理和恢复策略

### 10.1 错误分类和处理

```
错误分类处理策略:

1. 通信错误
   ├── 网络连接中断
   │   ├── 自动重连 (最多3次)
   │   ├── 降级服务
   │   └── 报告故障状态
   ├── 协议解析错误
   │   ├── 丢弃错误帧
   │   ├── 请求重传
   │   └── 记录错误日志
   └── 超时错误
       ├── 增加超时时间
       ├── 检查网络状态
       └── 重新建立连接

2. 系统错误
   ├── 内存不足
   │   ├── 清理缓存
   │   ├── 暂停低优先级任务
   │   └── 报告资源不足
   ├── 任务异常
   │   ├── 任务重启
   │   ├── 状态恢复
   │   └── 异常上报
   └── 硬件故障
       ├── 切换备用路径
       ├── 安全模式运行
       └── 维护提醒

3. 数据错误
   ├── 校验失败
   │   ├── 请求重传
   │   ├── 使用历史数据
   │   └── 错误标记
   ├── 格式错误
   │   ├── 数据转换
   │   ├── 默认值填充
   │   └── 格式修正
   └── 范围错误
       ├── 数据截断
       ├── 边界处理
       └── 告警通知
```

### 10.2 系统恢复流程

```mermaid
graph TD
    A[检测到错误] --> B{错误类型判断}

    B --> C[通信错误]
    B --> D[系统错误]
    B --> E[数据错误]

    C --> F[网络诊断]
    F --> G{网络可达?}
    G -->|是| H[重建连接]
    G -->|否| I[等待网络恢复]

    D --> J[系统诊断]
    J --> K{系统可恢复?}
    K -->|是| L[重启服务]
    K -->|否| M[安全模式]

    E --> N[数据校验]
    N --> O{数据可修复?}
    O -->|是| P[数据修复]
    O -->|否| Q[使用备用数据]

    H --> R[验证连接]
    I --> S[定期重试]
    L --> T[功能验证]
    M --> U[手动干预]
    P --> V[数据验证]
    Q --> W[降级服务]

    R --> X{验证成功?}
    S --> X
    T --> Y{功能正常?}
    V --> Z{数据正确?}

    X -->|是| AA[恢复正常服务]
    X -->|否| AB[继续故障处理]
    Y -->|是| AA
    Y -->|否| AB
    Z -->|是| AA
    Z -->|否| AB

    AA --> AC[更新系统状态]
    AB --> AD[升级故障级别]
```

## 11. 集成测试和验证

### 11.1 测试场景设计

```
测试场景分类:

1. 功能测试
   ├── 基本连接测试
   ├── 数据交换测试
   ├── 控制命令测试
   └── 状态查询测试

2. 性能测试
   ├── 响应时间测试
   ├── 吞吐量测试
   ├── 并发连接测试
   └── 长时间稳定性测试

3. 兼容性测试
   ├── 不同上位机软件
   ├── 不同网络环境
   ├── 不同操作系统
   └── 协议版本兼容

4. 异常测试
   ├── 网络中断测试
   ├── 电源断电测试
   ├── 数据损坏测试
   └── 恶意攻击测试

5. 压力测试
   ├── 高频数据请求
   ├── 大量并发连接
   ├── 长时间运行
   └── 资源耗尽场景
```

### 11.2 自动化测试框架

```
自动化测试架构:

测试控制器
├── 测试用例管理
├── 测试执行引擎
├── 结果分析器
└── 报告生成器

模拟器群
├── EtherCAT主站模拟器
├── Modbus客户端模拟器
├── TCP客户端模拟器
└── 网络环境模拟器

监控系统
├── 性能监控器
├── 错误检测器
├── 日志收集器
└── 数据分析器

结果验证
├── 功能正确性验证
├── 性能指标验证
├── 异常处理验证
└── 安全性验证
```

## 12. 部署和维护指南

### 12.1 部署清单

```
部署前检查清单:

1. 硬件环境
   ├── 网络连接质量
   ├── 电源稳定性
   ├── 环境温湿度
   └── 电磁干扰检查

2. 软件环境
   ├── 固件版本确认
   ├── 配置参数设置
   ├── 安全证书部署
   └── 备份策略制定

3. 网络配置
   ├── IP地址分配
   ├── 路由表配置
   ├── 防火墙规则
   └── QoS策略设置

4. 上位机准备
   ├── 软件安装配置
   ├── 连接参数设置
   ├── 用户账户创建
   └── 权限分配管理
```

### 12.2 维护策略

```
定期维护任务:

日常维护 (每日)
├── 系统状态检查
├── 连接状态监控
├── 性能指标查看
└── 错误日志审查

周期维护 (每周)
├── 系统性能分析
├── 安全日志审计
├── 备份数据验证
└── 软件更新检查

月度维护 (每月)
├── 全面系统诊断
├── 性能趋势分析
├── 容量规划评估
└── 灾难恢复演练

年度维护 (每年)
├── 硬件设备检查
├── 安全策略审查
├── 系统架构优化
└── 升级计划制定
```

## 13. 总结

本文档全面描述了供墨系统与上位机的交互流程，涵盖了EtherCAT、Modbus TCP和自定义TCP三种主要通信协议的详细交互序列。通过状态机设计、错误处理机制、性能监控和安全认证等多个维度，为上位机软件开发和系统集成提供了完整的技术指导。

### 13.1 关键特性

- **多协议并发支持**: 同时支持三种通信协议，满足不同应用场景需求
- **实时性保证**: EtherCAT 1ms严格实时，TCP 50ms响应，Modbus 100ms响应
- **高可靠性**: 完善的错误处理和恢复机制，确保系统稳定运行
- **安全防护**: 多层次安全机制，保护系统免受恶意攻击
- **易于集成**: 标准化接口和详细文档，简化上位机软件开发

### 13.2 适用范围

本交互流程设计适用于：
- 工业自动化控制系统
- 分布式生产线管理
- 实时监控和数据采集
- 远程设备维护和诊断
- 企业级供墨系统集成

通过遵循本文档的交互流程设计，可以确保上位机与供墨系统之间的高效、稳定、安全的通信交互。